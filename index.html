<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anchor</title>
    
    <!-- å›¾æ ‡ï¼šç»§ç»­ä½¿ç”¨ä½  GitHub æ ¹ç›®å½•é‡Œçš„ png æ–‡ä»¶ -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* --- ğŸ¨ Anchor v5.1 --- */
        :root {
            --bg-blue: #D4F1F4; /* æ›´åé©¬å¡é¾™çš„æµ…å¤©è“ï¼Œä¸ç²‰è‰²æ­é…æ›´æŸ”å’Œ */
            --bg-wood: #FDF6E3;
            --bg-pink: #FFE2E2; /* æ›´æŸ”å’Œçš„ç²‰è‰²ï¼Œé€‚åˆä½œä¸ºå¤§é¢ç§¯èƒŒæ™¯ */
            --bg-sos:  #E8DFF5;
            --bg-setting: #F0F4F8;
            --bg-footer: #FBF7FF; /* 04åŒºï¼šæ›´æ·¡çš„è–°è¡£è‰é©¬å¡é¾™èƒŒæ™¯ï¼Œå‡å¼±å­˜åœ¨æ„Ÿ */
            --text-main: #5D5C61;
            --gold: #D4AF37;
            --sport-green: #B5EAD7;
            --cycle-purple: #C7CEEA;
            --frog-green: #9CCC65;
            --flash-yellow: #FFD54F;
            --danger-red: #ff6b6b;
            --footprint-grey: #90A4AE;
            --panel-soft: #F7FAFF; /* æ›´æµ…ä¸€ç‚¹çš„ç°è“åº•è‰² */
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0; padding: 0; background-color: #f0f2f5;
            color: var(--text-main); display: flex; justify-content: center;
            min-height: 100vh;
            overscroll-behavior-y: none; 
        }

        .container {
            width: 100%; max-width: 450px; background-color: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            position: relative;
            min-height: 100vh;
        }

        .header {
            padding: 15px 20px; background: #fff; display: flex;
            justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;
            padding-top: max(15px, env(safe-area-inset-top));
        }
        .app-title { font-weight: bold; font-size: 1.1rem; color: #444; }
        .version-badge { background: #81C784; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px; }
        .btn-icon { cursor: pointer; font-size: 1.2rem; opacity: 0.6; }

	/* åŒ…ä½å¿µå¤´è®¡æ•°å™¨ + 00 åŒºçš„ä¸€æ•´å—åŒ…è£… */
	.stats-and-candy-wrapper {
   	 position: relative;
	}
        /* å¿µå¤´è®¡æ•°å™¨ */
        .stats-bar {
            display: flex; justify-content: space-around; padding: 10px 15px; background: #fff;
            border-bottom: 1px solid #eee;
        }
        .stat-btn {
    flex: 1;
    margin: 0 5px;
    padding: 8px;
    border-radius: 14px;
    cursor: pointer;
    text-align: center;
    transition: all 0.1s;
    user-select: none;
    border: 1px solid rgba(0,0,0,0.03);
}

.stat-btn.willpower {
    background: #F3FBF7;  /* è–„è·ç»¿ */
    color: #2E7D32;
}

.stat-btn.joy {
    background: #FFF5EB;  /* å¥¶æ¡ƒè‰² */
    color: #BF6A2F;       /* æŸ”å’Œä¸€ç‚¹çš„æ©™æ£•è‰²æ–‡å­— */
}

/* ğŸ¬ åƒç³–æŒ‰é’®ï¼šåªæœ‰ä¸€é¢—æ¯”è¾ƒå¤§çš„ç³–æœ emojiï¼Œæ²¡æœ‰å¤–æ¡†æŒ‰é’® */
.stat-btn.candy {
    flex: 0;                 /* ä¸è¦åƒå…¶ä»–æŒ‰é’®ä¸€æ ·è¢«æ‹‰ä¼¸ */
    margin: 0 6px;
    padding: 0;
    border: none;
    background: transparent;
    box-shadow: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;         /* ä»ç„¶ä¿æŒå¯ç‚¹å‡» */
    position: relative;
}
/* å½“ 00 åŒºå±•å¼€æ—¶ï¼Œä»ç³–æœä¸‹é¢è¿ä¸€æ ¹çº¿åˆ° 00 åŒºé¡¶éƒ¨ */
.stats-and-candy-wrapper.candy-open #candyButton::after {
    content: '';
    position: absolute;
    top: calc(100% - 4px);  /* è®©èµ·ç‚¹æ›´é è¿‘ç³–åº•éƒ¨ä¸€ç‚¹ */
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    height: 18px;           /* çº¿å†é•¿ä¸€ç‚¹ï¼ŒåŸºæœ¬èƒ½ç¢°åˆ° 00 åŒºèƒŒæ™¯ */
    background: #F1E4D2;    /* ç”¨å’ŒåŸåˆ†ç•Œçº¿æ¥è¿‘çš„é¢œè‰² */
}
/* çº¿æœ«ç«¯çš„å°åœ†ç‚¹ï¼šè®©â€œçº¿â€çœ‹èµ·æ¥æ²¡é‚£ä¹ˆå•è°ƒ */
.stats-and-candy-wrapper.candy-open #candyButton::before {
    content: '';
    position: absolute;
    top: calc(100% + 12px); /* è¿™ä¸ªæ•°å­—å¤§çº¦ = ä¸Šé¢é‚£æ¡çº¿çš„é«˜åº¦ - ä¸€ç‚¹ç‚¹ */
    left: 50%;
    transform: translateX(-50%);
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: #F8A8C8;    /* æŸ”å’Œä¸€ç‚¹çš„ç³–æœç²‰ */
    box-shadow: 0 0 4px rgba(248,168,200,0.7);
}



.stat-btn.candy .candy-emoji {
    font-size: 2.1rem;       /* ç³–æœå†å¤§ä¸€ç‚¹ */
    line-height: 1;
    transition: transform 0.15s, opacity 0.15s;
}

/* æœ¬æ¬¡å·²ç»ç©è¿‡ç³– â†’ ç³–è‡ªåŠ¨â€œé€€åœºâ€ï¼šç¨å¾®å˜å°ã€å˜æ·¡ */
.stat-btn.candy.candy-used .candy-emoji {
    opacity: 0.5;
    transform: scale(0.9);
}

/* æœ¬æ¬¡å·²ç»ç©è¿‡ç³– â†’ ç³–è‡ªåŠ¨â€œé€€åœºâ€ï¼šç¨å¾®å˜å°ã€å˜æ·¡ */
.stat-btn.candy.candy-used .candy-emoji {
    opacity: 0.5;
    transform: scale(0.9);
}


/* 00 åŒºæ•´ä½“å®¹å™¨ï¼šé»˜è®¤éšè—ï¼Œåªç”¨æµ…èƒŒæ™¯ï¼Œä¸å†ç”»æ•´åœˆè¾¹æ¡† */
.candy-section {
    display: none;  /* é»˜è®¤å…³é—­ï¼Œä¸å½±å“æŠ½å¡ä¸»åŒº */
    background: #FFFDF8;
    padding: 10px 16px 14px;
    margin-top: 0;
}

.candy-header {
    margin-bottom: 8px;
}

.candy-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6b4a3b;
}

.candy-subtitle {
    font-size: 0.75rem;
    color: #8c6f5a;
    opacity: 0.9;
}

.candy-stage {
    background: rgba(255,255,255,0.8);
    border-radius: 12px;
    padding: 10px;
    border: 1px dashed rgba(0,0,0,0.05);
    position: relative;
}
/* éŸ³ä¹ç³–ï¼ˆç½‘æ˜“äº‘æ­Œå•ï¼‰å¡ç‰‡æ ·å¼ */
.music-candy-card {
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    padding: 10px 12px;
    border: 1px solid rgba(0,0,0,0.04);
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.music-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6b4a3b;
    display: flex;
    align-items: center;
    gap: 4px;
}

.music-subtitle {
    font-size: 0.75rem;
    color: #8c6f5a;
    opacity: 0.9;
}

.music-player-wrapper {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.06);
}

.music-player-iframe {
    width: 100%;
    height: 90px; /* å‹æ‰æˆâ€œéŸ³é¢‘æ¡â€å°ºå¯¸ï¼Œå‡å°‘è§†é¢‘å¹²æ‰° */
    border: 0;
}

.music-player-fallback {
    margin-top: 4px;
    font-size: 0.75rem;
}

.music-player-fallback a {
    color: #6b4a3b;
    text-decoration: underline;
}

.sound-enable-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 50;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.92);
    color: rgba(0,0,0,0.72);
    font-size: 13px;
    display: none; /* é»˜è®¤éšè—ï¼šä»…åœ¨éœ€è¦è§£é”éŸ³æ•ˆæ—¶å‡ºç° */
    align-items: center;
    gap: 6px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    backdrop-filter: blur(6px);
}


/* æç¤ºæ–‡æ¡ˆï¼šå¤ç”¨æ³¡æ³¡ hint çš„é£æ ¼ */
.bubble-hint,
.music-hint {
    font-size: 0.75rem;
    color: #777;
}



/* ä¹å™¨ç³–ï¼ˆKalimbaï¼‰ */
.instrument-card{
    background: rgba(255,255,255,0.86);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 14px;
    padding: 12px;
    box-shadow: 0 10px 26px rgba(0,0,0,0.05);
}
.instrument-title{
    font-size: 14px;
    font-weight: 700;
    color: rgba(0,0,0,0.78);
    margin-bottom: 6px;
}
.instrument-sub{
    font-size: 12px;
    color: rgba(0,0,0,0.55);
    margin-bottom: 10px;
}
.kalimba-keys{
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    align-items: end;
}
.kalimba-key {
    height: 90px;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.08);  /* æ›´æŸ”å’Œçš„è¾¹æ¡† */
    background: 
        linear-gradient(180deg, rgba(255, 220, 160, 0.7), rgba(255, 255, 255, 0.3));  /* æŸ”å’Œçš„æµ…æ©™è‰²æ¸å˜åˆ°ç™½è‰² */
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);  /* æ›´è½»çš„é˜´å½±æ•ˆæœ */
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    padding-bottom: 8px;
    user-select: none;
    -webkit-user-select: none;
}



.kalimba-key:active{
    transform: translateY(1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.kalimba-num{
    font-size: 12px;
    font-weight: 700;
    color: rgba(0,0,0,0.78);
    line-height: 1.0;
}
.kalimba-note{
    font-size: 10px;
    color: rgba(0,0,0,0.52);
    margin-top: 3px;
}
.instrument-actions{
    display:flex;
    gap:10px;
    margin-top: 10px;
}
.instrument-actions button{
    flex:1;
    padding: 9px 10px;
    border-radius: 999px;
    border: none;
    background: rgba(255,255,255,0.94);
    box-shadow: 0 10px 22px rgba(0,0,0,0.05);
    cursor: pointer;
    color: rgba(0,0,0,0.72);
    font-size: 13px;
}
.instrument-to-gacha{
    margin-top: 10px;
    width: 100%;
    padding: 9px 10px;
    border-radius: 999px;
    border: none;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 10px 22px rgba(0,0,0,0.05);
    cursor: pointer;
    color: rgba(0,0,0,0.78);
    font-size: 13px;
}



/* ä¹å™¨ç³–ï¼šæ¨¡å¼åˆ‡æ¢ Tab + Chord Pad */
.instrument-tabs{
    display:flex;
    gap:8px;
    margin: 8px 0 10px;
    padding: 2px;
    border-radius: 999px;
    background: rgba(0,0,0,0.03);
}
.instrument-tab{
    flex:1;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,0.06);
    background: transparent;
    cursor: pointer;
    color: rgba(0,0,0,0.60);
    font-size: 13px;
    font-weight: 600;
    transition: transform .08s ease, box-shadow .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
}
.instrument-tab:active{
    transform: translateY(1px);
}
.instrument-tab.active{
    border-color: rgba(0,0,0,0.14);
    color: rgba(0,0,0,0.84);
    background: rgba(255,255,255,0.98);
    box-shadow: 0 10px 22px rgba(0,0,0,0.06);
}
.chordpad-grid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}
.chordpad-pad{
    height: 72px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.06);
    /* é©¬å¡é¾™è‰²ç³»ï¼šç”¨å˜é‡æŒ‰ nth-child åˆ†é… */
    background: radial-gradient(130% 130% at 30% 25%, rgba(255,255,255,0.92), var(--pad, rgba(245,245,245,0.90)));
    box-shadow: 0 10px 22px rgba(0,0,0,0.05);
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    display:flex;
    align-items:center;
    justify-content:center;
    gap: 6px;
    position: relative;
    overflow: hidden;
}
.chordpad-pad:nth-child(1){ --pad: #F7D6E6; } /* blush pink */
.chordpad-pad:nth-child(2){ --pad: #FAD9C3; } /* peach */
.chordpad-pad:nth-child(3){ --pad: #F7F0C6; } /* lemon */
.chordpad-pad:nth-child(4){ --pad: #D6F2E3; } /* mint */
.chordpad-pad:nth-child(5){ --pad: #D5ECFA; } /* sky */
.chordpad-pad:nth-child(6){ --pad: #E6D9FA; } /* lavender */
.chordpad-pad:nth-child(7){ --pad: #F5E8D1; } /* cream */
.chordpad-pad:nth-child(8){ --pad: #D2F7F4; } /* aqua */
.chordpad-pad:active{
    transform: translateY(1px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.05);
    filter: saturate(1.08) brightness(1.02);
}
.chordpad-label{
    font-size: 12px;
    font-weight: 800;
    color: rgba(0,0,0,0.78);
    letter-spacing: 0.2px;
}
.chordpad-sub{
    font-size: 10px;
    color: rgba(0,0,0,0.50);
}


/* ææ°”æ³¡ç³–çš„æ³¡æ³¡æ ·å¼ï¼ˆv5.6a çš„é¦–å‘ç³–ï¼‰ */
.bubble-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);  /* æ¯è¡Œ 6 ä¸ª */
    gap: 4px;
    justify-items: center;
    margin-bottom: 8px;
}

.bubble {
    width: 22px;
    height: 22px;
    border-radius: 999px;
    border: none;
    background: radial-gradient(circle at 30% 30%, #ffffff, #E0F7FA);
    box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: transform 0.08s, box-shadow 0.08s, opacity 0.15s;
}

.bubble:active {
    transform: scale(0.9);
    box-shadow: none;
}

.bubble-popped {
    background: #F1F1F1;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
    opacity: 0.7;
}

.bubble-hint {
    font-size: 0.75rem;
    color: #777;
}
.bubble-to-gacha {
    display: block;
    margin: 8px auto 0;          /* ä¸Šä¸‹ç•™ä¸€ç‚¹ç©ºç™½ï¼Œå·¦å³è‡ªåŠ¨ = å±…ä¸­ */
    padding: 6px 16px;
    border-radius: 999px;
    border: none;
    font-size: 0.85rem;
    background: #FFEBEE;         /* æŸ”å’Œçš„ç²‰åº•è‰² */
    color: #AD1457;              /* æ·±ä¸€ç‚¹çš„è“çº¢è‰²å­— */
    cursor: pointer;
}

.bubble-to-gacha:active {
    transform: scale(0.97);
}
/* --- æ¶‚é¸¦ / æ¶‚è‰²ç³– --- */

.doodle-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
}

.doodle-colors {
    display: flex;
    gap: 4px;
}
.doodle-linewidth-group {
    display: flex;
    gap: 4px;
    margin-left: 8px;
}

.linewidth-btn {
    border-radius: 999px;
    border: none;
    padding: 2px 8px;
    font-size: 0.7rem;
    background: #F4F4F4;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.06);
    cursor: pointer;
}

.linewidth-active {
    background: #E0E0E0;
    box-shadow: 0 0 0 2px rgba(0,0,0,0.18);
}

.doodle-color {
    width: 18px;
    height: 18px;
    border-radius: 999px;
    border: none;
    outline: none;
    cursor: pointer;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.06);
    transition: transform 0.12s, box-shadow 0.12s;
}

.doodle-color-active {
    transform: scale(1.15);
    box-shadow: 0 0 0 2px rgba(0,0,0,0.14);
}

.doodle-clear-btn {
    border-radius: 999px;
    border: none;
    padding: 2px 10px;
    font-size: 0.7rem;
    background: #F8F8F8;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.06);
    cursor: pointer;
    color: #666;
    flex-shrink: 0; /* ä¿è¯åœ¨å·¥å…·æ¡å³ä¾§ä¸ä¼šè¢«æŒ¤æ‰ */
}

.doodle-clear-btn:active {
    transform: scale(0.96);
}

.doodle-canvas-wrapper {
    background: #FFFFFF;
    border-radius: 10px;
    border: 1px dashed rgba(0,0,0,0.08);
    overflow: hidden;
    margin-bottom: 6px;
    position: relative;   /* è®©å†…éƒ¨çš„æ¸…ç©ºæŒ‰é’®å¯ä»¥ç»å¯¹å®šä½åœ¨è¿™ä¸ªç›’å­é‡Œ */
}

#doodleCanvas,
#coloringCanvas {
    display: block;
    width: 100%;
    height: 180px;  /* å’Œ JS é‡Œè®¾ç½®çš„é«˜åº¦ä¸€è‡´ */
    touch-action: none;       /* åœ¨ç”»å¸ƒä¸Šæ»‘åŠ¨æ—¶ä¸æ»šåŠ¨é¡µé¢ï¼Œä¸“å¿ƒç”»ç”» */
}


.doodle-hint {
    font-size: 0.75rem;
    color: #777;
    margin-bottom: 4px;
}

/* æ¯æ—¥æ‰“å¡å›¾å¼¹çª— */
.daily-poster-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.25);
    display: none;              /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    z-index: 999;
}

.daily-poster-card {
    background: transparent;
    border-radius: 0;
    padding: 0 18px;
    max-width: 420px;
    width: 100%;
    box-shadow: none;
}

.daily-poster-image {
    position: relative;
    border-radius: 18px;
    overflow: hidden;
    margin-bottom: 12px;
    background: #000;
}

.daily-poster-photo {
    width: 100%;
    display: block;
    object-fit: cover;
}

/* è´´åœ¨å›¾ç‰‡åº•éƒ¨çš„æ–‡å­—æ¡ */
.daily-poster-caption {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 8px 12px;
    background: linear-gradient(to top, rgba(0,0,0,0.55), rgba(0,0,0,0.0));
    color: #fff;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.daily-poster-day {
    font-size: 0.85rem;
    font-weight: 600;
}

.daily-poster-subline {
    font-size: 0.7rem;
    opacity: 0.9;
}

.daily-poster-actions {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

/* å¼¹çª—å†…éƒ¨çš„ä¸‰ä¸ªæŒ‰é’®ï¼ˆä¸å¤ç”¨å¤–é¢åŸæœ‰æŒ‰é’®ç±»ï¼Œé¿å…å†²çªï¼‰ */
.poster-btn-primary,
.poster-btn-secondary,
.poster-btn-tertiary {
    padding: 6px 0;
    border-radius: 999px;
    font-size: 0.85rem;
    border: none;
    cursor: pointer;
}

.poster-btn-primary {
    background: #81C784;
    color: #fff;
}

.poster-btn-secondary {
    background: #fff;
    color: #555;
    border: 1px solid rgba(0,0,0,0.05);
}

.poster-btn-tertiary {
    background: transparent;
    color: #777;
}


        .stat-btn:active {
            transform: scale(0.96);
            background: #E5F4ED;
        }
        .stat-btn:active { transform: scale(0.96); background: #f0f0f0; }
        .stat-label { font-size: 0.8rem; color: #666; margin-right: 5px; }
        .stat-count { font-weight: bold; font-size: 1rem; color: #333; font-family: monospace; }
        .stat-btn.willpower { color: #2E7D32; }
        .stat-btn.joy { color: #558B2F; }

        /* æŠ½å–åŒºåŸŸ */
        .section-filter {
            background: var(--bg-blue);
            padding: 8px 14px 6px; /* å†ç•¥ç¼©é«˜åº¦ï¼Œé¡¶éƒ¨ä¸åº•éƒ¨ç•™ç™½æ›´åŠ æ¥è¿‘ */
            text-align: left;
            border-radius: 18px;
            /* ä¿æŒç°åœ¨çš„å¤©è“è‰²ï¼Œä½†æ”¹ä¸ºçº¯è‰²åº•ï¼Œå»æ‰æ¸å˜ */
            box-shadow: 0 6px 18px rgba(144, 202, 249, 0.25);
            margin: 4px 6px 8px;
            transition: background 0.4s, box-shadow 0.2s, transform 0.2s;
            position: relative;
            z-index: 10;
        }

        /* v6.4 èƒ½é‡è¯ä¸¸æ ·å¼ */
        .energy-pill {
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, #FFB7B2, #A0E7E5);
            border-radius: 999px;
            position: relative;
            margin-bottom: 10px;
            overflow: hidden;
            transition: background 0.4s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
        }

        .energy-pill-zone {
            flex: 1;
            position: relative;
            cursor: pointer;
            z-index: 1;
        }

        .energy-pill.uptime {
            background: #FF9AA2;
        }

        .energy-pill.anchor {
            background: linear-gradient(90deg, #FFB7B2, #A0E7E5);
        }

        .energy-pill.downtime {
            background: #A0E7E5;
        }

        .energy-pill-slider {
            position: absolute;
            top: 4px;
            width: calc(33.333% - 8px);
            height: calc(100% - 8px);
            background: rgba(255,255,255,0.95);
            border-radius: 999px;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            color: #555;
            z-index: 3;
            pointer-events: none;
        }

        .energy-pill.uptime .energy-pill-slider {
            left: 4px;
        }

        .energy-pill.anchor .energy-pill-slider {
            left: calc(33.333% + 2px);
        }

        .energy-pill.downtime .energy-pill-slider {
            left: calc(66.666%);
        }

        .energy-pill-labels {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            font-size: 0.85rem;
            font-weight: 500;
            color: rgba(255,255,255,0.9);
            transition: opacity 0.3s;
        }

        .label-text {
            transition: opacity 0.3s;
        }

        /* uptime æ¨¡å¼ï¼šåªéšè—ç¬¬ä¸€ä¸ªåŒºåŸŸï¼ˆuptimeï¼‰çš„æ–‡å­—éƒ¨åˆ†ï¼Œå›¾æ ‡æ­£å¸¸æ˜¾ç¤º */
        .energy-pill.uptime .energy-pill-zone:first-child .label-text {
            opacity: 0;
        }

        /* anchor æ¨¡å¼ï¼šæ‰€æœ‰åŒºåŸŸæ ‡ç­¾æ–‡å­—éƒ½æ­£å¸¸æ˜¾ç¤º */
        .energy-pill.anchor .energy-pill-labels {
            opacity: 1;
        }

        /* downtime æ¨¡å¼ï¼šåªéšè—ç¬¬ä¸‰ä¸ªåŒºåŸŸï¼ˆdowntimeï¼‰çš„æ–‡å­—éƒ¨åˆ†ï¼Œå›¾æ ‡æ­£å¸¸æ˜¾ç¤º */
        .energy-pill.downtime .energy-pill-zone:last-child .label-text {
            opacity: 0;
        }

        .energy-hint {
            font-size: 0.75rem;
            color: #6b7a99;
            text-align: center;
            margin-bottom: 8px;
            min-height: 18px;
            transition: opacity 0.3s;
        }

        .filter-drawer-toggle {
            font-size: 0.7rem;
            color: #90A4AE;
            cursor: pointer;
            text-align: center;
            margin-bottom: 8px;
            padding: 4px;
            transition: opacity 0.3s, transform 0.2s;
            user-select: none;
        }

        .filter-drawer-toggle:hover {
            color: #607D8B;
        }

        .filter-drawer-toggle.breathing {
            animation: breathe 3s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        #filterDrawer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #filterDrawer.expanded {
            max-height: 500px;
        }
        .filter-label {
            font-size: 0.8rem;
            color: #6b7a99;
            margin-bottom: 6px;
            padding-left: 4px;
        }
        .mode-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; }
        .mode-tab {
            padding: 6px 14px;
            border-radius: 999px; /* æ›´æ¥è¿‘æ¤­åœ†ï¼Œå’Œç­›é€‰æŒ‰é’®å½¢çŠ¶åŒºåˆ† */
            font-size: 0.85rem;
            cursor: pointer;
            background: rgba(255,255,255,0.55);
            transition: all 0.2s;
        }
        .mode-tab.active { background: #fff; font-weight: bold; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .control-group {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 10px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        .select-wrapper {
            position: relative;
            flex: 1;
        }
        .section-filter select {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border-radius: 12px; /* ä¸ã€Œæ„å¿—åŠ›ã€æŒ‰é’®ç±»ä¼¼çš„è½»åœ†è§’é•¿æ–¹å½¢ */
            border: 1px solid #d6dde8;
            background: #ffffff !important; /* çº¯ç™½åº•è‰² */
            font-size: 0.95rem;
            box-shadow: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            color: #455A64;
        }
        .select-wrapper::after {
            content: "âŒƒ\AâŒ„";
            white-space: pre;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            color: #90A4AE;
            pointer-events: none;
            line-height: 0.4; /* ä¸Šä¸‹ç®­å¤´æ›´ç´§å‡‘ï¼Œè·ç¦»æ›´è¿‘ */
        }
        
        .btn-main {
            background-image: linear-gradient(135deg, #FF9AA2, #FFB6B9);
            color: #ffffff;
            font-weight: 600;
            letter-spacing: 0.03em;
            font-size: 1.05rem;
            padding: 12px 44px;
            border: none;
            border-radius: 999px;
            box-shadow: 0 10px 24px rgba(255, 154, 162, 0.55);
            cursor: pointer;
            transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;
            display: block;
            margin: 16px auto 6px; /* ç¨å¾®é è¿‘ç»“æœå¡ç‰‡ */
        }
        .btn-main:active {
            transform: translateY(1px) scale(0.97);
            box-shadow: 0 5px 14px rgba(255, 154, 162, 0.45);
        }

        /* æŠ½å–ç»“æœæ˜¾ç¤ºåŒº + æ‰­è›‹æœº */
        .section-display {
            flex-grow: 1;
            /* èƒŒæ™¯äº¤ç»™ hero-wrapper çš„å¤§æ¸å˜ï¼Œè¿™é‡Œä¿æŒé€æ˜ä»¥çªå‡ºå¡ç‰‡ */
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;  /* ç»“æœå¡ç‰‡é è¿‘ä¸Šæ–¹ï¼Œç¦»â€œå¸®æˆ‘é€‰â€æ›´è¿‘ */
            padding: 12px 22px 22px; /* è®©ç»“æœå¡ç‰‡æ›´è´´è¿‘æŒ‰é’®ï¼Œæ•´ä½“æ›´ç´§å‡‘ */
            min-height: 260px;
            transition: background 0.4s;
            position: relative;
            border-radius: 0 0 16px 16px;
        }
        .card {
            background: white;
            padding: 34px 26px;
            border-radius: 26px;
            text-align: center;
            width: 100%;          /* å†æ”¾å¤§ä¸€äº›ï¼Œå æ»¡å®¹å™¨å¯ç”¨å®½åº¦ */
            max-width: 560px;     /* æ¡Œé¢ç«¯ä¹Ÿæ›´å¤§ä¸€å· */
            box-shadow: 0 16px 40px rgba(0,0,0,0.10);
            display: none;
        }
        .card-icon { font-size: 4.4rem; display: block; margin-bottom: 16px; }
        .card-title { font-size: 1.6rem; font-weight: bold; margin-bottom: 10px; color: #333; }
        .card-desc { font-size: 0.9rem; color: #777; line-height: 1.6; margin-bottom: 15px; }
        .card-time { 
            display: inline-block; background: #f0f0f0; color: #888; padding: 2px 8px; 
            border-radius: 8px; font-size: 0.75rem; margin-top: 5px; 
        }
        #rStatus {
            font-size: 1rem;
            color: #FF8A65;  /* æŸ”å’ŒçŠç‘šæ©™ï¼Œå’Œç²‰è“æ›´å’Œè° */
            font-weight: 700;
            margin-bottom: 6px;
            text-align: left;
            display: none;
        }
        #rIngPulse {
            font-size: 0.9rem;
            color: #FF8A65;
            font-weight: 600;
            margin-top: 8px;   /* å’Œæ—¶é—´æ‹‰å¼€ä¸€ç‚¹è·ç¦» */
            margin-bottom: 6px;
            text-align: center;
            display: none;
            animation: anchorPulse 1.6s ease-in-out infinite;
        }
        @keyframes anchorPulse {
            0% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.04); }
            100% { opacity: 0.3; transform: scale(1); }
        }

        
        .card-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; vertical-align: middle; margin-left: 5px; color: #fff; }
        .bg-cycle { background: var(--cycle-purple); }
        .bg-frog { background: var(--frog-green); }
        .bg-flash { background: var(--flash-yellow); color: #555; }

        .btn-card-action {
            background: #f0f0f0; padding: 8px 18px; border-radius: 15px; font-size: 0.85rem; 
            border: none; cursor: pointer; color: #555; margin: 0 5px;
        }

        /* è¾“å…¥åŒº */
        .section-input { background-color: var(--bg-wood); padding: 20px; }
        .input-box {
            background: #fff; padding: 5px; border-radius: 15px; display: flex; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px;
        }
        textarea#inpTitle { 
            border: none; padding: 10px; flex: 1; border-radius: 10px; outline: none; 
            font-size: 16px; font-family: inherit; resize: none;
            min-height: 36px;
            line-height: 1.4;
        }
        .btn-add { background: #B5EAD7; border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; color: #555; cursor: pointer; }
        
        .input-options { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .input-options-row2 { display: flex; justify-content: flex-start; align-items: center; gap: 10px; margin-top: 8px; }
        .input-options-row2 .time-select-small {
    margin-left: auto;   /* æŠŠæ—¶é—´é€‰æ‹©æ¨åˆ°è¿™ä¸€è¡Œæœ€å³è¾¹ */
}

        .tags-row { display: flex; gap: 6px; flex-wrap: wrap; }
        .tag {
            padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; background: rgba(0,0,0,0.05); 
            cursor: pointer; border: 1px solid transparent; transition: all 0.2s;
        }
        .tag.active { background: #C7CEEA; border-color: #989ec2; color: #333; }
        .tag[data-v="sport"].active { background: var(--sport-green); border-color: #99cbb9; }

        .switch-container { display: flex; gap: 8px; margin-left: 0; }
        .switch-btn {
            font-size: 0.85rem; color: #555; display: flex; align-items: center; gap: 6px; cursor: pointer;
            background: rgba(255,255,255,0.7); padding: 6px 20px; border-radius: 12px; border: 1px solid transparent;
            transition: all 0.2s;
        }
        .switch-btn.active-cycle { background: var(--cycle-purple); color: #fff; font-weight: bold; border-color: var(--cycle-purple); }
        .switch-btn.active-flash { background: var(--flash-yellow); color: #555; font-weight: bold; border-color: #FBC02D; }

       .time-select-small {
    font-size: 16px;
    padding: 6px 14px;
    border-radius: 12px;                 /* å’Œé‚£ä¸¤ä¸ªå¼€å…³æŒ‰é’®åœ†è§’æ¥è¿‘ */
    border: 1px solid rgba(0,0,0,0.06);  /* å¾ˆæ·¡çš„æè¾¹ï¼Œä¸æŠ¢æˆ */
    background: #ffffff;                 /* é‡ç‚¹ï¼šç™½åº• */
    color: #666;
    transition: opacity 0.3s;
}
        .time-select-small.disabled { opacity: 0.3; pointer-events: none; }

        /* å››å¤§å—åˆ—è¡¨åŒºåŸŸï¼šä¸¤åˆ—æ’ç‰ˆ */
        .section-list {
            background-color: var(--panel-soft);
            padding: 16px;
        }

        .list-panels {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .list-panel {
            background: #fff; /* å››å—å¡ç‰‡æœ¬èº«ä¿æŒç™½è‰² */
            border-radius: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.04);
            padding: 10px 10px 6px;
            display: flex;
            flex-direction: column;
            min-height: 150px;
        }

        .panel-header {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .panel-header-top {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 6px;
        }

        .panel-title {
            font-size: 0.95rem;
            font-weight: bold;
            color: #555;
        }

        .panel-count {
            font-size: 0.75rem;
            color: #999;
        }

        .panel-subtitle {
            font-size: 0.75rem;
            color: #aaa;
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin: 6px 0 0 0;
        }

        .task-list.panel-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 4px;
            border-bottom: 1px solid #f0f1f5;
            font-size: 0.85rem;
        }

        .task-status-done { opacity: 0.4; text-decoration: line-through; }

        .list-badge {
            font-size: 0.6rem; padding: 1px 4px; border-radius: 4px; margin-left: 5px;
            border: 1px solid #eee; color: #888;
        }
        .lb-frog { color: var(--frog-green); border-color: var(--frog-green); font-weight:bold; }
        .lb-flash { color: #FBC02D; border-color: #FBC02D; }

        .footprint-time { font-size: 0.7rem; color: #aaa; margin-right: 10px; font-family: monospace;}
        .footprint-item { color: #666; font-size: 0.85rem; }

        .archive-item {
            padding: 5px 0;
            display: flex;
            gap: 10px;
            border-bottom: 1px dashed #f3f3f3;
            font-size: 0.8rem;
            align-items: center;
            justify-content: space-between;
        }
        .archive-date { font-family: monospace; color: #ccc; }
        .archive-del { cursor: pointer; color: #ccc; font-size: 0.75rem; }
        .archive-del:hover { color: #e57373; }

        /* è¯´æ˜ä¹¦ & è®¾ç½®åŒº */
        

        /* 04åŒºå¡ç‰‡ç»Ÿä¸€é£æ ¼ï¼šç”¨æˆ·æ‰‹å†Œ / æœ€è¿‘æ›´æ–° / æ•°æ®æ–¹èˆŸ */
        .section-footer-area .section-manual,
        .section-footer-area .section-updates,
        .section-footer-area .section-settings {
            background-color: #F9FAFB;
            padding: 10px 12px;
            border-radius: 16px;
        }
        .section-footer-area .section-manual details,
        .section-footer-area .section-updates details,
        .section-footer-area .section-settings details {
            background: transparent;
            border-radius: 0;
            margin-bottom: 0;
        }
        .section-footer-area summary,
        .section-footer-area .settings-title {
            font-size: 0.95rem;
        }
        .section-footer-area summary {
            padding: 10px 4px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #444;
        }
        .section-footer-area .manual-content {
            padding: 0 4px 10px 4px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
        }
.footer-note {
            margin-top: 10px;
            font-size: 0.75rem;
            color: #777;
            text-align: center;
        }

        .section-footer-area .section-manual,
        .section-footer-area .section-updates,
        .section-footer-area .section-settings {
            background-color: #F9FAFB;
        }
        .section-footer-area summary,
        .section-footer-area .settings-title {
            font-size: 0.95rem;
        }

        .section-footer-area .section-manual,
        .section-footer-area .section-updates,
        .section-footer-area .section-settings {
            margin-bottom: 14px;
            border-radius: 16px;
        }
        .section-footer-area .section-settings {
            /* 04åŒºä¸­ä¸å…¶ä»–å¡ç‰‡ä¿æŒä¸€è‡´çš„å†…è¾¹è· */
        }
        .section-footer-area .section-manual details,
        .section-footer-area .section-updates details {
            margin-bottom: 0;
        }
.section-manual { background-color: #F9FAFB; padding: 16px; border-top: 1px solid #eee; color: #666; font-size: 0.9rem; line-height: 1.6; }
        details { background: #f9f9f9; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        summary { padding: 15px; font-weight: bold; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; color: #444; }
        summary::after { content: '+'; font-size: 1.2rem; font-weight: normal; color: #999; }
        details[open] summary::after { content: '-'; }
	/* å†·åº“è¿™ä¸€è¡Œçš„ +/- å•ç‹¬è°ƒå°ä¸€ç‚¹ï¼Œå¹¶å¾®è°ƒå‚ç›´ä½ç½® */
	.section-cold summary::after {
    	position: relative;
    	top: -1px;            /* å¦‚æœæ„Ÿè§‰è¿˜æ˜¯ç•¥é«˜ï¼Œå¯ä»¥æ”¹æˆ 2px è¯•è¯• */
}
        .manual-content { padding: 0 15px 20px 15px; border-top: 1px solid #eee; font-size: 0.85rem; }
        .manual-h3 { font-weight: bold; color: #333; margin: 15px 0 5px 0; }
        .manual-tag { background: #eee; color: #666; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin: 0 2px; }
/* è®© 03 åŒºé‡Œçš„å†å²è®°å½•å¡ç‰‡ï¼Œå’Œå‰é¢å››å—å¡ç‰‡é£æ ¼ä¸€è‡´ */
.section-history {
    margin-top: 8px;           /* è·Ÿ HTML é‡Œçš„ 8px å¯¹é½ */
}

.section-history details {
    background: #fff;          /* å’Œ list-panel ä¸€æ ·çš„ç™½å¡ç‰‡ */
    border-radius: 16px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.04);
    margin-bottom: 0;
}

.section-history summary {
    padding: 10px 8px;
    font-weight: 600;
    font-size: 0.85rem;
    color: #444;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-history .manual-content {
    border-top: 1px solid #eee;
    padding: 6px 8px 10px;
    font-size: 0.8rem;
}

/* å†·åº“å¡ç‰‡ï¼šå’Œå†å²è®°å½•é£æ ¼ä¸€è‡´ï¼Œä½†æ•´ä½“æ›´ä½è°ƒä¸€ç‚¹ */
.section-cold {
    margin-top: 8px;
}

.section-cold details {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.04);
    margin-bottom: 0;
}

.section-cold summary {
    padding: 10px 8px;
    font-weight: 600;
    font-size: 0.85rem;
    color: #444;
    display: flex;
   justify-content: flex-start;
    align-items: center;
}

.section-cold summary span:last-child {
    margin-left: auto;
}

.section-cold .manual-content {
    border-top: 1px solid #eee;
    padding: 6px 8px 10px;
    font-size: 0.8rem;
}
/* å†·åº“æ“ä½œå¼¹çª—æ•´ä½“èƒŒæ™¯ï¼šå°½é‡è½»ï¼Œä¸è¦æŠ¢æˆ */
.cold-dialog-backdrop {
    position: fixed;
    inset: 0;
    display: none;                 /* é»˜è®¤éšè— */
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.08);  /* è½»å¾®ç°å¹• */
    z-index: 999;
}

/* ä¸­é—´çš„å°å¡ç‰‡æœ¬ä½“ */
.cold-dialog {
    background: #fff;
    border-radius: 18px;
    padding: 14px 16px;
    box-shadow: 0 10px 24px rgba(0,0,0,0.12);
    width: 86%;
    max-width: 320px;
    box-sizing: border-box;
    font-size: 0.85rem;
}

.cold-dialog-title {
    margin-bottom: 10px;
    font-weight: 600;
}

/* ä¸‰ä¸ªæŒ‰é’®æ¨ªæ’ */
.cold-dialog-buttons {
    display: flex;
    gap: 8px;
}

.cold-dialog-buttons button {
    flex: 1;
    padding: 6px 8px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 0.85rem;
    white-space: nowrap;
}

/* ä¸‰ä¸ªæŒ‰é’®ç¨å¾®åŒºåˆ†ä¸€ä¸‹è‰²è°ƒï¼Œä½†éƒ½ä¿æŒæŸ”å’Œ */
.cold-btn-delete {
    background: #ffecec;
}

.cold-btn-cold {
    background: #e7f4ff;
}

.cold-btn-cancel {
    background: #f5f5f5;
}

/* å¤‡ä»½å¯¹è¯æ¡†æŒ‰é’®æ ·å¼ */
.backup-btn-overwrite {
    background: #ffecec;
}

.backup-btn-merge {
    background: #e7f4ff;
}

.backup-btn-cancel {
    background: #f5f5f5;
}

/* è®©æ•´ä¸ª 03 åŒºä¸‹é¢ä¸è¦ç•™å¤ªå¤šç©ºç™½ */
.section-list {
    padding-bottom: 20px;
}

        .section-settings { background-color: var(--bg-setting); padding: 20px; border-top: 1px solid #eee; padding-bottom: 80px;}
        .settings-title { font-size: 0.9rem; font-weight: bold; color: #666; margin-bottom: 10px; }
        .backup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:10px;}
        .btn-outline { background: #fff; border: 1px solid #bbb; color: #555; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; }
        .btn-file { background: #e1eefd; border: 1px solid #bbd4f0; color: #1565C0; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        textarea { width: 100%; height: 80px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; color:#555; padding: 8px; font-family: monospace; }
        .btn-danger { width: 100%; padding: 10px; background: #ffebee; border: 1px solid #ffcdd2; color: #c62828; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 0.8rem; }

        /* Modal & Toast */
        .custom-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .custom-modal { background: white; width: 80%; max-width: 320px; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: left; max-height: 80vh; overflow-y: auto; }
        .modal-text { margin-bottom: 20px; font-size: 0.95rem; color: #333; line-height: 1.6; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; flex: 1; text-align: center;}
        .modal-btn.cancel { background: #f0f0f0; color: #666; }
        .modal-btn.confirm { background: var(--bg-blue); color: #006064; }
        .modal-btn.danger { background: var(--danger-red); color: white; }
        .toast-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(33,33,33,0.92);
            color: #fff;
            padding: 10px 16px;
            border-radius: 999px;
            font-size: 0.85rem;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease-out;
        }
        .toast-notification.show {
            opacity: 1;
        }
        /* --- æ‰­è›‹æœºåŠ¨ç”»ï¼šå¯¹é½ demo è·¯å¾„ --- */
        #gachaLayer {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: radial-gradient(
                circle at top,
                rgba(255,255,255,0.95),
                rgba(255,255,255,0.78)
            );
            z-index: 20;
            opacity: 1;
        }
        .gacha-stage {
            position: relative;
            width: 260px;
            max-width: 90%;
        }
        #gachaImg {
            width: 100%;
            display: block;
            border-radius: 18px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transform-origin: 50% 80%;
            transition: opacity 0.6s ease-out;  /* æœºå°æ·¡å‡º */
        }
        @keyframes machineShake {
            0%   { transform: translateY(0) rotate(0deg); }
            20%  { transform: translateY(-4px) rotate(-1deg); }
            40%  { transform: translateY(2px) rotate(1deg); }
            60%  { transform: translateY(-2px) rotate(-0.5deg); }
            80%  { transform: translateY(1px) rotate(0.5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        .machine-shake { animation: machineShake 0.7s ease-out; }

        #eggOut {
            position: absolute;
            left: 77%;          /* å‡ºå£æ¨ªå‘ä½ç½® */
            bottom: 88px;       /* å‡ºå£çºµå‘ä½ç½® */
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            opacity: 0;
        }
        @keyframes eggFly {
            0% {
                left: 77%;
                bottom: 72px;   /* ç¨å¾®åœ¨å‡ºå£é‡Œé¢ä¸€ç‚¹ */
                transform: translateX(-50%) scale(0.7);
                opacity: 0;
            }
            15% {
                left: 77%;
                bottom: 88px;   /* åˆ°å‡ºå£å£æ²¿ */
                transform: translateX(-50%) scale(0.9);
                opacity: 1;
            }
            55% {
                left: 62%;
                bottom: 60%;    /* é£å‡ºæœºå°ã€å‘ä¸­é—´ç§»åŠ¨ */
                transform: translateX(-50%) scale(1.15);
                opacity: 1;
            }
            85% {
                left: 50%;
                bottom: 44%;    /* æ›´é ä¸‹ï¼Œæ¥è¿‘å¡ç‰‡ä¸­å¿ƒ */
                transform: translateX(-50%) scale(1.3);
                opacity: 1;
            }
            100% {
                left: 50%;
                bottom: 44%;
                transform: translateX(-50%) scale(1.25);
                opacity: 1;     /* ä¿æŒå¯è§ï¼Œç­‰å¾…çˆ†å¼€åŠ¨ç”» */
            }
        }
        @keyframes eggBurst {
            0% {
                transform: translateX(-50%) scale(1.25);
                opacity: 1;
            }
            30% {
                transform: translateX(-50%) scale(1.6);
                opacity: 0.9;
            }
            100% {
                transform: translateX(-50%) scale(2.0);
                opacity: 0;
            }
        }
        .gm-caption {
            margin-top: 8px;
            font-size: 0.75rem;
            color: #888;
        }

        @keyframes stripOpen {
            0%   { transform: scaleX(0.6); opacity: 0; }
            40%  { transform: scaleX(0.9); opacity: 1; }
            100% { transform: scaleX(1);   opacity: 1; }
        }
    
        .hero-wrapper {
            margin: 4px 0 0;
            padding: 8px 12px 8px;
            /* ä» 01 æ ‡é¢˜å¼€å§‹ï¼Œæ•´ä½“ä»ç™½è‰²è¿‡æ¸¡åˆ°æµ…ç²‰è‰² */
            background: linear-gradient(to bottom, #FFFFFF 0%, var(--bg-pink) 82%);
            border-radius: 0;
            border: none;
            box-shadow: none;
        }
        #selContext, #selTime {
            font-size: 0.95rem;
            min-width: 0;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: #555;
            margin-bottom: 4px;
        }
.section-title.section-title-ritual {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.ritual-icons {
    display: flex;
    gap: 4px;
}

.ritual-icon-btn {
    min-width: 40px;
    height: 22px;
    padding: 0 8px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,0.10);
    background: #fffaf5;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0.75;          /* é»˜è®¤æ·¡ä¸€ç‚¹ */
}

.ritual-icon-btn.dimmed {
    opacity: 0.3;           /* å®Œæˆåå˜æ›´æ·¡ */
}

/* === æ ¹æ® APP_VARIANT åˆ‡æ¢ æ„å¿—åŠ› / å°ç¡®å¹¸ é…è‰² === */

/* personalï¼šä¸€ç»¿ä¸€æ¡ƒï¼ˆä½ ç°åœ¨è¿™ç‰ˆçš„æ„Ÿè§‰ï¼‰ */
body.variant-personal .stat-btn.willpower {
    background: #F3FBF7;
    color: #2E7D32;
}

body.variant-personal .stat-btn.joy {
    background: #FFF5EB;
    color: #BF6A2F;
}

/* commonï¼šä¸¤å—éƒ½ç”¨åŒä¸€æ¬¾æµ…ç»¿ */
body.variant-common .stat-btn.willpower,
body.variant-common .stat-btn.joy {
    background: #F3FBF7;
    color: #2E7D32;
}

        .section-subtitle {
            font-size: 0.75rem;
            color: #777;
            margin-bottom: 10px;
        }
        .section-footer-header {
            padding: 8px -8px 4px;
            margin-top: 4px; /* ä¸å‰é¢åˆ†åŒºçš„æ ‡é¢˜ç›¸å¯¹ä½ç½®ä¿æŒä¸€è‡´ */
        }

        .input-label {
            font-size: 0.75rem;
            color: #777;
            margin: 4px 0 4px 2px;
        }
        .section-list-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: #555;
            margin-bottom: 4px;
        }
        .section-list-subtitle {
            font-size: 0.75rem;
            color: #777;
            margin-bottom: 8px;
        }
/* ğŸŒ…ğŸŒ™ ä»ªå¼åŒºå°æŒ‰é’® */
        .ritual-shortcuts {
            display: flex;
            gap: 6px;
            margin: 6px 0 4px;
            font-size: 0.8rem;
        }
        .ritual-btn {
            flex: 1;
            padding: 4px 6px;
            border-radius: 999px;
            border: 1px dashed rgba(0,0,0,0.08);
            background: #fffaf5;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

/* ğŸŒ…ğŸŒ™ ä»ªå¼å¡ç‰‡ï¼šä½œä¸ºæŠ½å–åŒºé‡Œçš„æ™®é€šä¸€å¼ å¡ */
#ritualOverlay {
    display: none;          /* é»˜è®¤ä¸æ˜¾ç¤º */
    width: 100%;            /* âœ… å…³é”®ï¼šè®©å¤–å±‚å®¹å™¨å æ»¡ç»“æœåŒºå®½åº¦ */
    margin-top: 16px;
    margin-bottom: 16px;
}


.ritual-card {
    width: 100%;
    max-width: 560px;       /* å’Œ resultCard ä¸€è‡´ */
    margin: 0 auto;
    background: #fff;
    border-radius: 26px;    /* å’Œ resultCard ä¸€æ · */
    box-shadow: 0 16px 40px rgba(0,0,0,0.10);
    padding: 34px 26px;     /* å’Œ resultCard ä¸€æ · */
    box-sizing: border-box;
    text-align: center;     /* å’Œç»“æœå¡ä¸€æ ·ï¼Œä¸»æ ‡é¢˜å±…ä¸­ */
}

/* é¡¶éƒ¨å¤§å›¾æ ‡ï¼Œå¤ç”¨ card-icon çš„æ„Ÿè§‰ */
.ritual-card .card-icon {
    font-size: 4.4rem;      /* å’Œ .card-icon ç›¸åŒ */
    display: block;
    margin-bottom: 12px;
}

/* æ ‡é¢˜ï¼Œç®€æ´ä¸€ç‚¹ */
.ritual-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 12px;
}

/* ä¸­é—´ checklist æ–‡æœ¬æ”¹ä¸ºå·¦å¯¹é½ï¼Œå¹¶ç¨å¾®æ”¶çª„ä¸€ä¸‹å®½åº¦ */
.ritual-steps {
    margin: 6px 0 16px;
    /* å»æ‰ ul è‡ªå¸¦çš„é¡¹ç›®ç¬¦å·å’Œé¢å¤–ç¼©è¿› */
    list-style: none;
    padding-left: 0;

    max-height: 220px;
    overflow-y: auto;
    font-size: 0.9rem;
    line-height: 1.6;
    text-align: left;
}

.ritual-steps li {
    margin-bottom: 4px;     /* ç¨å¾®ç´§å‡‘ä¸€ç‚¹ï¼Œ7 æ¡ä¹Ÿä¸ä¼šå¤ªé•¿ */
}


/* åº•éƒ¨ä¸¤ä¸ªæŒ‰é’®ï¼Œå’Œå…¶ä»–å¡ç‰‡æŒ‰é’®é£æ ¼ç»Ÿä¸€ */
.ritual-actions {
    display: flex;
    gap: 10px;
    margin-top: 6px;
}

.ritual-actions button {
    flex: 1;
    padding: 8px 10px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    white-space: nowrap;     /* é˜²æ­¢â€œâœ… ä»ªå¼å®Œæˆâ€æ¢è¡Œ */
}

.ritual-btn-primary {
    background: var(--bg-pink);
}

.ritual-btn-secondary {
    background: #f5f5f5;
}


.ritual-step-checkbox {
    width: 14px;
    height: 14px;
}

.ritual-steps li label span.completed {
    text-decoration: line-through;
    color: #999;
}



/* v6.1 çƒŸèŠ±/æ˜Ÿç©ºç³– */
.fireworks-candy-card {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.fireworks-topbar {
    display: flex;
    justify-content: flex-start;
    align-items: center;
}
.mode-switch {
    display: inline-flex;
    background: rgba(255,255,255,0.75);
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 12px;
    padding: 4px;
    gap: 4px;
}
.mode-btn {
    border: none;
    background: transparent;
    padding: 6px 10px;
    border-radius: 10px;
    font-size: 13px;
    color: rgba(0,0,0,0.62);
    cursor: pointer;
}
.mode-btn.active {
    background: rgba(255,255,255,0.95);
    box-shadow: 0 6px 16px rgba(0,0,0,0.06);
    color: rgba(0,0,0,0.85);
}
.fireworks-hint {
    font-size: 13px;
    color: rgba(0,0,0,0.58);
}
.fireworks-canvas {
    width: 100%;
    height: 240px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.06);
    background: rgba(10, 12, 24, 0.92);
}

/* --- Candy: Fireworks/Stars canvas must stay inside the candy card --- */
.fireworks-canvas-wrap{
    width: 100%;
    height: 240px;              /* å›ºå®šèˆå°é«˜åº¦ï¼Œé¿å…æ’‘æ»¡å±å¹• */
    border-radius: 14px;
    overflow: hidden;           /* å…³é”®ï¼šé˜²æ­¢ç”»å¸ƒæº¢å‡ºåˆ°å¡ç‰‡å¤– */
    border: 1px solid rgba(0,0,0,0.06);
    background: rgba(10, 12, 24, 0.92);
    position: relative;
}
.fireworks-canvas-wrap canvas{
    width: 100%;
    height: 100%;
    display: block;
    border: 0;
    border-radius: 0;
    background: transparent;
}


/* === v6.3 Tarot Draw Mode (Fix Layout) === */
:root {
  /* ç¡®ä¿è¿™é‡Œæœ‰ä½ çš„ç‰ŒèƒŒå›¾ */
  --tarot-back: url("/assets/images/tarot-back.png");
}

#tarotLayer {
  display: none;
  width: 100%;
  height: 100%; /* ç¡®ä¿å±‚æ’‘æ»¡ */
  align-items: center;
  justify-content: flex-start; /* æ”¹ä¸ºä»ä¸Šå¾€ä¸‹æ’ */
  flex-direction: column;
  gap: 10px;
  padding: 20px 10px;
  perspective: 1000px; 
  position: relative;
  z-index: 50; /* ä¿è¯æ•´ä¸ªå¡”ç½—å±‚åœ¨æœ€ä¸Šé¢ */
}

.tarot-caption {
  font-size: 0.95rem;
  color: #555;
  text-align: center;
  line-height: 1.45;
  margin-top: 10px;
  z-index: 60; /* æ–‡å­—ä¸èƒ½æŒ¡ä½ç‰Œ */
  pointer-events: none; /* è®©é¼ æ ‡èƒ½é€è¿‡æ–‡å­—ç‚¹åˆ°ä¸‹é¢çš„ä¸œè¥¿ */
}

.tarot-subcaption {
  font-size: 0.8rem;
  color: #888;
  text-align: center;
  margin-bottom: 10px;
  pointer-events: none;
}

/* ä¿®æ”¹ï¼šæŠŠè·³è¿‡æŒ‰é’®æ”¾åˆ°é¡¶éƒ¨ï¼Œé˜²æ­¢æŒ¡ä½ä¸‹é¢çš„ç‰Œ */
.tarot-skip {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 0.78rem;
  color: #8a7f73;
  text-decoration: underline;
  cursor: pointer;
  z-index: 100; /* ä¿è¯å®ƒèƒ½ç‚¹ï¼Œä½†ä¸å¹²æ‰°ä¸­é—´ */
}

.tarot-stage {
  position: relative;
  width: 100%;
  max-width: 420px;
  height: 280px; 
  margin-top: 20px;
  /* å…³é”®ï¼šä¸èƒ½ overflow hiddenï¼Œå¦åˆ™ç‰Œé£å‡ºå»ä¼šè¢«åˆ‡æ‰ */
  overflow: visible; 
}

/* ç‰Œå † */
.tarot-deck {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 140px;
  height: 220px;
  border-radius: 12px;
  background-image: var(--tarot-back);
  background-size: cover; 
  background-position: center;
  /* å»æ‰è¾¹æ¡†ï¼Œæ”¹ä¸ºçº¯é˜´å½±ï¼Œè§£å†³é€æ˜è¾¹é—®é¢˜ */
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 10; /* ç‰Œå †å±‚çº§ */
  transition: opacity 0.3s;
}

.tarot-deck.shuffling {
  animation: tarotShuffle 0.9s ease-in-out 1;
}

@keyframes tarotShuffle {
  0%   { transform: translate(-50%, -50%) rotate(0deg); }
  25%  { transform: translate(-55%, -50%) rotate(-5deg); }
  50%  { transform: translate(-45%, -50%) rotate(5deg); }
  75%  { transform: translate(-52%, -50%) rotate(-3deg); }
  100% { transform: translate(-50%, -50%) rotate(0deg); }
}

.tarot-cards {
  position: absolute;
  inset: 0;
  pointer-events: none; 
  z-index: 20; /* æ•£å¼€åçš„ç‰Œå±‚çº§æ›´é«˜ */
}

/* å•å¼ å¡ç‰Œå®¹å™¨ */
.tarot-card {
  position: absolute;
  left: 50%;
  top: 50%; 
  width: 140px;
  height: 220px;
  transform-style: preserve-3d; 
  /* åˆå§‹ç¼©å°ä¸€ç‚¹ */
  transform: translate(-50%, -50%) scale(0.96);
  transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.35s ease, filter 0.35s ease;
  cursor: pointer;
  pointer-events: auto; /* å…³é”®ï¼šå¼€å¯ç‚¹å‡» */
  
  /* è§£å†³é€æ˜è¾¹ç¼˜çš„å…³é”®ï¼š */
  background: transparent; 
  border: none;
  outline: none;
}

/* æœªé€‰ä¸­å˜æš— */
.tarot-card.dim {
  opacity: 0.2; 
  filter: grayscale(0.5) blur(1px);
  pointer-events: none;
}

/* é€‰ä¸­å±‚çº§æœ€é«˜ */
.tarot-card.selected {
  z-index: 200 !important; /* ç¡®ä¿é€‰ä¸­ç¿»è½¬æ—¶å‹è¿‡ä¸€åˆ‡ */
  cursor: default;
}

/* å¡ç‰Œæ­£åé¢ */
.tarot-face {
  position: absolute;
  top: 0; left: 0;
  width: 100%; /* å¼ºåˆ¶æ’‘æ»¡ */
  height: 100%; /* å¼ºåˆ¶æ’‘æ»¡ */
  border-radius: 12px;
  backface-visibility: hidden; 
  overflow: hidden; /* åˆ‡æ‰å¤šä½™çš„å›¾ */
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* èƒŒé¢ */
.tarot-back {
  background-image: var(--tarot-back);
  background-size: cover; /* å›¾ç‰‡æ’‘æ»¡ */
  background-position: center;
  background-repeat: no-repeat;
  /* å»æ‰ border */
  border: none; 
}

/* æ­£é¢ */
.tarot-front {
  background: #fff;
  transform: rotateY(180deg);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 16px;
  text-align: center;
  border: 1px solid rgba(0,0,0,0.05); /* ä»…ç•™ææ·¡çš„å†…æè¾¹ */
}

.tarot-front .t-icon {
  font-size: 3.5rem;
  margin-bottom: 10px;
  display: block;
}
.tarot-front .t-title {
  font-weight: 800;
  font-size: 1.1rem;
  color: #333;
  margin-bottom: 6px;
}
.tarot-front .t-desc {
  font-size: 0.85rem;
  line-height: 1.5;
  color: #666;
  margin-bottom: 12px;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.tarot-front .t-btn {
  background: var(--bg-pink);
  color: #fff;
  border: none;
  padding: 8px 20px;
  border-radius: 99px;
  font-size: 0.85rem;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 4px 10px rgba(255, 154, 162, 0.4);
}

.tarot-card.reveal {
  /* ç¿»è½¬ */
  transform: translate(-50%, -50%) scale(1.1) rotateY(180deg) !important;
}

@media (max-width: 420px) {
  .tarot-stage { height: 260px; }
  /* ç§»åŠ¨ç«¯ç¨å¾®è°ƒå°ä¸€ç‚¹ç‰Œï¼Œé¿å…ä¸¤è¾¹å¤ªæŒ¤ */
  .tarot-deck, .tarot-card { width: 110px; height: 180px; }
  .tarot-front .t-icon { font-size: 2.8rem; }
}

/* v6.3-edit-buttons-enterï¼šä»»åŠ¡æ“ä½œå¯¹è¯æ¡†æ ·å¼ */
#taskActionDialog {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.task-dialog-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1;
}

.task-dialog-box {
  position: relative;
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  max-width: 340px;
  width: 90%;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  z-index: 2;
  animation: dialogFadeIn 0.2s ease-out;
}

@keyframes dialogFadeIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.task-dialog-title {
  font-size: 1.1rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 12px;
  text-align: center;
}

.task-dialog-message {
  font-size: 0.95rem;
  color: #666;
  line-height: 1.5;
  margin-bottom: 20px;
  text-align: center;
}

.task-dialog-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.task-dialog-btn {
  flex: 1;
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.task-dialog-btn-cancel {
  background: #f0f0f0;
  color: #666;
}

.task-dialog-btn-cancel:hover {
  background: #e0e0e0;
}

.task-dialog-btn-edit {
  background: #cfe8ff; /* v6.3-edit-buttons-enterï¼šæŸ”å’Œé©¬å¡é¾™æ·¡è“ */
  color: #2f5d90;
}

.task-dialog-btn-edit:hover {
  background: #b9dbff;
}

.task-dialog-btn-complete {
  background: #d3f3d6; /* v6.3-edit-buttons-enterï¼šæŸ”å’Œé©¬å¡é¾™æ·¡ç»¿ */
  color: #2d6a3a;
}

.task-dialog-btn-complete:hover {
  background: #bff0c4;
}

.task-dialog-btn-memory {
  background: #e8d5ff; /* v6.5ï¼šæŸ”å’Œé©¬å¡é¾™æ·¡ç´« */
  color: #6b4a7c;
}

.task-dialog-btn-memory:hover {
  background: #d8c5ef;
}

/* v6.5ï¼šå¤‡æ³¨æŒ‰é’®å‘¼å¸åŠ¨ç”» */
@keyframes memoryBtnBreathe {
  0%, 100% {
    opacity: 0.7;
  }
  50% {
    opacity: 0.85;
  }
}

/* v6.5ï¼šè®°å¿†é¢æ¿æ ·å¼ */
#memoryPanel {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10000;
  display: flex;
  align-items: flex-end;
  justify-content: center;
}

.memory-panel-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1;
}

.memory-panel-content {
  position: relative;
  background: #fff;
  border-radius: 20px 20px 0 0;
  padding: 20px 24px 30px;
  width: 100%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  z-index: 2;
  animation: memoryPanelSlideUp 0.3s ease-out;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
}

@keyframes memoryPanelSlideUp {
  from {
    transform: translateY(100%);
  }
  to {
    transform: translateY(0);
  }
}

.memory-panel-handle {
  width: 40px;
  height: 4px;
  background: #ddd;
  border-radius: 2px;
  margin: 0 auto 16px;
  cursor: pointer;
}

.memory-panel-title {
  font-size: 1.1rem;
  font-weight: bold;
  color: #333;
  margin-bottom: 20px;
  text-align: center;
}

.memory-panel-row1 {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}

.memory-input-bookmark {
  flex: 1;
  padding: 10px 12px;
  border: none;
  border-bottom: 2px solid #e0e0e0;
  font-size: 0.95rem;
  outline: none;
  transition: border-color 0.2s;
  max-width: 160px; /* è¿›ä¸€æ­¥é™åˆ¶æœ€å¤§å®½åº¦ï¼Œç»™æ—¶é—´é€‰æ‹©å™¨ç•™å‡ºæ›´å¤šç©ºé—´ */
}

.memory-input-bookmark:focus {
  border-bottom-color: #75B79E;
}

.memory-separator {
  font-size: 0.9rem;
  color: #999;
  padding: 0 2px; /* å‡å°‘å·¦å³é—´è· */
  white-space: nowrap;
  margin: 0 2px; /* æ·»åŠ å°çš„å¤–è¾¹è· */
}

.memory-time-picker {
  display: flex;
  align-items: center;
  gap: 2px; /* å‡å°‘é—´è·ï¼Œæ›´ç´§å‡‘ */
}

.memory-time-select {
  padding: 8px 12px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  font-size: 0.95rem;
  background: #fff;
  cursor: pointer;
  outline: none;
  min-width: 70px; /* å¢åŠ æœ€å°å®½åº¦ä»¥å®¹çº³"h"æ ‡è¯† */
}

.memory-time-select:focus {
  border-color: #75B79E;
}

.memory-textarea {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  font-size: 0.95rem;
  font-family: inherit;
  resize: vertical;
  outline: none;
  transition: border-color 0.2s;
  margin-bottom: 16px;
}

.memory-textarea:focus {
  border-color: #75B79E;
}

.memory-panel-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.memory-btn-save,
.memory-btn-clear {
  padding: 10px 24px;
  border: none;
  border-radius: 8px;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 500;
}

.memory-btn-save {
  background: #75B79E;
  color: #fff;
}

.memory-btn-save:hover {
  background: #65a78e;
}

.memory-btn-clear {
  background: #f0f0f0;
  color: #666;
}

.memory-btn-clear:hover {
  background: #e0e0e0;
}

@media (max-width: 420px) {
  .task-dialog-box {
    padding: 20px;
  }
  .task-dialog-buttons {
    flex-direction: column;
  }
  .task-dialog-btn {
    width: 100%;
  }
  
  .memory-panel-content {
    padding: 16px 20px 24px;
    max-height: 85vh;
  }
  
  .memory-panel-row1 {
    flex-direction: row;
    align-items: center;
    flex-wrap: nowrap; /* ä¸æ¢è¡Œï¼Œç¡®ä¿åœ¨åŒä¸€è¡Œ */
    gap: 4px; /* å‡å°‘é—´è· */
  }
  
  .memory-input-bookmark {
    flex: 0 1 auto;
    max-width: 35%; /* è¿›ä¸€æ­¥å‡å°‘ä¹¦ç­¾è¾“å…¥æ¡†å®½åº¦ */
    min-width: 100px;
  }
  
  .memory-separator {
    font-size: 0.75rem; /* æ›´å°çš„å­—ä½“ */
    padding: 0 1px; /* æœ€å°é—´è· */
    margin: 0;
    flex-shrink: 0;
  }
  
  .memory-time-picker {
    flex: 0 1 auto;
    min-width: 0; /* å…è®¸ç¼©å° */
    justify-content: flex-start;
    gap: 1px; /* æœ€å°é—´è· */
  }
  
  .memory-time-select {
    min-width: 60px; /* å‡å°‘æœ€å°å®½åº¦ */
    padding: 8px 6px; /* å‡å°‘å†…è¾¹è· */
    font-size: 0.85rem; /* ç¨å°çš„å­—ä½“ */
  }
}
/* =========================
   v6.6 ä¿®å¤ï¼š04åŒºæ•´ä½“åº•è‰² + å¡ç‰‡ç™½åº•ä¸€è‡´ + é€»è¾‘è¯å…¸å±‚çº§ + +/-
   ç›®æ ‡ï¼š
   1) 04åŒºï¼ˆsection-footer-areaï¼‰æ•´å—ä¸ºæ·¡ç´«è‰²åº•
   2) å››å¼ å¡ç‰‡ï¼ˆç”¨æˆ·æ‰‹å†Œ/æ›´æ–°æ—¥å¿—/èµ·é£ç€é™†ç¼–è¾‘/æ•°æ®æ–¹èˆŸï¼‰å…¨éƒ¨ç™½åº•ä¸€è‡´
   3) â€œé€»è¾‘è¯å…¸â€å±•å¼€åï¼Œå†…éƒ¨è¯æ¡ï¼ˆæ›´æ·±ä¸€å±‚ detailsï¼‰è§†è§‰ä¸Šæ›´å°ä¸€çº§
   4) æŠ˜å æ˜¾ç¤º â€œ+â€ï¼Œå±•å¼€æ˜¾ç¤º â€œ-â€
   ========================= */
   .section-footer-area{
  background: var(--bg-footer) !important; /* 04åŒºæ•´å—æ·¡ç´«è‰²åº• */
  border-radius: 16px;
  padding: 14px 16px 22px;
}

/* 04åŒºå››å¼ å¡ç‰‡ï¼šç»Ÿä¸€ç™½åº•ã€ç»Ÿä¸€é˜´å½±ä¸åœ†è§’ */
.section-footer-area .section-manual,
.section-footer-area .section-updates,
.section-footer-area .section-settings{
  background: #ffffff !important;
  border-radius: 16px !important;
  border: 1px solid rgba(0,0,0,0.06) !important;
  box-shadow: 0 3px 10px rgba(0,0,0,0.04) !important;
}

/* é¿å…ç»§æ‰¿åˆ°å…¨å±€ section-settings çš„ç°åº• */
.section-footer-area .section-settings{
  background: #ffffff !important;
}

/* 04åŒºå¡ç‰‡æ ‡é¢˜ï¼ˆç¬¬ä¸€å±‚ summaryï¼‰ */
/* ä¼˜åŒ–ï¼šç®€åŒ–é€‰æ‹©å™¨ï¼Œå‡å°‘æµè§ˆå™¨åŒ¹é…å¤æ‚åº¦ */
.section-footer-area .section-manual details summary,
.section-footer-area .section-updates details summary,
.section-footer-area .section-settings details summary{
  padding: 10px 8px !important;
  font-size: 0.95rem !important;
  font-weight: 700 !important;
  border-bottom: 1px solid rgba(0,0,0,0.06) !important;
}

/* ç”¨æˆ·æ‰‹å†Œå†…å®¹åŒºæ•´ä½“å­—å·ç•¥å°ä¸€ç‚¹ï¼Œé˜…è¯»æ›´é¡º */
.section-footer-area .manual-content{
  padding: 8px 10px 12px !important;
  font-size: 0.88rem;
}

/* ç¬¬äºŒå±‚ï¼šç”¨æˆ·æ‰‹å†Œå†…çš„æŠ˜å å—ï¼ˆå¦‚ï¼šæŠ½ç­¾è£…ç½® / è®°å¿†æ¨¡å— / æ™ºèƒ½è¾“å…¥è¯å…¸ ç­‰ï¼‰ */
.section-footer-area .manual-content > details{
  background: rgba(0,0,0,0.02);
  border: 1px solid rgba(0,0,0,0.05);
  border-radius: 12px;
  margin-top: 10px;
  overflow: hidden;
}

.section-footer-area .manual-content > details > summary{
  padding: 10px 12px !important;
  font-size: 0.90rem !important;
  font-weight: 650 !important;
}

/* ç¬¬ä¸‰å±‚ï¼šé€»è¾‘è¯å…¸å±•å¼€åçš„"è¯æ¡/æ¦‚å¿µ"â€”â€”æ¯”"é€»è¾‘è¯å…¸"å†å°ä¸€çº§ */
/* ä¼˜åŒ–ï¼šä½¿ç”¨æ›´å…·ä½“çš„é€‰æ‹©å™¨ï¼Œå‡å°‘æµè§ˆå™¨åŒ¹é…å¤æ‚åº¦ */
.section-footer-area .manual-content details details{
  background: rgba(255,255,255,0.72);
  border: 1px solid rgba(0,0,0,0.05);
  border-radius: 12px;
  margin: 8px 12px 0;
  overflow: hidden;
}

.section-footer-area .manual-content details details summary{
  padding: 9px 10px !important;
  font-size: 0.84rem !important;
  font-weight: 600 !important;
}

/* 04åŒºä¸“ç”¨ï¼šæŠ˜å  + / å±•å¼€ -ï¼ˆè¦†ç›–å…¨å±€ï¼Œç¡®ä¿è¡Œä¸ºä¸€è‡´ï¼‰ */
.section-footer-area summary{
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.section-footer-area summary::after{
  content: '+';
  font-size: 1.1rem;
  font-weight: 800;
  color: #9a9a9a;
  margin-left: 10px;
}

.section-footer-area details[open] > summary::after{
  content: '-';
}

</style>
</head>
<body>

<div id="toast" class="toast-notification">âœ… æ“ä½œæˆåŠŸ</div>

<div id="modalOverlay" class="custom-overlay">
    <div class="custom-modal">
        <div id="modalMsg" class="modal-text"></div>
        <div class="modal-btns" id="modalBtnContainer"></div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div><span class="app-title">Anchor âš“ï¸</span><span class="version-badge">v6.5 é€šç”¨ç‰ˆ</span></div>
        <span class="btn-icon" onclick="scrollToSettings()">âš™ï¸</span>
    </div>

<div class="stats-and-candy-wrapper">
    <!-- å¿µå¤´è®¡æ•°å™¨ -->
    <div class="stats-bar">
        <!-- æ„å¿—åŠ› -->
        <div class="stat-btn willpower" onclick="incrementStat('willpower')">
            <span class="stat-label">ğŸ›¡ï¸ æ„å¿—åŠ›</span>
            <span class="stat-count" id="stat-willpower">0</span>
        </div>

        <!-- 00 åŒº Â· åƒç³–æŒ‰é’®ï¼ˆç›²ç›’å…¥å£ï¼Œåªæ˜¯ä¸€é¢—ç³–å›¾æ ‡ï¼‰ -->
        <div id="candyButton" class="stat-btn candy" onclick="handleCandyButtonClick()" aria-label="åƒç³–">
            <span class="candy-emoji">ğŸ¬</span>
        </div>

        <!-- å°ç¡®å¹¸ -->
        <div class="stat-btn joy" onclick="incrementStat('joy')">
            <span class="stat-label">âœ¨ å°ç¡®å¹¸</span>
            <span class="stat-count" id="stat-joy">0</span>
        </div>
    </div>

    <!-- 00 Â· åƒä¸€é¢—ç³–ï¼ˆé»˜è®¤éšè—ï¼Œä¸å½±å“æŠ½å¡ä¸»åŒºï¼‰ -->
    <div id="candySection" class="candy-section">
        <div class="candy-header">
            <div class="candy-title">00 Â· åƒä¸€é¢—ç³–å†å‡ºå‘</div>
            <div class="candy-subtitle">æ¯æ¬¡ç‚¹â€œåƒç³–â€ï¼Œéƒ½ä¼šéšæœºæ‰“å¼€ä¸€ä¸ªå°ç©å…·ã€‚</div>
        </div>
        <div id="candyStage" class="candy-stage">
            <button id="candySoundBtn" class="sound-enable-btn" type="button" style="display:none;">å¼€å¯éŸ³æ•ˆ</button>
            <div id="candyStageInner"></div>
            <!-- ç³–çš„å…·ä½“å†…å®¹ç”±è„šæœ¬æ¸²æŸ“ -->
        </div>
    </div>
</div>

    <!-- æŠ½å–åŒº -->
    <div class="hero-wrapper">
        <div class="section-title section-title-ritual">
    <span>01 Â· æŠ½ç­¾è£…ç½®ï¼ˆç­›é€‰ + æŠ½å¡ï¼‰</span>
    <div class="ritual-icons">
        <button class="ritual-icon-btn" data-ritual="morning"
                onclick="openRitual('morning')" aria-label="èµ·åºŠèµ·é£">
            ğŸŒ…
        </button>
        <button class="ritual-icon-btn" data-ritual="night"
                onclick="openRitual('night')" aria-label="ç¡å‰ç€é™†">
            ğŸŒ™
        </button>
    </div>
</div>
        <div class="section-filter" id="filterSec">
        <!-- v6.4 èƒ½é‡è¯ä¸¸ï¼šç¬¬ä¸€å±‚å¸¸é©» -->
        <div class="energy-pill anchor" id="energyPill">
            <div class="energy-pill-slider" id="energyPillSlider">âš“</div>
            <div class="energy-pill-zone" onclick="setEnergyMode('uptime')">
                <div class="energy-pill-labels"><span class="label-icon">â˜€ï¸</span><span class="label-text">Uptime</span></div>
            </div>
            <div class="energy-pill-zone" onclick="setEnergyMode('anchor')">
                <div class="energy-pill-labels">âš“</div>
            </div>
            <div class="energy-pill-zone" onclick="setEnergyMode('downtime')">
                <div class="energy-pill-labels"><span class="label-icon">â˜ï¸</span><span class="label-text">Downtime</span></div>
            </div>
        </div>
        <div class="energy-hint" id="energyHint">äº¤ç»™ Anchorï¼Œä¸‹ä¸€æ­¥æˆ‘æ¥å†³å®šã€‚</div>
        
        <!-- é«˜çº§ç­›é€‰æŒ‰é’® -->
        <div class="filter-drawer-toggle" id="filterDrawerToggle" onclick="toggleFilterDrawer()">ğŸ”½ é«˜çº§ç­›é€‰</div>
        
        <!-- v6.4 é«˜çº§ç­›é€‰æŠ½å±‰ï¼šç¬¬äºŒå±‚æŠ˜å  -->
        <div id="filterDrawer">
            <div id="controls-normal" class="control-group">
                <div class="select-wrapper">
                    <select id="selContext">
                        <option value="desktop">ğŸ’» ä¹¦æ¡Œå‰</option>
                        <option value="indoor">ğŸ  å®¤å†…/å®¶</option>
                        <option value="outdoor">ğŸŒ³ æˆ·å¤–</option>
                    </select>
                </div>
                <div class="select-wrapper">
                    <select id="selTime">
                        <option value="15">â±ï¸ 15minä»¥å†…</option>
                        <option value="30" selected>â±ï¸ 30minå·¦å³</option>
                        <option value="60">â±ï¸ 1å°æ—¶+</option>
                        <option value="120">â±ï¸ 2å°æ—¶+</option>
                    </select>
                </div>
            </div>
            <div id="controls-sos" class="control-group" style="display:none; color: #555; font-size:0.9rem;">
                <span>ğŸƒ å…è®¸è‡ªå·±æš‚æ—¶åœä¸‹æ¥...</span>
            </div>
            <div class="mode-tabs">
                <div class="mode-tab active" onclick="setMode('normal')">ğŸ”® æ··åˆ/å…¨åŸŸ</div>
                <div class="mode-tab" onclick="setMode('culture')">ğŸ“– åªçœ‹ä¹¦å½±</div>
                <div class="mode-tab" id="mode-tab-vinyl" onclick="setMode('vinyl')">ğŸ’¿ åªå¬å”±ç‰‡</div>
                <div class="mode-tab" onclick="setMode('sos')" style="color:#d9534f">ğŸ†˜ SOS</div>
            </div>
        </div>
    </div>
    <button class="btn-main" onclick="draw()" id="mainBtn">æŠ½å–ä»»åŠ¡</button>

    <!-- æŠ½å–ç»“æœ + æ‰­è›‹æœº -->
    <div class="section-display" id="displaySec">
        <div id="placeholder" style="color:#aaa; font-weight:bold; opacity:0.5;">...</div>

        <!-- æ‰­è›‹æœºå±‚ -->
        <div id="gachaLayer">
            <div class="gacha-stage">
                <img id="gachaImg" src="/assets/images/gacha/gacha-machine.png" alt="Gacha Machine">
                <img id="eggOut" src="" alt="Capsule Ball">
            </div>
            <div class="gm-caption">å‘½è¿è½¬ä¸€è½¬ï¼Œçœ‹çœ‹ä»Šå¤©çš„é”šç‚¹â€¦</div>
        </div>

        <!-- Tarot mode layer (v6.3) -->
        <div id="tarotLayer">
            <div class="tarot-skip" id="tarotSkipLink" style="display:none;">è·³è¿‡å¡”ç½—ï¼Œç”¨æ™®é€šæŠ½å¡</div>
            <div class="tarot-caption" id="tarotCaption">ä»Šå¤©è®©å¡”ç½—å¸®ä½ æŠ½å‡ºä¸€å¼  Anchor å¡ã€‚</div>
            <div class="tarot-subcaption" id="tarotSubCaption">ç‚¹ä¸€ä¸‹ç‰Œå †ï¼Œå¼€å§‹æ´—ç‰Œã€‚</div>
            <div class="tarot-stage">
                <div class="tarot-deck" id="tarotDeck" title="ç‚¹æˆ‘å¼€å§‹æ´—ç‰Œ"></div>
                <div class="tarot-cards" id="tarotCards"></div>
            </div>
        </div>

    <!-- v6.3-edit-buttons-enterï¼šä»»åŠ¡æ“ä½œä¸‰é€‰é¡¹å¯¹è¯æ¡† -->
    <div id="taskActionDialog" style="display:none;">
        <div class="task-dialog-overlay" onclick="closeTaskActionDialog()"></div>
        <div class="task-dialog-box">
            <div class="task-dialog-title" id="taskDialogTitle">ä»»åŠ¡æ“ä½œ</div>
            <div class="task-dialog-message" id="taskDialogMessage"></div>
            <div class="task-dialog-buttons">
                <button class="task-dialog-btn task-dialog-btn-edit" onclick="handleTaskEdit()">ä¿®æ”¹</button>
                <button class="task-dialog-btn task-dialog-btn-memory" onclick="handleTaskMemory()">è®°å¿†</button>
                <button class="task-dialog-btn task-dialog-btn-complete" onclick="handleTaskComplete()">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- v6.5ï¼šè®°å¿†é¢æ¿ï¼ˆåº•éƒ¨æ»‘å‡ºï¼‰ -->
    <div id="memoryPanel" style="display:none;">
        <div class="memory-panel-overlay" onclick="closeMemoryPanel()"></div>
        <div class="memory-panel-content">
            <div class="memory-panel-handle" onclick="closeMemoryPanel()"></div>
            <div class="memory-panel-title">è®°å¿†é¢æ¿</div>
            
            <!-- ç¬¬ä¸€è¡Œï¼šä¹¦ç­¾ + æ—¶é—´é€‰æ‹©å™¨ -->
            <div class="memory-panel-row1">
                <input type="text" id="memoryBookmark" class="memory-input-bookmark" placeholder="è®°å½•åæ ‡ï¼ˆå¦‚ï¼šP120 / S2E5ï¼‰" />
                <span class="memory-separator">/ æœ¬æ¬¡æ—¶é•¿:</span>
                <div class="memory-time-picker">
                    <select id="memoryHours" class="memory-time-select">
                        <option value="0">0h</option>
                        <option value="1">1h</option>
                        <option value="2">2h</option>
                        <option value="3">3h</option>
                        <option value="4">4h</option>
                        <option value="5">5h</option>
                        <option value="6">6h</option>
                        <option value="7">7h</option>
                        <option value="8">8h</option>
                        <option value="9">9h</option>
                        <option value="10">10h</option>
                        <option value="11">11h</option>
                        <option value="12">12h</option>
                        <option value="13">13h</option>
                        <option value="14">14h</option>
                        <option value="15">15h</option>
                        <option value="16">16h</option>
                        <option value="17">17h</option>
                        <option value="18">18h</option>
                        <option value="19">19h</option>
                        <option value="20">20h</option>
                        <option value="21">21h</option>
                        <option value="22">22h</option>
                        <option value="23">23h</option>
                    </select>
                    <span style="margin:0 2px;">:</span>
                    <select id="memoryMinutes" class="memory-time-select">
                        <option value="0">00</option>
                        <option value="5">05</option>
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                        <option value="25">25</option>
                        <option value="30">30</option>
                        <option value="35">35</option>
                        <option value="40">40</option>
                        <option value="45">45</option>
                        <option value="50">50</option>
                        <option value="55">55</option>
                    </select>
                </div>
            </div>
            
            <!-- ç¬¬äºŒè¡Œï¼šè‡ªç”±å¤‡æ³¨ -->
            <textarea id="memoryNote" class="memory-textarea" placeholder="åæ§½ã€é“¾æ¥ã€è¯„ä»·ã€æé†’â€¦"></textarea>
            
            <!-- åº•éƒ¨æŒ‰é’® -->
            <div class="memory-panel-buttons">
                <button class="memory-btn-clear" id="memoryBtnClear" onclick="clearMemoryPanel()" style="display:none;">æ¸…ç©º</button>
                <button class="memory-btn-save" onclick="saveMemoryPanel()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ğŸŒ…ğŸŒ™ èµ·é£ / ç€é™†ä»ªå¼å¡ç‰‡ -->
        <div id="ritualOverlay">
        <div class="ritual-card">
            <!-- é¡¶éƒ¨å¤§å›¾æ ‡ï¼Œå’ŒæŠ½å¡ç»“æœçš„ card-icon ä¸€è‡´ -->
            <span class="card-icon" id="ritualIcon">ğŸŒ…</span>

            <!-- æ ‡é¢˜ï¼Œåªå†™â€œèµ·åºŠèµ·é£ / ç¡å‰ç€é™†â€ -->
            <div class="ritual-title" id="ritualTitle">èµ·åºŠèµ·é£</div>

            <!-- ä¸­é—´ checklist -->
            <ul class="ritual-steps" id="ritualSteps">
                <!-- è¿™é‡Œçš„æ­¥éª¤ä¼šç”¨ JS å¡«å…… -->
            </ul>

            <!-- åº•éƒ¨æŒ‰é’®åŒº -->
            <div class="ritual-actions">
                <button class="ritual-btn-secondary" type="button" onclick="closeRitual()">
                    å…ˆå…³æ‰
                </button>
                <button class="ritual-btn-primary" type="button" onclick="completeRitual()">
                    âœ… ä»ªå¼å®Œæˆ
                </button>
            </div>
        </div>
    </div>


        <!-- ç»“æœå¡ç‰‡ -->
        <div id="resultCard" class="card" style="position:relative;">
            <div id="rStatus">ğŸ“Œ é”šç‚¹ Â· ING...</div>
            <span class="card-icon" id="rIcon">ğŸ</span>
            <div class="card-title">
                <span id="rTitle"></span>
                <span id="rBadge"></span>
            </div>
            <button id="btnMemory" onclick="openMemoryPanel()" style="position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.9);border:none;border-radius:6px;font-size:0.85rem;cursor:pointer;padding:6px 10px;color:#666;animation:memoryBtnBreathe 3s ease-in-out infinite;" onmouseover="this.style.animation='none';this.style.opacity='1'" onmouseout="this.style.animation='memoryBtnBreathe 3s ease-in-out infinite';this.style.opacity=''" title="è®°å¿†">ğŸ“å¤‡æ³¨</button>
            <div id="rProgress" style="font-size:0.85rem;color:#999;margin-top:4px;margin-bottom:8px;min-height:1.2rem;"></div>
            <div class="card-desc" id="rDesc"></div>
            <div class="card-time" id="rTime"></div>
            <div id="rIngPulse">æ­£åœ¨è¿›è¡Œä¸­ Â· Â· Â·</div>
            <div style="margin-top:15px;">
                <button class="btn-card-action" onclick="changeTask()" id="btnChange">æ¢ä¸€ä¸ª</button>
                <button class="btn-card-action" onclick="handlePrimaryAction()" id="btnPrimary">å°±å®ƒå•¦</button>
            </div>
        </div>
    </div>
    </div>

    <!-- è¾“å…¥åŒº -->
    <div class="section-input">
        <div class="section-title">02 Â· æ–°ä»»åŠ¡å…¥åº“</div>
        <div class="input-box">
    <textarea id="inpTitle"
      placeholder="è¾“å…¥äº‹é¡¹â€¦ï¼ˆæ”¯æŒæ‰¹é‡è¾“å…¥ï¼‰&#10;ä¾‹ï¼šï¼å†™å¯¼è¨€30m / æ•´ç†ä¹¦æ¡Œ / çœ‹å¥½ä¸œè¥¿â€¦"
      oninput="autoTag()"
      onkeydown="handleEnter(event)"></textarea>
    <button class="btn-add" onclick="addNew()">ï¼‹</button>
</div>
        <div class="input-options">
            <div class="input-label">ç»™è¿™æ¡ä»»åŠ¡è´´æ ‡ç­¾ï¼š</div>
<div class="tags-row">
    <div class="tag active" data-v="indoor" onclick="pickTag(this)">ğŸ  å®¤å†…</div>
    <div class="tag" data-v="desktop" onclick="pickTag(this)">ğŸ’» æ¡Œå‰</div>
    <div class="tag" data-v="outdoor" onclick="pickTag(this)">ğŸŒ³ æˆ·å¤–</div>
    <div class="tag" data-v="sport" onclick="pickTag(this)">ğŸƒ è¿åŠ¨</div>

    <!-- ä¹¦ / å½± / å‰§é›†ï¼šé€»è¾‘ä¸Šä»ç„¶æ˜¯ cultureï¼Œåªæ˜¯è§†è§‰ä¸Šæ‹†æˆä¸‰ä¸ªæŒ‰é’® -->
<div class="tag" data-v="culture" data-sub="book" onclick="pickTag(this)">ğŸ“– ä¹¦ç±</div>
<div class="tag" data-v="culture" data-sub="movie" onclick="pickTag(this)">ğŸ¬ ç”µå½±</div>
<div class="tag" data-v="culture" data-sub="series" onclick="pickTag(this)">ğŸ“º å‰§é›†</div>


    <!-- å”±ç‰‡æŒ‰é’®ä¿ç•™ï¼Œç”± APP_VARIANT å†³å®šæ˜¯å¦æ˜¾ç¤º -->
    <div class="tag" id="tag-vinyl" data-v="vinyl" onclick="pickTag(this)">ğŸ’¿ å¬ç¢Ÿ</div>
</div>

        </div>
        <div class="input-options-row2">
            <div class="switch-container">
                <div class="switch-btn" id="cycleSwitch" onclick="toggleSwitch('cycle')">
                    <span>ğŸ”„ æ¯æ—¥å¾ªç¯</span>
                </div>
                <div class="switch-btn" id="flashSwitch" onclick="toggleSwitch('flash')">
                    <span>âš¡ï¸ é€ŸåŠæ¨¡å¼</span>
                </div>
            </div>
            <select id="inpTime" class="time-select-small">
                <option value="5">5m (é€ŸåŠ)</option>
                <option value="15">15m</option>
                <option value="30" selected>30m</option>
                <option value="60">1h</option>
                <option value="120">2h+</option>
            </select>
        </div>
        <div id="timeFeedback" style="font-size:0.7rem; color:#75B79E; margin-top:5px; margin-left:5px; height:1rem;"></div>
    </div>

    <!-- å››å¤§å—åˆ—è¡¨ -->
    <div class="section-list">
        <div class="section-list-title">03 Â· ä»»åŠ¡åº“ & è®°å½•</div>

        <!-- ç¬¬ä¸€è¡Œï¼šæ—¥å¸¸&è¿åŠ¨ + åª’ä½“åº“æˆ¿ -->
        <div class="list-panels">
            <div class="list-panel">
                <div class="panel-header">
                    <div class="panel-header-top">
                        <span class="panel-title">ğŸ§º æ—¥å¸¸ & è¿åŠ¨</span>
                        <span class="panel-count">(<span id="dailyCount">0</span>)</span>
                    </div>
                    <div class="panel-subtitle">ä»Šæ—¥é«˜é¢‘çš„å°äº‹</div>
                </div>
                <ul id="dailyList" class="task-list panel-list"></ul>
            </div>

            <div class="list-panel">
                <div class="panel-header">
                    <div class="panel-header-top">
                        <span class="panel-title">ğŸ åª’ä½“åº“æˆ¿</span>
                        <span class="panel-count">(<span id="mediaCount">0</span>)</span>
                    </div>
                    <div class="panel-subtitle">ä¹¦ / ç”µå½± / å”±ç‰‡ ç­‰</div>
                </div>
                <ul id="mediaList" class="task-list panel-list"></ul>
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šä»Šæ—¥è¶³è¿¹ + è£èª‰æ®¿å ‚ -->
        <div class="list-panels" style="margin-top:12px;">
            <div class="list-panel">
                <div class="panel-header">
                    <div class="panel-header-top">
                        <span class="panel-title" style="color:var(--footprint-grey);">ğŸ‘£ ä»Šæ—¥è¶³è¿¹</span>
                        <span class="panel-count">(<span id="logCount">0</span>)</span>
                    </div>
                    <div class="panel-subtitle">ä»…ä¿ç•™å½“å¤©è®°å½•</div>
                </div>
                <ul id="logList" class="task-list panel-list"></ul>
            </div>

            <div class="list-panel">
                <div class="panel-header">
                    <div class="panel-header-top">
                        <span class="panel-title" style="color:var(--gold);">ğŸ† è£èª‰æ®¿å ‚</span>
                        <span class="panel-count">(<span id="arcCount">0</span>)</span>
                    </div>
                    <div class="panel-subtitle">åªè®°å½•ä¹¦ / å½± / å¤§å·¥ç¨‹</div>
                </div>
                <div id="archiveList" class="task-list panel-list"></div>
            </div>
        </div>

        <!-- å†·åº“ï¼šæš‚æ—¶é€€åœºçš„ä»»åŠ¡ -->
<div class="section-cold" style="margin-top:12px;">
    <details id="coldDetails">
        <summary>
            <!-- æ ‡é¢˜å­—å·å’Œå†å²è®°å½•å¯¹é½ï¼š0.95rem + åŠ ç²— -->
            <span style="font-size:0.95rem; font-weight:bold;">ğŸ§Š å†·åº“</span>
            <!-- åœ¨åŸåŸºç¡€ä¸Šå¢åŠ  margin-right:6pxï¼Œè®©æ‹¬å·å’Œ + æ‹‰å¼€ä¸€ç‚¹ -->
            <span style="font-size:0.8rem; color:#999; margin-left:auto; margin-right:6px;">
                (<span id="coldCount">0</span>)
            </span>
        </summary>
        <div class="manual-content" id="coldContent">
            <p style="font-size:0.78rem; color:#777; margin-bottom:6px;">
                æš‚æ—¶é€€åœºçš„ä»»åŠ¡ï¼Œä¸ä¼šè¢«æŠ½åˆ°ã€‚éœ€è¦æ—¶å¯ä»¥èµ¦å…å›åº“æˆ–å½»åº•åˆ é™¤ã€‚
            </p>
            <ul id="coldList" class="task-list" style="max-height:160px; overflow-y:auto; margin-top:4px;"></ul>
        </div>
    </details>
</div>
    <!-- å†·åº“æ“ä½œå°å¼¹çª—ï¼šé€‰æ‹© åˆ é™¤ / å†·åº“ / å–æ¶ˆ -->
    <div id="coldDialog" class="cold-dialog-backdrop">
        <div class="cold-dialog">
            <div class="cold-dialog-title">
                è¦æ€ä¹ˆå¤„ç†è¿™æ¡ä»»åŠ¡ï¼Ÿ
            </div>
            <div class="cold-dialog-buttons">
                <button type="button" class="cold-btn-delete" onclick="confirmColdAction('delete')">
                    ğŸ—‘ï¸ åˆ é™¤
                </button>
                <button type="button" class="cold-btn-cold" onclick="confirmColdAction('cold')">
                    ğŸ§Š å†·åº“
                </button>
                <button type="button" class="cold-btn-cancel" onclick="confirmColdAction('cancel')">
                    ğŸ”™ å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- å¤‡ä»½å¯¼å…¥é€‰æ‹©å¼¹çª—ï¼šé€‰æ‹© è¦†ç›– / åˆå¹¶ / å–æ¶ˆ -->
    <div id="backupDialog" class="cold-dialog-backdrop">
        <div class="cold-dialog">
            <div class="cold-dialog-title" id="backupDialogTitle">
                é€‰æ‹©å¯¼å…¥æ–¹å¼
            </div>
            <div class="cold-dialog-buttons">
                <button type="button" class="backup-btn-overwrite" onclick="confirmBackupAction('overwrite')">
                    ğŸ”„ è¦†ç›–
                </button>
                <button type="button" class="backup-btn-merge" onclick="confirmBackupAction('merge')">
                    ğŸ”€ åˆå¹¶ï¼ˆæ¨èï¼‰
                </button>
                <button type="button" class="backup-btn-cancel" onclick="confirmBackupAction('cancel')">
                    âŒ å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

        <!-- å†å²è®°å½•ï¼ˆæœ€è¿‘å®Œæˆï¼‰ -->
        <div class="section-history" style="margin-top:12px;">
            <details id="historyDetails">
               <summary><span style="font-size:0.95rem; font-weight:bold;">ğŸ“… å†å²è®°å½•ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰</span></summary>
                <div class="manual-content" id="historyContent">
                    <p style="font-size:0.8rem; color:#777;">
                        è¿™é‡Œä¼šæ±‡æ€»æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å®Œæˆè®°å½•ï¼Œä»…åœ¨ä½ æƒ³å›é¡¾æ—¶å†å±•å¼€æŸ¥çœ‹ã€‚
                    </p>
                </div>
            </details>
        </div>
    </div>

    <!-- ç”¨æˆ·æ‰‹å†Œ & æ•°æ®æ–¹èˆŸ -->
    <!-- 04 åŒºï¼šç»Ÿä¸€æ·¡ç´«åº•è‰² + 4 å¼ åŒç±»å¡ç‰‡ -->
    <div class="section-footer-area" id="sec04">
        <div class="section-title">04 Â· ç”¨æˆ·æ‰‹å†Œ & æ•°æ®æ–¹èˆŸ</div>

          <!-- â‘  ç”¨æˆ·æ‰‹å†Œ & é€»è¾‘è¯å…¸ï¼ˆé»˜è®¤æŠ˜å ï¼Œä¼˜åŒ–æ€§èƒ½ï¼‰ -->
        <div class="section-manual">
          <details>
            <summary>ğŸ“– ç”¨æˆ·æ‰‹å†Œ & é€»è¾‘è¯å…¸</summary>
            <div class="manual-content">

        <div class="manual-h3">ğŸš€ 3 åˆ†é’Ÿä¸Šæ‰‹ï¼ˆæŒ‰åŒºèµ°ä¸€éï¼‰</div>
        <ol style="margin-top:6px; padding-left:18px; line-height:1.65;">
          <li>
            <b> 02 Â· æ–°ä»»åŠ¡å…¥åº“ï¼š</b>
            æŠŠæ‰“ç®—åšçš„äº‹è¾“å…¥è¿›å»ï¼ˆå¯æ‰¹é‡è¾“å…¥ï¼‰ã€‚
            å¯é€‰ <span class="manual-tag">ğŸ·ï¸æ ‡ç­¾</span>ã€<span class="manual-tag">ğŸ“åœ°ç‚¹</span>ã€<span class="manual-tag">â³æ—¶é•¿</span>ï¼›
            <span class="manual-tag">ğŸ” æ¯æ—¥å¾ªç¯</span>ã€‚
          </li>
          <li>
            <b> 00 Â· åƒä¸€é¢—ç³–ï¼š</b>
            å…ˆåš 30 ç§’â€œè½»åŠ¨ä½œâ€ï¼ˆğŸ«§æ°”æ³¡ / ğŸ–ï¸æ¶‚é¸¦ / ğŸµéŸ³ä¹ç­‰ï¼‰ï¼Œä»åœæ»åˆ‡åˆ°å¯è¡ŒåŠ¨ã€‚
          </li>
          <li>
            <b> 01 Â· æŠ½ç­¾è£…ç½®ï¼š</b>
            ç‚¹å‡» <span class="manual-tag">ğŸ”® å¸®æˆ‘é€‰</span>æŠ½å–ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚
            æŠ½åˆ°ååªåšä¸€ä¸ªå†³å®šï¼š<span class="manual-tag">âœ… å®Œæˆ</span> / <span class="manual-tag">ğŸ” æ¢ä¸€ä¸ª</span>ã€‚
          </li>
          <li>
            <b>ï¼ˆå¯é€‰ï¼‰ğŸ“ è®°å¿†ï¼š</b>
            æŠ½åˆ°ç»“æœå¡å³ä¸Šè§’ç‚¹ <span class="manual-tag">ğŸ“ å¤‡æ³¨</span>ï¼Œè®°å½•ä¹¦ç­¾/æ—¶é•¿/åæ§½ï¼ˆä¸å¼ºåˆ¶å¡«ï¼‰ã€‚
          </li>
          <li>
            <b> 03 Â· ä»»åŠ¡åº“ & è®°å½•ï¼š</b>
            éœ€è¦æ‰‹åŠ¨å¤„ç†æ—¶ï¼Œåœ¨ <b>ä»»åŠ¡åº“/åª’ä½“åº“</b> ç‚¹å‡»ä»»åŠ¡åç§°ï¼Œä¼šå¼¹å‡º
            <span class="manual-tag">å®Œæˆ</span> /
            <span class="manual-tag">ä¿®æ”¹</span> /
            <span class="manual-tag">è®°å¿†</span>ã€‚
          </li>
          <li>
            <b> 04 Â· æ•°æ®æ–¹èˆŸï¼š</b>
            å®šæœŸ <span class="manual-tag">ğŸ“¥ å¯¼å‡º</span> å¤‡ä»½ï¼›æ¢è®¾å¤‡æˆ–è¯¯åˆ æ—¶ç”¨ <span class="manual-tag">ğŸ“¤ å¯¼å…¥</span> æ¢å¤ã€‚
          </li>
        </ol>
      
        <!-- é€»è¾‘è¯å…¸æ€»æŠ˜å ï¼šé‡Œé¢å†åˆ†æ¡ç›® -->
        <details style="margin-top:12px;">
          <summary><b>ğŸ“š é€»è¾‘è¯å…¸ï¼ˆç‚¹æˆ‘å±•å¼€ï¼‰</b></summary>
      
          <div style="margin-top:10px;">


            <details style="margin-top:8px;">
              <summary><b>ğŸ´ 01 Â· æŠ½ç­¾è£…ç½®ï¼ˆç­›é€‰ + æŠ½å¡ï¼‰</b></summary>
              <div style="margin-top:8px;">
                <ul style="margin-top:6px; line-height:1.7;">
                    <li><b><span class="manual-tag">â˜€ï¸ Uptimeï¼ˆæ¨è¿›ï¼‰</span>ï¼š</b> æ›´åâ€œæ¨è¿›ã€æ¸…å•ã€å…³é”®ä»»åŠ¡â€ã€‚é€šå¸¸ä¸ä¼šæ¨å‰§é›†/å”±ç‰‡/SOSï¼›å¦‚æœä½ æœ‰ <span class="manual-tag">ğŸ¸ é’è›™</span>ï¼Œä¼šæ˜æ˜¾æ›´ä¼˜å…ˆã€‚</li>
                    <li><b><span class="manual-tag">âš“ Anchorï¼ˆå‡è¡¡ï¼‰</span>ï¼š</b> æœ€â€œå…¬å¹³â€çš„æ··åˆæŠ½å–ï¼Œé€‚åˆå¤§å¤šæ•°æ—¶åˆ»ã€‚</li>
                    <li><b><span class="manual-tag">â˜ï¸ Downtimeï¼ˆä¼‘æ¯ï¼‰</span>ï¼š</b> æ›´åâ€œè½»æ¾ã€è¾“å…¥ã€æ¢å¤â€ã€‚é€šå¸¸ä¸ä¼šæ¨ <span class="manual-tag">ğŸ¸ é’è›™</span>ï¼›æ›´å®¹æ˜“å‡ºç°å‰§é›†/ç”µå½±/å”±ç‰‡ç­‰ã€‚</li>
                  <li>
                    <b><span class="manual-tag">ğŸ”½ é«˜çº§ç­›é€‰</span>ï¼š</b>
                    åªåœ¨ä½ æƒ³æ§åˆ¶å˜é‡æ—¶å†å¼€ï¼ˆé¿å…æŠŠæŠ½å¡å˜æˆå¡«å†™è¡¨æ ¼ï¼‰ã€‚
                  </li>
                </ul>
              </div>
            </details>
      
            <details style="margin-top:8px;">
              <summary><b>ğŸ“ è®°å¿†æ¨¡å—ï¼ˆä¹¦ç­¾ / æœ¬æ¬¡æŠ•å…¥ / è‡ªç”±å¤‡æ³¨ï¼‰</b></summary>
              <div style="margin-top:8px;">
                <p style="margin:0 0 6px 0; font-size:0.9rem;">
                  å…¥å£åªæœ‰ä¸¤ä¸ªï¼š<b>â‘  æŠ½å¡ç»“æœå¡å³ä¸Šè§’ã€ŒğŸ“ å¤‡æ³¨ã€</b>ï¼›<b>â‘¡ ä»»åŠ¡åº“/åª’ä½“åº“ç‚¹ä»»åŠ¡å â†’ã€ŒğŸ“ è®°å¿†ã€</b>ã€‚
                </p>
      
                <div style="margin-top:6px;">
                  <div style="font-weight:bold; margin-bottom:4px;">ä¸€ã€ğŸ“ä¹¦ç­¾è¿›åº¦ï¼ˆåæ ‡å‹ï¼Œè¦†ç›–æœ€æ–°ï¼‰</div>
                  <ul style="margin-top:4px; line-height:1.7;">
                    <li>é€‚åˆï¼šä¹¦é¡µæ•°ã€å‰§é›†é›†æ•°ã€ç”µå½±æ—¶é—´ç‚¹ã€‚</li>
                    <li>å†™æ³•ç¤ºä¾‹ï¼š<span class="manual-tag">P120</span> / <span class="manual-tag">S2E5</span> / <span class="manual-tag">00:42:10</span></li>
                    <li>è§„åˆ™ï¼šæ¯æ¬¡ä¿å­˜ä¼š<b>è¦†ç›–</b>ä¸Šä¸€æ¬¡ä¹¦ç­¾ï¼›ä¸‹æ¬¡æŠ½åˆ°è¯¥ä»»åŠ¡ï¼Œä¼šæç¤ºâ€œä¸Šæ¬¡è¿›åº¦â€ã€‚</li>
                  </ul>
      
                  <div style="font-weight:bold; margin:10px 0 4px 0;">äºŒã€â³æœ¬æ¬¡æŠ•å…¥æ—¶é•¿ï¼ˆç´¯ç§¯å‹ï¼ŒåŠ æ€»ï¼‰</div>
                  <ul style="margin-top:4px; line-height:1.7;">
                    <li>é€‚åˆï¼šç»ƒä¹ /å­¦ä¹ /é¡¹ç›®æ¨è¿›ç­‰â€œæŠ•å…¥è¶Šå¤šè¶Šæœ‰æˆå°±â€çš„äº‹ã€‚</li>
                    <li>ç”¨æ³•ï¼šåœ¨æ—¶é•¿é€‰æ‹©å™¨é‡Œé€‰ <span class="manual-tag">0h 45m</span> è¿™ç±»å€¼ï¼Œç„¶åä¿å­˜ã€‚</li>
                    <li>è§„åˆ™ï¼šæ¯æ¬¡ä¿å­˜éƒ½ä¼š<b>ç´¯ç§¯åˆ°æ€»æ—¶é•¿</b>ï¼›ç»“æœå¡ä¼šæ˜¾ç¤ºâ€œç´¯è®¡æ€»æ—¶é•¿â€ï¼ˆè‹¥ä½ å¼€å¯äº†æ˜¾ç¤ºï¼‰ã€‚</li>
                  </ul>
      
                  <div style="font-weight:bold; margin:10px 0 4px 0;">ä¸‰ã€ğŸ—’ï¸è‡ªç”±å¤‡æ³¨ï¼ˆä¸»è§‚å‹ï¼Œå¯å†™é“¾æ¥/è¯„ä»·/æé†’ï¼‰</div>
                  <ul style="margin-top:4px; line-height:1.7;">
                    <li>é€‚åˆï¼šåæ§½ã€å¤ç›˜ä¸€å¥è¯ã€ææ–™é“¾æ¥ã€ä¸‹æ¬¡æ€ä¹ˆç»§ç»­ã€‚</li>
                    <li>æ˜¾ç¤ºç­–ç•¥ï¼šåˆ—è¡¨åŒºä¸å±•å¼€ï¼ˆé¿å…æ‹¥æŒ¤ï¼‰ï¼›æŠ½åˆ°/ç‚¹è®°å¿†æ—¶å†çœ‹ã€‚</li>
                  </ul>
      
                  <p style="margin-top:8px; font-size:0.82rem; color:#777;">
                    è®¾è®¡åŸåˆ™ï¼šä¸å¼ºè¿«ä½ æ¯æ¬¡å¡«å†™ã€‚è®°å¿†åªåœ¨â€œä½ éœ€è¦ä¸Šä¸‹æ–‡æ—¶â€å‡ºç°ã€‚
                  </p>
                </div>
              </div>
            </details>
      
            <details style="margin-top:8px;">
              <summary><b>ğŸ—‚ï¸ 03 Â· ä»»åŠ¡åº“ / åª’ä½“åº“ï¼ˆå¦‚ä½•æ“ä½œä¸€æ¡ä»»åŠ¡ï¼‰</b></summary>
              <div style="margin-top:8px;">
                <ul style="margin-top:6px; line-height:1.7;">
                  <li><b>ç‚¹å‡»ä»»åŠ¡åç§°ï¼š</b>å¼¹å‡ºæ“ä½œèœå•ï¼ˆ<span class="manual-tag">âœ… å®Œæˆ</span> / <span class="manual-tag">âœï¸ ä¿®æ”¹</span> / <span class="manual-tag">ğŸ“ è®°å¿†</span>ï¼‰ã€‚</li>
                  <li><b>âœ… å®Œæˆï¼š</b>è¿›å…¥ <span class="manual-tag">ğŸ‘£ ä»Šæ—¥è¶³è¿¹</span> ä¸ <span class="manual-tag">ğŸ“… å†å²è®°å½•</span>ã€‚</li>
                  <li><b>âœï¸ ä¿®æ”¹ï¼š</b>æ”¹æ ‡é¢˜ã€æ ‡ç­¾ã€æ—¶é•¿ã€å¾ªç¯ç­‰ï¼ˆç”¨äºçº é”™ä¸ç»´æŠ¤ä»»åŠ¡åº“ï¼‰ã€‚</li>
                  <li><b>ğŸ“ è®°å¿†ï¼š</b>åŒæŠ½å¡é¡µçš„è®°å¿†é¢æ¿ï¼Œç”¨æ¥è¡¥è¿›åº¦/æ—¶é•¿/å¤‡æ³¨ã€‚</li>
                </ul>
              </div>
            </details>
      
            <details style="margin-top:8px;">
              <summary><b>âŒ¨ï¸ æ™ºèƒ½è¾“å…¥è¯å…¸ï¼ˆå°‘ç‚¹ç‚¹ç‚¹ï¼Œå¤šè¯´äººè¯ï¼‰</b></summary>
              <div style="margin-top:8px;">
                <p style="margin:0 0 6px 0;">
                  æ”¯æŒæ‰¹é‡ç²˜è´´ï¼š<b>æ¯è¡Œä¸€ä¸ªä»»åŠ¡</b>ã€‚ç³»ç»Ÿä¼šæ ¹æ®å…³é”®è¯è‡ªåŠ¨è¡¥æ ‡ç­¾/å»ºè®®æ—¶é•¿ç­‰ã€‚
                </p>
                <ul style="margin-top:6px; line-height:1.7;">
                  <li>
                    <b>ğŸ¬ğŸ“– ä¹¦å½±å‰§è‡ªåŠ¨å½’ç±»ï¼š</b>
                    ç”¨ <span class="manual-tag">çœ‹/è¯»/ä¹¦/å½±/å‰§/è¿½</span> å¼€å¤´ä¼šèµ°æ–‡åŒ–é€»è¾‘ï¼ˆè‡ªåŠ¨ä¹¦åå·ç­‰ï¼‰ã€‚
                  </li>
                  <li>
                    <b>âš¡ï¸ é€ŸåŠä»»åŠ¡ï¼š</b>
                    è¾“å…¥<span class="manual-tag">æ´—/åˆ·/ç†/æ‹†/æ‰”/å–</span>ç­‰ ï¼Œä¼šå»ºè®® <span class="manual-tag">âš¡ï¸ é€ŸåŠ</span>ï¼ˆ5m çº§åˆ«ï¼‰ã€‚
                  </li>
                  <li>
                    <b>ğŸ¸ é’è›™ä»»åŠ¡ï¼š</b>
                    ç”¨ <span class="manual-tag">*/!/é‡è¦ + ç©ºæ ¼</span> å¼€å¤´ï¼Œæ ‡è®°ä¸ºæ›´éš¾ä½†æ›´é‡è¦çš„ä¸€ç±»ï¼ˆæ›´å®¹æ˜“åœ¨ â˜€ï¸Uptime å‡ºç°ï¼‰ã€‚
                  </li>
                  <li>
                    <b>ğŸ” æ¯æ—¥å¾ªç¯ï¼š</b>
                    è¾“å…¥å« <span class="manual-tag">æ¯å¤©/æ¯æ—¥</span>ï¼Œè‡ªåŠ¨å¼€å¯å¾ªç¯ï¼ˆé€‚åˆä¹ æƒ¯/ä¿åº•ä»»åŠ¡ï¼‰ã€‚
                  </li>
                </ul>
                <p style="margin-top:6px; font-size:0.82rem; color:#777;">
                  å»ºè®®ï¼šå…ˆâ€œç²—ç³™å…¥åº“â€ï¼Œå†é æŠ½å¡æ¨è¿›ï¼›ä¸è¦åœ¨å…¥åº“é˜¶æ®µæŠŠè‡ªå·±å¡æ­»åœ¨å®Œç¾åˆ†ç±»ã€‚
                </p>
              </div>
            </details>
      
            <details style="margin-top:8px;">
              <summary><b>ğŸ§Š å†·åº“ï¼ˆæš‚æ—¶é€€åœºï¼Œä¸å†è¢«æŠ½åˆ°ï¼‰</b></summary>
              <div style="margin-top:8px;">
                <ul style="margin-top:6px; line-height:1.7;">
                  <li>é€‚åˆï¼šå½“å‰é˜¶æ®µä¸æƒ³ç¢°ã€ä½†åˆä¸èˆå¾—åˆ çš„ä»»åŠ¡ã€‚</li>
                  <li>è¿›å…¥å†·åº“åï¼šä¸ä¼šè¢«æŠ½åˆ°ï¼›ä½ å¯ä»¥åœ¨å†·åº“é‡Œ <span class="manual-tag">â™»ï¸ èµ¦å…å›åº“</span> æˆ– <span class="manual-tag">ğŸ—‘ï¸ å½»åº•åˆ é™¤</span>ã€‚</li>
                </ul>
              </div>
            </details>
      
            <details style="margin-top:8px;">
              <summary><b>ğŸ“… ä»Šæ—¥è¶³è¿¹ & å†å²è®°å½•ï¼ˆè®°å½•ä¼šæ˜¾ç¤ºä»€ä¹ˆï¼‰</b></summary>
              <div style="margin-top:8px;">
                <ul style="margin-top:6px; line-height:1.7;">
                  <li><b><span class="manual-tag">ğŸ‘£ ä»Šæ—¥è¶³è¿¹</span>ï¼š</b>åªä¿ç•™å½“å¤©å®Œæˆçš„æ¸…å•ï¼Œæ–¹ä¾¿â€œä»Šå¤©æˆ‘åšè¿‡ä»€ä¹ˆâ€ã€‚</li>
                  <li><b><span class="manual-tag">ğŸ† è£èª‰æ®¿å ‚</span>ï¼š</b> æ›´åâ€œæ°¸ä¹…é‡Œç¨‹ç¢‘â€ï¼šçœ‹å®Œ/è¯»å®Œ/è¿½å®Œçš„æ–‡åŒ–å†…å®¹ï¼Œä»¥åŠé‡è¦ä»»åŠ¡çš„å®Œæˆè®°å½•ä¼šæ²‰æ·€åœ¨è¿™é‡Œã€‚</li>
                  <li><b><span class="manual-tag">ğŸ“… å†å²è®°å½•</span>ï¼š</b>æŒ‰æ—¥æœŸæ±‡æ€»å®Œæˆè®°å½•ï¼Œé€‚åˆå›é¡¾ä¸å¤ç›˜ã€‚</li>
                  <li><b><span class="manual-tag">ğŸ“ è®°å¿†æ˜¾ç¤º</span></b>ï¼š</b>
                    å¦‚æœä½ åœ¨å®Œæˆ/æŠ½å¡æ—¶è®°å½•äº†ã€Œâ³æœ¬æ¬¡æ—¶é•¿ / ğŸ“ä¹¦ç­¾è¿›åº¦ / ğŸ—’ï¸å¤‡æ³¨ã€ï¼Œ
                    å†å²è®°å½•ä¼šæŠŠå®ƒä»¬è·Ÿåœ¨è¯¥æ¡ä»»åŠ¡åé¢ï¼ˆè¿‡é•¿ä¼šåªæ˜¾ç¤ºç¬¬ä¸€è¡Œ/æˆªæ–­ï¼‰ã€‚
                  </li>
                </ul>
                
              </div>
            </details>
      
            <details style="margin-top:8px;">
              <summary><b>ğŸŒ… èµ·é£ / ğŸŒ™ ç€é™† / ğŸ†˜ SOSï¼ˆä½é—¨æ§›é‡å¯ï¼‰</b></summary>
              <div style="margin-top:8px;">
                <ul style="margin-top:6px; line-height:1.7;">
                  <li><b><span class="manual-tag">ğŸŒ… èµ·åºŠèµ·é£</span>ï¼š</b>å¼€å§‹ä¸€å¤©/å¼€å§‹ä¸€æ®µå·¥ä½œæ—¶ï¼Œç”¨ä¸€å¥—å›ºå®šåŠ¨ä½œæŠŠçŠ¶æ€æ‹‰èµ·æ¥ã€‚</li>
                  <li><b><span class="manual-tag">ğŸŒ™ ç¡å‰ç€é™†</span>ï¼š</b>ç¡å‰æˆ–ç»“æŸæ—¶ï¼Œç”¨ä¸€å¥—å›ºå®šåŠ¨ä½œæŠŠå¤§è„‘æ…¢æ…¢å…³æœºã€‚</li>
                  <li><b>æ€ä¹ˆç¼–è¾‘ï¼š</b> é¡µé¢åº•éƒ¨æœ‰ <span class="manual-tag">ğŸ“ èµ·é£ / ç€é™†ä»ªå¼ç¼–è¾‘</span>ï¼Œæ¯è¡Œä¸€ä¸ªæ­¥éª¤ï¼›ç•™ç©ºä¼šè‡ªåŠ¨æ¢å¤é»˜è®¤æ¨¡æ¿ã€‚</li>
                  <li><b><span class="manual-tag">ğŸ†˜ SOS</span>ï¼š</b>åªç»™â€œæœ€å°åŠ¨ä½œâ€ï¼ˆå‘¼å¸/å–æ°´/ä¼¸å±•ç­‰ï¼‰ï¼Œç›®çš„æ˜¯æ­¢æŸä¸é‡å¯ï¼Œä¸æ˜¯é€¼ä½ é«˜å¼ºåº¦æ¨è¿›ã€‚</li>
                </ul>
              </div>
            </details>
      

            <details style="margin-top:8px;">
                <summary><b>ğŸ“Š è®¡æ•°å™¨ï¼šğŸ›¡ï¸ æ„å¿—åŠ› / âœ¨ å°ç¡®å¹¸</b></summary>
                <div style="margin-top:8px;">
                  <ul style="margin-top:6px; line-height:1.7;">
                        <li><b>ğŸ›¡ï¸ æ„å¿—åŠ›ï¼š</b> æƒ³åšåä¹ æƒ¯ä½†å¿ä½æ—¶ç‚¹ä¸€ä¸‹ï¼Œç»™â€œå…‹åˆ¶â€ç•™è¯æ®ã€‚</li>
                        <li><b>âœ¨ å°ç¡®å¹¸ï¼š</b> é‡åˆ°å¼€å¿ƒå°äº‹ç‚¹ä¸€ä¸‹ï¼Œç»™â€œå¥½äº‹â€ç•™è®°å·ã€‚</li>
                        <li><b>ç”¨æ³•å»ºè®®ï¼š</b> ä¸è¦å½“ KPIï¼›å®ƒæ›´åƒâ€œä½ åœ¨æ´»ç€â€çš„ä½æ‘©æ“¦è®°å½•ã€‚</li>
                      </ul>
                </div>
              </details>

            <details style="margin-top:10px;">
              <summary><b>ğŸ“¡ æ•°æ®æ–¹èˆŸï¼ˆå¤‡ä»½ / å¯¼å…¥ / å®¹é‡è¯´æ˜ï¼‰</b></summary>
              <div style="margin-top:8px;">
                <ul style="margin-top:6px; line-height:1.7;">
                  <li><b>å»ºè®®é¢‘ç‡ï¼š</b>æ¯å‘¨æˆ–æ¯æ¬¡å¤§ç‰ˆæœ¬æ›´æ–°å‰ï¼Œ<span class="manual-tag">ğŸ“¥ å¯¼å‡º</span> ä¸€æ¬¡å¤‡ä»½ï¼ˆJSONï¼‰ã€‚</li>
                  <li><b>æ¢è®¾å¤‡ / è¯¯åˆ ï¼š</b>ç”¨ <span class="manual-tag">ğŸ“¤ å¯¼å…¥</span> æ¢å¤ã€‚</li>
                  <li><b>å®¹é‡æç¤ºï¼š</b>æœ¬é¡¹ç›®æ•°æ®å­˜åœ¨æµè§ˆå™¨ localStorageï¼Œç©ºé—´æœ‰é™ï¼›å†å²è®°å½•è¶Šé•¿ã€å¤‡æ³¨è¶Šå¤šï¼Œå ç”¨è¶Šå¿«ã€‚</li>
                </ul>
                
              </div>
            </details>
      
          </div>
        </details>
      
      </div>
</details>
</div>

    <div class="section-updates">
        <details>
            <summary>ğŸ“‘ æ›´æ–°æ—¥å¿—</summary>
            <div class="manual-content">
                <ul>
                    <li><b>v5.1ï¼š</b> æ–°å¢æ‰­è›‹æœºæŠ½å¡åŠ¨ç”»ï¼ˆå…¶ä»–å½¢å¼é™†ç»­æ·»åŠ ä¸­ï¼‰ã€‚</li>
                    <li><b>v5.2ï¼š</b> åŠŸèƒ½åˆ†åŒºé‡æ–°è§„åˆ’ æ›´åŠ æ¸…æ™°æ˜äº†ã€‚</li>
                    <li><b>v5.3ï¼š</b> å¢åŠ â€œæ­£åœ¨è¿›è¡Œä¸­â€¦â€ï¼›å¢åŠ 30å¤©å†å²è®°å½•ï¼›æ·»åŠ é‡è¦ä»»åŠ¡æ—¶å¯ä»¥é€šè¿‡â€œ*â€/â€œ!â€/â€œé‡è¦â€åŠ ç©ºæ ¼ å¼€å¯ã€‚</li>
                    <li><b>v5.4ï¼š</b> å…³é”®è¯ä¿®è®¢ï¼šè¾“å…¥â€œçœ‹/å½±â€å¼€å¤´ï¼šè¯†åˆ«ä¸ºç”µå½±ï¼›â€œè¯»/ä¹¦â€å¼€å¤´ï¼šè¯†åˆ«ä¸ºä¹¦ç±ï¼›â€œè¿½/å‰§â€å¼€å¤´ï¼šè¯†åˆ«ä¸ºå‰§é›†ã€‚</li>
                    <li><b>v5.5ï¼š</b> å¢åŠ èµ·åºŠèµ·é£ä»ªå¼ & ç¡å‰ç€é™†ä»ªå¼ï¼ˆå¯è‡ªè¡Œç¼–è¾‘ï¼‰ï¼›å¢åŠ å†·åº“åŠŸèƒ½ï¼šä»»åŠ¡å°å­˜ï¼Œæš‚æ—¶ä¸è¢«æŠ½åˆ°ï¼ˆå¯æ¢å¤ï¼‰</li>
		    <li><b>v5.6ï¼š</b> ç‚¹å‡»ä»»åŠ¡åº“ & åª’ä½“åº“æˆ¿é‡Œçš„ä»»åŠ¡åç§°ï¼Œå¯å‹¾é€‰ç›´æ¥å®Œæˆã€‚</li>
 		    <li><b>v6.0ï¼š</b> å¢åŠ â€œåƒé¢—ç³–â€ï¼šæ°”æ³¡ç³–ï¼›æ¶‚é¸¦ç³–ï¼›æ¶‚è‰²ç³–ï¼›éŸ³ä¹ç³–ï¼›å¢åŠ æ¯æ—¥æ‰“å¡å›¾ã€‚</li>
                <li><b>v6.1ï¼š</b> å¢åŠ â€œçƒŸèŠ±/æ˜Ÿç©ºæ‹–å°¾ç³–â€ï¼šç‚¹å‡»/è§¦æ§ç»½æ”¾çš„å°äº’åŠ¨ï¼ŒçŸ­æš‚åœé åå›åˆ°æŠ½å¡ã€‚</li>
                    <li><b>v6.2ï¼š</b> å¢åŠ â€œä¹å™¨ç³–â€ï¼šKalimbaï¼ˆå¡æ—å·´ç´ï¼‰ï¼›Chord Padï¼ˆå’Œå¼¦å‡»å«ï¼‰ã€‚</li>
                 <li><b>v6.3ï¼š</b> 01 åŒºæŠ½å¡æ–°å¢ã€Œå¡”ç½—æ‘Šç‰Œæ¨¡å¼ã€ï¼Œä¸ç»å…¸æ‰­è›‹æ¨¡å¼éšæœºè½®æµå‡ºç°ã€‚</li>
                 <li><b>v6.4ï¼š</b> æ–°å¢èƒ½é‡ä¸¸åå¥½ç­›é€‰ï¼šUpé«˜èƒ½æ¨¡å¼ï¼ˆä¸å‡ºç°å‰§é›†ï¼‰ï¼›Anchoræ¨¡å¼ï¼›Downä¼‘æ¯æ—¶åˆ»ï¼ˆä¸å‡ºç°é‡è¦ğŸ¸ä»»åŠ¡ï¼‰ã€‚</li>
                 <li><b>v6.5ï¼š</b> æ–°å¢è®°å¿†åŠŸèƒ½ï¼šç‚¹å‡»ç»“æœå¡ç‰‡ğŸ“å¤‡æ³¨æˆ–ä»»åŠ¡åº“ & åª’ä½“åº“é‡Œçš„ä»»åŠ¡åç§°ï¼Œå¯æ‰“å¼€è®°å¿†é¢æ¿ï¼Œè®°å½•æœ¬æ¬¡ä»»åŠ¡çš„åæ ‡ã€æ—¶é•¿ä»¥åŠå¤‡æ³¨ã€‚</li>
</ul>
            </div>
        </details>
    </div>
    <!-- èµ·é£ & ç€é™†ä»ªå¼ç¼–è¾‘ -->
    <div class="section-settings">
        <details>
            <summary>ğŸ“ èµ·é£ / ç€é™†ä»ªå¼ç¼–è¾‘</summary>
            <div class="manual-content">
                <div style="font-size:0.8rem; color:#666; margin-bottom:6px;">
                    æ¯è¡Œä»£è¡¨ä¸€ä¸ªæ­¥éª¤ï¼Œå¯ä»¥ä¿®æ”¹ã€åˆ å‡æˆ–å¢åŠ ï¼›å¦‚æœå…¨éƒ¨ç•™ç©ºï¼Œä¼šè‡ªåŠ¨æ¢å¤é»˜è®¤æ¨¡æ¿ã€‚
                </div>

                <div style="font-size:0.8rem; font-weight:bold; margin:6px 0 4px;">
                    ğŸŒ… èµ·åºŠèµ·é£
                </div>
                <textarea id="ritualMorningInput"
                          placeholder="ä¾‹å¦‚ï¼š&#10;èµ·èº«ç¦»å¼€åºŠ&#10;æ‹‰å¼€çª—å¸˜ / å¼€ç¯&#10;å–ä¸€å£æ°´&#10;èµ°åˆ°ä¹¦æ¡Œ / å›ºå®šè§’è½"></textarea>

                <div style="font-size:0.8rem; font-weight:bold; margin:10px 0 4px;">
                    ğŸŒ™ ç¡å‰ç€é™†
                </div>
                <textarea id="ritualNightInput"
                          placeholder="ä¾‹å¦‚ï¼š&#10;æ‰‹æœºå……ç”µå¹¶è¿œç¦»åºŠè¾¹&#10;å–ä¸€å£æ°´ / åƒè¯&#10;å…³çª—å¸˜ / ç¯&#10;å†™ä¸€å¥â€œæ˜å¤©æƒ³åšçš„äº‹â€"></textarea>

                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button class="btn-file" style="flex:1;" type="button" onclick="saveRitualFromInputs()">
                        ğŸ’¾ ä¿å­˜ä»ªå¼
                    </button>
                    <button class="btn-outline" style="flex:1;" type="button" onclick="resetRitualToDefault()">
                        âœ¨ æ¢å¤é»˜è®¤
                    </button>
                </div>
            </div>
        </details>
    </div>

<!-- è®¾ç½® & å¤‡ä»½ -->
    <div class="section-settings" id="settingSec">
        <details>
            <summary>ğŸ“¡ æ•°æ®æ–¹èˆŸ (Offline)</summary>
            <div class="manual-content">
        <div style="font-size:0.8rem; color:#1565C0; margin-bottom:5px; font-weight:bold;">ğŸ“‚ æ–‡ä»¶å¤‡ä»½ (ç”µè„‘ç«¯æ¨è)</div>
        <div class="backup-grid">
            <button class="btn-file" onclick="exportToFile()">ğŸ“¥ å¯¼å‡ºæ–‡ä»¶</button>
            <button class="btn-file" onclick="triggerImport()">ğŸ“¤ å¯¼å…¥æ–‡ä»¶ (Merge)</button>
        </div>
        <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
        <div style="font-size:0.8rem; color:#666; margin-bottom:5px; font-weight:bold;">ğŸ“ æ–‡æœ¬æ“ä½œ (æ‰‹æœºç«¯)</div>
        <div class="backup-grid">
            <button class="btn-outline" onclick="copyToClip()">ğŸ“‹ å¤åˆ¶æ–‡æœ¬ç </button>
            <button class="btn-outline" onclick="document.getElementById('dataArea').value=''">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <textarea id="dataArea" class="setting-textarea" placeholder="åœ¨æ­¤é•¿æŒ‰ç²˜è´´æ•°æ®ä»£ç ..."></textarea>
        <button class="btn-file" style="width:100%; background:#E8F5E9; border-color:#A5D6A7; color:#2E7D32;" onclick="executeImport()">âœ… ç¡®è®¤å¯¼å…¥ (Merge)</button>
        <button class="btn-danger" onclick="tryResetAll()">ğŸ—‘ï¸ æ ¼å¼åŒ–/é‡ç½®æ‰€æœ‰æ•°æ®</button>
        <input type="file" id="fileInput" style="display:none" onchange="importFromFile(this)">
                </div>
        </details>
    </div>
        <div class="footer-note">
            æœ¬å·¥å…·ä»…åœ¨æœ¬æœºæµè§ˆå™¨å­˜å‚¨æ•°æ®ï¼Œä¸ä¸Šä¼ äº‘ç«¯ã€‚è¯·è®°å¾—ã€Œå¯¼å‡ºå¤‡ä»½ã€ã€‚<br>
            Anchor Â· by scc ğŸŒŠ
        </div>
    </div>
<script>
// ===== Anchor Variant Switch =====
// è§„åˆ™ï¼šanchor.dawnharbour.com => commonï¼›anchor-scc.dawnharbour.com => personal
function detectVariant() {
  const host = (location.hostname || '').toLowerCase();

  // å¯é€‰ï¼šç»™è‡ªå·±ç•™ä¸€ä¸ªæµ‹è¯•åé—¨
  const qs = new URLSearchParams(location.search);
  const forced = (qs.get('variant') || qs.get('mode') || '').toLowerCase();
  if (forced === 'common' || forced === 'personal') return forced;

  if (host.startsWith('anchor-scc.')) return 'personal';
  return 'common';
}

const APP_VARIANT = detectVariant();


    const sosLibrary = [
        { title: "å¤§å£å–æ°´", icon: "ğŸ’§", desc: "æ„Ÿå—æ°´æµç»è¿‡é£Ÿé“ã€‚" },
        { title: "çœ‹çª—å¤–è¿œæ–¹", icon: "ğŸ‘€", desc: "å¯»æ‰¾è§†é‡é‡Œæœ€è¿œçš„ä¸€æ£µæ ‘ã€‚" },
        { title: "4-7-8 å‘¼å¸", icon: "ğŸŒ¬ï¸", desc: "å¸æ°”4ç§’ï¼Œæ†‹æ°”7ç§’ï¼Œå‘¼æ°”8ç§’ã€‚" },
        { title: "å‹è…¿æ‹‰ä¼¸", icon: "ğŸ¦µ", desc: "æ‹‰ä¼¸å¤§è…¿åä¾§ã€‚" },
        { title: "äº”æ„Ÿç€é™†", icon: "ğŸ–ï¸", desc: "5æ ·çœ‹åˆ°çš„ï¼Œ4æ ·å¬åˆ°çš„ã€‚" },
        { title: "æ´—æŠŠè„¸", icon: "ğŸš¿", desc: "å†·æ°´æ³¼è„¸ï¼Œç‰©ç†é™æ¸©ã€‚" },
        { title: "åƒä¸€é¢—æ°´æœ", icon: "ğŸŠ", desc: "æ…¢æ…¢åƒï¼Œæ„Ÿå—é¦™æ°”ã€‚" }
    ];

    const KEY_DB = 'anchor_live_db';
    const KEY_ARCHIVE = 'anchor_live_archive';
    const KEY_LOG = 'anchor_live_log';
    const KEY_STATS = 'anchor_live_stats';
    const KEY_VISITED = 'anchor_has_visited_v55_personal';
    const KEY_RITUAL_MORNING = 'anchor_ritual_morning_v55';
    const KEY_RITUAL_NIGHT  = 'anchor_ritual_night_v55';


    const defaultDB = [
        { id: 1, title: "å¬ä¸€å¼ å–œæ¬¢çš„é»‘èƒ¶", type: "vinyl", desc: "éŸ³ä¹æ—¶é—´", time: 0 },
        { id: 2, title: "å–æ°´æœèŒ¶", type: "indoor", desc: "è¡¥å……ç»´C", time: 15 }
    ];

    let db = JSON.parse(localStorage.getItem(KEY_DB)) || [];
    let archive = JSON.parse(localStorage.getItem(KEY_ARCHIVE)) || [];
    let dailyLog = JSON.parse(localStorage.getItem(KEY_LOG)) || [];
    let userStats = JSON.parse(localStorage.getItem(KEY_STATS)) || { willpower: 0, joy: 0 };
            // ğŸŒ…ğŸŒ™ èµ·é£ / ç€é™†é»˜è®¤æ­¥éª¤ï¼ˆé»˜è®¤æ¨¡æ¿ï¼‰
    const ritualMorningDefault = [
        'èµ·èº«ç¦»å¼€åºŠ',
        'æ‹‰å¼€çª—å¸˜ / å¼€ç¯',
        'å–ä¸€å£æ°´',
        'èµ°åˆ°ä¹¦æ¡Œ / å›ºå®šè§’è½'
    ];

    const ritualNightDefault = [
        'æ‰‹æœºå……ç”µå¹¶è¿œç¦»åºŠè¾¹',
        'å–ä¸€å£æ°´ / åƒè¯',
        'å…³çª—å¸˜ / ç¯',
        'å†™ä¸€å¥â€œæ˜å¤©æƒ³åšçš„äº‹â€'
    ];

    // å½“å‰å®é™…ä½¿ç”¨çš„æ­¥éª¤æ•°ç»„ï¼ˆå…è®¸è¢«ç”¨æˆ·è‡ªå®šä¹‰è¦†ç›–ï¼‰
    let ritualMorningSteps = ritualMorningDefault.slice();
    let ritualNightSteps   = ritualNightDefault.slice();

    let currentRitualType = null; // 'morning' | 'night'
    
    let recentHistory = [];
    // å†·åº“æ“ä½œå¼¹çª—ï¼šå½“å‰è¦å¤„ç†å“ªä¸€æ¡ä»»åŠ¡
    let pendingColdId = null;
    // å¤‡ä»½å¯¼å…¥ï¼šå¾…å¯¼å…¥çš„æ•°æ®
    let pendingImportData = null;

    function loadRitualSettings() {
        try {
            const storedMorning = localStorage.getItem(KEY_RITUAL_MORNING);
            const storedNight   = localStorage.getItem(KEY_RITUAL_NIGHT);

            if (storedMorning) {
                const parsed = JSON.parse(storedMorning);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    ritualMorningSteps = parsed;
                }
            }
            if (storedNight) {
                const parsed = JSON.parse(storedNight);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    ritualNightSteps = parsed;
                }
            }
        } catch (e) {
            console.warn('åŠ è½½ä»ªå¼è®¾ç½®å‡ºé”™', e);
        }
    }

    let mode = 'normal';
    // v6.4 èƒ½é‡æ¨¡å¼ï¼š'uptime' | 'anchor' | 'downtime'
    // v6.5ï¼šæ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½é‡ç½®ä¸º anchor ä¸­é—´æ¡£
    let energyMode = 'anchor';
    let currentTask = null;
    let currentStatus = 'idle';
    let anchorStartTime = null;
    let switchState = { cycle: false, flash: false };
    let gachaAnimating = false;
    // v6.4 æŠ½å±‰å±•å¼€çŠ¶æ€
    let filterDrawerExpanded = false;
    // æ ‡è®°æœ¬æ¬¡æ‰“å¼€è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦å·²ç»â€œåƒè¿‡ç³–â€ï¼ˆåªæ˜¯æ§åˆ¶æŒ‰é’®å˜æ·¡ï¼Œä¸å½“ä½œä»»åŠ¡ï¼‰
    let candyEatenThisSession = false;
// è®°å½•ä¸Šä¸€æ¬¡æŠ½åˆ°çš„æ˜¯å“ªä¸€é¢—ç³–ï¼ˆbubble / doodle / å°†æ¥ coloring / music ç­‰ï¼‰
let lastCandyType = null;
// æ¶‚è‰²ç³–ç”¨çš„çº¿ç¨¿åº•å›¾
const coloringBgImg = new Image();
let coloringBgImgLoaded = false;

// ç›¸å¯¹è·¯å¾„ï¼šå’Œå½“å‰ HTML åœ¨åŒä¸€ç›®å½•çš„ coloring_bg.png
coloringBgImg.src = '/assets/images/coloring_bg.png';
coloringBgImg.onload = function () {
    coloringBgImgLoaded = true;
};

// ç³–å®¶æ—é…ç½®ï¼šå…ˆåªå¯ç”¨å·²ç»åšå¥½çš„ä¸¤é¢—ç³–
// ä»¥åå¯ä»¥åœ¨è¿™é‡ŒåŠ ï¼šmusic / instrument / web / movie / joke ç­‰
const CANDY_FAMILIES = [
    {
        id: 'draw',              // ç»˜ç”»ç±»ç³–
        weight: 1,               // è¿™ä¸€å®¶æ—å  1 ä»½æƒé‡
        variants: ['doodle', 'doodle', 'coloring']     // ç»˜ç”»å®¶æ—ï¼šæ¶‚é¸¦ç³– + æ¶‚è‰²ç³–
    },
    {
        id: 'tactile',           // è§¦è§‰ç±»ç³–
        weight: 1,
        variants: ['bubble']     // å·²ç»å®ç°ï¼šææ°”æ³¡ç³–
    },
    {
        id: 'audio',             // éŸ³é¢‘ç±»ç³–ï¼ˆéŸ³ä¹ç³–ã€ä¹å™¨ç³–ï¼‰
        weight: 1,
        variants: ['music', 'instrument']      // v6.2ï¼šåŠ å…¥ä¹å™¨ç³–ï¼ˆé»˜è®¤ Kalimbaï¼‰
    },
    {
        id: 'visual',            // è§†è§‰äº’åŠ¨ç±»ç³–ï¼ˆçƒŸèŠ± / æ˜Ÿç©ºç­‰ï¼‰
        weight: 1,
        variants: ['fireworks']
    }
    // é¢„ç•™ä½ï¼ˆå°†æ¥è¦ç”¨ï¼‰ï¼š
    // {
    //   id: 'explore',
    //   weight: 1,
    //   variants: ['tetris', 'webtoy']
    // },
];

// Anchor å¯åŠ¨æ­Œå•ï¼ˆBç«™æ’­æ”¾åˆ—è¡¨ï¼‰
const MUSIC_CLIPS = [
    {
        title: 'ã€Šè¿™æ¡å°é±¼åœ¨ä¹ã€‹ç‹OK / æ´ªä½©ç‘œ',
        bvid: 'BV1yr421j7vr'
    },
{
  title: 'ã€Šå¤šè¿œéƒ½è¦åœ¨ä¸€èµ·ã€‹â€”â€” ç‹æ©¹æ°ï¼ˆsnnå®šåˆ¶ğŸ¬ï¼‰',
  bvid: 'BV1jTmMBqE4N'
},
    {
        title: 'ã€ŠRealityã€‹- 1980 å¹´å† å†›å•æ›²',
        bvid: 'BV1hr4y1v7k3'
    },
    {
        title: 'ã€ŠYoung And Beautifulã€‹- ç”µå½±ã€Šäº†ä¸èµ·çš„ç›–èŒ¨æ¯”ã€‹æ’æ›²',
        bvid: 'BV1jX4y1474a'
    },
    {
        title: 'ã€Šæˆ‘å¾ˆå¿«ä¹ã€‹- åˆ˜æƒœå› Â· å˜´ç¡¬ä¹‹æ­Œ',
        bvid: 'BV1L8411C7Ga'
    },
    {
        title: 'ã€Šå¥‡å¦™èƒ½åŠ›æ­Œã€‹- é™ˆç²’ Â· 4K Hi-Res ç‰ˆ',
        bvid: 'BV1ncygBBEcK'
    },
    {
        title: 'ã€Šæ°´æ˜Ÿè®°ã€‹- éƒ­é¡¶ Â· â€œè¿˜è¦å¤šè¿œæ‰èƒ½è¿›å…¥ä½ çš„å¿ƒâ€',
        bvid: 'BV1JeYYevEnd'
    },
    {
        title: 'ã€ŠMystery of Loveã€‹- ç”µå½±ã€Šè¯·ä»¥ä½ çš„åå­—å‘¼å”¤æˆ‘ã€‹æ’æ›²',
        bvid: 'BV1Au4y1o73t'
    },
    {
        title: 'ã€ŠTry Everythingã€‹- ç”µå½±ã€Šç–¯ç‹‚åŠ¨ç‰©åŸã€‹ä¸»é¢˜æ›²',
        bvid: 'BV1hz4y1D7JP'
    },
    {
        title: 'ã€ŠCalifornia Dreamingã€‹ç»å…¸è€æ­Œ',
        bvid: 'BV1U64y1L7x5'
    },
    {
        title: 'ã€Šæˆ‘è¦ä½ ã€‹- ä»»ç´ æ± Â· ç”µå½±ã€Šé©´å¾—æ°´ã€‹ä¸»é¢˜æ›²',
        bvid: 'BV1VY411J7cf'
    },
    {
        title: 'ã€ŠCity of Starsã€‹- ç”µå½±ã€Šçˆ±ä¹ä¹‹åŸã€‹ä¸»é¢˜æ›² MV',
        bvid: 'BV1Q4411A7Q6'
    },
	{
  title: 'æ—¥æ¨æ­Œå•ï½œâ€œååä½ å¿½ç•¥äº†æˆ‘çš„çˆ±â€ï½œã€ŠBeanieã€‹',
  bvid: 'BV1aRpqe3E7v'
},
{
  title: '4Kçè—ï½œéƒå¯å”¯ã€Šå»æœ‰é£çš„åœ°æ–¹ã€‹ä¸»é¢˜æ›²',
  bvid: 'BV1p14y137HP'
},
{
  title: '10CM - æ˜¥é›ªã€ŠèƒŒç€å–„å®°è·‘ã€‹OSTï½œCause I\'m falling slowly love with you',
  bvid: 'BV1nE421G73Q'
},
{
  title: 'ã€4Kä¿®å¤ã€‘å¾å°å‡¤ã€Šå¿ƒæ‹ã€‹90å¹´ä»£æ¼”å‡ºç°åœº',
  bvid: 'BV1z94y117A2'
},
{
  title: 'ã€Šå¤±æ‹é˜µçº¿è”ç›Ÿã€‹è‰èœ¢ MV 1080P 60FPSï¼ˆLDé‡‡é›†ï¼‰',
  bvid: 'BV1TL4y1E7dA'
},
{
  title: 'è´¾æ¨ŸæŸ¯ç”µå½±æ’æ›²ï¼šGo West - Pet Shop Boys',
  bvid: 'BV1mV411M7ic'
},
{
  title: 'ã€ç™½é›ªå…¬ä¸»OSTã€‘Heigh-Ho',
  bvid: 'BV1kW411G7Au'
},
{
  title: 'JVKE - golden hourï¼ˆæ— æŸéŸ³è´¨ 4K60 ä¸­è‹±å­—å¹•ï¼‰',
  bvid: 'BV1GV4y1c7nZ'
},
{
  title: 'ã€æ— æŸéŸ³è´¨ã€‘é™ˆç»®è´ - æˆ‘å–œæ¬¢ä¸Šä½ æ—¶çš„å†…å¿ƒæ´»åŠ¨',
  bvid: 'BV1PD4y1w72A'
},
    {
        title: 'ã€ŠAnother Day of Sunã€‹- ç”µå½±ã€Šçˆ±ä¹ä¹‹åŸã€‹å¼€åœºæ›² 4K 60FPS',
        bvid: 'BV14knez5E4x'
    }
];
// æ¯æ—¥æ‰“å¡å›¾å›¾åº“ï¼ˆä¼˜åŒ–ï¼šæ·»åŠ é¢„åŠ è½½æœºåˆ¶ï¼‰
const DAILY_POSTER_IMAGES = [
    '/assets/images/daily_posters/poster01.jpg',
    '/assets/images/daily_posters/poster02.jpg',
    '/assets/images/daily_posters/poster03.jpg',
    '/assets/images/daily_posters/poster04.jpg',
    '/assets/images/daily_posters/poster05.jpg',
    '/assets/images/daily_posters/poster06.jpg',
    '/assets/images/daily_posters/poster07.jpg',
    '/assets/images/daily_posters/poster08.jpg',
    '/assets/images/daily_posters/poster09.jpg',
    '/assets/images/daily_posters/poster10.jpg',
    '/assets/images/daily_posters/poster11.jpg',
    '/assets/images/daily_posters/poster12.jpg',
    '/assets/images/daily_posters/poster13.jpg',
    '/assets/images/daily_posters/poster14.jpg',
    '/assets/images/daily_posters/poster15.jpg',
    '/assets/images/daily_posters/poster16.jpg',
    '/assets/images/daily_posters/poster17.jpg',
    '/assets/images/daily_posters/poster18.jpg',
    '/assets/images/daily_posters/poster19.jpg',
    '/assets/images/daily_posters/poster20.jpg',
    '/assets/images/daily_posters/poster21.jpg',
    '/assets/images/daily_posters/poster22.jpg',
    '/assets/images/daily_posters/poster23.jpg',
    '/assets/images/daily_posters/poster24.jpg',
    '/assets/images/daily_posters/poster25.jpg',
    '/assets/images/daily_posters/poster26.jpg',
    '/assets/images/daily_posters/poster27.jpg',
    '/assets/images/daily_posters/poster28.jpg',
    '/assets/images/daily_posters/poster29.jpg',
    '/assets/images/daily_posters/poster30.jpg',
    '/assets/images/daily_posters/poster31.jpg',
    '/assets/images/daily_posters/poster32.jpg',
    '/assets/images/daily_posters/poster33.jpg',
    '/assets/images/daily_posters/poster34.jpg',
    '/assets/images/daily_posters/poster35.jpg',
    '/assets/images/daily_posters/poster36.jpg',
    '/assets/images/daily_posters/poster37.jpg',
    '/assets/images/daily_posters/poster38.jpg',
    '/assets/images/daily_posters/poster39.jpg',
    '/assets/images/daily_posters/poster40.jpg',
    '/assets/images/daily_posters/poster41.jpg',
    '/assets/images/daily_posters/poster42.jpg',
    '/assets/images/daily_posters/poster43.jpg',
    '/assets/images/daily_posters/poster44.jpg',
    '/assets/images/daily_posters/poster45.jpg',
    '/assets/images/daily_posters/poster46.jpg',
    '/assets/images/daily_posters/poster47.jpg',
    '/assets/images/daily_posters/poster48.jpg',
    '/assets/images/daily_posters/poster49.jpg',
    '/assets/images/daily_posters/poster50.jpg',
    '/assets/images/daily_posters/poster51.jpg',
    '/assets/images/daily_posters/poster52.jpg',
    '/assets/images/daily_posters/poster53.jpg',
    '/assets/images/daily_posters/poster54.jpg',
    '/assets/images/daily_posters/poster55.jpg',
    '/assets/images/daily_posters/poster56.jpg',
    '/assets/images/daily_posters/poster57.jpg',
    '/assets/images/daily_posters/poster58.jpg',
    '/assets/images/daily_posters/poster59.jpg',
    '/assets/images/daily_posters/poster60.jpg',
    '/assets/images/daily_posters/poster61.jpg',
    '/assets/images/daily_posters/poster62.jpg',
    '/assets/images/daily_posters/poster63.jpg',
    '/assets/images/daily_posters/poster64.jpg',
    '/assets/images/daily_posters/poster65.jpg',
    '/assets/images/daily_posters/poster66.jpg',
    '/assets/images/daily_posters/poster67.jpg',
    '/assets/images/daily_posters/poster68.jpg',
    '/assets/images/daily_posters/poster69.jpg',
    '/assets/images/daily_posters/poster70.jpg',
    '/assets/images/daily_posters/poster71.jpg',
    '/assets/images/daily_posters/poster72.jpg',
    '/assets/images/daily_posters/poster73.jpg',
    '/assets/images/daily_posters/poster74.jpg',
    '/assets/images/daily_posters/poster75.jpg',
    '/assets/images/daily_posters/poster76.jpg',
    '/assets/images/daily_posters/poster77.jpg',
    '/assets/images/daily_posters/poster78.jpg',
    '/assets/images/daily_posters/poster79.jpg',
    '/assets/images/daily_posters/poster80.jpg',
    '/assets/images/daily_posters/poster81.jpg',
    '/assets/images/daily_posters/poster82.jpg',
    '/assets/images/daily_posters/poster83.jpg',
    '/assets/images/daily_posters/poster84.jpg',
    '/assets/images/daily_posters/poster85.jpg',
    '/assets/images/daily_posters/poster86.jpg',
    '/assets/images/daily_posters/poster87.jpg',
    '/assets/images/daily_posters/poster88.jpg',
    '/assets/images/daily_posters/poster89.jpg',
    '/assets/images/daily_posters/poster90.jpg',
    '/assets/images/daily_posters/poster91.jpg',
    '/assets/images/daily_posters/poster92.jpg',
    '/assets/images/daily_posters/poster93.jpg',
    '/assets/images/daily_posters/poster94.jpg',
    '/assets/images/daily_posters/poster95.jpg',
    '/assets/images/daily_posters/poster96.jpg',
    '/assets/images/daily_posters/poster97.jpg'
];

// é¢„åŠ è½½æ‰“å¡å›¾ï¼ˆåœ¨é¡µé¢åŠ è½½æ—¶æå‰åŠ è½½ï¼Œé¿å…æ˜¾ç¤ºæ—¶æ‰å¼€å§‹åŠ è½½ï¼‰
// ä½¿ç”¨ Map è®°å½•æ¯ä¸ªå›¾ç‰‡çš„åŠ è½½çŠ¶æ€
const posterLoadCache = new Map();

function preloadDailyPosters() {
    DAILY_POSTER_IMAGES.forEach(url => {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç¼“å­˜ä¸­
        if (posterLoadCache.has(url)) {
            return; // å·²ç»åŠ è½½è¿‡ï¼Œè·³è¿‡
        }
        
        const img = new Image();
        const loadPromise = new Promise((resolve, reject) => {
            img.onload = () => {
                posterLoadCache.set(url, { loaded: true, img: img });
                resolve(img);
            };
            img.onerror = () => {
                posterLoadCache.set(url, { loaded: false, error: true });
                reject(new Error('Failed to load: ' + url));
            };
        });
        
        // å¼€å§‹åŠ è½½
        img.src = url;
        posterLoadCache.set(url, { loading: true, promise: loadPromise });
    });
}

// æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²åŠ è½½å®Œæˆï¼ˆä»ç¼“å­˜æˆ–é‡æ–°åŠ è½½ï¼‰
function ensurePosterLoaded(imageUrl) {
    return new Promise((resolve, reject) => {
        // å…ˆæ£€æŸ¥ç¼“å­˜
        const cached = posterLoadCache.get(imageUrl);
        
        if (cached && cached.loaded && cached.img) {
            // å·²ç»åœ¨ç¼“å­˜ä¸­ä¸”åŠ è½½å®Œæˆ
            resolve(cached.img);
            return;
        }
        
        if (cached && cached.loading && cached.promise) {
            // æ­£åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾…å®Œæˆ
            cached.promise.then(resolve).catch(reject);
            return;
        }
        
        // ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå¼€å§‹åŠ è½½
        const img = new Image();
        img.onload = () => {
            posterLoadCache.set(imageUrl, { loaded: true, img: img });
            resolve(img);
        };
        img.onerror = () => {
            posterLoadCache.set(imageUrl, { loaded: false, error: true });
            reject(new Error('Failed to load: ' + imageUrl));
        };
        img.src = imageUrl;
    });
}

// æ”¶é›†æ‰€æœ‰å½“å‰å¯ç”¨çš„ç³–ç±»å‹ï¼ˆå»é‡ï¼‰ï¼šç”¨äºâ€œè¿ç»­ä¸¤æ¬¡ä¸èƒ½ä¸€æ ·â€çš„å…œåº•é€»è¾‘
function getAllCandyTypes() {
    const all = [];
    CANDY_FAMILIES.forEach(f => {
        if (Array.isArray(f.variants)) {
            f.variants.forEach(v => {
                if (!all.includes(v)) {
                    all.push(v);
                }
            });
        }
    }, { passive: false });
    return all;
}
// ææ°”æ³¡ç”¨çš„éŸ³æ•ˆï¼šä½¿ç”¨ä¸€æ®µå¤–éƒ¨éŸ³é¢‘æ–‡ä»¶ï¼ˆå…¼å®¹ iOS Safari + ä¸»å±å¹•æ¨¡å¼ï¼‰
const BUBBLE_POP_URL = '/assets/audio/bubble-pop-short.mp3';
const FIREWORK_POP_URL = '/assets/audio/firework-pop.wav';
const STAR_SHINE_URL  = '/assets/audio/star-shinning.mp3'; // å’Œ index.html åŒç›®å½•
const BUBBLE_POP_FALLBACK_DATA = 'data:audio/wav;base64,UklGRl4RAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YToRAADgCvgQzhm/JWQ0mD1iPu9Br0eNXGxgY2GEaE1t225ldGp1onyYeXN6v30Le5h/hXwqcIBv1m38bNxgyF91WcpSdUpHSCY+2ixgKAMkyxVmCygDDf/19J3tUue02eTQ5MGYwJK5Z7IHpsGcwppjmXSWYZlAkYKSnpBFjEyQPY1ljTCSdJEgl5iX+aFbo/qqPrWTsNC55skGzarZfeH+6fXyw/bZ/BwJDhd/HhAgEy54MDA82UV2Sx5IZlhZXBVgiWT5aVxlX287amBzXG3Ha/FsL2E8Zm5Zx2EZX+xTaEoBRWhAaDRDJ/Urvh/CG1QNBALC/PTzgOvx46Dc+M3W0XjIrL/qtF60b65Hp5ehxp+toXGcR56slhGcnpwOnQecUJ+soQqnxql+tUm6WMTLx5zHhtRj21Hf6uqn9Ir+dQPkDHQXIyH/KqEzsTTnNso/jENHTcZRYk/NW8hcDlzKYeZguF8VZIldxF2gV7dW6E67T39HZD6UP0Y31i4iMHofbhhKB+YOdAFZ+UbklOWK3U7WUdQEz0DCS70DuvK3grM9qi2om6W+pO2g6aY6o+KlVatMqtOvCK/xuGPBzcK7yY7OpdXj2oDlJ/By84H6pQNFCrIXqhvtJP4sNTNyNjs+5EOBSHdLwFGsT9pPYlOKVYNW01Y6VchVvlFpToxHj0pcO049kDNYLeYmXCDNFhkNdQmhAAP3ivX85zjjRd3L04LMPsyawjG6PLuGurCwwawirmatA6wJtkax/rTits+1Wby3wXTDFsvVzRvXndyc54jn9/SO+KoBHgdEDPwWgR7/IkkslDBYMuA8Sj6bQ7pF7UtjTiBMWk6gSUtNd0htSOZGcUAjPYc+ojRNM4knxSFgGxAVFQoTBm/90vNC8avn0uVL4L/Sa9TqzGvJ3sMKv3G7ebmRuZy0y7bhtrS2lbsCvBTBAcgGyjXNCdF31HveG+FV7LPwPvj6AVIGQQ17EksbMyJDKgkp4zO1M/w+mjyARCJGKEYOQaZGi0jhQe1CVUFHPww6wzW6MRUv0yEpHkYWvw4DDEcKef9T9/ryPevj4nje2dRf0hrL7cnfxRvCyMCgxQG8nb6QvRTAg76Qv0LEH8pwyfPP09W52rzh7elW7c32qvzDBbQF6A5CF0QdpCJeKFsuHTN6NIU3xDhvQAo+A0E/Ppg7yz7POog4/jgTNB4utSd0JAseJhouE4MLQAcLATb4GPMG7yznmd5e2/rR+dKBzdrKEMuAxX3EJcVHwT7ERMTyxz3KPc0L0+zT2dje3z3imekR8Fn0t/v1AwgIOQ7BFxAdxh8MJe0nmywUMpIz3zTxOKs28zrnORk6gjtdM0YzqS2dKQMk6SEnG3UXAQ7UCRQEvPo7+a/ymeyu5p7kUtyo1enQS9JuzNHM78kxyBLJU8YVynrM9s8k02vXZ9aX343gNOak7RDzMvvm/d4BVQi6DgkUthzcIc0kHSvsKboq1TGgM7M12DT7NEwzETa2Ms4uWywVJX0kDyBOGeQVVg/jBkAEffvZ9jPyUe2N503gdd2d2YHW1dPM0S7NP87pzerLM9B+zdjQI9MY2YPddN+04Ezn5+6o9ev79PxgAtMKCBF0Fnoa6B4iIaklfysGL0op8jHSL+gt4i5hLhstUCtMJsskBB/GHK4XxRGBDvsFqwTg+mf3VPFq6WznoeIG4a3afthj1XvTkNNQ0dbQX8/C0tLSCtZS2ZLfP+Ha5STqhe9W9pv6IP8uBI0JGA0cFBoYOhzuH1Qh1yYyKAoqqyxxLTkuvCwpLMUpzygAI8Ae2xxbGAoQ6QwrCr4BT/0899v0Se897Ijnt+Ks3r/dbdkh16bU3tdA1CDTD9VD1+nbZd7N4ufkw+ca79zxsfaL/FICmQZNCrQOwhSvGsUdqyENJbcmgSdoKcooMScsKBMojCNbImEhUxsmF0ITURDhDR0J+wJH/9f4qPNf7gXp3+TF5DDg1NyC3Z/Xsdhv2GzXktlv2a7b0N/k4s/nKuvn7xn1+Pl1++T/uwfDCh0PiBVdF+8ZViCCIfAjpyR+JlUnaiXUIcIk9iJWHdwbhRY6FA0RtAxECOIByfzx+DX1QPBN64/pc+Ru4lDh99yR3JzbyNxV2fjb1Nwn4JjioOWC7PDtX/G49uz6v/4kA4kIggvTDxAUkxdNG+0cyB+UIkkiYyJtIiYj4yDxIFIbgxqtFswRzBDsDB4GsQM1/nb6j/Yd8OvsyOmA5tXkqeGh4Kze29wD31HepOHK4kzjueZ86abstvJV9KX43vzKAjMGggqrDh0TtRSsGMEYqxtoHvIfwCBiIFwetx6lHqMbUhnsFBER3Q1DCjcIbQMg/nn6G/Up8nLuB+sQ59flseKz4GPi6eD24eDhv+T95SznJexA7s7v3vMV+Df9kwG4BHcHdA3LEd8SaRVGGOcaERyxHHkfzx2ZHYkbHxoTGEQVoRNRDwwKfwkLBNr/L/v/99fzRvIH7Y7qhue95WnkUeMO5ZrjZ+Nj5J/m/OdD68fuvu+89DT5tPyo/6IDVggtDM0O9hDiFT8X3xhcGTAdihy7HPcbnBnHFxgVVhJ2EFYM/gkmB98B9P5p+n/3UfNx8ePt8Oms58XmK+Zl5KHliuXf5ojoper36gPujfEQ9er4xfuI/wUFXgZRCpYNAA8DFI4WpBdRGXAZyRkwGdUaRxgCF1MTvhFADoML4QeDA5AApv1I+U71e/JO73vtruq46RjnIuck5hXoUufq6BLqMO1z70bzJfXU9hb8y/9oAjEGogl0DcUPoxH8FUcWPBddFzoZ6xi7FqEWjBOJEzgOeg0FC2YF7gNk/xT9Bvoz9TLzDO/b7ZXs9uqp6N3orOdx6Yzp0up37uXv0fBd9X/3fvq2/s4BJAQJCKkLHg5vEFgSsRTJFEoWaxbHFs8TJBYaEzsQjA7YCvAHyQUMAiIAGf2a9yb2QfOj8LPsr+xI6vzq3OlX6+nqvusz7Rrv0vD+88L3EPk4/b7/tAVPBywIJA0dD3MQGhK5EwYVPhW7FFkUIBNxEtUPlg1LC/4IxwUzAjD+BvxN+f/0j/Td8NzveO2E647sOevX693sQe4L77LwdPOS9rL5p/to/tQBhAT0BbsJsQxmD/wQIRHnEfMTMhPaE1gSWhGqDwYN/Qp+CdEGsAKT/478EvnZ9iL1evEf8VHvMe0e7SvtQ+0t7tbu/e/P8qv0qfam+Mn71P7OAeMEuAf1Co8MTA4SEM8QmBIlE44ShRIeEXUPJQ31C54KqwaaBFkBef7J/HP4V/Yu83/yMPHT7/3uj+1m7R7vV+/R8CfzVPQo9k/5qfoG/xoBMgSNBp4IIgsfDS0OihA/EcIRMhDdEeYQ3A49DFkLAQgYBYUDkQBG/iz8Kvjh9R70SvKU8FXv5O/177HuPfCO8X7xQPTW9b/3/vpm/D8AFAJfBRQIhgp7DMgMag/8D7gPnQ/AENYORA0nDIoK4giFBbUDiwHN/pX8g/l89w71NfOy8d7woO8E8LTv8/AE8gbzv/Sv9qX44/tC/fT/3AKOBToHZAkcCxMN3g6HD84Pfw/EDvYNIwyoCoEJ5AdeBdYCQAAc/tH7wvjk9670vfTR8Vnx4vD48HPx9fFX81310/XB+aj7xf2k//MCTgTfBocIngriCxINOw42D/IOLg08DX0LLAuXCEQHPQWIAqgA6P0h+/b4jvda9VH0BfP28Eby0vFk8gXzDvRH9g74kfkn/KX+ZQDjAqAEhAaNCFoKHQwcDXENGg4mDYQMjQyFCnkIFAcyBbICHQE3/mz83vlS+Hf2mPUD9G/zEPLo8rnyyvOA9bn2efj9+dX7/v2zAPsCEwSPBq0I5AkoCzcM0ww1DRYNHQx/CiEKMwisBsoEVwK8APP9Z/xI+c73UvYN9kH0kPNI81jz4PNG9SH2Wvj++Ib78vwPAJ0BVgOGBWYHXgkeCqMKZAvQDJMM2AvgCgIKwAifBrsEKQMqAZT/S/yS+uT4CvfX9Zf0FfVz9Jz0m/Rp9cX2kvdF+Xb7G/0b/6UBxgIjBd8GkghECuQKiwtYC34LdgtSCr4I7wd3BusEBQJgAID+Svym+u34oveQ9hf1/vTN9PT08PWF9vX3uviv+nv8Gf5wAEgCogMjBfwGPwmTCXQKIgvaCsUKKAoQCdYHcAYJBEcDRAHo/hb9/fvQ+Fn4Q/fT9Rr1jfWL9RH23/bH96j4dfox/K3+XwBXAlME8wTLBsoHAQkxCscJQgqGCcEJDAhjB+kF6ANEAokAiv6L/X/79fk1+N734PYv9pP11PWi9nX3ofgI+rb74Pzy/gABOQJxBMAF0wYMCOIIdQnSCe4JGwmDCMgH7gW8BOkCfQHN/vH95Pvq+r35bfhY92b2avai9l/3m/eP+Nj5hfs6/fr+0wAMAicD7wTRBtEH0AfsCBEJAwmZCP8H6gYBBh4F4ALaAIL/rv7d+xz73fmt+PT3SPcD96P3sPf+9/X4RPoc/Fb9FP+DAGYCgAPyBDkGqAf3B6MIbAhWCGsIJwcvBgYFygPXAUUA7f4o/SP8M/pM+YT44vcw92L3cvfb+Bb5zvmC+6X87f4qAKsBdANWBPIF8ga5ByEI2AdsCJ8HawdpBt8FvAPvAWQAtP7a/U/8Bftv+u74k/jS9+P3gPhi+CT6ffoW/Cr9LP73/2EB8gIrBO4F+QZSB3IHuQf/B20HYAa0BcQEDwMZAmoAOf9h/Qf8AvvQ+cv4Uvg5+CD4u/gz+Qf6fPud/Kj9Jv/qAH8C9APfBMgFmQYPB1wHoQfvBrUGFga5BLoDhQL6ABT/8f34/I377frQ+TD5sfiD+JL4evkX+uP6CPzs/Tv/oQDOARADMAQOBeMF6QZCB14HfwZIBoUF7QS6A1EC4QCf/9r9Iv2E+936HfqL+Vb54/ik+eX52fqt+3n8Gv4f/1AApwGtAoUE+AQvBoUG1wbkBn4G/QVMBUsE4AKgAYcAC/8i/gn9Vvuy+iP6sfkd+eX5vfl4+jz7Efz+/Ff+4f/WAI4CHQNaBGoF2QUcBp0GpQW7BacFlgTKAyoCawCj/1v+wf0X/Df7Zvr2+aT5ofkq+oX6bfv8+y39XP6r/4sAjQE2A+ADpASpBekFEQb3BbIF4QRDBHoDSwIjARkAq/49/Vj8rvtQ+4f6QPoM+lz6gfpZ+1D8JP2o/oP/7wAGAksDNQS3BFUFmAUhBhMG3QTKBBcEGQMMApcAbv8//kD9Q/y8+x/7dvpP+mn6nPqF+0r85vzO/Q7/KQBRARkCVwN/BAQFZAVbBasFiwXeBCAEEwOEAmwB0v8L/9z9+vyQ+5j7y/qb+n/6ovo3++f7wPyn/ev+6v+lAGwCFAMIBOsEBwURBXsF/ATzBPcDPQM8AqYBXQAo/wb+C/04/Fr7IPv++tH6Lvt9++X7+/yH/dL+CQDgAPQBCgPdAxwErQQhBeIEwARaBA8EBwPwASMBuf/C/tj9LP1p/JP7Sftk+yj7Nvv/+0L8Nf1n/jv/NwCZAT4C9QKlA2AEqQT0BJUEoQTkAysDigKhAZYAfP+j/pj91/wk/H37f/tH+1376vtl/Bv9Fv4l/+//2ACdAa4CEQP+A2cEWgSgBFQE+wMrA6oC2QHgAM7/7v4k/vr8hfwB/I77jfuv+wH8dPzT/K39uf7H/7oAQgFuAhoDqAM0BIUELQQdBO4DigOXAuQB+wDR//r+If6A/ZH8VPyy+8n7w/tD/J38LP0N/qL+o/9YAJwBagJAA2wD8wNCBDsE4gNdA9oCWgJVAV0Aof+x/vr9X/2S/Gn88fvu+wz8Z/zM/IT9cP5d/9r/CAGYAaYC9AJ6A9UDAwT2A60DMgNwAswB+gADAE7/pf6K/f38hPxw/FD8EfyF/Nn8Vf0G/hL/pf8=';

// WebAudio å…œåº•ï¼ˆæçŸ­â€œpopâ€ï¼‰ï¼Œç”¨äºï¼šæœ¬åœ°éŸ³é¢‘ç¼ºå¤±/åŠ è½½å¤±è´¥æ—¶ä»å¯å‘å£°
let _candyAudioCtx = null;
function getCandyAudioCtx() {
    try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return null;

        // å¦‚æœä¹‹å‰æ²¡æœ‰ï¼Œæˆ–è€…å·²ç»è¢«ç³»ç»Ÿå…³æ‰ï¼Œå°±é‡å»ºä¸€ä¸ª
        if (!_candyAudioCtx || _candyAudioCtx.state === 'closed') {
            _candyAudioCtx = new AC();
        }

        // å¦‚æœåªæ˜¯æš‚æ—¶æŒ‚èµ·ï¼Œæ¢å¤å®ƒ
        if (_candyAudioCtx.state === 'suspended') {
            _candyAudioCtx.resume().catch(() => {});
        }
    } catch (e) {
        _candyAudioCtx = null;
    }
    return _candyAudioCtx;
}

function playWebPop(f = 260, dur = 0.10) {
    const ctx = getCandyAudioCtx();
    if (!ctx) return;
    const t0 = ctx.currentTime;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const filter = ctx.createBiquadFilter();

    osc.type = 'sine';
    osc.frequency.setValueAtTime(f, t0);
    osc.frequency.exponentialRampToValueAtTime(Math.max(60, f * 1.9), t0 + Math.max(0.02, dur * 0.35));

    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(1600, t0);

    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.55, t0 + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    osc.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);

    osc.start(t0);
    osc.stop(t0 + dur + 0.01);
}

async function safePlayAudio(audioEl, fallbackDataUrl) {
    try {
        audioEl.currentTime = 0;
        await audioEl.play();
        return true;
    } catch (e) {}

    if (fallbackDataUrl) {
        try {
            if (!audioEl.src || audioEl.src.indexOf('data:audio') !== 0) {
                audioEl.src = fallbackDataUrl;
                audioEl.load();
            }
            audioEl.currentTime = 0;
            await audioEl.play();
            return true;
        } catch (e) {}
    }
    return false;
}
const bubblePopAudio = new Audio(BUBBLE_POP_URL);
bubblePopAudio.preload = 'auto';
bubblePopAudio.volume = 1.0;
// è‹¥æœ¬åœ° bubble-pop-short.mp3 ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨å›é€€åˆ°å†…ç½®çŸ­éŸ³æ•ˆ
bubblePopAudio.addEventListener('error', () => {
    try {
        bubblePopAudio.src = BUBBLE_POP_FALLBACK_DATA;
        bubblePopAudio.load();
    } catch (e) {}
});

const fireworkPopAudio = new Audio(FIREWORK_POP_URL);
fireworkPopAudio.preload = 'auto';
fireworkPopAudio.volume = 1.0;

const starShineAudio = new Audio(STAR_SHINE_URL);
starShineAudio.preload = 'auto';
starShineAudio.loop = true;
starShineAudio.volume = 0.65;

let soundUnlocked = false;

// åˆ¤æ–­æ˜¯å¦å¤„äºã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€çš„ç‹¬ç«‹æ¨¡å¼ï¼ˆä»…ç”¨äºæç¤ºï¼Œä¸å†å‚ä¸æ ¸å¿ƒåˆ¤æ–­ï¼‰
function isStandaloneMode() {
    try {
        return (
            (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
            window.navigator.standalone === true
        );
    } catch (e) {
        return false;
    }
}

// å½“å‰ç³–æ˜¯å¦éœ€è¦éŸ³æ•ˆï¼ˆç”¨äºæ§åˆ¶â€œå¼€å¯éŸ³æ•ˆâ€æŒ‰é’®æ˜¯å¦å‡ºç°ï¼‰
let currentCandyNeedsSound = false;

// ä»…åœ¨â€œéœ€è¦éŸ³æ•ˆä¸”å°šæœªè§£é”â€çš„æƒ…å†µä¸‹æ˜¾ç¤ºæŒ‰é’®
function updateCandySoundButton(needsSound) {
    currentCandyNeedsSound = !!needsSound;
    const btn = document.getElementById('candySoundBtn');
    if (!btn) return;

    if (currentCandyNeedsSound && !soundUnlocked) {
        btn.style.display = 'inline-flex';
    } else {
        btn.style.display = 'none';
    }
}

// ç»Ÿä¸€è§£é”ï¼šç”¨æˆ·ç‚¹ä¸€æ¬¡æŒ‰é’®ï¼ŒæŠŠç›¸å…³éŸ³é¢‘éƒ½â€œç‚¹äº®â€
async function unlockAllCandySounds() {
    const btn = document.getElementById('candySoundBtn');

    // å°è¯•å”¤é†’ WebAudioï¼ˆä½œä¸ºå…œåº•ï¼‰
    try { getCandyAudioCtx(); } catch (e) {}

    // é€ä¸ªå°è¯•ï¼Œä¸è¦å› ä¸ºæŸä¸ªå¤±è´¥å°±ä¸­æ–­
    try {
        bubblePopAudio.currentTime = 0;
        await bubblePopAudio.play();
        bubblePopAudio.pause();
    } catch (e) {
        try {
            bubblePopAudio.src = BUBBLE_POP_FALLBACK_DATA;
            bubblePopAudio.load();
            bubblePopAudio.currentTime = 0;
            await bubblePopAudio.play();
            bubblePopAudio.pause();
        } catch (_) {}
    }

    try {
        fireworkPopAudio.currentTime = 0;
        await fireworkPopAudio.play();
        fireworkPopAudio.pause();
    } catch (e) {}

    try {
        starShineAudio.currentTime = 0;
        await starShineAudio.play();
        starShineAudio.pause();
    } catch (e) {}

    // ä¸ç®¡å®é™…æ˜¯å¦å‘å£°ï¼Œåªè¦èµ°åˆ°è¿™é‡Œï¼Œå°±è®¤ä¸ºç”¨æˆ·å·²ç»â€œå°è¯•å¼€å¯â€
    soundUnlocked = true;
    updateCandySoundButton(currentCandyNeedsSound);
}

// åˆå§‹åŒ–æŒ‰é’®ç‚¹å‡»ï¼ˆæŒ‰é’®æœ¬èº«å¸¸é©»åœ¨ candyStageï¼Œä¸ä¼šè¢« innerHTML æ¸…æ‰ï¼‰
function initCandySoundButton() {
    const btn = document.getElementById('candySoundBtn');
    if (!btn) return;
    btn.addEventListener('click', () => {
        unlockAllCandySounds();
    });
}

document.addEventListener('DOMContentLoaded', initCandySoundButton);

// é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ï¼Œåœ¨æ²™ç›’æ¨¡å¼ä¸‹è¦æ±‚ç”¨æˆ·é‡æ–°è§£é”éŸ³æ•ˆ
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        if (isStandaloneMode()) {
            soundUnlocked = false;
        }
    } else if (document.visibilityState === 'visible') {
        if (isStandaloneMode()) {
            updateCandySoundButton(currentCandyNeedsSound);
        }
    }
});


function playBubblePopSound() {
    // ä¸»å±å¹•æ¨¡å¼æœªè§£é”æ—¶ï¼Œç›´æ¥ä¸æ’­ï¼Œé¿å…è¢«ç³»ç»Ÿé™éŸ³/æŠ¥é”™
    if (isStandaloneMode() && !soundUnlocked) return;

    // å…ˆå°è¯•æ’­æ”¾æœ¬åœ°æ–‡ä»¶ï¼›å¤±è´¥åˆ™å›é€€åˆ°å†…ç½®çŸ­éŸ³æ•ˆï¼›å†å¤±è´¥åˆ™ç”¨ WebAudio å…œåº•
    safePlayAudio(bubblePopAudio, BUBBLE_POP_FALLBACK_DATA).then((ok) => {
        if (!ok) {
            try { playWebPop(260, 0.10); } catch (e) {}
        }
    });
}

function playFireworkPopSound() {
    if (isStandaloneMode() && !soundUnlocked) return;

    safePlayAudio(fireworkPopAudio, null).then((ok) => {
        if (!ok) {
            try { playWebPop(180, 0.12); } catch (e) {}
        }
    });
}


function startStarShineSound() {
    // ä¸»å±å¹•/æ²™ç›’æ¨¡å¼ï¼šæœªè§£é”å‰ä¸å¼ºè¡Œæ’­æ”¾ï¼ˆé¿å…è¢«ç³»ç»Ÿæ‹¦æˆªï¼‰
    if (isStandaloneMode() && !soundUnlocked) return;

    try {
        // å·²åœ¨æ’­æ”¾å°±ä¸é‡å¤è§¦å‘
        if (starShineAudio && !starShineAudio.paused) return;

        if (!starShineAudio) return;

        // æ¯æ¬¡å¼€å§‹ä»å¤´æ’­æ”¾ï¼Œæ›´åƒâ€œå¯åŠ¨ä»ªå¼â€
        starShineAudio.currentTime = 0;

        const p = starShineAudio.play();
        if (p && typeof p.catch === 'function') p.catch(() => {});
    } catch (e) {}
}

function stopStarShineSound() {
    try {
        starShineAudio.pause();
    } catch (e) {}
}


    // è®°å½•ç´¯è®¡æ‰“å¼€å¤©æ•° & æ¯æ—¥æ‰“å¡å›¾å·²å¼¹å‡ºçš„æ—¥æœŸ
    const KEY_OPENED_DAYS = 'anchor_opened_days_v56';
    const KEY_POSTER_SHOWN_DAY = 'anchor_poster_shown_day_v56';

    // è·å– yyyy-mm-dd æ ¼å¼çš„ä»Šå¤©æ—¥æœŸ
    function getTodayDateStr() {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    // åˆå§‹åŒ– / æ›´æ–°ç´¯è®¡æ‰“å¼€å¤©æ•°ï¼Œè¿”å›â€œè¿™æ˜¯ç¬¬å‡ å¤©â€
    function initOpenedDays() {
        const today = getTodayDateStr();
        let raw = localStorage.getItem(KEY_OPENED_DAYS);
        let arr;
        try {
            arr = raw ? JSON.parse(raw) : [];
            if (!Array.isArray(arr)) arr = [];
        } catch (e) {
            arr = [];
        }

        if (!arr.includes(today)) {
            arr.push(today);
            localStorage.setItem(KEY_OPENED_DAYS, JSON.stringify(arr));
        }

        return arr.length;
    }

    // å¦‚æœ‰éœ€è¦ï¼Œå¼¹å‡ºä»Šæ—¥æ‰“å¡å›¾ï¼ˆä¼˜åŒ–ï¼šæ·»åŠ å›¾ç‰‡é¢„åŠ è½½å’Œé”™è¯¯å¤„ç†ï¼‰
function showDailyPosterIfNeeded(openDaysCount) {
    // ã€Bug #5 ä¿®å¤ã€‘æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»å¼¹è¿‡ï¼Œé¿å…é‡å¤å¼¹
    const today = getTodayDateStr();
    const shownDay = localStorage.getItem(KEY_POSTER_SHOWN_DAY);
    // if (shownDay === today) return; // ä¸´æ—¶ï¼šæ¯æ¬¡æ‰“å¼€éƒ½å¼¹

    
    const overlay = document.getElementById('dailyPosterOverlay');
    const daySpan = document.getElementById('dailyPosterDayCount');
    const imgEl   = document.getElementById('dailyPosterImg');
    const dateEl  = document.getElementById('dailyPosterDate');
    if (!overlay || !daySpan) return;

    // æ›´æ–°ã€Œç¬¬å‡ å¤©ã€çš„æ•°å­—
    daySpan.textContent = openDaysCount;

        // æ›´æ–°å½“å¤©æ—¥æœŸ + æ–‡æ¡ˆï¼ˆæ ¼å¼ï¼šYYYY.MM.DD | åƒä¸€æ¬¡çŸ­æš‚åœé ï¼Œçœ‹çœ‹ä»Šå¤©èµ°åˆ°äº†å“ªé‡Œã€‚ï¼‰
    if (dateEl) {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const dateStr = `${y}.${m}.${d}`;
        dateEl.textContent = `${dateStr} | åƒä¸€æ¬¡çŸ­æš‚åœé ï¼Œçœ‹çœ‹ä»Šå¤©èµ°åˆ°äº†å“ªé‡Œã€‚`;
    }

    // æŒ‰å¤©æ•°åœ¨å›¾åº“é‡Œé€‰ä¸€å¼ å›¾
    if (imgEl && Array.isArray(DAILY_POSTER_IMAGES) && DAILY_POSTER_IMAGES.length > 0) {
        const idx = (openDaysCount - 1) % DAILY_POSTER_IMAGES.length;
        const imageUrl = DAILY_POSTER_IMAGES[idx];
        
        // ä¼˜åŒ–ï¼šç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå†æ˜¾ç¤ºå¼¹çª—
        // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ5ç§’ï¼‰ï¼Œé¿å…æ— é™ç­‰å¾…
        const loadTimeout = setTimeout(() => {
            console.warn('æ‰“å¡å›¾åŠ è½½è¶…æ—¶ï¼Œç›´æ¥æ˜¾ç¤ºå¼¹çª—ï¼ˆå¯èƒ½æ˜¾ç¤ºç©ºç™½ï¼‰');
            imgEl.src = imageUrl; // å³ä½¿è¶…æ—¶ä¹Ÿå°è¯•è®¾ç½®
            imgEl.style.opacity = '0.3'; // é™ä½é€æ˜åº¦æç¤ºå¯èƒ½æœªå®Œå…¨åŠ è½½
            overlay.style.display = 'flex';
            markPosterShown(today);
        }, 5000);
        
        // ä½¿ç”¨æ”¹è¿›çš„åŠ è½½å‡½æ•°
        ensurePosterLoaded(imageUrl)
            .then((loadedImg) => {
                clearTimeout(loadTimeout);
                // å›¾ç‰‡å·²å®Œå…¨åŠ è½½ï¼Œè®¾ç½® src
                imgEl.src = imageUrl;
                imgEl.style.display = 'block';
                
                // ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•ï¼šç­‰å¾…å›¾ç‰‡åœ¨ img å…ƒç´ ä¸­å®Œå…¨åŠ è½½
                const showPoster = () => {
                    imgEl.style.opacity = '1';
                    overlay.style.display = 'flex';
                    markPosterShown(today);
                };
                
                // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²ç»åœ¨æµè§ˆå™¨ç¼“å­˜ä¸­
                if (imgEl.complete && imgEl.naturalHeight !== 0) {
                    // å›¾ç‰‡å·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œç«‹å³æ˜¾ç¤º
                    showPoster();
                } else {
                    // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
                    const imgLoadHandler = () => {
                        showPoster();
                        imgEl.removeEventListener('load', imgLoadHandler);
                        imgEl.removeEventListener('error', imgErrorHandler);
                    };
                    const imgErrorHandler = () => {
                        clearTimeout(loadTimeout);
                        console.warn('æ‰“å¡å›¾åœ¨ img å…ƒç´ ä¸­åŠ è½½å¤±è´¥:', imageUrl);
                        imgEl.style.display = 'none';
                        overlay.style.display = 'flex';
                        markPosterShown(today);
                        imgEl.removeEventListener('load', imgLoadHandler);
                        imgEl.removeEventListener('error', imgErrorHandler);
                    };
                    imgEl.addEventListener('load', imgLoadHandler, { once: true });
                    imgEl.addEventListener('error', imgErrorHandler, { once: true });
                }
            })
            .catch((error) => {
                clearTimeout(loadTimeout);
                console.warn('æ‰“å¡å›¾åŠ è½½å¤±è´¥:', imageUrl, error);
                // åŠ è½½å¤±è´¥ï¼Œéšè—å›¾ç‰‡ä½†æ˜¾ç¤ºå¼¹çª—
                imgEl.style.display = 'none';
                overlay.style.display = 'flex';
                markPosterShown(today);
            });
    } else {
        // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç›´æ¥æ˜¾ç¤ºå¼¹çª—
        overlay.style.display = 'flex';
        markPosterShown(today);
    }
}

// è¾…åŠ©å‡½æ•°ï¼šæ ‡è®°æ‰“å¡å›¾å·²æ˜¾ç¤º
function markPosterShown(today) {
    try {
        localStorage.setItem(KEY_POSTER_SHOWN_DAY, today);
    } catch (e) {
        console.warn('ä¿å­˜ posterShownDay å¤±è´¥', e);
    }
}

    function closeDailyPoster() {
        const overlay = document.getElementById('dailyPosterOverlay');
        if (overlay) overlay.style.display = 'none';
    }

    function dailyPosterEatCandy() {
        // å…³é—­å¼¹çª— â†’ æ‰“å¼€ 00 åŒºå¹¶éšæœºæ¥ä¸€é¢—ç³–
        closeDailyPoster();
        openCandyEngine();
    }

    function dailyPosterSkipToGacha() {
        // å…³é—­å¼¹çª— â†’ å¹³æ»‘æ»šåŠ¨åˆ° 01 åŒºæŠ½å¡æœº
        closeDailyPoster();
        const hero = document.querySelector('.hero-wrapper');
        if (hero && hero.scrollIntoView) {
            hero.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // --- 00 åŒº Â· åƒç³–ç›²ç›’å¼•æ“ ---

    // é¡¶éƒ¨ ğŸ¬ æŒ‰é’®ç‚¹å‡»ï¼šå¦‚æœ 00 åŒºæ˜¯å…³çš„å°±æ‰“å¼€ï¼Œæ˜¯å¼€çš„å°±æ”¶èµ·
function handleCandyButtonClick() {
    const section = document.getElementById('candySection');
    const stage   = document.getElementById('candyStageInner');
    const wrapper = document.querySelector('.stats-and-candy-wrapper');
    if (!section || !stage) return;

    const isVisible = section.style.display === 'block';

    if (isVisible) {
        // æ”¶èµ· 00 åŒºï¼ˆä¸åšä»»ä½•è‡ªåŠ¨æ»šåŠ¨ï¼Œé¿å…é¡µé¢è¶Šæ»šè¶Šä¸‹ï¼‰
        section.style.display = 'none';
        if (wrapper) wrapper.classList.remove('candy-open');
    } else {
        // æ‰“å¼€ 00 åŒºå¹¶éšæœºä¸€é¢—ç³–ï¼ˆä¸åš scrollIntoViewï¼‰
        openCandyEngine();
    }
}


    // æ‰“å¼€ 00 åŒºï¼Œå¹¶éšæœºé€‰æ‹©ä¸€ç§ç³–æ¨¡å¼
    function openCandyEngine() {
        const section = document.getElementById('candySection');
        const stage   = document.getElementById('candyStageInner');
        const wrapper = document.querySelector('.stats-and-candy-wrapper');
        if (!section || !stage) return;

        // ç¡®ä¿ 00 åŒºå±•ç¤ºå‡ºæ¥ï¼ˆä¸åš scrollIntoViewï¼Œé¿å…æ¯æ¬¡å±•å¼€éƒ½æŠŠé¡µé¢æ¨èµ°ï¼‰
        section.style.display = 'block';
        if (wrapper) wrapper.classList.add('candy-open');

        // æ¯æ¬¡æ‰“å¼€éƒ½å½“ä½œä¸€æ¬¡â€œæ‹†ç›²ç›’â€
        renderRandomCandy(stage);
    }

    // æ ¹æ®ç³–ç±»å‹ï¼Œæ¸²æŸ“å…·ä½“ç³–å†…å®¹
function renderRandomCandy(stageEl) {
    const t = pickCandyType() || 'bubble';

    // åªæœ‰éœ€è¦éŸ³æ•ˆçš„ç³–ï¼ˆææ°”æ³¡ / çƒŸèŠ±Â·æ˜Ÿç©ºï¼‰æ‰æœ‰å¯èƒ½æ˜¾ç¤ºâ€œå¼€å¯éŸ³æ•ˆâ€æŒ‰é’®
    updateCandySoundButton(t === 'bubble' || t === 'fireworks' || t === 'instrument');  // å…œåº•ï¼šå¦‚æœå‡ºé”™ï¼Œå°±ç”¨ bubble

    if (t === 'bubble') {
        // ææ°”æ³¡ç³–
        renderBubbleCandy(stageEl);
    } else if (t === 'doodle') {
        // æ¶‚é¸¦ç³–
        renderDoodleCandy(stageEl);
    } else if (t === 'coloring') {
        // æ¶‚è‰²ç³–
        renderColoringCandy(stageEl);
    } else if (t === 'music') {
        // éŸ³ä¹ç³–ï¼ˆBç«™æ’­æ”¾åˆ—è¡¨ï¼‰
        renderMusicCandy(stageEl);
    } else if (t === 'instrument') {
        // ä¹å™¨ç³–ï¼ˆé»˜è®¤ Kalimbaï¼‰
        renderInstrumentCandy(stageEl);
    } else if (t === 'fireworks') {
        // çƒŸèŠ± / æ˜Ÿç©ºæ‹–å°¾ç³–
        renderFireworksCandy(stageEl);
    } else {
        // ä¸‡ä¸€å°†æ¥é…ç½®é‡Œå¤šäº†æ–°ç±»å‹ä½†æ²¡å®ç°ï¼Œå°±å®‰å…¨å…œåº•åˆ°æ°”æ³¡ç³–
        renderBubbleCandy(stageEl);
    }
}

// ä»â€œç³–å®¶æ—â€é‡Œé€‰å‡ºæœ¬æ¬¡è¦åƒçš„ç³–ï¼š
// 1ï¼‰å…ˆæŒ‰å®¶æ—æƒé‡é€‰å®¶æ—ï¼›
// 2ï¼‰å†åœ¨è¯¥å®¶æ—å†…éƒ¨éšæœºä¸€é¢—ç³–ï¼›
// 3ï¼‰å¦‚æœå’Œä¸Šä¸€æ¬¡ç›¸åŒï¼Œåˆ™å°½é‡é‡æŠ½ï¼Œä¿è¯â€œè¿ç»­ä¸¤æ¬¡ä¸ä¸€æ ·â€ã€‚
function pickCandyType() {
    // åªä¿ç•™æœ‰æœ‰æ•ˆ variants çš„å®¶æ—
    const enabledFamilies = CANDY_FAMILIES.filter(f => Array.isArray(f.variants) && f.variants.length > 0);
    if (enabledFamilies.length === 0) {
        return null;
    }

    // è®¡ç®—æ€»æƒé‡
    let totalWeight = 0;
    enabledFamilies.forEach(f => {
        const w = typeof f.weight === 'number' && f.weight > 0 ? f.weight : 1;
        totalWeight += w;
    });

    // æŒ‰æƒé‡éšæœºé€‰æ‹©ä¸€ä¸ªå®¶æ—
    let r = Math.random() * totalWeight;
    let chosenFamily = enabledFamilies[0];
    for (let i = 0; i < enabledFamilies.length; i++) {
        const f = enabledFamilies[i];
        const w = typeof f.weight === 'number' && f.weight > 0 ? f.weight : 1;
        if (r < w) {
            chosenFamily = f;
            break;
        }
        r -= w;
    }

    if (!chosenFamily || !Array.isArray(chosenFamily.variants) || chosenFamily.variants.length === 0) {
        return null;
    }

    // åœ¨å®¶æ—å†…éƒ¨é€‰ä¸€é¢—ç³–ï¼ŒåŒæ—¶å°½é‡é¿å…å’Œ lastCandyType ä¸€æ ·
    let candidate = null;

    // å°è¯•å‡ æ¬¡éšæœºï¼Œå°½é‡é¿å…é‡å¤
    for (let attempt = 0; attempt < 5; attempt++) {
        const idx = Math.floor(Math.random() * chosenFamily.variants.length);
        candidate = chosenFamily.variants[idx];
        if (candidate !== lastCandyType) {
            break;
        }
    }

    // å¦‚æœå°è¯•å¤šæ¬¡è¿˜æ˜¯å’Œä¸Šä¸€æ¬¡ä¸€æ ·ï¼Œå°±ä»æ‰€æœ‰ç³–é‡ŒæŒ‘ä¸€ä¸ªâ€œä¸æ˜¯ä¸Šä¸€æ¬¡â€çš„
    if (candidate === lastCandyType) {
        const all = getAllCandyTypes().filter(t => t !== lastCandyType);
        if (all.length > 0) {
            candidate = all[Math.floor(Math.random() * all.length)];
        }
    }

    // æ›´æ–°è®°å½•ï¼Œæ–¹ä¾¿ä¸‹ä¸€æ¬¡â€œé¿å…é‡å¤â€
    lastCandyType = candidate;
    return candidate;
}

    // v5.6aï¼šææ°”æ³¡ç³–ï¼ˆæ›´å¯†é›† + æœ‰â€œå»æŠ½å¡â€æŒ‰é’®ï¼‰
function renderBubbleCandy(stageEl) {
    const cols = 6;     // æ¯è¡Œ 6 ä¸ªæ³¡æ³¡
    const rows = 5;     // å…± 5 è¡Œ
    const total = cols * rows;
    const threshold = 8;   // æˆ³æ»¡ 8 ä¸ªå°±è®¤ä¸ºâ€œåƒå®Œè¿™é¢—ç³–â€

    let html = '<div class="bubble-grid">';
    for (let i = 0; i < total; i++) {
        html += '<button class="bubble" data-popped="0" type="button"></button>';
    }
    html += '</div>';
    html += '<div class="bubble-hint" id="bubbleHint">éšä¾¿æå‡ ä¸ªæ°”æ³¡ï¼Œä¸ç”¨æƒ³å¤ªå¤šã€‚</div>';
    html += '<button type="button" id="bubbleToGachaBtn" class="bubble-to-gacha" style="display:none;">å»æŠ½å¡</button>';

    stageEl.innerHTML = html;

    let popCount = 0;
    const bubbles = stageEl.querySelectorAll('.bubble');
    const hint = stageEl.querySelector('#bubbleHint');
    const toGachaBtn = stageEl.querySelector('#bubbleToGachaBtn');

    bubbles.forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.dataset.popped === '1') return;

            btn.dataset.popped = '1';
            btn.classList.add('bubble-popped');
            popCount++;

            // æ¯æ¬¡æˆ³éƒ½æ”¾ä¸€ä¸ªå°å£°éŸ³
            playBubblePopSound();

            // ç¬¬ä¸€æ¬¡åœ¨æœ¬æ¬¡æ‰“å¼€ä¸­è®¤çœŸâ€œç©äº†ä¸€ä¼šå„¿ç³–â€
            if (!candyEatenThisSession && popCount >= threshold) {
                markCandyDone();
                if (hint) {
                    hint.textContent = 'å¥½ï¼Œè¿™æ ·å°±å¤Ÿå•¦ï¼Œå¯ä»¥å»æŠ½ä¸€å¼ å¡ã€‚';
                }
                if (toGachaBtn) {
                    toGachaBtn.style.display = 'block';
                }
            }
        });
    });

    if (toGachaBtn) {
        toGachaBtn.addEventListener('click', () => {
            const hero = document.querySelector('.hero-wrapper');
            if (hero && hero.scrollIntoView) {
                hero.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }
}
// v6ï¼šéŸ³ä¹ç³–ï¼ˆAnchor å¯åŠ¨æ­Œå• Â· ç½‘æ˜“äº‘ï¼‰
// v6.1ï¼šçƒŸèŠ±/æ˜Ÿç©ºç³–ï¼ˆåŒä¸€é¢—ç³–ï¼Œä¸¤ç§æ¨¡å¼ï¼‰
function renderFireworksCandy(stageEl) {
    const thresholdFire = 8;   // çƒŸèŠ±ï¼šç‚¹å‡º 8 æ¬¡è§†ä¸ºâ€œå¤Ÿå•¦â€
    const thresholdStar = 6;   // æ˜Ÿç©ºï¼šå®Œæˆ 6 æ¬¡æŒ‰ä½æ‹–åŠ¨è§†ä¸ºâ€œå¤Ÿå•¦â€
    const maxRunMs      = 80000; // æœ€é•¿è¿è¡Œæ—¶é—´ï¼š80s

    // ä½“éªŒç­–ç•¥ï¼šé»˜è®¤å›ºå®šå…ˆè¿›å…¥ã€ŒçƒŸèŠ±ã€ï¼Œç”¨æˆ·å¯ç‚¹æŒ‰é’®åˆ‡åˆ°ã€Œæ˜Ÿç©ºã€
    let mode = 'fireworks';

    let burstCount  = 0;
    let strokeCount = 0;
    let startedAt   = Date.now();

    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    // --- UI ---
    let html = '';
    html += '<div class="fireworks-candy-card">';
    html += '  <div class="fireworks-topbar">';
    html += '    <div class="mode-switch">';
    html += '      <button type="button" class="mode-btn" id="fwModeFire">çƒŸèŠ±</button>';
    html += '      <button type="button" class="mode-btn" id="fwModeStar">æ˜Ÿç©º</button>';
    html += '    </div>';
    html += '  </div>';
    html += '  <div class="fireworks-hint" id="fwHint"></div>';
    html += '  <div class="fireworks-canvas-wrap">';
    html += '    <canvas id="fwCanvas" aria-label="Fireworks / Stars"></canvas>';
    html += '  </div>';
    html += '  <button type="button" id="fwToGachaBtn" class="bubble-to-gacha" style="display:none;">å»æŠ½å¡</button>';
    html += '</div>';

    stageEl.innerHTML = html;

    const canvas   = stageEl.querySelector('#fwCanvas');
    const wrap     = stageEl.querySelector('.fireworks-canvas-wrap');
    const ctx      = canvas.getContext('2d');
    const hint     = stageEl.querySelector('#fwHint');
    const btnFire  = stageEl.querySelector('#fwModeFire');
    const btnStar  = stageEl.querySelector('#fwModeStar');
    const toGachaBtn = stageEl.querySelector('#fwToGachaBtn');

    // CSS è§¦æ§é˜²æ»šåŠ¨
    canvas.style.touchAction = 'none';

    // --- Canvas sizing ---
    let dpr = 1;
    function fitCanvas() {
        const rect = (wrap || canvas).getBoundingClientRect();
        const w = Math.max(1, Math.floor(rect.width));
        const h = Math.max(1, Math.floor(rect.height));
        dpr = Math.min((window.devicePixelRatio || 1), isMobile ? 1.5 : 2);
        const pxW = Math.floor(w * dpr);
        const pxH = Math.floor(h * dpr);
        if (canvas.width !== pxW || canvas.height !== pxH) {
            canvas.width = pxW;
            canvas.height = pxH;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
    }

    // ç»Ÿä¸€åº•è‰²ï¼ˆè½»å¾®æ®‹å½±ï¼‰
    function clearFrame(alpha) {
        fitCanvas();
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = `rgba(10, 12, 24, ${alpha})`;
        const cw = (wrap && wrap.clientWidth) ? wrap.clientWidth : canvas.clientWidth;
        const ch = (wrap && wrap.clientHeight) ? wrap.clientHeight : canvas.clientHeight;
        ctx.fillRect(0, 0, cw, ch);
    }

    // --- çŠ¶æ€ä¸ç²’å­ ---
    let rafId = 0;
    let running = false;
    let isDown = false;
    let lastSpawnAt = 0;

    // çƒŸèŠ±ï¼šå®Œå…¨ä½¿ç”¨ v6.1 é€šç”¨ç‰ˆçš„ç²’å­ç»“æ„ï¼ˆé‡åŠ›ä¸‹å  + æ®‹å½±ï¼‰
    const fwParticles = [];
    const fwPalette = ['#FF6B6B', '#FFD93D', '#6BCB77', '#4D96FF', '#B983FF', '#FF9F1C', '#F72585', '#00BBF9'];

    function spawnBurstFW(x, y) {
        const count = 42;
        const base = fwPalette[Math.floor(Math.random() * fwPalette.length)];
        for (let i = 0; i < count; i++) {
            const a = Math.random() * Math.PI * 2;
            const sp = 1.2 + Math.random() * 3.2;
            fwParticles.push({
                x, y,
                vx: Math.cos(a) * sp,
                vy: Math.sin(a) * sp,
                life: 1,
                decay: 0.012 + Math.random() * 0.016,
                r: 1.2 + Math.random() * 1.8,
                color: base,
            });
        }
    }

    // æ˜Ÿç©ºï¼šè½»é‡â€œæ‹–å°¾åˆ·â€ + æ˜Ÿç‚¹ç²’å­ï¼ˆç§»åŠ¨ç«¯æ›´çœï¼‰
    const starParticles = [];
    const starPalette = ['rgba(255,255,255,0.95)', 'rgba(217,242,255,0.95)', 'rgba(190,227,255,0.95)', 'rgba(242,233,255,0.95)', 'rgba(255,232,244,0.95)'];
    let lastPt = null;
    let dragProgress = 0;
    let lastFrameAt = 0;

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    // â€œä»ç»†åˆ°å®½ã€é€æ¸æ•£å¼€â€ï¼šspread éšæ‹–åŠ¨ç´¯è®¡è·ç¦»å¢é•¿ï¼ˆç•¥æ¯”ä¸Šä¸€ç‰ˆæ›´å¤§ä¸€ç‚¹ç‚¹ï¼‰
    function getStarSpread() {
        const t = clamp(dragProgress / 260, 0, 1);   // 0..1
        return 2.2 + t * 10.2; // çº¦ 2.2 -> 12.4ï¼ˆæ•£å¼€ç¨å¤§ä¸€ç‚¹ç‚¹ï¼‰
    }

    function spawnStarDots(x, y, spread) {
        // å°¾éƒ¨æ˜Ÿç‚¹å¯†é›†ä¸€ç‚¹ï¼Œä½†å—ç§»åŠ¨ç«¯/æ€»é‡ä¸Šé™ä¿æŠ¤
        const n = (isMobile ? (4 + Math.floor(Math.random() * 3)) : (6 + Math.floor(Math.random() * 5)));
        const maxParticles = isMobile ? 220 : 520;

        for (let i = 0; i < n; i++) {
            const c = starPalette[Math.floor(Math.random() * starPalette.length)];
            const ox = (Math.random() - 0.5) * spread;
            const oy = (Math.random() - 0.5) * spread;
            const life = isMobile ? (34 + Math.random() * 20) : (46 + Math.random() * 26);
            starParticles.push({
                x: x + ox,
                y: y + oy,
                vx: (Math.random() - 0.5) * 0.55,
                vy: (Math.random() - 0.5) * 0.55,
                life: life,
                maxLife: life,
                color: c,
                size: (isMobile ? (0.9 + Math.random() * 1.1) : (1.1 + Math.random() * 1.5))
            });
        }

        // è¶…è¿‡ä¸Šé™å°±ä¸¢å¼ƒæœ€æ—§çš„ï¼Œé˜²å¡é¡¿
        if (starParticles.length > maxParticles) {
            starParticles.splice(0, starParticles.length - maxParticles);
        }
    }

    function drawStarBrushSegment(a, b, spread) {
        // è½»é‡æ¸å˜æ‹–å°¾ï¼ˆé¿å…â€œç™½æ¡â€ï¼šæ•´ä½“ alpha å¾ˆå…‹åˆ¶ï¼Œé æ˜Ÿç‚¹æ¥æ’‘è´¨æ„Ÿï¼‰
        const dx = b.x - a.x;
        const dy = b.y - a.y;
        const dist = Math.hypot(dx, dy) || 1;
        const speed = clamp(dist / 18, 0.6, 2.2);

        // å®½åº¦ä»ç»†åˆ°å®½ï¼ˆæ¯”ä¸Šä¸€ç‰ˆå®½ä¸€ç‚¹ç‚¹ï¼Œä½†ä¸è¿‡åˆ†ï¼‰
        const t = clamp(dragProgress / 260, 0, 1);
        const base = (isMobile ? 1.6 : 1.8);
        const maxW = (isMobile ? 6.8 : 7.8);
        const w = (base + t * (maxW - base)) * speed;

        const g = ctx.createLinearGradient(a.x, a.y, b.x, b.y);
        g.addColorStop(0, 'rgba(255,255,255,0.00)');
        g.addColorStop(0.35, 'rgba(190,227,255,0.10)');
        g.addColorStop(0.75, 'rgba(255,232,244,0.10)');
        g.addColorStop(1, 'rgba(255,255,255,0.00)');

        ctx.save();
        ctx.globalCompositeOperation = 'lighter';
        ctx.strokeStyle = g;
        ctx.lineWidth = w;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.shadowBlur = 10;
        ctx.shadowColor = 'rgba(190,227,255,0.18)';
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.lineTo(b.x, b.y);
        ctx.stroke();

        // é¢å¤–â€œæ•£å¼€â€çš„å¾®æ˜Ÿå°˜ï¼ˆè½»é‡ï¼Œä¸»è¦åœ¨å°¾éƒ¨ï¼‰
        const dustN = isMobile ? 1 : 2;
        for (let i = 0; i < dustN; i++) {
            const px = b.x + (Math.random() - 0.5) * (spread * 0.65);
            const py = b.y + (Math.random() - 0.5) * (spread * 0.65);
            ctx.fillStyle = 'rgba(255,255,255,0.14)';
            ctx.beginPath();
            ctx.arc(px, py, 0.9 + Math.random() * 0.9, 0, Math.PI * 2);
            ctx.fill();
        }

        ctx.restore();
    }

    // --- å®Œæˆåˆ¤å®š ---
    function maybeComplete() {
        const done = (mode === 'fireworks') ? (burstCount >= thresholdFire) : (strokeCount >= thresholdStar);
        if (!done) return;

        if (toGachaBtn) toGachaBtn.style.display = 'block';
        if (!candyEatenThisSession) markCandyDone();

        if (hint) {
            hint.textContent = (mode === 'fireworks')
                ? 'å¥½ï¼Œè¿™æ ·å°±å¤Ÿå•¦ï¼Œå¯ä»¥å»æŠ½ä¸€å¼ å¡ã€‚'
                : 'å¥½ï¼Œæ˜Ÿå…‰å°±åˆ°è¿™é‡Œã€‚å¯ä»¥å»æŠ½ä¸€å¼ å¡ã€‚';
        }
    }

    // --- åŠ¨ç”»å¾ªç¯ ---
    function ensureRunning() {
        if (!running) {
            running = true;
            rafId = requestAnimationFrame(tick);
        }
    }

    function stopRunning() {
        running = false;
        if (rafId) cancelAnimationFrame(rafId);
        rafId = 0;
    }

    function computeFadeAlpha(dt, base) {
        // dt è‡ªé€‚åº”ï¼šä½å¸§ç‡æ—¶æ¯å¸§æ¸…å¾—æ›´å¤šï¼Œé¿å…â€œå°¾å·´è¿Ÿè¿Ÿä¸æ•£â€
        const keep = Math.pow(1 - base, dt / 16.6667);
        return 1 - keep; // è½¬å› fill çš„ alpha
    }

    function tick(now) {
        // å®¹å™¨è¢«æ›¿æ¢/ç§»é™¤æ—¶åœæ­¢åŠ¨ç”»ï¼ˆé¿å…åå°å ç”¨ï¼‰
        if (!document.body.contains(canvas)) {
            stopStarShineSound();
            stopRunning();
            return;
        }

        // è¶…æ—¶ä¿æŠ¤ï¼šåˆ°æ—¶é—´å°±æç¤ºå›æŠ½å¡
        if (now - startedAt > maxRunMs && toGachaBtn) {
            if (!candyEatenThisSession) markCandyDone();
            toGachaBtn.style.display = 'block';
        }

        if (mode === 'fireworks') {
            // v6.1 çƒŸèŠ±åº•è‰²æ®‹å½±ï¼ˆæ²¿ç”¨ v6.1.6ï¼šæ›´æœ‰â€œæ®‹å½± + ä¸‹å â€æ‰‹æ„Ÿï¼‰
            clearFrame(0.18);

            ctx.save();
            ctx.globalCompositeOperation = 'lighter';
            for (let i = fwParticles.length - 1; i >= 0; i--) {
                const p = fwParticles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.985;
                p.vy = p.vy * 0.985 + 0.045; // é‡åŠ›ï¼šå†³å®šâ€œå¾€ä¸‹æ‰â€çš„æ„Ÿè§‰
                p.life -= p.decay;

                if (p.life <= 0) {
                    fwParticles.splice(i, 1);
                    continue;
                }

                ctx.globalAlpha = Math.max(0, Math.min(1, p.life));
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
            ctx.globalAlpha = 1;

            // ç²’å­æ¸…ç©ºä¸”æœªæŒ‰ä¸‹æ—¶å¯åœå¸§ï¼ˆçœç”µï¼‰
            if (fwParticles.length === 0 && !isDown) {
                stopRunning();
                return;
            }
        } else {
            // æ˜Ÿç©ºï¼šæ¯”çƒŸèŠ±æ›´è½»ï¼Œä¸”ç§»åŠ¨ç«¯æ›´å¿«æ¶ˆæ•£
            const dt = lastFrameAt ? (now - lastFrameAt) : 16.6;
            lastFrameAt = now;

            const base = isMobile ? 0.34 : 0.26; // base è¶Šå¤§æ¶ˆæ•£è¶Šå¿«
            const fade = computeFadeAlpha(dt, base);
            clearFrame(fade);

            for (let i = starParticles.length - 1; i >= 0; i--) {
                const p = starParticles[i];
                p.life -= 1;
                p.x += p.vx;
                p.y += p.vy;
                p.vx *= 0.985;
                p.vy *= 0.985;

                if (p.life <= 0) {
                    starParticles.splice(i, 1);
                    continue;
                }

                const alpha = (p.life / p.maxLife);
                ctx.globalAlpha = alpha;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            if (starParticles.length === 0 && !isDown) {
                stopRunning();
                return;
            }
        }

        rafId = requestAnimationFrame(tick);
    }

    // --- äº¤äº’ ---
    function getXY(e) {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left);
        const y = (e.clientY - rect.top);
        return { x, y };
    }

    function setMode(next) {
        if (mode === next) return;
        mode = next;

        // åˆ‡æ¢æ—¶åšä¸€æ¬¡æ¸…å±ï¼Œä¸”åœæ­¢æ˜Ÿç©ºå¾ªç¯éŸ³
        stopStarShineSound();
        isDown = false;
        lastPt = null;
        dragProgress = 0;

        // æ¸…æ‰ç²’å­ï¼ˆé¿å…è·¨æ¨¡å¼æ®‹ç•™ï¼‰
        fwParticles.length = 0;
        starParticles.length = 0;

        // æ›´æ–°æŒ‰é’®æ€
        if (btnFire) btnFire.classList.toggle('active', mode === 'fireworks');
        if (btnStar) btnStar.classList.toggle('active', mode === 'stars');

        updateHint();
        clearFrame(0.92);
    }

    function updateHint() {
        if (!hint) return;
        hint.textContent = (mode === 'fireworks')
            ? 'ç‚¹å‡ ä¸‹ï¼Œè®©å®ƒç‚¸å¼€ã€‚å¤Ÿå•¦å°±å»æŠ½å¡ã€‚'
            : 'æŒ‰ä½æ‹–åŠ¨ï¼Œç”»å‡ºä¸€ç‚¹æ˜Ÿå…‰æ‹–å°¾ã€‚å¤Ÿå•¦å°±å»æŠ½å¡ã€‚';
    }

    // äº‹ä»¶ç»‘å®šï¼ˆpointer æ”¯æŒæ¡Œé¢/ç§»åŠ¨ç«¯ï¼‰
    canvas.addEventListener('pointerdown', (e) => {
        try {
        isDown = true;
        startedAt = startedAt || Date.now();
        try { canvas.setPointerCapture && canvas.setPointerCapture(e.pointerId); } catch (_) {}

        const { x, y } = getXY(e);

        if (mode === 'fireworks') {
            spawnBurstFW(x, y);
            burstCount++;
            playFireworkPopSound();
            if (burstCount >= thresholdFire) maybeComplete();
        } else {
            strokeCount++;
            dragProgress = 0;
            lastPt = { x, y };
            startStarShineSound();

            const spread = getStarSpread();
            spawnStarDots(x, y, spread);
            if (strokeCount >= thresholdStar) maybeComplete();
        }

        ensureRunning();
        } catch (err) {
            console.error('[FireworksCandy] pointerdown error', err);
            if (hint) hint.textContent = 'âš ï¸ å°çƒŸèŠ±å‡ºäº†ç‚¹å°æ•…éšœï¼Œåˆ·æ–°ä¸€ä¸‹å†è¯•';
            stopRunning();
        }

    });

    canvas.addEventListener('pointermove', (e) => {
        if (!isDown) return;

        const now = Date.now();

        if (mode === 'fireworks') {
            // æŒ‰ä½æ‹–åŠ¨ï¼šèŠ‚æµè¿ç»­è§¦å‘çƒŸèŠ±ï¼ˆå®Œå…¨æ²¿ç”¨ v6.1 çš„èŠ‚å¥ï¼‰
            if (now - lastSpawnAt < 45) return;
            lastSpawnAt = now;
            const { x, y } = getXY(e);
            spawnBurstFW(x, y);
            burstCount++;
            playFireworkPopSound();
            if (burstCount >= thresholdFire) maybeComplete();
            ensureRunning();
            return;
        }

        // starsï¼šæ‹–åŠ¨ç»˜åˆ¶ï¼ˆç§»åŠ¨ç«¯èŠ‚æµæ›´å¼ºï¼‰
        const minInterval = isMobile ? 55 : 28;
        if (now - lastSpawnAt < minInterval) return;
        lastSpawnAt = now;

        const { x, y } = getXY(e);
        if (lastPt) {
            const dx = x - lastPt.x;
            const dy = y - lastPt.y;
            dragProgress += Math.hypot(dx, dy);
        }

        const spread = getStarSpread();

        // ç”»æ¸å˜æ‹–å°¾ï¼ˆç”¨ä½ alpha é˜²æ­¢â€œç™½æ¡â€ï¼‰
        if (lastPt) drawStarBrushSegment(lastPt, { x, y }, spread);

        // æ˜Ÿç‚¹æ›´å¯†é›†ä¸€ç‚¹ï¼ˆä½†æœ‰ä¸Šé™ä¿æŠ¤ï¼‰
        spawnStarDots(x, y, spread);

        lastPt = { x, y };
        ensureRunning();
    });

    function endPointer(e) {
        if (!isDown) return;
        isDown = false;
        lastPt = null;
        dragProgress = 0;
        stopStarShineSound();
        ensureRunning(); // è®©å°¾å·´è‡ªç„¶æ·¡å‡º
    }

    canvas.addEventListener('pointerup', endPointer);
    canvas.addEventListener('pointercancel', endPointer);
    canvas.addEventListener('pointerleave', endPointer);

    // æ¨¡å¼åˆ‡æ¢æŒ‰é’®
    if (btnFire) btnFire.addEventListener('click', () => setMode('fireworks'));
    if (btnStar) btnStar.addEventListener('click', () => setMode('stars'));

    if (toGachaBtn) {
        toGachaBtn.addEventListener('click', () => {
            if (!candyEatenThisSession) markCandyDone();
            const hero = document.querySelector('.hero-wrapper');
            if (hero && hero.scrollIntoView) {
                hero.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }

    // åˆå§‹åŒ–
    setMode('fireworks');
    updateHint();
    clearFrame(0.92);
}

function renderMusicCandy(stageEl) {
    // å¦‚æœæ­Œå•é…ç½®é‡Œæš‚æ—¶æ²¡æœ‰æ­Œæ›²ï¼Œå°±å…œåº•æˆæ°”æ³¡ç³–ï¼Œé¿å…æŠ¥é”™
    if (!Array.isArray(MUSIC_CLIPS) || MUSIC_CLIPS.length === 0) {
        renderBubbleCandy(stageEl);
        return;
    }

    // éšæœºæŒ‘ä¸€é¦–æ­Œ
    const clip = MUSIC_CLIPS[Math.floor(Math.random() * MUSIC_CLIPS.length)];

    let html = '';
    html += '<div class="music-candy-card">';
    html += '  <div class="music-title">ğŸµ Anchor å¯åŠ¨æ­Œå• Â· éšæœºä¸€æ›²</div>';
    html += '  <div class="music-subtitle">' + clip.title + '</div>';
    html += '  <div class="music-player-wrapper">';
    html += '    <iframe class="music-player-iframe"';
    html += '            src="https://player.bilibili.com/player.html?bvid=' + clip.bvid + '&page=1&high_quality=1&autoplay=0"';
    html += '            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"';
    html += '            referrerpolicy="no-referrer-when-downgrade"';
    html += '            frameborder="0" scrolling="no"></iframe>';
    html += '  </div>';
    html += '  <div class="music-player-fallback">';
    html += '    å¦‚æœæ’­æ”¾å™¨åŠ è½½ä¸å‡ºæ¥ï¼Œå¯ä»¥ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®åœ¨ B ç«™ä¸­å®Œæ•´æ’­æ”¾ã€‚';
    html += '  </div>';
    html += '  <div class="music-hint">å»ºè®®åªå½“ä½œã€Œå¯åŠ¨ BGMã€ï¼Œå¬ä¸€å°ä¼šå„¿å°±å›åˆ°æŠ½å¡åŒºï¼Œä¸è¢«è§†é¢‘ç”»é¢å¸¦èµ°æ³¨æ„åŠ›ã€‚</div>';
    html += '  <button type="button" id="musicToGachaBtn" class="bubble-to-gacha">å»æŠ½å¡</button>';
    html += '</div>';

    stageEl.innerHTML = html;

    const toGachaBtn = stageEl.querySelector('#musicToGachaBtn');

    if (toGachaBtn) {
        toGachaBtn.addEventListener('click', () => {
            // ç‚¹å‡»â€œå»æŠ½å¡â€æ—¶ï¼Œè§†ä¸ºä»Šå¤©è¿™é¢—ç³–å·²ç»åƒè¿‡
            if (!candyEatenThisSession) {
                markCandyDone();
            }
            const hero = document.querySelector('.hero-wrapper');
            if (hero && hero.scrollIntoView) {
                hero.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }
}



// v6.2ï¼šä¹å™¨ç³–ï¼ˆKalimbaï¼‰â€”â€” è½»é‡ WebAudio åˆæˆç‰ˆï¼ˆä¸ä¾èµ–å¤šæ®µéŸ³é¢‘æ–‡ä»¶ï¼Œä½“ç§¯æ›´å°ï¼‰
function renderInstrumentCandy(stageEl) {
    const threshold = 10; // æŒ‰å¤Ÿ 10 ä¸‹å°±è®¤ä¸ºâ€œå¤Ÿå•¦â€
    let playCount = 0;

    // é»˜è®¤å…ˆæ˜¾ç¤º Kalimbaï¼ˆä½ å·²æŒ‡å®šï¼‰
    let mode = 'kalimba';

    // äº”å£°éŸ³é˜¶ï¼šéšä¾¿æŒ‰ä¹Ÿå¥½å¬ï¼ˆé¿å…â€œä¸ä¼šå¼¹å°±éš¾å¬â€çš„æŒ«è´¥ï¼‰
    const NOTES = [
        { num: '1', note: 'C',  freq: 261.63 },
        { num: '2', note: 'D',  freq: 293.66 },
        { num: '3', note: 'E',  freq: 329.63 },
        { num: '4', note: 'G',  freq: 392.00 },
        { num: '5', note: 'A',  freq: 440.00 },
        { num: '6', note: 'C',  freq: 523.25 },
        { num: '7', note: 'D',  freq: 587.33 },
        { num: '8', note: 'E',  freq: 659.25 }
    ];

    // Chord Padï¼šæ¯ä¸ª Pad è§¦å‘ä¸€ä¸ªâ€œæ°›å›´å’Œå¼¦â€ï¼ˆä¸æ˜¯èŠ‚å¥å¾ªç¯ï¼‰
    // è¯´æ˜ï¼šè¿™äº›å’Œå¼¦åˆ»æ„é€‰æˆâ€œæŒ‰å“ªä¸€ä¸ªéƒ½ä¸ä¼šå¤ªåˆºè€³â€çš„ç»„åˆï¼Œé€‚åˆç›²æŒ‰å åŠ ã€‚
    const CHORDS = [
        { label: 'Cmaj9',  sub: 'èˆ’å±•', freqs: [261.63, 329.63, 392.00, 493.88, 587.33] },
        { label: 'Am9',    sub: 'æŸ”å’Œ', freqs: [220.00, 261.63, 329.63, 392.00, 493.88] },
        { label: 'Fmaj7',  sub: 'æ˜äº®', freqs: [174.61, 220.00, 261.63, 329.63] },
        { label: 'G6',     sub: 'æ¨è¿›', freqs: [196.00, 246.94, 293.66, 392.00] },
        { label: 'Dm7',    sub: 'é›¾æ„Ÿ', freqs: [293.66, 349.23, 392.00, 523.25] },
        { label: 'Em7',    sub: 'æ¼‚æµ®', freqs: [329.63, 392.00, 493.88, 587.33] },
        { label: 'Csus2',  sub: 'é€šé€', freqs: [261.63, 293.66, 392.00, 523.25] },
        { label: 'Gsus4',  sub: 'å¼ åŠ›', freqs: [196.00, 261.63, 293.66, 392.00] }
    ];

    // ç®€å•çš„â€œä¸Šè¡Œå†å›è½â€å°æ—‹å¾‹ï¼šç»™ä¸ä¼šå¼¹çš„äººä¸€ä¸ªâ€œæŒ‰ä¸€ä¸‹å°±å¥½å¬â€çš„å…¥å£
    const MELODY_SEQ = [0, 1, 2, 3, 4, 3, 2, 1, 0];

    // è½»é‡ polyphony é™åˆ¶ï¼šé¿å…ç§»åŠ¨ç«¯åŒæ—¶è§¦å‘è¿‡å¤šå£°éŸ³å¯¼è‡´å¡é¡¿
    const MAX_VOICES = 10;
    let activeVoices = 0;

    function afterPlayedOne() {
        playCount++;
        if (!candyEatenThisSession && playCount >= threshold) {
            markCandyDone();
            const hint = stageEl.querySelector('#instrumentHint');
            if (hint) hint.textContent = 'å¥½ï¼Œè¿™æ ·å°±å¤Ÿå•¦ï¼Œå¯ä»¥å»æŠ½ä¸€å¼ å¡ã€‚';
            const toGachaBtn = stageEl.querySelector('#instrumentToGachaBtn');
            if (toGachaBtn) toGachaBtn.style.display = 'block';
        }
    }

    function canPlayNow() {
        // ä¸»å±å¹•/æ²™ç›’æ¨¡å¼æœªè§£é”æ—¶ï¼šæé†’ç”¨æˆ·å…ˆç‚¹â€œå¼€å¯éŸ³æ•ˆâ€
        if (isStandaloneMode() && !soundUnlocked) {
            if (typeof showToast === 'function') showToast('å…ˆç‚¹å³ä¸Šè§’ã€Œå¼€å¯éŸ³æ•ˆã€å†è¯•~');
            return false;
        }
        return true;
    }

    function makeVoice(ctx, { freq, type1='sine', type2='triangle', detune2=-7, attack=0.008, peak=0.55, release=1.2, lp=12000 }) {
        const t0 = ctx.currentTime;

        const osc1 = ctx.createOscillator();
        const osc2 = ctx.createOscillator();
        const gain = ctx.createGain();
        const filter = ctx.createBiquadFilter();

        osc1.type = type1;
        osc2.type = type2;

        osc1.frequency.setValueAtTime(freq, t0);
        osc2.frequency.setValueAtTime(freq * 2, t0);
        osc2.detune.setValueAtTime(detune2, t0);

        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(Math.min(lp, Math.max(1200, freq * 10)), t0);

        gain.gain.setValueAtTime(0.0001, t0);
        gain.gain.exponentialRampToValueAtTime(peak, t0 + attack);
        gain.gain.exponentialRampToValueAtTime(0.0001, t0 + release);

        osc1.connect(filter);
        osc2.connect(filter);
        filter.connect(gain);
        gain.connect(ctx.destination);

        osc1.start(t0);
        osc2.start(t0);
        osc1.stop(t0 + release + 0.05);
        osc2.stop(t0 + release + 0.05);

        activeVoices++;
        const doneAt = (release + 0.08) * 1000;
        setTimeout(() => { activeVoices = Math.max(0, activeVoices - 1); }, doneAt);
    }

    function playKalimbaTone(freq) {
        if (!canPlayNow()) return;

        if (activeVoices >= MAX_VOICES) return;
        const ctx = getCandyAudioCtx();
        if (!ctx) return;

        // Kalimbaï¼šæ›´â€œå¼¹æ‹¨â€ã€æ›´çŸ­ã€æ›´æ¸…è„†
        makeVoice(ctx, { freq, attack: 0.008, peak: 0.55, release: 1.25, lp: 14000 });
    }

    function playPadChord(freqs) {
        if (!canPlayNow()) return;

        const ctx = getCandyAudioCtx();
        if (!ctx) return;

        // Chord Padï¼šæ›´â€œæ°›å›´â€ï¼Œé‡Šæ”¾æ›´é•¿ä¸€ç‚¹ï¼ˆä½†ç§»åŠ¨ç«¯ä¸èƒ½å¤ªé•¿ï¼‰
        freqs.forEach((f, k) => {
            if (activeVoices >= MAX_VOICES) return;
            setTimeout(() => {
                // ç”¨æ›´æŸ”çš„åŒ…ç»œä¸æ»¤æ³¢ï¼Œè®©â€œå éŸ³â€åƒä¸€å›¢æ°›å›´è€Œä¸æ˜¯åˆºè€³çš„å †å 
                makeVoice(ctx, { freq: f, type1: 'sine', type2: 'sine', detune2: +3, attack: 0.02, peak: 0.22, release: 1.85, lp: 9000 });
            }, k * 14);
        });
    }

    function renderBody() {
        const body = stageEl.querySelector('#instrumentBody');
        const sub = stageEl.querySelector('#instrumentSub');
        if (!body) return;

        if (mode === 'kalimba') {
            if (sub) sub.textContent = 'äº”å£°éŸ³é˜¶ï¼šéšä¾¿æŒ‰ä¹Ÿå¥½å¬ã€‚ä½™éŸ³ä¼šå åœ¨ä¸€èµ·ï¼Œåƒè½»è½»çš„å’Œå¼¦ã€‚';

            let h = '<div class="kalimba-keys">';
            NOTES.forEach((n, i) => {
                h += '<button type="button" class="kalimba-key" data-i="' + i + '">';
                h += '  <div class="kalimba-num">' + n.num + '</div>';
                h += '  <div class="kalimba-note">' + n.note + '</div>';
                h += '</button>';
            });
            h += '</div>';

            h += '<div class="instrument-actions">';
            h += '  <button type="button" id="kalimbaChordBtn">éšæœºå’Œå¼¦</button>';
            h += '  <button type="button" id="kalimbaMelodyBtn">å°æ—‹å¾‹</button>';
            h += '</div>';

            body.innerHTML = h;

            // ç»‘å®šï¼šå•éŸ³
            body.querySelectorAll('.kalimba-key').forEach(btn => {
                btn.addEventListener('click', () => {
                    const i = parseInt(btn.getAttribute('data-i') || '0', 10);
                    const n = NOTES[i] || NOTES[0];
                    playKalimbaTone(n.freq);
                    afterPlayedOne();
                });
            });

            // ç»‘å®šï¼šéšæœºå’Œå¼¦ï¼ˆç”¨ä¸‰éŸ³å°æ‹¨å¼¦å¢åŠ â€œåƒå’Œå¼¦â€çš„æ»¡è¶³æ„Ÿï¼‰
            const chordBtn = body.querySelector('#kalimbaChordBtn');
            if (chordBtn) {
                chordBtn.addEventListener('click', () => {
                    const chordPools = [
                        [0, 2, 4], // C-E-A
                        [1, 3, 4], // D-G-A
                        [0, 3, 4], // C-G-A
                        [2, 4, 6]  // E-A-D
                    ];
                    const chord = chordPools[Math.floor(Math.random() * chordPools.length)];
                    chord.forEach((idx, k) => {
                        setTimeout(() => {
                            const n = NOTES[idx] || NOTES[0];
                            playKalimbaTone(n.freq);
                            afterPlayedOne();
                        }, k * 55);
                    });
                });
            }

            // ç»‘å®šï¼šå°æ—‹å¾‹
            const melodyBtn = body.querySelector('#kalimbaMelodyBtn');
            if (melodyBtn) {
                melodyBtn.addEventListener('click', () => {
                    MELODY_SEQ.forEach((idx, k) => {
                        setTimeout(() => {
                            const n = NOTES[idx] || NOTES[0];
                            playKalimbaTone(n.freq);
                            afterPlayedOne();
                        }, k * 160);
                    });
                });
            }

        } else {
            if (sub) sub.textContent = 'Chord Padï¼šä¸€æŒ‰å°±æ˜¯ä¸€å›¢å’Œå£°æ°›å›´ã€‚å¯ä»¥å æŒ‰ï¼Œè¶ŠæŒ‰è¶Šæœ‰ç©ºé—´æ„Ÿã€‚';

            let h = '<div class="chordpad-grid">';
            CHORDS.forEach((c, i) => {
                h += '<button type="button" class="chordpad-pad" data-i="' + i + '">';
                h += '  <span class="chordpad-label">' + c.label + '</span>';
                h += '  <span class="chordpad-sub">' + c.sub + '</span>';
                h += '</button>';
            });
            h += '</div>';

            body.innerHTML = h;

            body.querySelectorAll('.chordpad-pad').forEach(btn => {
                btn.addEventListener('click', () => {
                    const i = parseInt(btn.getAttribute('data-i') || '0', 10);
                    const c = CHORDS[i] || CHORDS[0];
                    playPadChord(c.freqs);
                    afterPlayedOne();
                });
            });
        }
    }

    // å¤–å£³ HTMLï¼šæ ‡é¢˜ + Tab + å†…å®¹åŒº + æç¤º + å»æŠ½å¡
    stageEl.innerHTML = [
        '<div class="instrument-card">',
            '<div class="instrument-title">ğŸ¶ ä¹å™¨ç³–</div>',
            '<div class="instrument-sub" id="instrumentSub"></div>',
            '<div class="instrument-tabs">',
                '<button type="button" class="instrument-tab active" id="tabKalimba">Kalimba</button>',
                '<button type="button" class="instrument-tab" id="tabChord">Chord Pad</button>',
            '</div>',
            '<div id="instrumentBody"></div>',
            '<div class="bubble-hint" id="instrumentHint">éšä¾¿æŒ‰å‡ ä¸‹ï¼Œä¸ç”¨å¼¹å¾—â€œå¥½å¬â€ã€‚</div>',
            '<button type="button" id="instrumentToGachaBtn" class="instrument-to-gacha" style="display:none;">å»æŠ½å¡</button>',
        '</div>'
    ].join('');

    // Tab åˆ‡æ¢
    const tabK = stageEl.querySelector('#tabKalimba');
    const tabC = stageEl.querySelector('#tabChord');

    function setMode(next) {
        if (mode === next) return;
        mode = next;
        if (tabK) tabK.classList.toggle('active', mode === 'kalimba');
        if (tabC) tabC.classList.toggle('active', mode === 'chord');
        renderBody();
    }

    if (tabK) tabK.addEventListener('click', () => setMode('kalimba'));
    if (tabC) tabC.addEventListener('click', () => setMode('chord'));

    // åˆå§‹æ¸²æŸ“ï¼ˆé»˜è®¤ Kalimbaï¼‰
    renderBody();

    // å»æŠ½å¡
    const toGachaBtn = stageEl.querySelector('#instrumentToGachaBtn');
    if (toGachaBtn) {
        toGachaBtn.addEventListener('click', () => {
            const hero = document.querySelector('.hero-wrapper');
            if (hero && hero.scrollIntoView) {
                hero.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }
}



// v5.6aï¼šç¬¬äºŒé¢—ç³– Â· æ¶‚é¸¦ / æ¶‚è‰²ç³–
function renderDoodleCandy(stageEl) {
    // 1. å…ˆæŠŠç”»æ¿å’Œå·¥å…·æ¡çš„ HTML å¡«è¿›å»
    let html = '';
   html += '<div class="doodle-toolbar">';
html += '  <div class="doodle-colors">';
html += '    <button type="button" class="doodle-color doodle-color-active" data-color="#616161" style="background:#616161;"></button>';   // æµ…ä¸€ç‚¹çš„æ·±ç°
html += '    <button type="button" class="doodle-color" data-color="#FFCDD2" style="background:#FFCDD2;"></button>';  // æŸ”å’Œçº¢
html += '    <button type="button" class="doodle-color" data-color="#FFF9C4" style="background:#FFF9C4;"></button>';  // æŸ”å’Œé»„
html += '    <button type="button" class="doodle-color" data-color="#BBDEFB" style="background:#BBDEFB;"></button>';  // æŸ”å’Œè“
html += '    <button type="button" class="doodle-color" data-color="#C8E6C9" style="background:#C8E6C9;"></button>';  // æŸ”å’Œç»¿
html += '    <button type="button" class="doodle-color" data-color="#F8BBD0" style="background:#F8BBD0;"></button>';  // æŸ”å’Œç²‰
html += '    <button type="button" class="doodle-color" data-color="#E1BEE7" style="background:#E1BEE7;"></button>';  // æŸ”å’Œç´«
html += '  </div>';
html += '  <button type="button" id="doodleClearBtn" class="doodle-clear-btn">æ¸…ç©º</button>';
html += '</div>';
html += '<div class="doodle-canvas-wrapper">';
html += '  <canvas id="doodleCanvas"></canvas>';
html += '</div>';
html += '<div class="doodle-hint" id="doodleHint">éšæ‰‹ç”»ä¸¤ç¬”å°±å¯ä»¥ï¼Œä¸ç”¨å¥½çœ‹ã€‚</div>';
html += '<button type="button" id="doodleToGachaBtn" class="bubble-to-gacha" style="display:none;">å»æŠ½å¡</button>';

    stageEl.innerHTML = html;

    const canvas = stageEl.querySelector('#doodleCanvas');
    const wrapper = stageEl.querySelector('.doodle-canvas-wrapper');
    const hint    = stageEl.querySelector('#doodleHint');
    const toGachaBtn = stageEl.querySelector('#doodleToGachaBtn');
    const clearBtn   = stageEl.querySelector('#doodleClearBtn');
    const colorBtns  = stageEl.querySelectorAll('.doodle-color');

    if (!canvas || !wrapper) return;

    // 2. è®¾ç½®ç”»å¸ƒå°ºå¯¸ï¼ˆå®½åº¦è·Ÿéšå®¹å™¨ï¼Œé«˜åº¦å›ºå®šä¸º 180 åƒç´ ï¼‰
    const wrapperWidth = wrapper.clientWidth || 260;
    const canvasHeight = 180;
    canvas.width = wrapperWidth;
    canvas.height = canvasHeight;

    const ctx = canvas.getContext('2d');
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

let drawing = false;
let lastX = 0;
let lastY = 0;
let currentColor = '#616161';
let hasDoodled = false;


function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    const touch = evt.touches && evt.touches[0];

    const clientX = (touch ? touch.clientX : evt.clientX);
    const clientY = (touch ? touch.clientY : evt.clientY);

    // å¦‚æœäº‹ä»¶é‡Œæ ¹æœ¬æ‹¿ä¸åˆ°åæ ‡ï¼Œç›´æ¥è¿”å›ä¸Šä¸€æ¬¡çš„ä½ç½®ï¼Œé˜²æ­¢æŠ¥é”™
    if (clientX == null || clientY == null) {
        return { x: lastX, y: lastY };
    }

    // è®¡ç®—ç›¸å¯¹äºç”»å¸ƒå·¦ä¸Šè§’çš„åæ ‡
    let x = clientX - rect.left;
    let y = clientY - rect.top;

    // æŠŠåæ ‡â€œé’‰æ­»â€åœ¨ç”»å¸ƒè¾¹ç•Œå†…ï¼šä¸ä¼šç”»å‡ºç”»å¸ƒä¹‹å¤–
    x = Math.max(0, Math.min(x, canvas.width));
    y = Math.max(0, Math.min(y, canvas.height));

    return { x, y };
}


    function startDraw(evt) {
        evt.preventDefault();
        drawing = true;
        const pos = getPos(evt);
        lastX = pos.x;
        lastY = pos.y;
    }

    function draw(evt) {
        if (!drawing) return;
        evt.preventDefault();
        const pos = getPos(evt);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = 6;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastX = pos.x;
        lastY = pos.y;

        if (!hasDoodled) {
            hasDoodled = true;
            // åªè¦ç”»è¿‡ä¸€ç‚¹ç‚¹ï¼Œå°±è®¤ä¸ºåƒå®Œäº†è¿™é¢—ç³–
            if (!candyEatenThisSession) {
                markCandyDone();
            }
            if (hint) {
                hint.textContent = 'å¾ˆå¥½ï¼Œè¿™æ ·å°±å¤Ÿå•¦ï¼Œå¯ä»¥å»æŠ½ä¸€å¼ å¡ã€‚';
            }
            if (toGachaBtn) {
                toGachaBtn.style.display = 'block';
            }
        }
    }

    function endDraw(evt) {
        if (!drawing) return;
        drawing = false;
    }

    // æ”¯æŒé¼ æ ‡ + è§¦æ‘¸
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', startDraw, { passive: false });
    canvas.addEventListener('touchmove', draw, { passive: false });
    canvas.addEventListener('touchend', endDraw);

    // é¢œè‰²åˆ‡æ¢
    colorBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const color = btn.getAttribute('data-color');
            if (color) {
                currentColor = color;
                // é€‰ä¸­æ€ï¼šå½“å‰é¢œè‰²çš„å°åœ†ç‚¹ç¨å¾®å¤§ä¸€ç‚¹
                colorBtns.forEach(b => b.classList.remove('doodle-color-active'));
                btn.classList.add('doodle-color-active');
            }
        });
    });

    // æ¸…ç©ºç”»å¸ƒ
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasDoodled = false;
            if (hint) {
                hint.textContent = 'é‡æ–°æ¥ä¸€å¼ ä¹Ÿå¯ä»¥ï¼Œéšä¾¿ç”»ã€‚';
            }
            if (toGachaBtn) {
                toGachaBtn.style.display = 'none';
            }
        });
    }

    // â€œå»æŠ½å¡â€æŒ‰é’®ï¼šæ»šåˆ° 01 åŒº
    if (toGachaBtn) {
        toGachaBtn.addEventListener('click', () => {
            const hero = document.querySelector('.hero-wrapper');
            if (hero && hero.scrollIntoView) {
                hero.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }
}
// v6ï¼šæ¶‚è‰²ç³– v2 Â· åŒºåŸŸå¡«è‰²ç‰ˆ

function renderColoringCandy(stageEl) {
    let html = '';
    // å·¥å…·æ¡ï¼šå·¦ä¾§æ˜¯é©¬å¡é¾™è‰²ï¼Œå³ä¾§æ˜¯æ¸…ç©º
    html += '<div class="doodle-toolbar">';
html += '  <div class="doodle-colors">';
html += '    <button type="button" class="doodle-color doodle-color-active" data-color="#616161" style="background:#616161;"></button>';
html += '    <button type="button" class="doodle-color" data-color="#FFCDD2" style="background:#FFCDD2;"></button>';
html += '    <button type="button" class="doodle-color" data-color="#FFF9C4" style="background:#FFF9C4;"></button>';
html += '    <button type="button" class="doodle-color" data-color="#BBDEFB" style="background:#BBDEFB;"></button>';
html += '    <button type="button" class="doodle-color" data-color="#C8E6C9" style="background:#C8E6C9;"></button>';
html += '    <button type="button" class="doodle-color" data-color="#F8BBD0" style="background:#F8BBD0;"></button>';
html += '    <button type="button" class="doodle-color" data-color="#E1BEE7" style="background:#E1BEE7;"></button>';
html += '  </div>';
// æ–°å¢ï¼šçº¿å®½åˆ‡æ¢æŒ‰é’®ç»„
html += '  <div class="doodle-linewidth-group">';
html += '    <button type="button" class="linewidth-btn linewidth-thin linewidth-active" data-width="6">ç»†</button>';
html += '    <button type="button" class="linewidth-btn linewidth-thick" data-width="12">ç²—</button>';
html += '  </div>';
html += '  <button type="button" id="coloringClearBtn" class="doodle-clear-btn">æ¸…ç©º</button>';
html += '</div>';

    // ç”»å¸ƒåŒºåŸŸ
    html += '<div class="doodle-canvas-wrapper">';
    html += '  <canvas id="coloringCanvas"></canvas>';
    html += '</div>';

    // æç¤º + å»æŠ½å¡æŒ‰é’®
    html += '<div class="doodle-hint" id="coloringHint">å°±åƒæ‹¿èœ¡ç¬”éšä¾¿æ¶‚å‡ ç¬”ï¼Œä¸ç”¨å¾ˆå·¥æ•´ã€‚</div>';
    html += '<button type="button" id="coloringToGachaBtn" class="bubble-to-gacha" style="display:none;">å»æŠ½å¡</button>';

    stageEl.innerHTML = html;

    const canvas = stageEl.querySelector('#coloringCanvas');
    const wrapper = stageEl.querySelector('.doodle-canvas-wrapper');
    const hint    = stageEl.querySelector('#coloringHint');
    const toGachaBtn = stageEl.querySelector('#coloringToGachaBtn');
    const clearBtn   = stageEl.querySelector('#coloringClearBtn');
    const colorBtns  = stageEl.querySelectorAll('.doodle-color');

    if (!canvas || !wrapper) return;

    // è®¾ç½®ç”»å¸ƒå°ºå¯¸
    const wrapperWidth = wrapper.clientWidth || 260;
    const canvasHeight = 180;
    canvas.width = wrapperWidth;
    canvas.height = canvasHeight;

    const ctx = canvas.getContext('2d');

    // å…ˆç”»ä¸€æ¬¡çº¿ç¨¿èƒŒæ™¯å›¾
    function drawLineArtBackground() {
        if (typeof coloringBgImg !== 'undefined' && coloringBgImgLoaded) {
            ctx.save();
            // çº¿ç¨¿æœ¬èº«å¯ä»¥ç¨å¾®æ·¡ä¸€ç‚¹ï¼Œå½“ä½œåº•ç¨¿
            ctx.globalAlpha = 0.85;
            ctx.drawImage(coloringBgImg, 0, 0, canvas.width, canvas.height);
            ctx.restore();
        } else if (typeof coloringBgImg !== 'undefined' && !coloringBgImgLoaded) {
            const onLoadOnce = () => {
                coloringBgImgLoaded = true;
                drawLineArtBackground();
                coloringBgImg.removeEventListener('load', onLoadOnce);
            };
            coloringBgImg.addEventListener('load', onLoadOnce);
        }
    }

    drawLineArtBackground();

    let painting = false;
    let lastX = 0;
    let lastY = 0;
    let currentColor = '#616161';
let hasColored = false;
let strokeSteps = 0;           // è®°å½•ç”»äº†å¤šå°‘æ®µ
const threshold = 25;          // ç”»åˆ°ä¸€å®šæ¬¡æ•°å°±ç®—å®Œæˆ
let currentLineWidth = 6;      // é»˜è®¤ç»†çº¿æ¡ 6px


    function getPos(evt) {
        const rect = canvas.getBoundingClientRect();
        const touch = evt.touches && evt.touches[0];

        const clientX = (touch ? touch.clientX : evt.clientX);
        const clientY = (touch ? touch.clientY : evt.clientY);

        if (clientX == null || clientY == null) {
            return { x: rect.width / 2, y: rect.height / 2 };
        }

        let x = clientX - rect.left;
        let y = clientY - rect.top;

        // é™åˆ¶åœ¨ç”»å¸ƒèŒƒå›´å†…ï¼Œä¸ä¼šç”»å‡ºå»
        x = Math.max(0, Math.min(x, canvas.width));
        y = Math.max(0, Math.min(y, canvas.height));

        return { x, y };
    }

    function startPaint(evt) {
        evt.preventDefault();
        painting = true;
        const pos = getPos(evt);
        lastX = pos.x;
        lastY = pos.y;
        drawStrokeTo(pos);
    }

    function drawStrokeTo(pos) {
ctx.strokeStyle = currentColor;
ctx.lineWidth = currentLineWidth;
ctx.lineCap = 'round';
ctx.lineJoin = 'round';


        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();

        lastX = pos.x;
        lastY = pos.y;

        strokeSteps++;

        if (!hasColored && strokeSteps >= threshold) {
            hasColored = true;
            if (!candyEatenThisSession) {
                markCandyDone();
            }
            if (hint) {
                hint.textContent = 'å¾ˆå¥½ï¼Œä»Šå¤©è¿™é¡µå·²ç»æœ‰é¢œè‰²äº†ï¼Œå¯ä»¥å»æŠ½ä¸€å¼ å¡ã€‚';
            }
            if (toGachaBtn) {
                toGachaBtn.style.display = 'block';
            }
        }
    }

    function paint(evt) {
        if (!painting) return;
        evt.preventDefault();
        const pos = getPos(evt);
        drawStrokeTo(pos);
    }

    function endPaint(evt) {
        if (!painting) return;
        painting = false;
    }

    // ç»‘å®šé¼ æ ‡äº‹ä»¶
    canvas.addEventListener('mousedown', startPaint);
    canvas.addEventListener('mousemove', paint);
    canvas.addEventListener('mouseup', endPaint);
    canvas.addEventListener('mouseleave', endPaint);

    // ç»‘å®šè§¦æ‘¸äº‹ä»¶
    canvas.addEventListener('touchstart', startPaint, { passive: false });
    canvas.addEventListener('touchmove', paint, { passive: false });
    canvas.addEventListener('touchend', endPaint);

    // é¢œè‰²åˆ‡æ¢
    colorBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const color = btn.getAttribute('data-color');
            if (color) {
                currentColor = color;
                colorBtns.forEach(b => b.classList.remove('doodle-color-active'));
                btn.classList.add('doodle-color-active');
            }
        });
    });
// çº¿å®½æŒ‰é’®ï¼ˆç»† / ç²—ï¼‰
const widthBtns = stageEl.querySelectorAll('.linewidth-btn');
widthBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const wVal = parseFloat(btn.getAttribute('data-width'));
        if (!isNaN(wVal)) {
            currentLineWidth = wVal;
            widthBtns.forEach(b => b.classList.remove('linewidth-active'));
            btn.classList.add('linewidth-active');
        }
    });
});

    // æ¸…ç©ºç”»å¸ƒï¼šåªæ¸…é™¤æ¶‚è‰²ï¼Œå†é‡æ–°ç”»çº¿ç¨¿åº•å›¾
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawLineArtBackground();
            hasColored = false;
            strokeSteps = 0;
            if (hint) {
                hint.textContent = 'å¯ä»¥é‡æ–°éšä¾¿æ¶‚å‡ ç¬”ï¼Œç©ä¸€ç©å°±å¥½ã€‚';
            }
            if (toGachaBtn) {
                toGachaBtn.style.display = 'none';
            }
        });
    }

    // â€œå»æŠ½å¡â€æŒ‰é’®ï¼šæ»šåˆ° 01 åŒº
    if (toGachaBtn) {
        toGachaBtn.addEventListener('click', () => {
            const hero = document.querySelector('.hero-wrapper');
            if (hero && hero.scrollIntoView) {
                hero.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }
}

// æ¶‚è‰²ç³–çš„çº¿ç¨¿ï¼šå¤©ç©º + åœ°é¢ + ä¸¤åº§å°å±±ä¸˜ + å¤ªé˜³ + äº‘æœµï¼ˆå¤šä¸ªå°é—­åŒºåŸŸï¼‰
// æ¶‚è‰²ç³–çš„çº¿ç¨¿ï¼šå¤©ç©º + åœ°é¢ + ä¸¤åº§å±±ä¸˜ + æ¹–æ³Š + ä¸€æ£µæ ‘ + å¤ªé˜³ + äº‘æœµ
// æ¶‚è‰²ç³–çº¿ç¨¿æ¸²æŸ“ï¼šå…ˆç”»åŒºåŸŸè‰²å—ï¼Œå†æŠŠçº¿ç¨¿åº•å›¾ç›–åœ¨æœ€ä¸Šé¢

function drawColoringTemplate(ctx, w, h, regionColors) {
    regionColors = regionColors || {};
    ctx.save();
    ctx.clearRect(0, 0, w, h);

    // åŸºäºæœ€æ–°çº¿ç¨¿çš„å¤§è‡´ç»“æ„æ¥åˆ’åˆ†å‡ ä¸ªä¸»è¦åŒºåŸŸï¼š
    // ä¸Šæ–¹ï¼šå¤©ç©º + å¤ªé˜³
    // ä¸­é—´ï¼šä¸¤å±‚å±±ä¸˜ + æ¹–é¢
    // ä¸‹æ–¹ï¼šå·¦ä¾§å‰æ™¯è‰åœ° / åœ°é¢ï¼Œå³ä¾§å¤§æ ‘

    // è¿™äº›é«˜åº¦å’Œä½ç½®å…¨éƒ¨ç”¨ã€Œç™¾åˆ†æ¯”ã€æ¥å†™ï¼Œæ–¹ä¾¿å’Œä¸åŒå°ºå¯¸çš„ç”»å¸ƒå¯¹é½
    const hillsTopY    = h * 0.40;  // å±±ä¸˜ä¸Šç¼˜å¤§è‡´ä½ç½®
    const hillsBottomY = h * 0.55;  // å±±ä¸˜ä¸æ¹–äº¤ç•Œ
    const lakeTopY     = h * 0.55;  // æ¹–é¢ä¸Šç¼˜
    const lakeBottomY  = h * 0.75;  // æ¹–é¢ä¸‹ç¼˜
    const groundTopY   = h * 0.75;  // å‰æ™¯è‰åœ°èµ·ç‚¹

    // === 1. å¤©ç©º ===
    ctx.beginPath();
    ctx.rect(0, 0, w, hillsTopY);
    ctx.fillStyle = regionColors.sky || '#FFFFFF';
    ctx.fill();

    // ä¸ºäº†è®©å±±ä¸˜ä¸Šæ–¹è¿˜æœ‰ä¸€ç‚¹å¤©ç©ºç¼“å†²ï¼Œå†ç”»ä¸€å—å¤©ç©ºè¦†ç›–åˆ° hillsBottomY
    ctx.beginPath();
    ctx.rect(0, hillsTopY, w, hillsBottomY - hillsTopY);
    ctx.fillStyle = regionColors.sky || '#FFFFFF';
    ctx.fill();

    // === 2. å·¦å³ä¸¤åº§å±±ä¸˜ï¼ˆå¤§è‡´è´´åˆçº¿ç¨¿çš„å½¢çŠ¶ä¸ä½ç½®ï¼‰ ===
    // å·¦å±±ï¼šå¤§è‡´åœ¨ç”»é¢çš„å·¦ 0â€“60% åŒºåŸŸ
    const hill1CX = w * 0.28;
    const hill1CY = (hillsTopY + hillsBottomY) / 2;
    const hill1RX = w * 0.40;
    const hill1RY = h * 0.25;

    ctx.beginPath();
    ctx.ellipse(hill1CX, hill1CY, hill1RX, hill1RY, 0, Math.PI, 0);
    ctx.lineTo(0, hillsBottomY);
    ctx.lineTo(0, hillsTopY);
    ctx.closePath();
    ctx.fillStyle = regionColors.hill1 || '#FFFFFF';
    ctx.fill();

    // å³å±±ï¼šå¤§è‡´åœ¨ç”»é¢çš„ä¸­éƒ¨åå³ï¼Œè¦†ç›–åˆ° xâ‰ˆ70%
    const hill2CX = w * 0.60;
    const hill2CY = (hillsTopY + hillsBottomY) / 2;
    const hill2RX = w * 0.35;
    const hill2RY = h * 0.23;

    ctx.beginPath();
    ctx.ellipse(hill2CX, hill2CY, hill2RX, hill2RY, 0, Math.PI, 0);
    ctx.lineTo(w, hillsBottomY);
    ctx.lineTo(w, hillsTopY);
    ctx.closePath();
    ctx.fillStyle = regionColors.hill2 || '#FFFFFF';
    ctx.fill();

    // === 3. æ¹–é¢ ===
    // ä½¿ç”¨ä¸€æ¡æ¨ªå‘çš„æ¤­åœ†ï¼Œå¤§è‡´è¦†ç›– JSON é‡Œçš„ x 0â€“80%, y 55â€“75%
    const lakeCX = w * 0.45;
    const lakeCY = (lakeTopY + lakeBottomY) / 2;
    const lakeRX = w * 0.42;
    const lakeRY = (lakeBottomY - lakeTopY) / 2;

    ctx.beginPath();
    ctx.ellipse(lakeCX, lakeCY, lakeRX, lakeRY, 0, 0, Math.PI * 2);
    ctx.fillStyle = regionColors.lake || '#FFFFFF';
    ctx.fill();

    // === 4. å‰æ™¯è‰åœ° / åœ°é¢ ===
    // å·¦ä¸‹è§’æœ‰ä¸€å¤§ç‰‡è‰ï¼Œå³ä¸‹è§’æ˜¯æ ‘è„šä¸‹çš„åœ°é¢ï¼Œè¿™é‡Œåˆå¹¶æˆä¸€ä¸ª ground åŒºåŸŸ
    ctx.beginPath();
    ctx.moveTo(0, groundTopY);
    ctx.lineTo(w * 0.55, h);
    ctx.lineTo(0, h);
    ctx.closePath();
    ctx.fillStyle = regionColors.ground || '#FFFFFF';
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(w * 0.45, groundTopY);
    ctx.lineTo(w, groundTopY + h * 0.05);
    ctx.lineTo(w, h);
    ctx.lineTo(w * 0.55, h);
    ctx.closePath();
    ctx.fillStyle = regionColors.ground || '#FFFFFF';
    ctx.fill();

    // === 5. å¤§æ ‘ï¼ˆæ ‘å¹² + æ ‘å† ï¼‰ ===
    // å¯¹åº” JSON é‡Œçš„ x 65â€“98%, y 5â€“75%
    const treeTrunkWidth  = w * 0.05;
    const treeTrunkHeight = h * 0.26;
    const treeTrunkX = w * 0.78;
    const treeTrunkBottomY = h * 0.92;
    const treeTrunkY = treeTrunkBottomY - treeTrunkHeight;

    const treeCrownCX = treeTrunkX + treeTrunkWidth / 2;
    const treeCrownCY = h * 0.42;
    const treeCrownR  = h * 0.18;

    ctx.beginPath();
    // æ ‘å¹²
    ctx.rect(treeTrunkX, treeTrunkY, treeTrunkWidth, treeTrunkHeight);
    // æ ‘å† 
    ctx.arc(treeCrownCX, treeCrownCY, treeCrownR, 0, Math.PI * 2);
    ctx.fillStyle = regionColors.tree || '#FFFFFF';
    ctx.fill();

    // === 6. å¤ªé˜³ ===
    // å¯¹åº” JSONï¼šx 8â€“22%, y 5â€“25%
    const sunCX = w * 0.15;
    const sunCY = h * 0.16;
    const sunR  = h * 0.07;

    ctx.beginPath();
    ctx.arc(sunCX, sunCY, sunR, 0, Math.PI * 2);
    ctx.fillStyle = regionColors.sun || '#FFFFFF';
    ctx.fill();

    // === 7. æœ€åä¸€å±‚ï¼šå†ç›–ä¸Šçº¿ç¨¿ ===
    if (coloringBgImgLoaded) {
        ctx.save();
        ctx.globalAlpha = 0.7;   // çº¿ç¨¿ç¨å¾®é€ä¸€ç‚¹ï¼Œä¸‹é¢çš„é¢œè‰²èƒ½éœ²å‡ºæ¥
        ctx.drawImage(coloringBgImg, 0, 0, w, h);
        ctx.restore();
    } else {
        // ä¸‡ä¸€åº•å›¾è¿˜æ²¡åŠ è½½å‡ºæ¥ï¼Œå°±ç”¨ä¸€ä¸ªæµ…ç°è¾¹æ¡†å…œåº•
        ctx.strokeStyle = '#D0D0D0';
        ctx.lineWidth = 1;
        ctx.strokeRect(0, 0, w, h);
    }

    ctx.restore();
}
// åƒå®Œç³– â†’ æŠŠ ğŸ¬ æŒ‰é’®å˜æˆä½è°ƒç‰ˆæœ¬ï¼ˆä¸æ˜¯æ‰“å‹¾ï¼Œåªæ˜¯é€€å±…äºŒçº¿ï¼‰
    function markCandyDone() {
        candyEatenThisSession = true;
        const btn = document.getElementById('candyButton');
        if (btn) {
            btn.classList.add('candy-used');
        }
    }

    // æ ‡è®°ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨è¦†ç›–é€ŸåŠ
    let userOverrideFlash = false;

    // ç«‹å³å¼€å§‹é¢„åŠ è½½æ‰“å¡å›¾ï¼ˆä¸ç­‰å¾… DOMContentLoadedï¼Œæ›´æ—©å¼€å§‹åŠ è½½ï¼‰
    // ä½¿ç”¨ requestIdleCallback æˆ– setTimeout é¿å…é˜»å¡å…³é”®èµ„æº
    if (window.requestIdleCallback) {
        requestIdleCallback(() => preloadDailyPosters(), { timeout: 1000 });
    } else {
        setTimeout(preloadDailyPosters, 100);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        
        // å…ˆè¯»å–å¯èƒ½å­˜åœ¨çš„è‡ªå®šä¹‰ä»ªå¼
        loadRitualSettings();
        if(db.length === 0 && archive.length === 0) {
            if (typeof APP_VARIANT !== 'undefined' && APP_VARIANT === 'common') {
                db = defaultDB.filter(item => item.type !== 'vinyl');
            } else {
                db = defaultDB;
            }
        } 
                checkLogExpiry();
        renderList(); renderArchive(); renderLog(); renderHistory(); updateStatsUI();
        setMode('normal');
        hideTarotLayer();

        // è®¡ç®—â€œè¿™æ˜¯ä½ å’Œ Anchor çš„ç¬¬å‡ å¤©â€ï¼Œå¹¶è§†æƒ…å†µå¼¹æ¯æ—¥æ‰“å¡å›¾
        const openDaysCount = initOpenedDays();
        showDailyPosterIfNeeded(openDaysCount);

        applyVariant();


        // åˆå§‹åŒ–ä»ªå¼ç¼–è¾‘åŒºæ–‡æœ¬ï¼šæŠŠå½“å‰ä½¿ç”¨çš„æ­¥éª¤å†™è¿›æ–‡æœ¬æ¡†
        const inputMorning = document.getElementById('ritualMorningInput');
        const inputNight   = document.getElementById('ritualNightInput');
        if (inputMorning) inputMorning.value = ritualMorningSteps.join('\n');
        if (inputNight)   inputNight.value   = ritualNightSteps.join('\n');

        // v6.4 åˆå§‹åŒ–èƒ½é‡è¯ä¸¸ UI
        // v6.5ï¼šæ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½é‡ç½®ä¸º anchor ä¸­é—´æ¡£
        energyMode = 'anchor';
        updateEnergyPillUI();
});

        // ğŸŒ…ğŸŒ™ ä»ªå¼æ­¥éª¤ï¼šå‹¾é€‰æ—¶ç»™æ–‡å­—åŠ ä¸Šåˆ’çº¿
        const ritualStepsEl = document.getElementById('ritualSteps');
        if (ritualStepsEl) {
            ritualStepsEl.addEventListener('change', function (e) {
                const checkbox = e.target;
                if (!checkbox.classList.contains('ritual-step-checkbox')) return;
                const span = checkbox.nextSibling;
                if (span && span.nodeType === 1) {
                    span.classList.toggle('completed', checkbox.checked);
                }
            });
        }

    function scrollToSettings() {
        const sec = document.getElementById('settingSec');
        if (sec) sec.scrollIntoView({ behavior: 'smooth' });
    }

    function save() {
        localStorage.setItem(KEY_DB, JSON.stringify(db));
        localStorage.setItem(KEY_ARCHIVE, JSON.stringify(archive));
        localStorage.setItem(KEY_LOG, JSON.stringify(dailyLog));
        localStorage.setItem(KEY_STATS, JSON.stringify(userStats));
    }

    function renderList() {
        const dailyList = document.getElementById('dailyList');
        const mediaList = document.getElementById('mediaList');
        const coldList  = document.getElementById('coldList');
        if (!dailyList || !mediaList) return;

        dailyList.innerHTML = "";
        mediaList.innerHTML = "";
        if (coldList) coldList.innerHTML = "";

        let dCount = 0, mCount = 0, cCount = 0;
        const todayStr = new Date().toDateString();
        const sortedDB = [...db].sort((a, b) => b.id - a.id);

        sortedDB.forEach(item => {
            const li = document.createElement('li');
            li.className = 'task-item';
            const isDoneToday = (item.recurrence === 'daily' && item.lastDone === todayStr);
            if (isDoneToday) li.classList.add('task-status-done');

            const seriesBadge = item.isSeries ? `<span class="list-badge">âˆç³»åˆ—</span>` : '';
            const cycleBadge = item.recurrence === 'daily'
                ? (isDoneToday ? `<span class="list-badge">ä»Šå¤©âœ…</span>` : `<span class="list-badge">ğŸ”„</span>`)
                : '';

            let extraBadges = "";
            if (item.isFrog) extraBadges += `<span class="list-badge lb-frog">ğŸ¸</span>`;
            if (item.isQuick) extraBadges += `<span class="list-badge lb-flash">âš¡ï¸</span>`;

            let tDisplay = "";
            if (item.time === 0) tDisplay = `<span style="font-size:0.7rem;color:#ccc;margin-left:5px;">ä»»æ„</span>`;
            else if (item.time) tDisplay = `<span style="font-size:0.7rem;color:#ccc;margin-left:5px;">${item.time}m</span>`;

            const isCold = item.inColdStorage === true;

            let actionHtml = "";
            if (isCold) {
                actionHtml = `
                <div style="display:flex;align-items:center;gap:6px;font-size:0.75rem;color:#ccc;">
                    <span class="task-restore" style="cursor:pointer;" onclick="restoreFromColdStorage(${item.id})">â™»ï¸</span>
                    <span class="task-del" style="cursor:pointer;" onclick="tryDeleteItem(${item.id})">ğŸ—‘ï¸</span>
                </div>
                `;
            } else {
                actionHtml = `
                <div style="display:flex;align-items:center;gap:6px;font-size:0.75rem;color:#ccc;">
                    <span class="task-cold" style="cursor:pointer;" onclick="handleColdOrDelete(${item.id})">ğŸ§Š</span>
                </div>
                `;
            }

            // â­ æ ‡é¢˜æ˜¯å¦å¯ç‚¹å‡»ï¼ˆå†·åº“ä¸ç‚¹ï¼Œæ—¥å¸¸ & åª’ä½“å¯ç‚¹ï¼‰
            // v6.5ï¼šæ·»åŠ  4px è§’æ ‡æç¤º
            const hasMemory = (item.bookmarkText && item.bookmarkText.trim()) || 
                             (item.totalMinutes && item.totalMinutes > 0) || 
                             (item.noteText && item.noteText.trim());
            const memoryDot = hasMemory ? '<span style="position:absolute;top:-2px;right:-8px;width:4px;height:4px;background:#6b9bd1;border-radius:50%;"></span>' : '';
            
            let titleSpanHtml;
            if (isCold) {
                // å†·åº“é‡Œåªå±•ç¤ºï¼Œä¸æä¾›â€œç›´æ¥å®Œæˆâ€
                titleSpanHtml = `<span style="position:relative;font-size:0.9rem;color:#555;">${item.title}${memoryDot}</span>`;
            } else {
                // æ—¥å¸¸ä»»åŠ¡åº“ & åª’ä½“åº“é‡Œçš„æ ‡é¢˜ï¼šå¯ç‚¹å‡»æ‰‹åŠ¨å®Œæˆ
                titleSpanHtml = `
                    <span
                        style="position:relative;font-size:0.9rem;color:#555;cursor:pointer;"
                        title="ç‚¹å‡»æ ‡è®°ä»Šå¤©å·²å®Œæˆ"
                        onclick="manualCompleteFromList(${item.id})"
                    >${item.title}${memoryDot}</span>
                `;
            }

            li.innerHTML = `
                <div style="display:flex;align-items:center;gap:5px;">
                    <span style="width:20px;text-align:center;">${getSmartIcon(item)}</span>
                    ${titleSpanHtml}
                    ${seriesBadge}${cycleBadge}${extraBadges}${tDisplay}
                </div>
                ${actionHtml}
            `;

            if (isCold) {
                if (coldList) {
                    coldList.appendChild(li);
                    cCount++;
                }
            } else if (item.type === 'culture' || item.type === 'vinyl') {
                mediaList.appendChild(li);
                mCount++;
            } else {
                dailyList.appendChild(li);
                dCount++;
            }
        });

        const dailyCountEl = document.getElementById('dailyCount');
        const mediaCountEl = document.getElementById('mediaCount');
        const coldCountEl  = document.getElementById('coldCount');

        if (dailyCountEl) dailyCountEl.innerText = dCount;
        if (mediaCountEl) mediaCountEl.innerText = mCount;
        if (coldCountEl) coldCountEl.innerText = cCount;

        const coldContent = document.getElementById('coldContent');
        if (coldContent) {
            const infoP = coldContent.querySelector('p');
            if (infoP) {
                infoP.style.display = cCount === 0 ? 'block' : 'none';
            }
        }
    }

    function renderArchive() {
        const list = document.getElementById('archiveList');
        if(!list) return;
        list.innerHTML = "";
        document.getElementById('arcCount').innerText = archive.length;

        archive.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'archive-item';

            const icon = item.icon || getSmartIcon(item);
            const badge = (item.isFrog || item.type === 'important') ? ' ğŸ…' : '';

            div.innerHTML = `
                <span style="flex:1;">${icon} ${item.title}${badge}</span>
                <span class="archive-del" onclick="deleteArchiveItem(${i})">ğŸ—‘ï¸</span>
            `;
            list.appendChild(div);
        });
    }


    

    function renderLog() {
        const list = document.getElementById('logList');
        if(!list) return;
        list.innerHTML = "";
        const today = new Date().toDateString();
        let count = 0;
        dailyLog.forEach((log, idx) => {
            if (log.date !== today) return;
            count++;
            const li = document.createElement('li');
            li.className = 'task-item';
            const suffix = log.done ? ' âœ…' : '';
            li.innerHTML = `
                <div style="display:flex;align-items:center;gap:0px;width:100%;font-size:0.8rem;">
                    <span class="footprint-time">${log.timeStr || ''}</span>
                    <span class="footprint-item" style="flex:1;">${log.icon || ''} ${log.title}${suffix}</span>
                    <span style="cursor:pointer;color:#c44;margin-left:auto;" title="åˆ é™¤" onclick="deleteLogEntry(${idx})">ğŸ—‘ï¸</span>
                </div>
            `;
            list.appendChild(li);
        });
        const cntEl = document.getElementById('logCount');
        if (cntEl) cntEl.innerText = count;
    }

    // v6.3-edit-buttons-enterï¼šåˆ é™¤ä»Šæ—¥è¶³è¿¹è®°å½•ï¼ˆä¸è£èª‰æ®¿å ‚ä¸€è‡´ï¼ŒäºŒæ¬¡ç¡®è®¤ï¼‰
    function deleteLogEntry(idx) {
        if (idx < 0 || idx >= dailyLog.length) return;
        if (!confirm("ç¡®å®šä»ä»Šæ—¥è¶³è¿¹åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
        dailyLog.splice(idx, 1);
        save();
        renderLog();
        renderHistory();
    }

    function renderHistory() {
        const container = document.getElementById('historyContent');
        if (!container) return;
        if (!Array.isArray(dailyLog) || dailyLog.length === 0) {
            container.innerHTML = `<p style="font-size:0.8rem; color:#777;">æœ€è¿‘æš‚æ— å®Œæˆè®°å½•ã€‚</p>`;
            return;
        }
        const byDate = {};
        dailyLog.forEach((log, idx) => {
            if (!log.date) return;
            if (!byDate[log.date]) byDate[log.date] = [];
            byDate[log.date].push({ ...log, _index: idx });
        });
        const dateKeys = Object.keys(byDate).sort((a,b) => new Date(b) - new Date(a));
        const maxDays = 30;
        let htmlStr = "";
        dateKeys.slice(0, maxDays).forEach(dateStr => {
            const dayLogs = byDate[dateStr];
            const dateLabel = new Date(dateStr).toLocaleDateString();
            htmlStr += `<div style="margin-bottom:8px;">`;
            htmlStr += `<div style="font-size:0.8rem; color:#666; margin-bottom:2px;">${dateLabel}</div>`;
            dayLogs.forEach(log => {
                const suffix = log.done ? ' âœ…' : '';
                
                // v6.5ï¼šæ£€æŸ¥ä»»åŠ¡åº“ä¸­å¯¹åº”ä»»åŠ¡çš„å½“å‰è®°å¿†çŠ¶æ€ï¼ˆè·Ÿéšä»»åŠ¡æœ€æ–°çŠ¶æ€æ˜¾ç¤ºï¼‰
                let currentBookmark = null;
                let currentTotalMinutes = 0;
                let currentNote = null;
                
                // å¦‚æœæœ‰taskIdï¼ŒæŸ¥æ‰¾ä»»åŠ¡åº“ä¸­å¯¹åº”ä»»åŠ¡çš„å½“å‰çŠ¶æ€
                if (log.taskId) {
                    const currentTask = db.find(t => t.id === log.taskId);
                    if (currentTask) {
                        currentBookmark = currentTask.bookmarkText && currentTask.bookmarkText.trim() ? currentTask.bookmarkText : null;
                        currentTotalMinutes = currentTask.totalMinutes || 0;
                        currentNote = currentTask.noteText && currentTask.noteText.trim() ? currentTask.noteText : null;
                    }
                }
                
                // ä¼˜å…ˆä½¿ç”¨ä»»åŠ¡å½“å‰çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å¿«ç…§
                const displayBookmark = currentBookmark || (log.bookmarkSnapshot && log.bookmarkSnapshot.trim() ? log.bookmarkSnapshot : null);
                const displayTotalMinutes = currentTotalMinutes > 0 ? currentTotalMinutes : 0;
                const displayNote = currentNote || (log.noteSnapshot && log.noteSnapshot.trim() ? log.noteSnapshot : null);
                const displayLastAddMinutes = log.lastAddMinutes && log.lastAddMinutes > 0 ? log.lastAddMinutes : null;
                
                // æ˜¾ç¤ºè®°å¿†å‚æ•°ï¼ˆä¸ç®¡æœ‰æ²¡æœ‰âœ…ï¼Œåªè¦æœ‰è®°å¿†å‚æ•°å°±æ˜¾ç¤ºï¼‰
                let memoryInfo = "";
                const hasMemory = displayLastAddMinutes || displayBookmark || displayTotalMinutes > 0 || displayNote;
                
                if (hasMemory) {
                    // æ˜¾ç¤ºæœ¬æ¬¡æŠ•å…¥æ—¶é•¿ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (displayLastAddMinutes) {
                        const hours = Math.floor(displayLastAddMinutes / 60);
                        const mins = displayLastAddMinutes % 60;
                        let timeDisplay = "";
                        if (hours > 0) {
                            timeDisplay = mins > 0 ? `${hours}h${mins}m` : `${hours}h`;
                        } else {
                            timeDisplay = `${mins}m`;
                        }
                        memoryInfo += ` <span class="manual-tag">â± +${timeDisplay}</span>`;
                    }
                    // æ˜¾ç¤ºä¹¦ç­¾
                    if (displayBookmark) {
                        memoryInfo += ` <span class="manual-tag">ğŸ”– ${displayBookmark}</span>`;
                    }
                    // æ˜¾ç¤ºå¤‡æ³¨
                    if (displayNote) {
                        const notePreview = displayNote.split('\n')[0].substring(0, 15);
                        const noteFull = displayNote;
                        const noteId = `note_${log._index || Math.random()}`;
                        memoryInfo += ` <span class="manual-tag note-preview" data-note-id="${noteId}" data-note-full="${noteFull.replace(/"/g, '&quot;')}" style="cursor:pointer;" onclick="toggleNotePreview('${noteId}')">ğŸ“ ${notePreview}${notePreview.length >= 15 ? '...' : ''}</span>`;
                    }
                }
                
                htmlStr += `<div style="font-size:0.8rem; color:#444; display:flex; align-items:center; gap:4px; margin-bottom:2px;">
                    <span style="flex:1;">${log.icon || ''} ${log.title}${suffix}</span>
                    <span style="font-size:0.75rem; color:#999;">${memoryInfo}</span>
                </div>`;
            });
            htmlStr += `</div>`;
        });
        if (!htmlStr) {
            container.innerHTML = `<p style="font-size:0.8rem; color:#777;">æœ€è¿‘æš‚æ— å®Œæˆè®°å½•ã€‚</p>`;
        } else {
            container.innerHTML = htmlStr;
        }
    }

    // v6.5ï¼šå±•å¼€/æ”¶èµ·å¤‡æ³¨é¢„è§ˆ
    function toggleNotePreview(noteId) {
        const el = document.querySelector(`[data-note-id="${noteId}"]`);
        if (!el) return;
        
        const isExpanded = el.dataset.expanded === 'true';
        const noteFull = el.dataset.noteFull || '';
        
        if (isExpanded) {
            // æ”¶èµ·
            const notePreview = noteFull.split('\n')[0].substring(0, 15);
            el.innerHTML = `ğŸ“ ${notePreview}${notePreview.length >= 15 ? '...' : ''}`;
            el.dataset.expanded = 'false';
            el.style.whiteSpace = 'nowrap';
        } else {
            // å±•å¼€
            el.innerHTML = `ğŸ“ ${noteFull.replace(/\n/g, '<br>')}`;
            el.dataset.expanded = 'true';
            el.style.whiteSpace = 'normal';
        }
    }

function updateStatsUI() {
        const elWill = document.getElementById('stat-willpower');
        const elJoy = document.getElementById('stat-joy');
        if(elWill) elWill.innerText = userStats.willpower;
        if(elJoy) elJoy.innerText = userStats.joy;
    }
    
    
function showToast(msg) {
        const t = document.getElementById('toast');
        if(t) {
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        } else {
            alert(msg);
        }
    }

    function incrementStat(type) {
        if (type === 'willpower') { userStats.willpower++; showToast("ğŸ’ª æ„å¿—åŠ› +1"); } 
        else if (type === 'joy') { userStats.joy++; showToast("âœ¨ å°ç¡®å¹¸ +1"); }
        updateStatsUI(); save();
    }

    
function checkLogExpiry() {
        // ä»¥å‰ä¼šåœ¨è¿™é‡Œæ¸…ç†æ‰éä»Šå¤©çš„è¶³è¿¹ï¼›ç°åœ¨ä¿ç•™å®Œæ•´ dailyLog ä½œä¸ºå†å²ã€‚
        // åªåšä¸€ä¸ªè½»é‡ä¿æŠ¤ï¼šç¡®ä¿ dailyLog æ˜¯æ•°ç»„ã€‚
        if (!Array.isArray(dailyLog)) {
            dailyLog = [];
            save();
        }
    }

function parseTimeFromInput(str) {
        let detectedTime = null; let cleanStr = str;
        const regexH = /(\d+(?:\.\d+)?)\s*(h|hr|hour|hours|å°æ—¶)/i;
        let matchH = str.match(regexH);
        if (matchH) { detectedTime = parseFloat(matchH[1]) * 60; cleanStr = cleanStr.replace(matchH[0], '').trim(); }
        if (!detectedTime) {
            const regexM = /(\d+)\s*(m|min|mins|åˆ†|åˆ†é’Ÿ)/i;
            let matchM = str.match(regexM);
            if (matchM) { detectedTime = parseInt(matchM[1]); cleanStr = cleanStr.replace(matchM[0], '').trim(); }
        }
        return { time: detectedTime, title: cleanStr };
    }

function getSmartIcon(item) {
    const titleRaw = item.title || "";
    const title = titleRaw.trim();
    const firstChar = title.charAt(0) || '';

    // === 1ï¼‰ä¹¦å½±ç±»ï¼šä¼˜å…ˆçœ‹ç³»åˆ— / subtypeï¼Œç„¶åå†çœ‹é¦–å­— / å…³é”®è¯ ===
    if (item.type === 'culture') {
        // 1.0 ç³»åˆ—ä¼˜å…ˆï¼šæ‚å¿— / å‘¨åˆŠ / ç³»åˆ— / å…¨é›† ç­‰ï¼Œåœ¨ addNew é‡Œå·²ç»æ‰“äº† isSeries
        if (item.isSeries) {
            return 'ğŸ“º';
        }

        // 1.1 æœ‰ subtype æ—¶æœ€å¯é 
        if (item.subtype === 'book')  return 'ğŸ“–';
        if (item.subtype === 'movie') return 'ğŸ¬';

        // 1.2 æ²¡æœ‰ subtypeï¼Œå†çœ‹é¦–å­—
        if (firstChar === 'è¯»' || firstChar === 'ä¹¦') {
            return 'ğŸ“–';
        }
        if (firstChar === 'çœ‹' || firstChar === 'å½±') {
            return 'ğŸ¬';
        }

        // 1.3 å†å…œåº•çœ‹å…³é”®è¯ï¼ˆå…¼å®¹ç›´æ¥å†™ã€Šä¹¦åã€‹è¿™ç±»ï¼‰
        if (
            title.includes('ä¹¦') ||
            title.includes('è¯»') ||
            title.includes('æ‚å¿—') ||
            title.includes('é˜…è¯»')
        ) {
            return 'ğŸ“–';
        }
        if (
            title.includes('ç”µå½±') ||
            title.includes('å½±') ||
            title.includes('ç‰‡')
        ) {
            return 'ğŸ¬';
        }

        // å®åœ¨åˆ†ä¸å‡ºï¼Œå°±ç»™ä¸€ä¸ªä¸­æ€§çš„æ–‡åŒ–å›¾æ ‡
        return 'ğŸ–¼ï¸';
    }

    // === 2ï¼‰å”±ç‰‡ç±» ===
    if (item.type === 'vinyl') {
        return 'ğŸ’¿';
    }

    // === 3ï¼‰å…¶ä»–ç±»å‹äº¤ç»™é€šç”¨æ˜ å°„ ===
    return getIcon(item.type);
}


    function getIcon(t) {
        const map = { 'indoor':'ğŸ ', 'desktop':'ğŸ’»', 'outdoor':'ğŸŒ³', 'sport':'ğŸƒ', 'culture':'ğŸ¬', 'vinyl':'ğŸ’¿', 'sos':'ğŸš‘' };
        return map[t] || 'âœ¨';
    }

    function getDescByType(t) {
        if(t==='vinyl') return "äº«å—è¿™æ®µéŸ³ä¹æ—¶å…‰ã€‚";
        if(t==='culture') return "æ²‰æµ¸åœ¨æ•…äº‹é‡Œã€‚";
        if(t==='sport') return "åŠ¨èµ·æ¥ï¼";
        return "å»è¡ŒåŠ¨å§ï¼";
    }

    // æ‰­è›‹çƒé¢œè‰²æ˜ å°„
    function getCapsuleSrc(task) {
        if (!task || task.type === 'sos') return null;
        if (task.isFrog) return "/assets/images/gacha/gacha-ball-white.png";
        if (task.isQuick) return "/assets/images/gacha/gacha-ball-yellow.png";
        if (task.type === 'vinyl') return "/assets/images/gacha/gacha-ball-orange.png";
        if (task.type === 'culture') {
            const t = task.title || "";
            if (t.includes("å½±") || t.includes("ç‰‡")) return "/assets/images/gacha/gacha-ball-blue.png";
            return "/assets/images/gacha/gacha-ball-pink.png";
        }
        if (task.type === 'sport') return "/assets/images/gacha/gacha-ball-green.png";
        return "/assets/images/gacha/gacha-ball-purple.png";
    }

    
function renderResultCard(result) {
        const card   = document.getElementById('resultCard');
        const ph     = document.getElementById('placeholder');
        const title  = document.getElementById('rTitle');
        const badge  = document.getElementById('rBadge');
        const descEl = document.getElementById('rDesc');
        const iconEl = document.getElementById('rIcon');
        const timeEl = document.getElementById('rTime');
        const statusEl = document.getElementById('rStatus');
        const changeBtn = document.getElementById('btnChange');
        const primaryBtn = document.getElementById('btnPrimary');
        const ingEl = document.getElementById('rIngPulse');

        if (!card) return;

        if (!result) {
            if (ph) ph.style.display = 'none';
            if (title) title.innerText = "æš‚æ— ä»»åŠ¡";
            if (badge) badge.innerHTML = "";
            if (descEl) descEl.innerText = "ä¼‘æ¯ä¸€ä¸‹ï¼Ÿ";
            if (iconEl) iconEl.innerText = "ğŸŒ™";
            if (timeEl) timeEl.innerText = "";
            if (statusEl) statusEl.style.display = 'none';
            if (ingEl) ingEl.style.display = 'none';
            if (changeBtn) changeBtn.style.display = 'none';
            if (primaryBtn) primaryBtn.style.display = 'none';
        } else {
            if (title) title.innerText = result.title || "";
            if (badge) {
                let badgesHtml = "";
                if (result.isFrog) badgesHtml += `<span class='card-badge bg-frog'>ğŸ¸ é’è›™</span>`;
                if (result.isQuick) badgesHtml += `<span class='card-badge bg-flash'>âš¡ï¸ é€ŸåŠ</span>`;
                if (result.recurrence === 'daily') badgesHtml += `<span class='card-badge bg-cycle'>ğŸ”„ æ¯æ—¥</span>`;
                badge.innerHTML = badgesHtml;
            }
            let displayDesc = result.desc;
            if (!displayDesc || displayDesc === "è‡ªå®šä¹‰") displayDesc = getDescByType(result.type);
            if (descEl) descEl.innerText = displayDesc || "";
            if (iconEl) iconEl.innerText = result.icon || getSmartIcon(result);

            let timeStr = "";
            if (result.type === 'sos')      timeStr = "âš¡ï¸ å³æ—¶";
            else if (result.time === 0)     timeStr = "â³ ä¸°ä¿­ç”±äºº";
            else                            timeStr = `â±ï¸ ${result.time || 30} min`;
            if (timeEl) timeEl.innerText = timeStr;

            // v6.5ï¼šæ˜¾ç¤ºè¿›åº¦æç¤ºè¡Œï¼ˆä¹¦ç­¾å’Œç´¯è®¡æ—¶é•¿ï¼‰
            const progressEl = document.getElementById('rProgress');
            if (progressEl) {
                let progressHtml = "";
                const hasBookmark = result.bookmarkText && result.bookmarkText.trim();
                const hasTotal = result.totalMinutes && result.totalMinutes > 0;
                
                if (hasBookmark || hasTotal) {
                    if (hasBookmark) {
                        progressHtml += `ğŸ”– ${result.bookmarkText}`;
                    }
                    if (hasBookmark && hasTotal) {
                        progressHtml += " Â· ";
                    }
                    if (hasTotal) {
                        const totalMins = result.totalMinutes;
                        let timeDisplay = "";
                        if (totalMins < 60) {
                            timeDisplay = `${totalMins}m`;
                        } else {
                            const hours = Math.floor(totalMins / 60);
                            const mins = totalMins % 60;
                            timeDisplay = mins > 0 ? `${hours}h${mins}m` : `${hours}h`;
                        }
                        progressHtml += `â± æ€»è®¡ ${timeDisplay}`;
                    }
                }
                progressEl.innerHTML = progressHtml;
            }

            if (statusEl) statusEl.style.display = 'none';
            if (ingEl) ingEl.style.display = 'none';
            if (changeBtn) changeBtn.style.display = 'inline-block';
            if (primaryBtn) {
                primaryBtn.style.display = 'inline-block';
                if (result.type === 'sos') {
                    primaryBtn.innerText = "å»å®Œæˆ";
                    currentStatus = 'sos';
                } else {
                    primaryBtn.innerText = "å°±å®ƒå•¦";
                    currentStatus = 'suggest';
                }
            }
        }

        card.style.animation = "none";
        void card.offsetWidth;
        card.style.animation = "stripOpen 0.28s ease-out forwards";
        card.style.display = 'block';
    }

    function setCardAsAnchor() {
        if (!currentTask || currentTask.type === 'sos') return;
        const statusEl = document.getElementById('rStatus');
        const primaryBtn = document.getElementById('btnPrimary');
        const ingEl = document.getElementById('rIngPulse');
        if (statusEl) {
            statusEl.style.display = 'block';
            statusEl.innerText = 'ğŸ“Œ é”šç‚¹ Â· ING...';
        }
        if (ingEl) {
            ingEl.style.display = 'block';
        }
        if (primaryBtn) {
            primaryBtn.innerText = 'å·²å®Œæˆ';
        }
        currentStatus = 'anchor';
        anchorStartTime = Date.now();

        // v6.3-edit-buttons-enterï¼šå°±å®ƒå•¦åå†™å…¥ä»Šæ—¥è¶³è¿¹ï¼ˆæœªå®Œæˆï¼‰
        const dt = new Date();
        const timeStr = dt.getHours().toString().padStart(2, '0') + ":" + dt.getMinutes().toString().padStart(2, '0');
        dailyLog.unshift({
            title: currentTask.title,
            icon: currentTask.icon || getSmartIcon(currentTask),
            timeStr,
            date: dt.toDateString(),
            done: false,
            taskId: currentTask.id
        });
        save();
        renderLog();
        renderHistory();
    }

    function handlePrimaryAction() {
        if (!currentTask) return;
        if (currentTask.type === 'sos') {
            finishTask();
            return;
        }
        if (currentStatus === 'suggest') {
            setCardAsAnchor();
        } else if (currentStatus === 'anchor') {
            finishTask();
        } else {
            draw();
        }
    }

    function changeTask() {
        if (!currentTask) { 
            draw();
            return;
        }
        
        // v6.5ï¼šå¦‚æœå½“å‰ä»»åŠ¡æœ‰å†å²è®°å½•ï¼ˆæœªå®ŒæˆçŠ¶æ€ï¼‰ï¼Œæ›´æ–°è®°å¿†æ•°æ®
        const now = new Date();
        const todayStr = now.toDateString();
        const taskId = currentTask.id;
        
        // æŸ¥æ‰¾ä»»åŠ¡åœ¨ db ä¸­çš„æœ€æ–°çŠ¶æ€
        const taskInDb = db.find(t => t.id === taskId);
        if (taskInDb) {
            // æŸ¥æ‰¾å¹¶æ›´æ–°å†å²è®°å½•
            for (let i = 0; i < dailyLog.length; i++) {
                const log = dailyLog[i];
                if (log.date === todayStr && log.taskId === taskId && !log.done) {
                    // æ›´æ–°è®°å¿†æ•°æ®åˆ°å†å²è®°å½•
                    log.bookmarkSnapshot = taskInDb.bookmarkText || '';
                    log.noteSnapshot = taskInDb.noteText || '';
                    if (taskInDb.lastAddMinutes && taskInDb.lastAddMinutes > 0) {
                        log.lastAddMinutes = taskInDb.lastAddMinutes;
                    }
                    save();
                    renderHistory();
                    break;
                }
            }
        }
        
        currentTask = null;
        currentStatus = 'idle';
        anchorStartTime = null;
        const statusEl = document.getElementById('rStatus');
        const ingEl = document.getElementById('rIngPulse');
        if (statusEl) statusEl.style.display = 'none';
        if (ingEl) ingEl.style.display = 'none';
        draw();
    }

function playGachaAnimation(result) {
        const layer  = document.getElementById('gachaLayer');
        const eggOut = document.getElementById('eggOut');
        const img    = document.getElementById('gachaImg');
        const card   = document.getElementById('resultCard');
        const ph     = document.getElementById('placeholder');
        const btn    = document.getElementById('mainBtn');

        if (!layer || !eggOut || !img) {
            renderResultCard(result);
            return;
        }

        gachaAnimating = true;

        if (btn) {
            btn.disabled = true;
            btn.innerText = "æŠ½å–ä¸­â€¦";
        }
        if (ph)   ph.style.display   = 'none';
        if (card) card.style.display = 'none';

        layer.style.display = 'flex';
        layer.style.opacity = '1';
        img.style.opacity   = '1';

        const src = getCapsuleSrc(result) || "/assets/images/gacha/gacha-ball-pink.png";
        eggOut.src = src;
        eggOut.style.opacity    = 0;
        eggOut.style.animation  = 'none';
        eggOut.style.transition = 'none';
        img.classList.remove('machine-shake');
        void eggOut.offsetWidth;

        setTimeout(() => { img.classList.add('machine-shake'); }, 80);
        setTimeout(() => { eggOut.style.animation = 'eggFly 1.1s ease-out forwards'; }, 260);
        setTimeout(() => { img.style.opacity = '0'; }, 700);

        setTimeout(() => {
            eggOut.style.animation  = 'none';
            eggOut.style.left       = '50%';
            eggOut.style.bottom     = '44%';
            eggOut.style.transform  = 'translateX(-50%) scale(1.25)';
            void eggOut.offsetWidth;

            eggOut.style.animation = 'eggBurst 0.4s ease-out forwards';
            renderResultCard(result);

            layer.style.transition = 'opacity 0.25s ease-out';
            layer.style.opacity    = '0';
        }, 1350);

        setTimeout(() => {
            layer.style.display = 'none';
            layer.style.opacity = '1';
            img.classList.remove('machine-shake');
            img.style.opacity = '1';
            eggOut.style.animation = 'none';

            if (btn) {
                btn.disabled = false;
                if (mode === 'vinyl')        btn.innerText = "ğŸ’¿ æŒ‘å”±ç‰‡";
                else if (mode === 'culture') btn.innerText = "ğŸ¬ ç²¾ç¥é£Ÿç²®";
                else if (mode === 'sos')     btn.innerText = "ğŸš‘ æ•‘æ•‘æˆ‘";
                else                         btn.innerText = "ğŸ”® å¸®æˆ‘é€‰ (æ··åˆ)";
            }
            gachaAnimating = false;
        }, 2000);
    }

    // v6.3-edit-buttons-enterï¼šåŒºåˆ†ç§»åŠ¨ç«¯å’ŒPCç«¯çš„å›è½¦è¡Œä¸º
    function handleEnter(e) {
        if (e.key !== 'Enter') return;
        
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                         || window.innerWidth <= 768;
        
        if (isMobile) {
            // ç§»åŠ¨ç«¯ï¼šEnter å°±æ˜¯æ¢è¡Œï¼Œä¸æ‹¦æˆª
            return;
        } else {
            // PCç«¯ï¼šShift+Enter æ¢è¡Œï¼Œå•ç‹¬ Enter æäº¤
            if (!e.shiftKey) {
                e.preventDefault();
                addNew();
            }
        }
    }

    // v6.4 èƒ½é‡è¯ä¸¸åˆ‡æ¢å‡½æ•°ï¼ˆç‚¹å‡»å¯¹åº”åŒºåŸŸç›´æ¥åˆ‡æ¢åˆ°æŒ‡å®šæ¨¡å¼ï¼‰
    function setEnergyMode(mode) {
        if (energyMode === mode) return;
        
        energyMode = mode;
        
        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('energyMode', energyMode);
        
        // æ›´æ–° UI
        updateEnergyPillUI();
        
        // å¦‚æœåˆ‡æ¢åˆ°å·¦å³æ¡£ï¼ˆUptime/Downtimeï¼‰ï¼Œè‡ªåŠ¨æ”¶èµ·æŠ½å±‰ï¼ˆæš—ç¤ºèƒ½é‡æ¨¡å¼æ¥ç®¡ä¸€åˆ‡ï¼‰
        if (energyMode === 'uptime' || energyMode === 'downtime') {
            if (filterDrawerExpanded) {
                toggleFilterDrawer(false);
            }
        }
    }

    // v6.4 æ›´æ–°èƒ½é‡è¯ä¸¸ UI
    function updateEnergyPillUI() {
        const pill = document.getElementById('energyPill');
        const slider = document.getElementById('energyPillSlider');
        const hint = document.getElementById('energyHint');
        
        if (!pill || !slider || !hint) return;
        
        // ç§»é™¤æ‰€æœ‰æ¨¡å¼ç±»
        pill.classList.remove('uptime', 'anchor', 'downtime');
        pill.classList.add(energyMode);
        
        // æ›´æ–°æ»‘å—å›¾æ ‡ï¼šuptime åªæ˜¾ç¤º â˜€ï¸ï¼Œanchor æ˜¾ç¤º âš“ï¼Œdowntime åªæ˜¾ç¤º â˜ï¸
        const icons = { 'uptime': 'â˜€ï¸', 'anchor': 'âš“', 'downtime': 'â˜ï¸' };
        slider.textContent = icons[energyMode];
        
        // æ›´æ–°æç¤ºè¯­
        const hints = {
            'uptime': ' ğŸ”¥ é«˜èƒ½æ¨è¿›ï¼šè¶ç°åœ¨çŠ¶æ€å¥½ï¼Œå»è§£å†³é‚£åªâ€œé’è›™â€',
            'anchor': 'âš“ éšæœºæ¼«æ­¥ï¼šå‡å°‘çº ç»“ï¼ŒæŠŠä¸‹ä¸€æ­¥äº¤ç»™æ¦‚ç‡ã€‚',
            'downtime': ' ğŸ”‹ å®‰é™è“„èƒ½ï¼šå…è®¸è‡ªå·±åœä¸‹æ¥ï¼Œäº«å—ä½åŠŸè€—æ—¶åˆ»ã€‚'
        };
        hint.textContent = hints[energyMode];
        
        // Anchor æ¨¡å¼ä¸‹ï¼Œé«˜çº§ç­›é€‰æŒ‰é’®å‘¼å¸æé†’
        const toggleBtn = document.getElementById('filterDrawerToggle');
        if (toggleBtn) {
            if (energyMode === 'anchor' && !filterDrawerExpanded) {
                toggleBtn.classList.add('breathing');
            } else {
                toggleBtn.classList.remove('breathing');
            }
        }
    }

    // v6.4 åˆ‡æ¢é«˜çº§ç­›é€‰æŠ½å±‰
    function toggleFilterDrawer(forceState) {
        const drawer = document.getElementById('filterDrawer');
        const toggleBtn = document.getElementById('filterDrawerToggle');
        
        if (!drawer) return;
        
        // å¦‚æœä¼ å…¥äº† forceStateï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™åˆ‡æ¢çŠ¶æ€
        if (forceState !== undefined) {
            filterDrawerExpanded = forceState;
        } else {
            filterDrawerExpanded = !filterDrawerExpanded;
        }
        
        if (filterDrawerExpanded) {
            drawer.classList.add('expanded');
            if (toggleBtn) toggleBtn.textContent = 'ğŸ”¼ æ”¶èµ·ç­›é€‰';
        } else {
            drawer.classList.remove('expanded');
            if (toggleBtn) toggleBtn.textContent = 'ğŸ”½ é«˜çº§ç­›é€‰';
        }
        
        // æ›´æ–°å‘¼å¸æé†’
        updateEnergyPillUI();
    }

    function setMode(m) {
    if (APP_VARIANT === 'common' && m === 'vinyl') m = 'normal';
    // ä¸‹é¢ä¿æŒä½ åŸæ¥çš„ä»£ç ä¸åŠ¨
        mode = m;
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
        const map = { 'normal':0, 'culture':1, 'vinyl':2, 'sos':3 };
        if(map[m] !== undefined) document.querySelectorAll('.mode-tab')[map[m]].classList.add('active');

        const filter = document.getElementById('filterSec');
        const display = document.getElementById('displaySec');
        const normCtl = document.getElementById('controls-normal');
        const sosCtl = document.getElementById('controls-sos');
        const btn = document.getElementById('mainBtn');

        if(m === 'sos') {
            filter.style.background = 'var(--bg-sos)';
            display.style.background = '#F3E5F5';
            normCtl.style.display = 'none';
            sosCtl.style.display = 'flex';
            btn.innerText = "ğŸš‘ æ•‘æ•‘æˆ‘";
            btn.style.background = "#957DAD";
        } else {
            /* æ¸…é™¤å†…è”èƒŒæ™¯ï¼Œä½¿ç”¨ CSS ä¸­çš„æ¸å˜èƒŒæ™¯ */
            filter.style.background = '';
            display.style.background = '';
            normCtl.style.display = 'flex';
            sosCtl.style.display = 'none';
            btn.style.background = "#FF9AA2";
            if(m === 'vinyl') btn.innerText = "ğŸ’¿ æŒ‘å”±ç‰‡";
            else if(m === 'culture') btn.innerText = "ğŸ¬ ç²¾ç¥é£Ÿç²®";
            else btn.innerText = "ğŸ”® å¸®æˆ‘é€‰ (æ··åˆ)";
        }
    }
    
    
// === v6.3ï¼šæŠ½å¡æ¨¡å¼è°ƒåº¦å™¨ï¼ˆclassic / tarotï¼‰ ===
const DRAW_MODES = ['classic', 'tarot'];
let lastDrawMode = 'tarot'; // è®©ç¬¬ä¸€æ¬¡ä» classic å¼€å§‹ï¼Œä¹‹å classic â†” tarot è½®æµå‡ºç°

function pickDrawMode() {
    // v6.3 v2ï¼šä¸¤ç§æ¨¡å¼è½®ç€æ¥ï¼ˆclassic â†’ tarot â†’ classic...ï¼‰
    const next = (lastDrawMode === 'classic') ? 'tarot' : 'classic';
    lastDrawMode = next;
    return next;
}

// æŠŠ v6.2 draw() é‡Œâ€œæ ¹æ®ç­›é€‰/é˜²é‡å¤/é’è›™ä¼˜å…ˆâ€ç­‰é€»è¾‘æŠ½å‡ºæ¥ï¼Œæ–¹ä¾¿å¡”ç½—æ¨¡å¼å¤ç”¨

// v6.4 é‡å†™ pickTaskByFiltersï¼šå®ç°èƒ½é‡è¯ä¸¸ç­›é€‰é€»è¾‘
function pickTaskByFilters() {
    const ctx = document.getElementById('selContext').value;
    const limitTime = parseInt(document.getElementById('selTime').value);
    const todayStr = new Date().toDateString();

    // Step 1: ç‰©ç†é“å¾‹è¿‡æ»¤ï¼ˆHard Filtersï¼‰
    let validPool = db.filter(item => {
        // å†·å®«ä»»åŠ¡å¿…é¡»æ’é™¤
        if (item.inColdStorage === true) return false;
        
        // æ—¥å¸¸ä»»åŠ¡ï¼šå¦‚æœä»Šå¤©å·²å®Œæˆï¼Œè·³è¿‡
        if (item.recurrence === 'daily' && item.lastDone === todayStr) return false;
        
        return true;
    });

    // Step 2: æ¨¡å¼åˆ†æ”¯ç­–ç•¥ï¼ˆMode Strategyï¼‰
    if (energyMode === 'anchor') {
        // åˆ†æ”¯ Aï¼šä¸­é—´æ¡£ (Anchor) - å®Œå…¨æ²¿ç”¨ v6.3 çš„é€»è¾‘
        validPool = validPool.filter(item => {
            const tTime = (item.time === undefined || item.time === null) ? 30 : item.time;
            const isFlexible = (tTime === 0);
            
            // æ—¶é•¿é™åˆ¶
            if (!isFlexible && !item.isQuick && tTime > limitTime) return false;

            // mode è¿‡æ»¤ï¼ˆvinyl/cultureï¼‰
            if (mode === 'vinyl') return item.type === 'vinyl';
            if (mode === 'culture') return item.type === 'culture';

            // åœ°ç‚¹è¿‡æ»¤
            if (item.type === 'culture' || item.type === 'vinyl') {
                if (ctx === 'outdoor') return false;
            } else if (item.type === 'sport') {
                return true;
            } else {
                if (ctx === 'desktop') return item.type !== 'outdoor';
                if (ctx === 'indoor')  return item.type === 'indoor';
                if (ctx === 'outdoor') return item.type === 'outdoor';
            }
            return true;
        });
    } else {
        // åˆ†æ”¯ Bï¼šå·¦å³æ¡£ (Uptime / Downtime) - æ™ºèƒ½æ¥ç®¡
        const ctxEl = document.getElementById('selContext');
        const userSelectedContext = ctxEl ? ctxEl.value : 'desktop';
        
        // å¦‚æœæŠ½å±‰æœªå±•å¼€ï¼Œå¿½ç•¥åœ°ç‚¹é™åˆ¶ï¼Œå…¨åŸŸæœç´¢ï¼›å¦‚æœå±•å¼€ï¼Œå°Šé‡ç”¨æˆ·é€‰æ‹©
        const shouldRespectLocation = filterDrawerExpanded;
        
        validPool = validPool.filter(item => {
            // æ—¶é•¿ï¼šå¿½ç•¥ä¸‹æ‹‰æ¡†é™åˆ¶ï¼ˆUptime/Downtime æ¨¡å¼ä¸‹å…è®¸æ‰€æœ‰æ—¶é•¿ï¼‰
            
            // mode è¿‡æ»¤ï¼ˆvinyl/cultureï¼‰ä»ç„¶ç”Ÿæ•ˆ
            if (mode === 'vinyl') return item.type === 'vinyl';
            if (mode === 'culture') return item.type === 'culture';

            // åœ°ç‚¹è¿‡æ»¤
            if (!shouldRespectLocation) {
                // æœªå±•å¼€æŠ½å±‰ï¼šå¿½ç•¥åœ°ç‚¹é™åˆ¶ï¼Œå…¨åŸŸæœç´¢ï¼ˆä½†æˆ·å¤–æ—¶ä»…ç¦ vinylï¼Œå…è®¸ culture:book/seriesï¼‰
                if (item.type === 'vinyl' && userSelectedContext === 'outdoor') return false;
                return true;
            } else {
                // å·²å±•å¼€æŠ½å±‰ï¼šå°Šé‡ç”¨æˆ·é€‰æ‹©çš„åœ°ç‚¹
                if (item.type === 'culture' || item.type === 'vinyl') {
                    // æˆ·å¤–åœºæ™¯ï¼šå…è®¸ cultureï¼ˆåŒ…æ‹¬ book/seriesï¼‰ï¼Œä»…ç¦ vinyl
                    if (userSelectedContext === 'outdoor') {
                        return item.type !== 'vinyl'; // culture å…è®¸ï¼Œvinyl ç¦æ­¢
                    }
                    // å…¶ä»–åœ°ç‚¹ï¼ˆdesktop/indoorï¼‰ï¼šculture å’Œ vinyl éƒ½å…è®¸
                    return true;
                } else if (item.type === 'sport') {
                    return true; // sport åœ¨æ‰€æœ‰åœ°ç‚¹éƒ½å…è®¸
                } else {
                    // æ™®é€šä»»åŠ¡ç±»å‹ï¼šæŒ‰åœ°ç‚¹ç­›é€‰
                    if (userSelectedContext === 'desktop') return item.type !== 'outdoor';
                    if (userSelectedContext === 'indoor')  return item.type === 'indoor';
                    if (userSelectedContext === 'outdoor') return item.type === 'outdoor';
                }
            }
            return true;
        });
    }

    // Step 3: åŠ æƒéšæœº (Weighted Randomness)
    if (validPool.length === 0) {
        // å…œåº•ï¼šå¦‚æœ Uptime/Downtime æ¨¡å¼ä¸‹è¿‡æ»¤ç»“æœä¸ºç©ºï¼Œé™çº§ä¸º Anchor æ¨¡å¼
        if (energyMode === 'uptime' || energyMode === 'downtime') {
            const originalMode = energyMode;
            energyMode = 'anchor';
            const fallbackResult = pickTaskByFilters();
            energyMode = originalMode;
            if (fallbackResult) {
                if (typeof showToast === 'function') {
                    showToast('å½“å‰æ¨¡å¼æ— åˆé€‚ä»»åŠ¡ï¼Œå·²è‡ªåŠ¨æ··åˆæŠ½å–');
                }
                return fallbackResult;
            }
        }
        return null;
    }

    // è®¡ç®—æƒé‡
    const weightedPool = validPool.map(item => {
        let weight = 10; // åŸºç¡€åˆ†

        if (energyMode === 'uptime') {
            // ğŸ”´ æ¨è¿›æ¨¡å¼ (Uptime)
            if (item.isFrog === true) weight *= 100; // ç»å¯¹ä¼˜å…ˆ
            else if (item.type === 'desktop') weight *= 20;
            else if (item.subtype === 'book') weight *= 15;
            else if (item.type === 'sport') weight *= 10;
            else if (item.type === 'indoor') weight *= 5;
            else if (item.subtype === 'movie') weight *= 2;
            
            // å±è”½é¡¹
            if (item.isSeries === true || item.type === 'vinyl' || item.type === 'sos') weight = 0;
        } else if (energyMode === 'downtime') {
            // ğŸ”µ è“„èƒ½æ¨¡å¼ (Downtime)
            if (item.isSeries === true) weight *= 30;
            else if (item.subtype === 'movie') weight *= 20;
            else if (item.type === 'vinyl') weight *= 20;
            else if (item.type === 'outdoor') weight *= 15;
            else if (item.type === 'indoor' && item.isQuick === true) weight *= 10;
            else if (item.subtype === 'book') weight *= 8;
            
            // å±è”½é¡¹
            if (item.isFrog === true) weight = 0;
        }
        // âšªï¸ é”šå®šæ¨¡å¼ (Anchor)ï¼šæ‰€æœ‰ä»»åŠ¡æƒé‡ x1 (å‡åŒ€éšæœº)ï¼Œå·²ç»åœ¨ä¸Šé¢å¤„ç†

        return { item, weight };
    }).filter(entry => entry.weight > 0);

    if (weightedPool.length === 0) {
        // å†æ¬¡å…œåº•
        if (energyMode === 'uptime' || energyMode === 'downtime') {
            const originalMode = energyMode;
            energyMode = 'anchor';
            const fallbackResult = pickTaskByFilters();
            energyMode = originalMode;
            if (fallbackResult && typeof showToast === 'function') {
                showToast('å½“å‰æ¨¡å¼æ— åˆé€‚ä»»åŠ¡ï¼Œå·²è‡ªåŠ¨æ··åˆæŠ½å–');
            }
            return fallbackResult;
        }
        return null;
    }

    // æŒ‰æƒé‡éšæœºé€‰æ‹©
    const totalWeight = weightedPool.reduce((sum, entry) => sum + entry.weight, 0);
    let random = Math.random() * totalWeight;
    
    for (const entry of weightedPool) {
        random -= entry.weight;
        if (random <= 0) {
            return entry.item;
        }
    }

    // æœ€åçš„å…œåº•
    return weightedPool[0].item;
}
// Tarot flow state
let tarotState = 'idle'; // idle | shuffling | choose | reveal
let tarotChosenTask = null;
let tarotLuckyIndex = 0;
let tarotRerollLeft = 3;

function hideClassicGachaLayer() {
    const gacha = document.getElementById('gachaLayer');
    if (gacha) gacha.style.display = 'none';
}

function showTarotLayer() {
    const layer = document.getElementById('tarotLayer');
    if (layer) layer.style.display = 'flex';
}

function hideTarotLayer() {
    const layer = document.getElementById('tarotLayer');
    const cards = document.getElementById('tarotCards');
    const deck  = document.getElementById('tarotDeck');
    const skip  = document.getElementById('tarotSkipLink');
    if (layer) layer.style.display = 'none';
    if (cards) cards.innerHTML = '';
    if (deck) deck.classList.remove('shuffling');
    if (skip) skip.style.display = 'none';
    tarotState = 'idle';
}

function prepareTarotScene(task) {
    tarotChosenTask = task;
    tarotLuckyIndex = Math.floor(Math.random() * 7);
    tarotState = 'idle';

    const caption = document.getElementById('tarotCaption');
    const sub = document.getElementById('tarotSubCaption');
    const deck = document.getElementById('tarotDeck');
    const cards = document.getElementById('tarotCards');
    const skip = document.getElementById('tarotSkipLink');

    if (caption) caption.textContent = 'ä»Šå¤©è®©å¡”ç½—å¸®ä½ æŠ½å‡ºä¸€å¼  Anchor å¡ã€‚';
    if (sub) sub.textContent = 'ç‚¹ä¸€ä¸‹ç‰Œå †ï¼Œå¼€å§‹æ´—ç‰Œã€‚';
    if (cards) cards.innerHTML = '';
    
    // â˜… æ–°å¢ï¼šç¡®ä¿æ¯æ¬¡å¼€å§‹æ—¶ï¼Œç‰Œå †æ˜¯å¯è§çš„
    if (deck) {
        deck.style.opacity = '1';
        deck.classList.remove('shuffling');
        deck.onclick = () => {
            if (tarotState !== 'idle') return;
            startTarotShuffle();
        };
    }

    if (skip) {
        skip.style.display = 'block';
        skip.onclick = () => {
            hideTarotLayer();
            playGachaAnimation(tarotChosenTask);
        };
    }

    showTarotLayer();
}

function startTarotShuffle() {
    const deck = document.getElementById('tarotDeck');
    const sub = document.getElementById('tarotSubCaption');
    if (sub) sub.textContent = 'æ´—ç‰Œä¸­â€¦';
    tarotState = 'shuffling';
    if (deck) {
        deck.classList.remove('shuffling');
        void deck.offsetWidth;
        deck.classList.add('shuffling');
    }
    setTimeout(() => {
        spreadTarotCards();
    }, 900);
}

function spreadTarotCards() {
    const sub = document.getElementById('tarotSubCaption');
    const cardsWrap = document.getElementById('tarotCards');
    const deck = document.getElementById('tarotDeck');
    
    if (!cardsWrap) return;
    if (deck) deck.style.opacity = '0';

    if (sub) sub.textContent = 'å‡­ç›´è§‰ï¼Œé€‰ä¸€å¼ ä»Šå¤©çš„å¡ç‰Œã€‚';
    cardsWrap.innerHTML = '';
    tarotState = 'choose';

    // è§’åº¦è°ƒå°ä¸€ç‚¹ï¼Œæ˜¾å¾—æ›´ä¼˜é›…
    const angles = [-20, -14, -7, 0, 7, 14, 20];
    
    // Yè½´åŸºå‡†
    const baseY = 15; 

    for (let i = 0; i < 7; i++) {
        const card = document.createElement('div');
        card.className = 'tarot-card';
        card.dataset.index = String(i);

        // â˜… ä¿®æ”¹ç‚¹ï¼šé—´è·ä» 38 æ”¹ä¸º 34ï¼Œé˜²æ­¢æœ€å³è¾¹çš„ç‰Œè·‘å¤ªè¿œ
        const gap = 34; 
        const x = (i - 3) * gap; 
        
        // â˜… ä¿®æ”¹ç‚¹ï¼šå¼§åº¦ç³»æ•° 8 -> 6ï¼Œè®©å®ƒå¹³ç¼“ä¸€ç‚¹ï¼Œä¸è‡³äºæ‰å‡ºå±å¹•
        const y = baseY + Math.pow(Math.abs(i - 3), 1.8) * 6; 

        const a = angles[i];

        // åˆå§‹ä½ç½®
        card.style.transform = `translate(-50%, -50%) scale(0.5)`;
        card.style.opacity = '0';

        // ç»“æ„
        card.innerHTML = `
            <div class="tarot-face tarot-back"></div>
            <div class="tarot-face tarot-front">
                <span class="t-icon">âœ¨</span>
                <div class="t-title">...</div>
                <div class="t-desc">...</div>
                <button class="t-btn" type="button">æ”¶ä¸‹</button>
            </div>
        `;

        card.addEventListener('click', (e) => {
            // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢ç‚¹ç©¿
            e.stopPropagation();
            handleTarotCardClick(i);
        });
        cardsWrap.appendChild(card);

        // åŠ¨ç”»
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) rotate(${a}deg)`;
        }, i * 40); 
    }
}

function handleTarotCardClick(index) {
    if (tarotState !== 'choose') return;
    const cardsWrap = document.getElementById('tarotCards');
    if (!cardsWrap) return;

    tarotState = 'reveal';

    const cards = Array.from(cardsWrap.querySelectorAll('.tarot-card'));
    
    // 1. å…¶ä»–ç‰Œå˜æš—
    cards.forEach((c, i) => {
        if (i !== index) c.classList.add('dim');
    });

    // 2. é€‰ä¸­ç‰Œå¤„ç†
    const selected = cards[index];
    if (!selected) return;
    selected.classList.add('selected');
    
    // 3. å¡«å……ä»»åŠ¡å†…å®¹ï¼ˆåƒ ResultCard é‚£æ ·ï¼‰
    // æ— è®ºç‚¹å“ªå¼ ï¼Œå…¶å®éƒ½æ˜¯å‘½ä¸­ tarotChosenTaskï¼ˆè¿™æ˜¯å‘½è¿çš„å®‰æ’ï¼‰
    const tIcon  = selected.querySelector('.t-icon');
    const tTitle = selected.querySelector('.t-title');
    const tDesc  = selected.querySelector('.t-desc');
    const tBtn   = selected.querySelector('.t-btn');

    if (tarotChosenTask) {
        if (tIcon) tIcon.textContent = tarotChosenTask.icon || getSmartIcon(tarotChosenTask);
        if (tTitle) tTitle.textContent = tarotChosenTask.title;
        // æè¿°ï¼šå¦‚æœæ˜¯è‡ªå®šä¹‰æè¿°å°±æ˜¾ç¤ºæè¿°ï¼Œå¦åˆ™æ˜¾ç¤ºé»˜è®¤ç±»å‹æ–‡æ¡ˆ
        let d = tarotChosenTask.desc;
        if (!d || d === 'è‡ªå®šä¹‰' || d === 'ç³»åˆ—' || d === 'æ¯æ—¥ä»»åŠ¡') d = getDescByType(tarotChosenTask.type);
        if (tDesc) tDesc.textContent = d;
    }

    // 4. æŒ‰é’®é€»è¾‘ï¼šç‚¹å‡»â€œæ”¶ä¸‹â€åï¼Œè¿›å…¥ä¸»ç•Œé¢
    if (tBtn) {
        tBtn.onclick = (e) => {
            e.stopPropagation(); // é˜²æ­¢å†’æ³¡
            // éšè—å¡”ç½—å±‚
            hideTarotLayer();
            // æ¸²æŸ“ä¸»ç»“æœå¡ï¼Œå¹¶æ ‡è®°ä¸ºâ€œå½“å‰ä»»åŠ¡â€
            currentTask = tarotChosenTask;
            renderResultCard(tarotChosenTask);
        };
    }

    // 5. æ‰§è¡Œç¿»è½¬åŠ¨ç”»
    // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œè®©å˜æš—çš„åŠ¨ç”»å…ˆèµ°ä¸€èµ°
    setTimeout(() => {
        selected.classList.add('reveal');
    }, 50);
}

function runTarotDrawFlow(result) {
    // è¿›å…¥å¡”ç½—å‰ï¼šéšè—ç»å…¸æ‰­è›‹å±‚/ç»“æœå¡
    const card = document.getElementById('resultCard');
    if (card) card.style.display = 'none';
    hideClassicGachaLayer();

    // åˆå§‹åŒ–æ¢ç‰Œæ¬¡æ•°
    tarotRerollLeft = 3;
    prepareTarotScene(result);
}


function draw() {
        const card = document.getElementById('resultCard'); 
        if (card) card.style.display = 'none';

        // ğŸ‘‰ å¦‚æœæœ‰èµ·åºŠ/ç¡å‰ä»ªå¼å¡åœ¨ï¼Œå°±å…ˆå…³æ‰
        const overlay = document.getElementById('ritualOverlay');
        if (overlay) overlay.style.display = 'none';

        // è¿›å…¥æŠ½å¡å‰ï¼Œå…ˆç¡®ä¿å¡”ç½—å±‚è¢«æ”¶èµ·ï¼ˆé¿å…æ®‹ç•™ï¼‰
        hideTarotLayer();

        if (mode !== 'sos' && gachaAnimating) return;

        setTimeout(() => {
            let result = null;

            if (mode === 'sos') { 
                const r = Math.floor(Math.random() * sosLibrary.length); 
                result = { ...sosLibrary[r], type: 'sos', time: 0 }; 
            } else {
                result = pickTaskByFilters();
            }

            // æ›´æ–°å½“å‰ä»»åŠ¡å¼•ç”¨ï¼ˆè®©åç»­â€œå°±å®ƒå•¦/æ¢ä¸€ä¸ªâ€ç­‰ä¸»çº¿é€»è¾‘ä¿æŒä¸€è‡´ï¼‰
            currentTask = result;

            const ph = document.getElementById('placeholder');

            if (result) {
                if (ph) ph.style.display = 'none';

                if (mode === 'sos') {
                    renderResultCard(result);
                } else {
                    const drawMode = pickDrawMode();
                    if (drawMode === 'tarot') {
                        runTarotDrawFlow(result);
                    } else {
                        playGachaAnimation(result);
                    }
                }
            } else {
                if (ph) ph.style.display = 'none';
                renderResultCard(null);
            }
        }, 300);
    }

    // ğŸŒ…ğŸŒ™ èµ·é£ / ç€é™†ï¼šæ‰“å¼€æµ®å±‚
        function dimRitualButton(type) {
        if (!type) return;
        const selector = type === 'morning'
            ? '.ritual-icon-btn[data-ritual="morning"]'
            : '.ritual-icon-btn[data-ritual="night"]';
        const btn = document.querySelector(selector);
        if (btn) {
            btn.classList.add('dimmed');
        }
    }
function openRitual(type) {
    currentRitualType = type; // 'morning' or 'night'
    const overlay = document.getElementById('ritualOverlay');
    const titleEl = document.getElementById('ritualTitle');
    const iconEl  = document.getElementById('ritualIcon');
    const listEl  = document.getElementById('ritualSteps');
    if (!overlay || !titleEl || !listEl) return;

    const steps = type === 'morning' ? ritualMorningSteps : ritualNightSteps;

    // é¡¶éƒ¨å¤§å›¾æ ‡ + ç®€çŸ­æ ‡é¢˜
    if (iconEl) {
        iconEl.textContent = (type === 'morning') ? 'ğŸŒ…' : 'ğŸŒ™';
    }
    titleEl.textContent = (type === 'morning') ? 'èµ·åºŠèµ·é£' : 'ç¡å‰ç€é™†';


    // å…ˆæŠŠå…¶ä»–ç»“æœåŒºçŠ¶æ€éƒ½æ”¶èµ·æ¥
    const resultCard = document.getElementById('resultCard');
    const placeholder = document.getElementById('placeholder');
    const gachaLayer = document.getElementById('gachaLayer');

    if (resultCard) resultCard.style.display = 'none';
    if (placeholder) placeholder.style.display = 'none';
    if (gachaLayer) gachaLayer.style.display = 'none';

    // æ¸…ç©ºå¹¶ç”Ÿæˆæ­¥éª¤ï¼ˆä¿æŒä½ ä¹‹å‰å‹¾é€‰é€»è¾‘ï¼‰
    listEl.innerHTML = '';
    steps.forEach((text, index) => {
        if (!text) return;
        const li = document.createElement('li');

        const label = document.createElement('label');
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '6px';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'ritual-step-checkbox';

        const span = document.createElement('span');
        span.textContent = text;

        label.appendChild(checkbox);
        label.appendChild(span);
        li.appendChild(label);
        listEl.appendChild(li);
    });

    // æ˜¾ç¤ºä»ªå¼å¡ç‰‡
    overlay.style.display = 'block';

    // ä»ªå¼ä¸æ˜¯â€œä»»åŠ¡æŠ½å¡â€ï¼Œæ‰€ä»¥æ¸…æ‰ currentTask
    if (typeof currentTask !== 'undefined') {
        currentTask = null;
    }
}

    // å…³é—­æµ®å±‚ï¼ˆä¸å†™å…¥è¶³è¿¹ï¼‰
    function closeRitual() {
    const overlay = document.getElementById('ritualOverlay');
    if (overlay) overlay.style.display = 'none';

    // ä»ªå¼ç»“æŸåï¼Œæ¢å¤é»˜è®¤å ä½ & æ‰­è›‹æœº
    const placeholder = document.getElementById('placeholder');
    const gachaLayer = document.getElementById('gachaLayer');
    const resultCard = document.getElementById('resultCard');

    if (placeholder) placeholder.style.display = 'block';
    if (gachaLayer) gachaLayer.style.display = 'block';
    if (resultCard) resultCard.style.display = 'none';

    currentRitualType = null;
}


    // å®Œæˆä»ªå¼ï¼šåœ¨ä»Šæ—¥è¶³è¿¹å†™ä¸€æ¡è®°å½•
    function completeRitual() {
        if (!currentRitualType) {
            closeRitual();
            return;
        }

        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        const icon = currentRitualType === 'morning' ? 'ğŸŒ…' : 'ğŸŒ™';
        const title = currentRitualType === 'morning' ? 'èµ·åºŠèµ·é£' : 'ç¡å‰ç€é™†';

        dailyLog.unshift({
            title: title,
            icon: icon,
            timeStr: timeStr,
            date: now.toDateString(),
            done: true
        });

        save();
        renderLog();
        if (typeof renderHistory === 'function') renderHistory();

               const overlay = document.getElementById('ritualOverlay');
    if (overlay) overlay.style.display = 'none';

    // å®Œæˆåæ¢å¤é»˜è®¤å ä½ & æ‰­è›‹æœº
    const placeholder = document.getElementById('placeholder');
    const gachaLayer = document.getElementById('gachaLayer');
    const resultCard = document.getElementById('resultCard');

    if (placeholder) placeholder.style.display = 'block';
    if (gachaLayer) gachaLayer.style.display = 'block';
    if (resultCard) resultCard.style.display = 'none';

    // æœ¬æ¬¡ä¼šè¯å†…ï¼Œè®©å¯¹åº”çš„å°å›¾æ ‡æ·¡ä¸€äº›
    dimRitualButton(currentRitualType);

    showToast(icon === 'ğŸŒ…' ? 'ğŸŒ… èµ·é£å•¦ï¼' : 'ğŸŒ™ ç€é™†å®Œæˆ');
    currentRitualType = null;
}
   

    /**
     * é€šç”¨å®Œæˆé€»è¾‘æ ¸å¿ƒï¼š
     * - task: è¦å®Œæˆçš„ä»»åŠ¡å¯¹è±¡ï¼ˆå¯ä»¥æ¥è‡ª currentTaskï¼Œä¹Ÿå¯ä»¥æ¥è‡ªåˆ—è¡¨ dbï¼‰
     * - options.silentCard: true æ—¶ä¸åŠ¨ç»“æœå¡ç‰‡ / é”šç‚¹çŠ¶æ€ï¼ˆç”¨äºåˆ—è¡¨æ‰‹åŠ¨å®Œæˆï¼‰
     */
    function completeTaskCore(task, options) {
        if (!task) return;

        const opts = options || {};
        const silent = !!opts.silentCard;

        // åªæœ‰åœ¨â€œä¸æ˜¯ silentâ€çš„æ—¶å€™ï¼Œæ‰å»æ“ä½œç»“æœå¡ç‰‡ç›¸å…³ DOM
        const card     = silent ? null : document.getElementById('resultCard');
        const statusEl = silent ? null : document.getElementById('rStatus');
        const ingEl    = silent ? null : document.getElementById('rIngPulse');

        // SOS æ¨¡å¼ï¼šåªé‡ç½®çŠ¶æ€ï¼Œä¸è®°å…¥è¶³è¿¹/è£èª‰æ®¿å ‚ï¼ˆç†è®ºä¸Šä¸ä¼šä»åˆ—è¡¨è§¦å‘ï¼‰
        if (task.type === 'sos') {
            if (!silent) {
                showToast("çŠ¶æ€é‡å¯ï¼ğŸŒ±");
                if (card) card.style.display = 'none';
                currentTask = null;
                if (typeof currentStatus !== 'undefined') currentStatus = 'idle';
                if (typeof anchorStartTime !== 'undefined') anchorStartTime = null;
                if (statusEl) statusEl.style.display = 'none';
                if (ingEl) ingEl.style.display = 'none';
            }
            return;
        }

        // å†™å…¥ã€Œä»Šæ—¥è¶³è¿¹ / å†å²è®°å½•ã€ï¼šå¦‚æœå·²æœ‰â€œå°±å®ƒå•¦â€è®°å½•åˆ™æ ‡è®°ä¸ºå®Œæˆï¼Œå¦åˆ™è¡¥ä¸€æ¡å®Œæˆè®°å½•
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');

        // v6.5ï¼šä¿å­˜ä¹¦ç­¾å’Œå¤‡æ³¨å¿«ç…§ï¼ˆä½¿ç”¨ä»»åŠ¡çš„æœ€æ–°çŠ¶æ€ï¼‰
        // å¦‚æœä»»åŠ¡åœ¨ db ä¸­ï¼Œä½¿ç”¨ db ä¸­çš„æœ€æ–°çŠ¶æ€ï¼›å¦åˆ™ä½¿ç”¨ä¼ å…¥çš„ task
        const taskInDb = db.find(t => t.id === task.id);
        const finalTask = taskInDb || task;
        const bookmarkSnapshot = finalTask.bookmarkText || '';
        const noteSnapshot = finalTask.noteText || '';
        const lastAddMinutes = finalTask.lastAddMinutes || 0;

        let marked = false;
        for (let i = 0; i < dailyLog.length; i++) {
            const log = dailyLog[i];
            if (log.date === now.toDateString() && log.taskId === task.id) {
                log.done = true;
                log.title = finalTask.title;
                log.icon = finalTask.icon || getSmartIcon(finalTask);
                log.timeStr = log.timeStr || timeStr;
                // v6.5ï¼šä¿å­˜å¿«ç…§ï¼ˆä½¿ç”¨æœ€æ–°çŠ¶æ€ï¼‰
                log.bookmarkSnapshot = bookmarkSnapshot;
                log.noteSnapshot = noteSnapshot;
                log.lastAddMinutes = lastAddMinutes;
                marked = true;
                break;
            }
        }
        if (!marked) {
            dailyLog.unshift({
                title: task.title,
                icon: task.icon || getSmartIcon(task),
                timeStr: timeStr,
                date: now.toDateString(),
                done: true,
                taskId: task.id,
                // v6.5ï¼šä¿å­˜å¿«ç…§
                bookmarkSnapshot: bookmarkSnapshot,
                noteSnapshot: noteSnapshot,
                lastAddMinutes: lastAddMinutes
            });
        }

        // 1ï¼‰æ¯æ—¥å¾ªç¯ä»»åŠ¡ï¼šåªæ‰“å¡ï¼Œä¸å‡ºä»»åŠ¡æ± 
        if (task.recurrence === 'daily') {
            const taskIndex = db.findIndex(t => t.id === task.id);
            if (taskIndex > -1) db[taskIndex].lastDone = now.toDateString();
            renderLog();
            if (typeof renderHistory === 'function') renderHistory();
            save();
            renderList();
            showToast("âœ… ä»Šæ—¥æ‰“å¡æˆåŠŸï¼");
        }
        // 2ï¼‰ä¹¦ / å½± / å‰§ ç­‰ culture ç±»
        else if (task.type === 'culture') {
            const subtype = task.subtype || null;
            const icon = task.icon || getSmartIcon(task);
            const isSeries = !!task.isSeries;

            // æŠŠâ€œç”µå½±â€çš„åˆ¤æ–­æ”¾å®½ï¼š
            // 1ï¼‰subtype === 'movie'
            // 2ï¼‰æˆ–è€… å›¾æ ‡å°±æ˜¯ ğŸ¬
            const isMovie = (subtype === 'movie') || icon === 'ğŸ¬';

            // ğŸ¬ ç”µå½±ï¼ˆéç³»åˆ—ï¼‰ï¼šä¸€æ¬¡æ€§çœ‹å®Œ
            if (isMovie && !isSeries) {
                const ok = confirm(`ã€Š${task.title}ã€‹è¿™éƒ¨ç”µå½±å½»åº•çœ‹å®Œäº†å—ï¼Ÿ\n[ç¡®å®š]=å½’æ¡£ [å–æ¶ˆ]=ä»…è®°å½•æœ¬æ¬¡è§‚çœ‹`);
                if (ok) {
                    // å®Œæ•´çœ‹å®Œï¼šä»ä»»åŠ¡æ± åˆ é™¤ï¼Œå¹¶è¿›å…¥è£èª‰æ®¿å ‚
                    db = db.filter(t => t.id !== task.id);
                    archive.unshift({
                        ...task,
                        finishDate: now.toLocaleDateString()
                    });
                    save();
                    renderList();
                    renderArchive();
                    showToast("ğŸ† å·²å½’æ¡£");
                } else {
                    // åªè®°å½•åˆ°ä»Šæ—¥è¶³è¿¹ï¼Œä½†è§†ä¸ºâ€œå°šæœªå®Œå…¨çœ‹å®Œâ€ï¼Œä¸æ‰“ âœ…
                    if (Array.isArray(dailyLog) && dailyLog.length > 0) {
                        dailyLog[0].done = false;
                    }
                    save();
                    renderLog();
                    showToast("ğŸ¬ å·²è®°å½•åˆ°ä»Šæ—¥è¶³è¿¹");
                }
            } else {
                // ğŸ“š ä¹¦ / æ‚å¿— / å‰§é›† / å…¶ä»–é•¿çº¿æ–‡åŒ–å†…å®¹ï¼š
                // ä¸ä»åª’ä½“ç¯®ç§»é™¤ï¼Œåªåœ¨è£èª‰æ®¿å ‚è®°è¿›åº¦
                archive.unshift({
                    ...task,
                    finishDate: now.toLocaleDateString()
                });
                save();
                renderArchive();
                showToast("ğŸ“š å·²è®°å½•åˆ°è£èª‰æ®¿å ‚");
            }
        }
        // 3ï¼‰æ™®é€šä»»åŠ¡ï¼šå®Œæˆåä»ä»»åŠ¡æ± åˆ é™¤ï¼›å¦‚æœæ˜¯é‡è¦ä»»åŠ¡ï¼ˆé’è›™ï¼‰ï¼ŒåŒæ—¶æ”¾å…¥è£èª‰æ®¿å ‚
        else {
            db = db.filter(i => i.id !== task.id);

            if (task.isFrog) {
                archive.unshift({
                    title: task.title,
                    type: 'important',
                    isFrog: true,
                    icon: task.icon || getSmartIcon(task),
                    finishDate: now.toLocaleDateString()
                });
            }

            save();
            renderList();
            renderArchive();
            showToast(task.isFrog ? "ğŸ… é‡è¦ä»»åŠ¡å·²åŠ å…¥è£èª‰æ®¿å ‚ï¼" : "âœ¨ å®Œæˆï¼");
        }

        // ç»Ÿä¸€åˆ·æ–°è¶³è¿¹ & å†å²
        renderLog();
        if (typeof renderHistory === 'function') renderHistory();

        // é silent æ¨¡å¼ä¸‹ï¼Œæ”¶èµ·å¡ç‰‡ & æ¸…ç©ºé”šç‚¹çŠ¶æ€
        if (!silent) {
            if (card) card.style.display = 'none';
            if (statusEl) statusEl.style.display = 'none';
            if (ingEl) ingEl.style.display = 'none';
            currentTask = null;
            if (typeof currentStatus !== 'undefined') currentStatus = 'idle';
            if (typeof anchorStartTime !== 'undefined') anchorStartTime = null;
        }
    }

    /** åŸ finishTaskï¼šç°åœ¨åªæ˜¯ä¸€ä¸ªâ€œå£³â€ï¼ŒæŠŠ currentTask ä¸¢ç»™æ ¸å¿ƒé€»è¾‘ */
    function finishTask() {
        if (!currentTask) return;
        completeTaskCore(currentTask, { silentCard: false });
    }

    // v6.3-edit-buttons-enterï¼šå½“å‰å¯¹è¯æ¡†è¦æ“ä½œçš„ä»»åŠ¡
    let currentDialogTask = null;
    // v6.3-edit-buttons-enterï¼šç¼–è¾‘çŠ¶æ€è®°å½•ï¼ˆè¦†ç›–åŸä»»åŠ¡ç”¨ï¼‰
    let editingTaskId = null;
    let editingTaskOriginal = null;

    /**
     * åˆ—è¡¨é‡Œæ‰‹åŠ¨ç‚¹å‡»æ ‡é¢˜ï¼š
     * v6.3-edit-buttons-enterï¼šæ”¹ä¸ºå¼¹å‡ºä¸‰é€‰é¡¹å¯¹è¯æ¡†ï¼ˆå–æ¶ˆ/ä¿®æ”¹/å®Œæˆï¼‰
     * - æ—¥å¸¸ä»»åŠ¡ï¼šç›¸å½“äºâ€œä»Šå¤©è¿™æ¡æ‰“å¡ä¸€æ¬¡â€
     * - ä¸€æ¬¡æ€§ä»»åŠ¡ï¼šå®Œæˆå¹¶ç§»å‡ºä»»åŠ¡æ± ï¼ˆé’è›™è¿›è£èª‰æ®¿å ‚ï¼‰
     * - ä¹¦ / å½± / å‰§ï¼šç›¸å½“äºâ€œä»Šå¤©çœ‹/è¯»/è¿½äº†ä¸€ç‚¹â€ï¼Œç”µå½±ä¼šå†é—®æ˜¯å¦å½»åº•çœ‹å®Œ
     */
    function manualCompleteFromList(id) {
        // 1) å…ˆçœ‹çœ‹æ˜¯ä¸æ˜¯å½“å‰æŠ½å‡ºæ¥é‚£å¼ å¡æœ¬èº«
        let task = (typeof currentTask !== 'undefined' && currentTask && currentTask.id === id)
            ? currentTask
            : db.find(t => t.id === id);

        if (!task) return;
        if (task.inColdStorage) return;  // å†·åº“ä¸æ”¯æŒâ€œç›´æ¥å®Œæˆâ€ï¼ˆåŒé‡ä¿æŠ¤ï¼‰

        // 2) v6.3-edit-buttons-enterï¼šæ˜¾ç¤ºä¸‰é€‰é¡¹å¯¹è¯æ¡†
        let msg;
        if (task.type === 'culture') {
            msg = `ã€Œ${task.title}ã€ä»Šå¤©æœ‰çœ‹/è¯»/è¿½ä¸€ç‚¹å—ï¼Ÿ`;
        } else if (task.recurrence === 'daily') {
            msg = `è¦å¯¹ã€Œ${task.title}ã€åšä»€ä¹ˆæ“ä½œï¼Ÿ`;
        } else {
            msg = `è¦å¯¹ã€Œ${task.title}ã€åšä»€ä¹ˆæ“ä½œï¼Ÿ`;
        }

        showTaskActionDialog(task, msg);
    }

    // v6.3-edit-buttons-enterï¼šæ˜¾ç¤ºä»»åŠ¡æ“ä½œå¯¹è¯æ¡†
    function showTaskActionDialog(task, message) {
        currentDialogTask = task;
        const dialog = document.getElementById('taskActionDialog');
        const msgEl = document.getElementById('taskDialogMessage');
        if (msgEl) msgEl.innerText = message;
        if (dialog) dialog.style.display = 'flex';
    }

    // v6.3-edit-buttons-enterï¼šå…³é—­å¯¹è¯æ¡†
    function closeTaskActionDialog() {
        const dialog = document.getElementById('taskActionDialog');
        if (dialog) dialog.style.display = 'none';
        currentDialogTask = null;
    }

    // v6.3-edit-buttons-enterï¼šå¤„ç†å®Œæˆæ“ä½œ
    function handleTaskComplete() {
        if (!currentDialogTask) return;
        const task = currentDialogTask;
        closeTaskActionDialog();
        
        // å¦‚æœè¿™æ¡æ­£å¥½æ˜¯å½“å‰ card ä¸Šçš„ä»»åŠ¡ï¼šå½“ä½œæ­£å¸¸ finishTaskï¼Œé¡ºä¾¿å…³å¡ç‰‡
        const isCurrent = (typeof currentTask !== 'undefined' && currentTask && currentTask.id === task.id);
        completeTaskCore(task, { silentCard: !isCurrent });
    }

    // v6.3-edit-buttons-enterï¼šå¤„ç†ä¿®æ”¹æ“ä½œ
    function handleTaskEdit() {
        if (!currentDialogTask) return;
        const task = currentDialogTask;
        closeTaskActionDialog();
        
        // v6.3-edit-buttons-enterï¼šè®°å½•å½“å‰ç¼–è¾‘ä»»åŠ¡ï¼Œç”¨äºæäº¤æ—¶è¦†ç›–
        editingTaskId = task.id;
        try { editingTaskOriginal = JSON.parse(JSON.stringify(task)); } catch(e) { editingTaskOriginal = { ...task }; }

        // v6.3-edit-buttons-enterï¼šæŠŠä»»åŠ¡å±æ€§å¡«å›è¾“å…¥åŒºï¼Œç”¨æˆ·å¯ç¼–è¾‘åå†æäº¤
        const input = document.getElementById('inpTitle');
        if (input) {
            input.value = task.title || '';
            input.focus();
            const len = input.value.length;
            try { input.setSelectionRange(len, len); } catch(e) {}
        }

        // é€‰ä¸­æ ‡ç­¾ï¼ˆculture æŒ‰ subtype/isSeries ä¼˜å…ˆï¼‰
        const tags = Array.from(document.querySelectorAll('.tag'));
        const type = task.type;
        let targetTag = null;
        if (type === 'culture') {
            if (task.subtype === 'book') {
                targetTag = tags.find(t => t.dataset.v === 'culture' && t.dataset.sub === 'book');
            } else if (task.subtype === 'movie') {
                targetTag = tags.find(t => t.dataset.v === 'culture' && t.dataset.sub === 'movie');
            } else if (task.isSeries) {
                targetTag = tags.find(t => t.dataset.v === 'culture' && t.dataset.sub === 'series');
            }
            if (!targetTag) targetTag = tags.find(t => t.dataset.v === 'culture');
        } else {
            targetTag = tags.find(t => t.dataset.v === type);
        }
        if (!targetTag && tags.length > 0) targetTag = tags[0];
        if (targetTag) pickTag(targetTag);

        // åŒæ­¥æ—¶é—´é€‰æ‹©
        const timeSel = document.getElementById('inpTime');
        if (timeSel && typeof task.time !== 'undefined' && task.time !== null) {
            timeSel.value = task.time;
        }

        // åŒæ­¥æ¯æ—¥å¾ªç¯ / é€ŸåŠå¼€å…³
        toggleSwitch('cycle', task.recurrence === 'daily');
        toggleSwitch('flash', !!task.isQuick);

        // å…¶ä»–å±æ€§ï¼ˆå¦‚ isFrog ç­‰ï¼‰ä¿æŒåœ¨ä»»åŠ¡å¯¹è±¡ä¸Šï¼Œç”¨æˆ·æäº¤åæ²¿ç”¨
    }

    // v6.5ï¼šå¤„ç†è®°å¿†æ“ä½œï¼ˆä»ä»»åŠ¡æ“ä½œèœå•ï¼‰
    function handleTaskMemory() {
        if (!currentDialogTask) return;
        const task = currentDialogTask;
        closeTaskActionDialog();
        openMemoryPanel(task);
    }

    // v6.5ï¼šå½“å‰æ­£åœ¨ç¼–è¾‘è®°å¿†çš„ä»»åŠ¡
    let currentMemoryTask = null;
    let memoryOriginalState = {};

    // v6.5ï¼šæ‰“å¼€è®°å¿†é¢æ¿
    function openMemoryPanel(task) {
        // å¦‚æœæ²¡æœ‰ä¼ å…¥ taskï¼Œä½¿ç”¨ currentTask
        if (!task) task = currentTask;
        if (!task) return;

        currentMemoryTask = task;
        
        // ä¿å­˜åŸå§‹çŠ¶æ€ï¼ˆç”¨äºå·®å¼‚åŒ–ä¿å­˜ï¼‰
        memoryOriginalState = {
            bookmarkText: task.bookmarkText || '',
            totalMinutes: task.totalMinutes || 0,
            noteText: task.noteText || ''
        };

        const panel = document.getElementById('memoryPanel');
        const bookmarkInput = document.getElementById('memoryBookmark');
        const hoursSelect = document.getElementById('memoryHours');
        const minutesSelect = document.getElementById('memoryMinutes');
        const noteTextarea = document.getElementById('memoryNote');
        const clearBtn = document.getElementById('memoryBtnClear');

        if (!panel) return;

        // åŠ è½½æ•°æ®
        if (bookmarkInput) {
            bookmarkInput.value = task.bookmarkText || '';
            // è®¾ç½®å ä½ç¬¦
            const placeholder = getBookmarkPlaceholder(task);
            bookmarkInput.placeholder = placeholder;
        }
        if (hoursSelect) hoursSelect.value = '0';
        if (minutesSelect) minutesSelect.value = '0';
        if (noteTextarea) noteTextarea.value = task.noteText || '';

        // æ˜¾ç¤º/éšè—æ¸…ç©ºæŒ‰é’®
        if (clearBtn) {
            const hasContent = (task.bookmarkText && task.bookmarkText.trim()) || 
                              (task.noteText && task.noteText.trim());
            clearBtn.style.display = hasContent ? 'block' : 'none';
        }

        // æ˜¾ç¤ºé¢æ¿
        panel.style.display = 'flex';

        // PC ç«¯ï¼šä¹¦ç­¾è¾“å…¥æ¡† Enter ä¿å­˜
        if (bookmarkInput) {
            bookmarkInput.onkeydown = function(e) {
                if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    saveMemoryPanel();
                }
            };
        }

        // PC ç«¯ï¼šå¤‡æ³¨ textarea Ctrl/Cmd + Enter ä¿å­˜
        if (noteTextarea) {
            noteTextarea.onkeydown = function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    saveMemoryPanel();
                }
            };
        }
    }

    // v6.5ï¼šå…³é—­è®°å¿†é¢æ¿
    function closeMemoryPanel() {
        const panel = document.getElementById('memoryPanel');
        if (panel) panel.style.display = 'none';
        currentMemoryTask = null;
        memoryOriginalState = {};
    }

    // v6.5ï¼šè·å–ä¹¦ç­¾å ä½ç¬¦
    function getBookmarkPlaceholder(task) {
        if (!task) return "è®°å½•åæ ‡ï¼ˆå¯é€‰ï¼‰";
        
        if (task.type === 'culture') {
            if (task.subtype === 'book') {
                return "P120 / Ch.3";
            } else if (task.subtype === 'movie') {
                return "00:42:10";
            } else if (task.isSeries) {
                return "S2E5 / E07";
            }
        } else if (task.type === 'sport') {
            return "3ç»„ / 5ä¸ª / 8æ¬¡";
        }
        
        return "è®°å½•åæ ‡ï¼ˆå¯é€‰ï¼‰";
    }

    // v6.5ï¼šä¿å­˜è®°å¿†é¢æ¿
    function saveMemoryPanel() {
        if (!currentMemoryTask) return;

        const bookmarkInput = document.getElementById('memoryBookmark');
        const hoursSelect = document.getElementById('memoryHours');
        const minutesSelect = document.getElementById('memoryMinutes');
        const noteTextarea = document.getElementById('memoryNote');

        if (!bookmarkInput || !hoursSelect || !minutesSelect || !noteTextarea) return;

        // æ‰¾åˆ°ä»»åŠ¡åœ¨ db ä¸­çš„ç´¢å¼•
        const taskIndex = db.findIndex(t => t.id === currentMemoryTask.id);
        if (taskIndex === -1) return;

        const task = db[taskIndex];
        let hasChanges = false;

        // 1. ä¿å­˜ä¹¦ç­¾ï¼ˆè¦†ç›–å¼ï¼‰
        const newBookmark = bookmarkInput.value.trim();
        if (newBookmark !== memoryOriginalState.bookmarkText) {
            if (newBookmark) {
                task.bookmarkText = newBookmark;
                task.bookmarkUpdatedAt = Date.now();
                hasChanges = true;
            }
            // å¦‚æœä¸ºç©ºä¸”ç”¨æˆ·æœªæ˜ç¡®æ¸…ç©ºï¼Œä¸è¦†ç›–ï¼ˆå·²åœ¨ clearMemoryPanel ä¸­å¤„ç†ï¼‰
        }

        // 2. ä¿å­˜ç´¯è®¡æ—¶é•¿ï¼ˆç´¯åŠ å¼ï¼‰
        const hours = parseInt(hoursSelect.value) || 0;
        const minutes = parseInt(minutesSelect.value) || 0;
        const addMinutes = hours * 60 + minutes;
        
        if (addMinutes > 0) {
            task.totalMinutes = (task.totalMinutes || 0) + addMinutes;
            task.lastAddMinutes = addMinutes;
            task.totalUpdatedAt = Date.now();
            hasChanges = true;
            
            // é‡ç½®é€‰æ‹©å™¨
            hoursSelect.value = '0';
            minutesSelect.value = '0';
        }

        // 3. ä¿å­˜å¤‡æ³¨ï¼ˆè¦†ç›–å¼ï¼‰
        const newNote = noteTextarea.value.trim();
        if (newNote !== memoryOriginalState.noteText) {
            if (newNote) {
                task.noteText = newNote;
                task.noteUpdatedAt = Date.now();
                hasChanges = true;
            }
            // å¦‚æœä¸ºç©ºä¸”ç”¨æˆ·æœªæ˜ç¡®æ¸…ç©ºï¼Œä¸è¦†ç›–
        }

        if (hasChanges) {
            save();
            // æ›´æ–° currentTask å¦‚æœå®ƒæ˜¯åŒä¸€ä¸ªä»»åŠ¡ï¼ˆåªæ›´æ–°è®°å¿†æ•°æ®ï¼Œä¸åˆ·æ–°æ•´ä¸ªå¡ç‰‡ï¼‰
            if (currentTask && currentTask.id === task.id) {
                // åŒæ­¥è®°å¿†æ•°æ®åˆ° currentTask
                currentTask.bookmarkText = task.bookmarkText;
                currentTask.bookmarkUpdatedAt = task.bookmarkUpdatedAt;
                currentTask.totalMinutes = task.totalMinutes;
                currentTask.lastAddMinutes = task.lastAddMinutes;
                currentTask.totalUpdatedAt = task.totalUpdatedAt;
                currentTask.noteText = task.noteText;
                currentTask.noteUpdatedAt = task.noteUpdatedAt;
                
                // åªæ›´æ–°è¿›åº¦æç¤ºè¡Œï¼Œä¸åˆ·æ–°æ•´ä¸ªå¡ç‰‡
                const progressEl = document.getElementById('rProgress');
                if (progressEl) {
                    let progressHtml = "";
                    const hasBookmark = currentTask.bookmarkText && currentTask.bookmarkText.trim();
                    const hasTotal = currentTask.totalMinutes && currentTask.totalMinutes > 0;
                    
                    if (hasBookmark || hasTotal) {
                        if (hasBookmark) {
                            progressHtml += `ğŸ”– ${currentTask.bookmarkText}`;
                        }
                        if (hasBookmark && hasTotal) {
                            progressHtml += " Â· ";
                        }
                        if (hasTotal) {
                            const totalMins = currentTask.totalMinutes;
                            let timeDisplay = "";
                            if (totalMins < 60) {
                                timeDisplay = `${totalMins}m`;
                            } else {
                                const hours = Math.floor(totalMins / 60);
                                const mins = totalMins % 60;
                                timeDisplay = mins > 0 ? `${hours}h${mins}m` : `${hours}h`;
                            }
                            progressHtml += `â± æ€»è®¡ ${timeDisplay}`;
                        }
                    }
                    progressEl.innerHTML = progressHtml;
                }
            }
            
            // v6.5ï¼šæ›´æ–°å†å²è®°å½•ä¸­çš„è®°å¿†æ•°æ®ï¼ˆå¦‚æœä»»åŠ¡å·²ç»æœ‰å†å²è®°å½•ï¼‰
            const now = new Date();
            const todayStr = now.toDateString();
            for (let i = 0; i < dailyLog.length; i++) {
                const log = dailyLog[i];
                if (log.date === todayStr && log.taskId === task.id) {
                    // æ›´æ–°è®°å¿†æ•°æ®åˆ°å†å²è®°å½•
                    log.bookmarkSnapshot = task.bookmarkText || '';
                    log.noteSnapshot = task.noteText || '';
                    if (task.lastAddMinutes && task.lastAddMinutes > 0) {
                        log.lastAddMinutes = task.lastAddMinutes;
                    }
                    save();
                    renderHistory();
                    break;
                }
            }
            
            // æ›´æ–°åˆ—è¡¨æ˜¾ç¤º
            renderList();
            showToast("âœ… è®°å¿†å·²ä¿å­˜");
        }

        closeMemoryPanel();
    }

    // v6.5ï¼šæ¸…ç©ºè®°å¿†é¢æ¿
    function clearMemoryPanel() {
        if (!currentMemoryTask) return;
        if (!confirm("ç¡®å®šè¦æ¸…ç©ºä¹¦ç­¾å’Œå¤‡æ³¨å—ï¼Ÿï¼ˆç´¯è®¡æ—¶é•¿ä¸ä¼šè¢«æ¸…ç©ºï¼‰")) return;

        const taskIndex = db.findIndex(t => t.id === currentMemoryTask.id);
        if (taskIndex === -1) return;

        const task = db[taskIndex];
        let hasChanges = false;

        // æ¸…ç©ºä¹¦ç­¾
        if (task.bookmarkText) {
            task.bookmarkText = '';
            task.bookmarkUpdatedAt = Date.now();
            hasChanges = true;
        }

        // æ¸…ç©ºå¤‡æ³¨
        if (task.noteText) {
            task.noteText = '';
            task.noteUpdatedAt = Date.now();
            hasChanges = true;
        }

        if (hasChanges) {
            save();
            if (currentTask && currentTask.id === task.id) {
                currentTask = task;
                renderResultCard(currentTask);
            }
            renderList();
            showToast("âœ… å·²æ¸…ç©º");
        }

        closeMemoryPanel();
    }

    function recordLog() { renderLog(); }


    function autoTag() {
    const inp = document.getElementById('inpTitle');
    if (!inp) return;

    const raw = inp.value;
    const lines = raw.split('\n');
    const targetLine = lines[0] || "";
    const v = targetLine;
    const trimmed = v.trim();
    const tags = document.querySelectorAll('.tag');

    // === 1. æ—¶é—´è¯†åˆ«æç¤ºï¼ˆä¿ç•™åŸåŠŸèƒ½ï¼‰ ===
    const parsed = parseTimeFromInput(targetLine);
    const feedback = document.getElementById('timeFeedback');
    if (parsed.time) {
        feedback.innerText = `ğŸ’¡ è¯†åˆ«: ${parsed.time} min`;
    } else {
        feedback.innerText = "";
    }

    // === 2. è‡ªåŠ¨è¯†åˆ«â€œæ¯æ—¥å¾ªç¯â€ ===
    if (targetLine.includes("æ¯å¤©") || targetLine.includes("æ¯æ—¥")) {
        if (!isCycleActive) toggleCycle(true);
    }

    // === 3. é¦–å­—è§„åˆ™ + å…³é”®è¯å…œåº• ===
    let t = null;                // è¦æ¿€æ´»çš„æ ‡ç­¾ç±»å‹
    let detectQuick = false;     // æ˜¯å¦æ˜¯â€œå®¶åŠ¡é€ŸåŠå€™é€‰â€
    const firstChar = trimmed.charAt(0) || '';

    // ç‰¹æ®Šï¼šæ•´ç†ç…§ç‰‡ï¼ˆä¸ç®—é€ŸåŠï¼‰
    const isPhotoSort = trimmed.includes('æ•´ç†') && trimmed.includes('ç…§ç‰‡');

    // 3.1 é¦–å­—è§„åˆ™
    if (firstChar === 'çœ‹' || firstChar === 'å½±') {
        // çœ‹ / å½± å¼€å¤´ â†’ çœ‹ä½œå“ï¼ˆç”µå½±ï¼‰ï¼Œå½’ä¹¦å½±ç±»
        t = 'culture';
    } else if (firstChar === 'è¯»' || firstChar === 'ä¹¦') {
        // è¯» / ä¹¦ å¼€å¤´ â†’ é˜…è¯»ç±»
        t = 'culture';
    } else if (firstChar === 'è¿½' || firstChar === 'å‰§') {
        // è¿½ / å‰§ å¼€å¤´ â†’ å¤§æ¦‚ç‡æ˜¯åœ¨è¿½å‰§
        t = 'culture';
    } else if (firstChar === 'å»') {
        // å» å¼€å¤´ â†’ å¤–å‡ºä»»åŠ¡
        t = 'outdoor';
    } else {
        // 3.2 å…³é”®è¯å…œåº•ï¼ˆåªåœ¨æ²¡å‘½ä¸­é¦–å­—è§„åˆ™æ—¶ç”¨ï¼‰
        // å®¶åŠ¡ / å®¤å†…ï¼ˆæ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰å•ç‹¬çš„â€œç†â€ï¼‰
        if (/(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(v)) {
            t = 'indoor';
            detectQuick = true;
        }
        // å”± / å¬ â†’ å”±ç‰‡æˆ–éŸ³é¢‘
        else if (v.includes('å”±') || v.includes('å¬')) {
            t = 'vinyl';
        }
        // é˜…è¯»å…³é”®è¯
        else if (v.includes('ä¹¦') || v.includes('è¯»') || v.includes('æ‚å¿—')) {
            t = 'culture';
        }
        // å½±è§†å…³é”®è¯
        else if (v.includes('ç”µå½±') || v.includes('å½±') || v.includes('å‰§') || v.includes('ç‰‡')) {
            t = 'culture';
        }
        // è¿åŠ¨ç›¸å…³
        else if (v.includes('åŠ¨') || v.includes('è·‘') || v.includes('çƒ') || v.includes('èˆ') || v.includes('æ“')) {
            t = 'sport';
        }
        // ä¹°ä¸œè¥¿ / å‡ºå»åŠäº‹
        else if (v.includes('ä¹°') || v.includes('å¤–') || v.includes('è¶…å¸‚') || v.includes('å•†åœº') || v.includes('å–å¿«é€’') || v.includes('å¯„å¿«é€’')) {
            t = 'outdoor';
        }
        // å†™ä½œ / ç ”ç©¶ / ç¼–è¾‘ â†’ æ¡Œå‰è„‘åŠ›
        else if (v.includes('è„‘') || v.includes('å†™') || v.includes('ç ”ç©¶') || v.includes('ä½œ') || v.includes('ç¼–è¾‘')) {
            t = 'desktop';
        }
    }

    // === 4. åº”ç”¨è‡ªåŠ¨æ ‡ç­¾é«˜äº® ===
    if (t) {
    tags.forEach(tag => tag.classList.remove('active'));

    let selector = `.tag[data-v="${t}"]`;

    // å¦‚æœæ˜¯ä¹¦å½±ç±»ï¼Œæ ¹æ®é¦–å­—é€‰ ğŸ“– / ğŸ¬ / ğŸ“º
    if (t === 'culture') {
        const firstChar = trimmed.charAt(0) || '';
        let sub = 'book'; // é»˜è®¤ä¹¦

        if (firstChar === 'çœ‹' || firstChar === 'å½±') {
            sub = 'movie';
        } else if (firstChar === 'è¿½' || firstChar === 'å‰§' || /ç¬¬.+é›†/.test(trimmed)) {
            sub = 'series';
        } else if (trimmed.includes('æ‚å¿—') || trimmed.includes('å‘¨åˆŠ')) {
            sub = 'book';
        }

        selector = `.tag[data-v="culture"][data-sub="${sub}"]`;
    }

    const activeTag = document.querySelector(selector) || document.querySelector(`.tag[data-v="${t}"]`);
    if (activeTag) activeTag.classList.add('active');

    toggleTimeInput(t);
}

    // === 5. è‡ªåŠ¨é€ŸåŠé€»è¾‘ ===
    // åªå¯¹â€œå®¶åŠ¡ç±»å…³é”®è¯â€è§¦å‘ï¼Œå¹¶ä¸”æ’é™¤â€œæ•´ç†ç…§ç‰‡â€
    if (!isPhotoSort && detectQuick) {
        toggleSwitch('flash', true);
        const sel = document.getElementById('inpTime');
        if (sel) sel.value = "5";
    } else if (isPhotoSort) {
        // æ•´ç†ç…§ç‰‡ï¼šç¡®ä¿ä¸æ˜¯é€ŸåŠï¼Œé»˜è®¤ 30min
        toggleSwitch('flash', false);
        const sel = document.getElementById('inpTime');
        if (sel) sel.value = "30";
    }
}

    function pickTag(el) { 
        document.querySelectorAll('.tag').forEach(t => t.classList.remove('active')); 
        el.classList.add('active'); 
        toggleTimeInput(el.dataset.v); 
    }

    function toggleTimeInput(type) { 
        const sel = document.getElementById('inpTime'); 
        if (type === 'vinyl' || type === 'culture') sel.classList.add('disabled'); 
        else sel.classList.remove('disabled'); 
    }

    // â­ ä¿®æ”¹ï¼šå¢åŠ  userOverrideFlash é€»è¾‘ + å…³é—­é€ŸåŠæ—¶è‡ªåŠ¨æŠŠæ—¶é—´è°ƒå› 30m
    function toggleSwitch(type, forceState) { 
        const isUserAction = (forceState === undefined);
        const newState = (forceState !== undefined) ? forceState : !switchState[type]; 
        switchState[type] = newState; 
        const sw = document.getElementById(type + 'Switch'); 
        const activeClass = (type === 'cycle') ? 'active-cycle' : 'active-flash'; 
        if (newState) sw.classList.add(activeClass); else sw.classList.remove(activeClass); 

        if (type === 'flash') {
    const sel = document.getElementById('inpTime');
    if (isUserAction) {
        // ç”¨æˆ·æ‰‹åŠ¨ç‚¹å¼€çš„/ç‚¹æ‰çš„é€ŸåŠï¼Œæ ‡è®°ä¸ºâ€œç”¨æˆ·è¦†ç›–â€
        userOverrideFlash = true;

        if (sel) {
            if (newState) {
                // âœ… ç”¨æˆ·æ‰‹åŠ¨å¼€å¯é€ŸåŠï¼šæ—¶é—´æ”¹æˆ 5m
                sel.value = "5";
            } else {
                // âœ… ç”¨æˆ·æ‰‹åŠ¨å…³é—­é€ŸåŠï¼šæ—¶é—´æ¢å¤é»˜è®¤ 30m
                sel.value = "30";
            }
        }
    } else {
        // ç¨‹åºè‡ªåŠ¨æ§åˆ¶é€ŸåŠï¼ˆä¾‹å¦‚å…³é”®è¯è¯†åˆ«æˆ–å­˜å…¥åé‡ç½®ï¼‰
        if (newState) {
            // è‡ªåŠ¨å¼€å¯é€ŸåŠæ—¶ä¸è®¤ä¸ºç”¨æˆ·è¦†ç›–
            userOverrideFlash = false;
        } else {
            // è‡ªåŠ¨å…³é—­æ—¶ä¹Ÿæ¸…æ‰è¦†ç›–æ ‡è®°
            userOverrideFlash = false;
        }
    }
}
}

    let isCycleActive = false;
    function toggleCycle(forceOn) { 
        const desired = (forceOn === true) ? true : !isCycleActive;
        isCycleActive = desired;
        toggleSwitch('cycle', desired);
    }

    // ä¿®å¤ç‰ˆ addNewï¼ˆä¸å‰ä¸€ç‰ˆä¿æŒä¸€è‡´ï¼Œåªä¿®ä¸¤ä¸ª bugï¼‰
    function addNew() {
        const rawInput = document.getElementById('inpTitle').value; 
        if(!rawInput || rawInput.trim() === "") return;

        // v6.3-edit-buttons-enterï¼šç¼–è¾‘æ¨¡å¼ä»…å–é¦–è¡Œå¹¶è¦†ç›–åŸä»»åŠ¡
        let lines = rawInput.split('\n').filter(line => line.trim() !== ""); 
        if (editingTaskId) {
            lines = [lines.join(' ')].filter(Boolean);
        }
        const activeTag = document.querySelector('.tag.active');
        const type = activeTag.dataset.v; 
        const manualSubtype = activeTag.dataset.sub || '';
        let addedCount = 0; 
        let batchSubtype = manualSubtype || ''; 

        if (!batchSubtype && lines.length > 0) { 
            const firstRaw = lines[0];
            const first = firstRaw.toLowerCase(); 
            const isCleaning = /(ç†|æ•´ç†|æ”¶æ‹¾|æ“¦|æ‰«|æ‹–|æ´—|æ¢|å |é“º|æŒ‚|æ‰”|æ‹†|è£…|å–)/.test(firstRaw); 
            if (!isCleaning) { 
                const firstChar = firstRaw.charAt(0) || '';
                // é¦–å­—ä¼˜å…ˆï¼šè¯» / ä¹¦ å¼€å¤´ä¸€å¾‹å½“ä¹¦ç±
                if (firstChar === 'è¯»' || firstChar === 'ä¹¦') {
                    batchSubtype = 'book';
                }
                // çœ‹ / å½± å¼€å¤´ä¼˜å…ˆå½“ç”µå½±
                else if (firstChar === 'çœ‹' || firstChar === 'å½±') {
                    batchSubtype = 'movie';
                }
                // å¦åˆ™å†ç”¨åŒ…å«å…³ç³»åšå…œåº•
                else if (['è¯»', 'ä¹¦', 'é˜…', 'book', 'read', 'æ‚å¿—'].some(k => first.includes(k))) {
                    batchSubtype = 'book';
                } else if (['çœ‹', 'å½±', 'è§†', 'ç‰‡', 'movie'].some(k => first.includes(k))) {
                    batchSubtype = 'movie';
                }
                // â­ ä¿®æ”¹ç‚¹ 1ï¼šåªæœ‰åœ¨â€œç¡®å®æ˜¯æ‰¹é‡æ¨¡å¼â€ï¼ˆå¤šè¡Œï¼‰çš„æƒ…å†µä¸‹ï¼Œæ‰æŠŠç¬¬ä¸€è¡Œå½“ä½œæŒ‡ä»¤è¡Œæ¸…æ´—æ‰
                if (batchSubtype && first.length <= 4 && lines.length > 1) lines.shift(); 
            } 
        }

        lines.forEach(line => {
            const parsed = parseTimeFromInput(line); 
            let title = parsed.title; 
            let timeVal = parsed.time; 
            let subtype = batchSubtype;

            let isFrog = false; 
            // é‡è¦äº‹é¡¹æ ‡è®°ï¼šæ”¯æŒ è¡Œé¦– * / ï¼Š / ! / ï¼ / â€œé‡è¦ â€
            let rawTitle = title.trimStart();
            const importantMarkers = ['*', 'ï¼Š', '!', 'ï¼'];
            if (importantMarkers.some(m => rawTitle.startsWith(m))) {
                isFrog = true;
                rawTitle = rawTitle.substring(1).trim();
            } else if (rawTitle.startsWith('é‡è¦')) {
                isFrog = true;
                rawTitle = rawTitle.replace(/^é‡è¦\s*/, '').trim();
            }
            title = rawTitle;

            // â­ ä¿®æ”¹ç‚¹ 2ï¼ˆæ ¸å¿ƒï¼‰ï¼šå¦‚æœç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨è¦†ç›–é€ŸåŠï¼Œåˆ™å…è®¸å…³é”®è¯/æ—¶é—´è‡ªåŠ¨åˆ¤å®šï¼›
            // ä¸€æ—¦ userOverrideFlash ä¸º trueï¼Œå°±å®Œå…¨å°Šé‡å½“å‰å¼€å…³çŠ¶æ€ï¼Œä¸å†è¢«â€œæ•´ç†â€ç­‰å…³é”®è¯å¼ºåˆ¶æ‹‰å›é€ŸåŠã€‚
            let isQuick = switchState.flash;

/**
 * é‡è¦æ”¹åŠ¨ï¼š
 * 1ï¼‰åªå¯¹ã€Œå®¤å†…å®¶åŠ¡ã€å°è¯•è‡ªåŠ¨é€ŸåŠ â†’ type å¿…é¡»æ˜¯ 'indoor'
 * 2ï¼‰å»æ‰å•ç‹¬çš„ã€Œç†ã€ï¼Œé¿å…â€œå¿ƒç†åŒ»ç”Ÿâ€è¢«è¯¯åˆ¤æˆæ‰“æ‰«
 */
if (!userOverrideFlash) {
    if (!isQuick) {
        const isPhotoSort = title.includes('æ•´ç†') && title.includes('ç…§ç‰‡');

        // åªæœ‰ã€Œå®¤å†…ã€ä»»åŠ¡æ‰ä¼šè§¦å‘å®¶åŠ¡é€ŸåŠé€»è¾‘
        if (
            !isPhotoSort &&
            type === 'indoor' &&
            /(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(title)
        ) {
            isQuick = true;
        }

        // å¦‚æœç”¨æˆ·è‡ªå·±å†™äº† 5m/5åˆ†é’Ÿï¼Œä¹Ÿè®¤ä¸ºæ˜¯é€ŸåŠ
        if (timeVal && timeVal <= 5) isQuick = true;
    }
}

            if (!timeVal) { 
                timeVal = parseInt(document.getElementById('inpTime').value); 
                if (type === 'vinyl' && !isQuick) timeVal = 0; 
                else if (type === 'culture' && !isQuick) { 
                    if (subtype === 'movie') timeVal = 120; 
                    else timeVal = 0; 
                } 
            }

            if (isQuick && (!timeVal || timeVal > 15)) timeVal = 5;

            if (!isQuick && !subtype && type === 'culture') {
    const t = (title || "").trim();
    const firstChar = t.charAt(0) || '';

    // 1. é¦–å­—ä¼˜å…ˆï¼šä½ æ˜¯â€œè¯»/ä¹¦â€è¿˜æ˜¯â€œçœ‹/å½±â€å¼€å¤´
    if (firstChar === 'è¯»' || firstChar === 'ä¹¦') {
        subtype = 'book';
    } else if (firstChar === 'çœ‹' || firstChar === 'å½±') {
        subtype = 'movie';
    } else {
        // 2. é¦–å­—ä¸æ˜¯è¯»/çœ‹ï¼Œå†ç”¨å†…å®¹å…œåº•ï¼š
        //    å…ˆçœ‹â€œä¹¦â€çš„ç—•è¿¹
        if (
            t.includes('ä¹¦') ||
            t.includes('è¯»') ||
            t.includes('é˜…') ||
            t.includes('æ‚å¿—') ||
            t.includes('å‘¨åˆŠ')
        ) {
            subtype = 'book';
        }
        // 3. å®åœ¨ä¸åƒä¹¦ï¼Œå†çœ‹æ˜¯å¦åƒç”µå½±
        else if (
            t.includes('ç”µå½±') ||
            t.includes('å½±') ||
            t.includes('ç‰‡')
        ) {
            subtype = 'movie';
        }
        // 4. éƒ½ä¸åƒå°±ä¿æŒ subtype = nullï¼Œç”¨ä¸­æ€§å›¾æ ‡ï¼Œè®©ä½ æ‰‹åŠ¨åˆ¤æ–­
    }
}

            // å…ˆæ‹¿ä¸€ä»½â€œç”¨äºåˆ¤å®šå‰§é›†â€çš„åŸå§‹æ ‡é¢˜ï¼šå»æ‰å»/çœ‹/è¯»/å¬/åšï¼Œä½†è¿˜æ²¡åŠ ã€Šã€‹
            const rawForSeries = title.replace(/^(å»|çœ‹|è¯»|å¬|åš)\s*/, '').trim();

            let isSeries = false;
            if (type === 'culture' && subtype === 'series') {
                isSeries = true;
            }
            if (type === 'culture') {
                const firstCharSeries = rawForSeries.charAt(0) || '';

                // 1. é¦–å­—åˆ¤å®šï¼šè¿½å‰§ / å‰§ å¼€å¤´
                if (firstCharSeries === 'è¿½' || firstCharSeries === 'å‰§') {
                    isSeries = true;
                }

                // 2. å†…å®¹å…œåº•ï¼šå…¨é›† / ç³»åˆ— / ç¬¬Xé›†...
                if (
                    rawForSeries.includes('å…¨é›†') ||
                    rawForSeries.includes('ç³»åˆ—') ||
                    /ç¬¬.+é›†/.test(rawForSeries)
                ) {
                    isSeries = true;
                }
            }

                        // å†æŠŠ title è§„èŒƒæˆæœ€ç»ˆå±•ç¤ºç”¨æ ·å¼ï¼ˆè¿™é‡Œé¡ºæ‰‹æŠŠâ€œè¿½ / å‰§â€å‰ç¼€æ¸…æ´—æ‰ï¼‰
            let displayTitle = rawForSeries;

            // å¦‚æœæ˜¯ä¹¦å½±ç±» & è¢«è¯†åˆ«ä¸ºå‰§é›†ï¼Œå°±æŠŠå¼€å¤´çš„â€œè¿½ / å‰§â€å»æ‰
            if (type === 'culture' && isSeries && (displayTitle.startsWith('è¿½') || displayTitle.startsWith('å‰§'))) {
                displayTitle = displayTitle.slice(1).trim();
            }

            title = displayTitle;

            if (!isQuick && (type === 'culture' || type === 'vinyl')) { 
                if (title && !title.startsWith('ã€Š') && !title.endsWith('ã€‹')) {
                    title = `ã€Š${title}ã€‹`; 
                }
            }

            
            let recurrence = switchState.cycle ? 'daily' : 'none'; 
            if (recurrence === 'none' && (title.includes('æ¯å¤©') || title.includes('æ¯æ—¥'))) { recurrence = 'daily'; }
            if (recurrence === 'daily') title = title.replace(/æ¯å¤©|æ¯æ—¥/g, '').trim();

            // v6.3-edit-buttons-enterï¼šç¼–è¾‘æ¨¡å¼è¦†ç›–åŸä»»åŠ¡ï¼Œä¿ç•™å…¶ä»–å±æ€§ï¼ˆå¦‚ğŸ¸ï¼‰
            if (editingTaskId) {
                const idx = db.findIndex(t => t.id === editingTaskId);
                const base = (idx > -1) ? { ...db[idx] } : (editingTaskOriginal ? { ...editingTaskOriginal } : {});

                db[idx] = {
                    ...base,
                    id: editingTaskId,
                    title,
                    type,
                    subtype,
                    desc: isSeries ? "ç³»åˆ—" : (recurrence === 'daily' ? "æ¯æ—¥ä»»åŠ¡" : ""),
                    isSeries,
                    time: timeVal,
                    recurrence,
                    isFrog: base.isFrog || isFrog,
                    isQuick: isQuick,
                };
                addedCount++;
            } else {
                db.push({ 
                    id: Date.now() + Math.floor(Math.random() * 10000), 
                    title: title, type: type, subtype: subtype, 
                    desc: isSeries ? "ç³»åˆ—" : (recurrence === 'daily' ? "æ¯æ—¥ä»»åŠ¡" : ""), 
                    isSeries: isSeries, time: timeVal, recurrence: recurrence, 
                    isFrog: isFrog, isQuick: isQuick, lastDone: '' 
                }); 
                addedCount++;
            }
        });

        save(); renderList(); 
        const input = document.getElementById('inpTitle'); 
        input.value = ''; 
        input.placeholder = "âœ… å­˜å…¥æˆåŠŸï¼"; 
        document.getElementById('timeFeedback').innerText = ""; 
        if(switchState.cycle) toggleSwitch('cycle', false); 
        if(switchState.flash) toggleSwitch('flash', false); 
        editingTaskId = null;
        editingTaskOriginal = null;
        showToast(`ğŸ‰ å­˜å…¥ ${addedCount} ä¸ªä»»åŠ¡ï¼`); 
        setTimeout(() => input.placeholder = "è¾“å…¥äº‹é¡¹...", 1500);
    }
    
    function tryDeleteItem(id) { 
        if(confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) { 
            db = db.filter(item => item.id !== id); 
            save(); renderList(); showToast("ğŸ—‘ï¸ å·²åˆ é™¤"); 
        } 
    }
       // ç‚¹å‡»ä»»åŠ¡åˆ—è¡¨é‡Œçš„å†°å—ï¼šæ‰“å¼€å¼¹çª—ï¼Œåç»­å…·ä½“æ“ä½œåœ¨ confirmColdAction é‡Œæ‰§è¡Œ
    function handleColdOrDelete(id) {
        const item = db.find(t => t.id === id);
        if (!item) return;
        pendingColdId = id;

        const dlg = document.getElementById('coldDialog');
        if (dlg) {
            dlg.style.display = 'flex';
        }
    }
    // å¼¹çª—ä¸­ç‚¹å‡»ä¸‰ä¸ªæŒ‰é’®ä¹‹ä¸€ï¼šdelete / cold / cancel
    function confirmColdAction(action) {
        const dlg = document.getElementById('coldDialog');
        if (dlg) {
            dlg.style.display = 'none';
        }

        const id = pendingColdId;
        pendingColdId = null;
        if (!id) return;

        if (action === 'cold') {
            // ç›´æ¥ç§»å…¥å†·åº“
            moveToColdStorage(id);
            } else if (action === 'delete') {
        // åˆ é™¤å†åšä¸€æ¬¡ç¡®è®¤ï¼Œé¿å…è¯¯åˆ 
        const ok = confirm("ç¡®å®šè¦å½»åº•åˆ é™¤è¿™æ¡ä»»åŠ¡å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚");
        if (ok) {
            // è¿™é‡Œç›´æ¥åˆ é™¤ï¼Œä¸å†èµ° tryDeleteItemï¼ˆé¿å…å†å¼¹ä¸€æ¬¡ç¡®è®¤ï¼‰
            db = db.filter(item => item.id !== id);
            save();
            renderList();
            showToast("ğŸ—‘ï¸ å·²åˆ é™¤");
            }
        } else {
            // cancelï¼šä»€ä¹ˆéƒ½ä¸åš
            return;
        }
    }


   function moveToColdStorage(id) {
    const item = db.find(t => t.id === id);
    if (!item) return;
    item.inColdStorage = true;
    save();
    renderList();
    showToast("ğŸ§Š å·²ç§»å…¥å†·åº“");
}


    function restoreFromColdStorage(id) {
        const item = db.find(t => t.id === id);
        if (!item) return;
        item.inColdStorage = false;
        save();
        renderList();
        showToast("â™»ï¸ å·²ä»å†·åº“èµ¦å…");
    }

    function deleteArchiveItem(index) {
        if (index < 0 || index >= archive.length) return;
        if (!confirm("ç¡®å®šä»è£èª‰æ®¿å ‚åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;
        archive.splice(index, 1);
        save();
        renderArchive();
        showToast("ğŸ—‘ï¸ å·²åˆ é™¤");
    }

    function tryResetAll() { 
        if(confirm("âš ï¸ ç¡®å®šæ¸…ç©ºï¼Ÿ")) { 
            db = []; archive = []; dailyLog = []; userStats = { willpower: 0, joy: 0 }; 
            save(); renderList(); renderArchive(); renderLog(); renderHistory(); updateStatsUI(); showToast("å·²æ ¼å¼åŒ–"); 
        } 
    }

    // å¯¼å…¥/å¯¼å‡ºé€»è¾‘ä¿æŒåŸæ ·
    // ã€å¤‡ä»½å¯¼å‡º/å¯¼å…¥å‡çº§ v6.3-backup2ã€‘executeImport: æ”¯æŒæ–°ç‰ˆæ ¼å¼å¹¶å…¼å®¹æ—§ç‰ˆï¼Œæ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
    function executeImport() {
        const str = document.getElementById('dataArea').value;
        if (!str || str.trim().length === 0) { alert("âš ï¸ è¯·å…ˆç²˜è´´ä»£ç ï¼"); return; }
        try {
            const json = JSON.parse(str);
            
            // å…¼å®¹æ—§ç‰ˆæ ¼å¼ï¼ˆç›´æ¥æœ‰ db/archive/dailyLog/userStatsï¼‰å’Œæ–°ç‰ˆæ ¼å¼ï¼ˆæœ‰ version/data/localï¼‰
            let incomingDB, incomingArchive, incomingDailyLog, incomingStats;
            let localData = null;
            
            if (json.version && json.data) {
                // æ–°ç‰ˆæ ¼å¼ï¼šv6.3-backup2
                incomingDB = json.data.db || [];
                incomingArchive = json.data.archive || [];
                incomingDailyLog = json.data.dailyLog || [];
                incomingStats = json.data.userStats || {};
                localData = json.local || null;
            } else {
                // æ—§ç‰ˆæ ¼å¼ï¼šç›´æ¥æœ‰ db/archive/dailyLog/userStats
                incomingDB = json.db || (Array.isArray(json) ? json : []);
                incomingArchive = json.archive || [];
                incomingDailyLog = json.dailyLog || [];
                incomingStats = json.userStats || {};
            }
            
            if (!Array.isArray(incomingDB)) throw new Error("æ ¼å¼é”™è¯¯ï¼šdb å¿…é¡»æ˜¯æ•°ç»„");
            if (!Array.isArray(incomingArchive)) incomingArchive = [];
            if (!Array.isArray(incomingDailyLog)) incomingDailyLog = [];
            if (typeof incomingStats !== 'object') incomingStats = {};
            
            const taskCount = incomingDB.length;
            const archiveCount = incomingArchive.length;
            const logCount = incomingDailyLog.length;
            const hasLocalData = localData && (localData.ritualMorning || localData.ritualNight || localData.openedDays || localData.posterShownDay);
            
            // ä¿å­˜å¾…å¯¼å…¥çš„æ•°æ®
            pendingImportData = {
                incomingDB,
                incomingArchive,
                incomingDailyLog,
                incomingStats,
                localData,
                taskCount,
                archiveCount,
                logCount,
                hasLocalData
            };
            
            // æ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
            let dialogTitle = `ğŸ“¡ æ‰¾åˆ° ${taskCount} ä¸ªä»»åŠ¡`;
            if (archiveCount > 0) dialogTitle += `ã€${archiveCount} ä¸ªå½’æ¡£`;
            if (logCount > 0) dialogTitle += `ã€${logCount} æ¡è¶³è¿¹`;
            if (hasLocalData) dialogTitle += `\nä»¥åŠä»ªå¼å’Œæ‰“å¡æ•°æ®`;
            dialogTitle += `\n\nè¯·é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š`;
            
            const titleElement = document.getElementById('backupDialogTitle');
            if (titleElement) {
                titleElement.textContent = dialogTitle;
            }
            
            const dialog = document.getElementById('backupDialog');
            if (dialog) {
                dialog.style.display = 'flex';
            }
        } catch(e) { 
            alert(`âŒ å¯¼å…¥å¤±è´¥ï¼š${e.message}`); 
            console.error('å¯¼å…¥é”™è¯¯è¯¦æƒ…', e);
        }
    }

    // å¤„ç†å¤‡ä»½å¯¼å…¥çš„ç”¨æˆ·é€‰æ‹©ï¼šè¦†ç›– / åˆå¹¶ / å–æ¶ˆ
    function confirmBackupAction(action) {
        const dialog = document.getElementById('backupDialog');
        if (dialog) {
            dialog.style.display = 'none';
        }

        if (!pendingImportData) return;

        if (action === 'cancel') {
            // å–æ¶ˆï¼šä»€ä¹ˆéƒ½ä¸åš
            pendingImportData = null;
            return;
        }

        const { incomingDB, incomingArchive, incomingDailyLog, incomingStats, localData, taskCount, archiveCount, logCount, hasLocalData } = pendingImportData;
        pendingImportData = null;

        if (action === 'overwrite') {
            // è¦†ç›–ç­–ç•¥ï¼šç”¨å¤‡ä»½æ•°æ®å®Œå…¨æ›¿æ¢å½“å‰æ•°æ®
            // 1. è¦†ç›– dbï¼ˆä»»åŠ¡åˆ—è¡¨ï¼‰
            db = incomingDB.map(item => {
                // ç¡®ä¿æ¯ä¸ªä»»åŠ¡æœ‰ id å’Œ time
                if (!item.id) item.id = Date.now() + Math.floor(Math.random()*10000);
                if (item.time === undefined) item.time = 30;
                return item;
            });
            
            // 2. è¦†ç›– archiveï¼ˆå½’æ¡£ï¼‰
            archive = incomingArchive.slice();
            
            // 3. è¦†ç›– dailyLogï¼ˆè¶³è¿¹ï¼‰
            dailyLog = incomingDailyLog.slice();
            
            // 4. è¦†ç›– userStatsï¼ˆæ„å¿—åŠ›&å°ç¡®å¹¸ï¼‰
            userStats = Object.assign({}, incomingStats);
        } else if (action === 'merge') {
            // åˆå¹¶ç­–ç•¥ï¼šåˆå¹¶å¤‡ä»½æ•°æ®å’Œå½“å‰æ•°æ®
            // 1. åˆå¹¶ dbï¼ˆä»»åŠ¡åˆ—è¡¨ï¼‰ï¼šåŸºäº id å»é‡ï¼Œå¦‚æœ id ç›¸åŒåˆ™ä¿ç•™å¤‡ä»½ä¸­çš„
            const existingIds = new Set(db.map(item => item.id));
            const mergedDB = db.slice(); // å…ˆä¿ç•™ç°æœ‰ä»»åŠ¡
            
            incomingDB.forEach(item => {
                // ç¡®ä¿æ¯ä¸ªä»»åŠ¡æœ‰ id å’Œ time
                if (!item.id) item.id = Date.now() + Math.floor(Math.random()*10000);
                if (item.time === undefined) item.time = 30;
                
                const existingIndex = mergedDB.findIndex(existing => existing.id === item.id);
                if (existingIndex >= 0) {
                    // id å·²å­˜åœ¨ï¼Œç”¨å¤‡ä»½æ•°æ®æ›¿æ¢
                    mergedDB[existingIndex] = item;
                } else {
                    // æ–°ä»»åŠ¡ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
                    mergedDB.push(item);
                }
            });
            db = mergedDB;
            
            // 2. åˆå¹¶ archiveï¼ˆå½’æ¡£ï¼‰ï¼šåŸºäºå®Œæ•´å¯¹è±¡å»é‡
            const archiveMap = new Map();
            archive.forEach(item => {
                const key = JSON.stringify(item);
                archiveMap.set(key, item);
            });
            incomingArchive.forEach(item => {
                const key = JSON.stringify(item);
                archiveMap.set(key, item);
            });
            archive = Array.from(archiveMap.values());
            
            // 3. åˆå¹¶ dailyLogï¼ˆè¶³è¿¹ï¼‰ï¼šåŸºäºå®Œæ•´å¯¹è±¡å»é‡
            const logMap = new Map();
            dailyLog.forEach(item => {
                const key = JSON.stringify(item);
                logMap.set(key, item);
            });
            incomingDailyLog.forEach(item => {
                const key = JSON.stringify(item);
                logMap.set(key, item);
            });
            dailyLog = Array.from(logMap.values());
            
            // 4. åˆå¹¶ userStatsï¼ˆæ„å¿—åŠ›&å°ç¡®å¹¸ï¼‰ï¼šå¤‡ä»½æ•°æ®è¦†ç›–ç°æœ‰æ•°æ®
            userStats = Object.assign({}, userStats, incomingStats);
        }

        // 5. ä¿å­˜åˆ° localStorage
        save();
        
        // 6. æ¢å¤ localStorage çš„ local æ•°æ®ï¼ˆå¦‚æœå¤‡ä»½ä¸­æœ‰ï¼‰
        if (localData) {
            try {
                if (localData.ritualMorning !== undefined && localData.ritualMorning !== null) {
                    localStorage.setItem(KEY_RITUAL_MORNING, JSON.stringify(localData.ritualMorning));
                }
                if (localData.ritualNight !== undefined && localData.ritualNight !== null) {
                    localStorage.setItem(KEY_RITUAL_NIGHT, JSON.stringify(localData.ritualNight));
                }
                // ã€é£é™© #4 ä¿®å¤ã€‘openedDays: é›†åˆå»é‡+åˆæ³•æ ¼å¼è¿‡æ»¤ï¼ˆyyyy-mm-ddï¼‰ï¼Œç¡®ä¿ä»Šå¤©æ—¥æœŸåœ¨æ•°ç»„ä¸­
                if (localData.openedDays !== undefined && Array.isArray(localData.openedDays)) {
                    const today = getTodayDateStr();
                    let validDays;
                    
                    if (action === 'merge') {
                        // åˆå¹¶æ¨¡å¼ï¼šåˆå¹¶ç°æœ‰çš„å’Œå¤‡ä»½çš„ openedDays
                        let currentDays = [];
                        try {
                            const stored = localStorage.getItem(KEY_OPENED_DAYS);
                            if (stored) {
                                currentDays = JSON.parse(stored);
                                if (!Array.isArray(currentDays)) currentDays = [];
                            }
                        } catch (e) {
                            currentDays = [];
                        }
                        // åˆå¹¶ä¸¤ä¸ªæ•°ç»„å¹¶å»é‡
                        const mergedDays = [...currentDays, ...localData.openedDays];
                        validDays = [...new Set(mergedDays.filter(day => 
                            typeof day === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(day)
                        ))];
                    } else {
                        // è¦†ç›–æ¨¡å¼ï¼šç›´æ¥ç”¨å¤‡ä»½çš„ openedDays
                        validDays = [...new Set(localData.openedDays.filter(day => 
                            typeof day === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(day)
                        ))];
                    }
                    
                    // ç¡®ä¿ä»Šå¤©æ—¥æœŸåœ¨æ•°ç»„ä¸­ï¼ˆå¦‚æœå¤‡ä»½ä¸­æ²¡æœ‰ä»Šå¤©ï¼Œå¯¼å…¥å initOpenedDays ä¼šæ·»åŠ ï¼Œä½†è¿™é‡Œæå‰ä¿è¯ä¸€è‡´æ€§ï¼‰
                    if (!validDays.includes(today)) {
                        validDays.push(today);
                    }
                    localStorage.setItem(KEY_OPENED_DAYS, JSON.stringify(validDays));
                }
                if (localData.posterShownDay !== undefined && localData.posterShownDay !== null) {
                    localStorage.setItem(KEY_POSTER_SHOWN_DAY, localData.posterShownDay);
                }
            } catch (e) {
                console.warn('æ¢å¤ localStorage æ•°æ®æ—¶å‡ºé”™', e);
            }
        }
        
        // 7. å¦‚æœæ¢å¤äº†ä»ªå¼æ•°æ®ï¼Œéœ€è¦é‡æ–°åŠ è½½å¹¶æ›´æ–°ç•Œé¢
        if (localData && (localData.ritualMorning || localData.ritualNight)) {
            loadRitualSettings();
            const inputMorning = document.getElementById('ritualMorningInput');
            const inputNight = document.getElementById('ritualNightInput');
            if (inputMorning && ritualMorningSteps) inputMorning.value = ritualMorningSteps.join('\n');
            if (inputNight && ritualNightSteps) inputNight.value = ritualNightSteps.join('\n');
        }
        
        // 8. è°ƒç”¨æ¸²æŸ“å‡½æ•°åˆ·æ–°ç•Œé¢
        renderList();
        renderArchive();
        renderLog();
        renderHistory();
        updateStatsUI();
        
        let successMsg = `âœ… æˆåŠŸ${action === 'overwrite' ? 'è¦†ç›–' : 'åˆå¹¶'}å¯¼å…¥ ${taskCount} ä¸ªä»»åŠ¡`;
        if (archiveCount > 0) successMsg += `ã€${archiveCount} ä¸ªå½’æ¡£`;
        if (logCount > 0) successMsg += `ã€${logCount} æ¡è¶³è¿¹`;
        if (hasLocalData) successMsg += `\nä»¥åŠä»ªå¼å’Œæ‰“å¡æ•°æ®`;
        alert(successMsg);
        
        document.getElementById('dataArea').value = "";
    }

    function triggerImport() { document.getElementById('fileInput').click(); }

    function importFromFile(input) { 
        const file = input.files[0]; if(!file) return; 
        const reader = new FileReader(); 
        reader.onload = function(e) { 
            document.getElementById('dataArea').value = e.target.result; 
            executeImport(); 
        }; 
        reader.readAsText(file); 
    }
    // ä»ç¼–è¾‘æ¡†ä¿å­˜èµ·é£ / ç€é™†ä»ªå¼åˆ°æœ¬åœ°
    function saveRitualFromInputs() {
        const inputMorning = document.getElementById('ritualMorningInput');
        const inputNight   = document.getElementById('ritualNightInput');
        if (!inputMorning || !inputNight) return;

        const mLines = inputMorning.value
            .split('\n')
            .map(s => s.trim())
            .filter(Boolean);   // å»æ‰ç©ºè¡Œ
        const nLines = inputNight.value
            .split('\n')
            .map(s => s.trim())
            .filter(Boolean);

        // å¦‚æœç”¨æˆ·å…¨åˆ ç©ºï¼Œå°±é€€å›é»˜è®¤æ¨¡æ¿ï¼Œé¿å…å‡ºç°â€œç©ºä»ªå¼â€
        ritualMorningSteps = mLines.length ? mLines : ritualMorningDefault.slice();
        ritualNightSteps   = nLines.length ? nLines : ritualNightDefault.slice();

        try {
            localStorage.setItem(KEY_RITUAL_MORNING, JSON.stringify(ritualMorningSteps));
            localStorage.setItem(KEY_RITUAL_NIGHT,  JSON.stringify(ritualNightSteps));
        } catch (e) {
            console.warn('ä¿å­˜ä»ªå¼è®¾ç½®å‡ºé”™', e);
        }

        showToast('ğŸ“ å·²æ›´æ–°èµ·é£ / ç€é™†ä»ªå¼');
    }

    // æ¢å¤ä¸ºé»˜è®¤æ¨¡æ¿
    function resetRitualToDefault() {
        ritualMorningSteps = ritualMorningDefault.slice();
        ritualNightSteps   = ritualNightDefault.slice();

        try {
            localStorage.removeItem(KEY_RITUAL_MORNING);
            localStorage.removeItem(KEY_RITUAL_NIGHT);
        } catch (e) {}

        const inputMorning = document.getElementById('ritualMorningInput');
        const inputNight   = document.getElementById('ritualNightInput');
        if (inputMorning) inputMorning.value = ritualMorningSteps.join('\n');
        if (inputNight)   inputNight.value   = ritualNightSteps.join('\n');

        showToast('âœ¨ å·²æ¢å¤é»˜è®¤ä»ªå¼');
    }

    // ã€å¤‡ä»½å¯¼å‡º/å¯¼å…¥å‡çº§ v6.3-backup2ã€‘exportToFile: å¯¼å‡ºåŒ…å«ç‰ˆæœ¬ä¿¡æ¯å’Œ localStorage æ•°æ®çš„æ–°æ ¼å¼
    function exportToFile() { 
        // è¯»å– localStorage ä¸­çš„ä»ªå¼å’Œæ‰“å¡æ•°æ®
        let ritualMorning = null;
        let ritualNight = null;
        let openedDays = [];
        let posterShownDay = null;
        
        try {
            const storedMorning = localStorage.getItem(KEY_RITUAL_MORNING);
            const storedNight = localStorage.getItem(KEY_RITUAL_NIGHT);
            if (storedMorning) {
                ritualMorning = JSON.parse(storedMorning);
            }
            if (storedNight) {
                ritualNight = JSON.parse(storedNight);
            }
            
            const storedDays = localStorage.getItem(KEY_OPENED_DAYS);
            if (storedDays) {
                openedDays = JSON.parse(storedDays);
                if (!Array.isArray(openedDays)) openedDays = [];
            }
            
            posterShownDay = localStorage.getItem(KEY_POSTER_SHOWN_DAY);
        } catch (e) {
            console.warn('è¯»å– localStorage æ•°æ®æ—¶å‡ºé”™', e);
        }
        
        // æ„å»ºæ–°æ ¼å¼çš„å¤‡ä»½å¯¹è±¡
        const backupData = {
            version: "v6.3-backup2",
            exportedAt: new Date().toISOString(),
            data: { db, archive, dailyLog, userStats },
            local: {
                ritualMorning: ritualMorning,
                ritualNight: ritualNight,
                openedDays: openedDays,
                posterShownDay: posterShownDay
            }
        };
        
        const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: "application/json"}); 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = "anchor_backup_" + new Date().toISOString().slice(0,10) + ".json"; 
        a.click(); 
    }

    // ã€å¤‡ä»½å¯¼å‡º/å¯¼å…¥å‡çº§ v6.3-backup2ã€‘copyToClip: å¤åˆ¶åŒ…å«ç‰ˆæœ¬ä¿¡æ¯å’Œ localStorage æ•°æ®çš„æ–°æ ¼å¼
    function copyToClip() { 
        // è¯»å– localStorage ä¸­çš„ä»ªå¼å’Œæ‰“å¡æ•°æ®
        let ritualMorning = null;
        let ritualNight = null;
        let openedDays = [];
        let posterShownDay = null;
        
        try {
            const storedMorning = localStorage.getItem(KEY_RITUAL_MORNING);
            const storedNight = localStorage.getItem(KEY_RITUAL_NIGHT);
            if (storedMorning) {
                ritualMorning = JSON.parse(storedMorning);
            }
            if (storedNight) {
                ritualNight = JSON.parse(storedNight);
            }
            
            const storedDays = localStorage.getItem(KEY_OPENED_DAYS);
            if (storedDays) {
                openedDays = JSON.parse(storedDays);
                if (!Array.isArray(openedDays)) openedDays = [];
            }
            
            posterShownDay = localStorage.getItem(KEY_POSTER_SHOWN_DAY);
        } catch (e) {
            console.warn('è¯»å– localStorage æ•°æ®æ—¶å‡ºé”™', e);
        }
        
        // æ„å»ºæ–°æ ¼å¼çš„å¤‡ä»½å¯¹è±¡
        const backupData = {
            version: "v6.3-backup2",
            exportedAt: new Date().toISOString(),
            data: { db, archive, dailyLog, userStats },
            local: {
                ritualMorning: ritualMorning,
                ritualNight: ritualNight,
                openedDays: openedDays,
                posterShownDay: posterShownDay
            }
        };
        
        const str = JSON.stringify(backupData, null, 2); 
        if (navigator.clipboard && navigator.clipboard.writeText) { 
            navigator.clipboard.writeText(str)
                .then(()=> alert("âœ… å·²å¤åˆ¶"))
                .catch(()=>{ 
                    document.getElementById('dataArea').value=str; 
                    alert("âš ï¸ è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶"); 
                }); 
        } else { 
            document.getElementById('dataArea').value=str; 
            alert("âš ï¸ è¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶"); 
        } 
    }

    // æ ¹æ® APP_VARIANT è°ƒæ•´ UIï¼ˆpersonal / commonï¼‰
function applyVariant() {
    if (typeof APP_VARIANT === 'undefined') return;

    // 1ï¼‰æ ¹æ® variant ç»™ body åŠ  classï¼Œæ–¹ä¾¿ CSS åŒºåˆ†é…è‰²
    document.body.classList.remove('variant-personal', 'variant-common');
    document.body.classList.add(APP_VARIANT === 'common' ? 'variant-common' : 'variant-personal');

    // 2ï¼‰åŸæ¥çš„å”±ç‰‡å…¥å£æ˜¾éšé€»è¾‘
    var vinylTab = document.getElementById('mode-tab-vinyl');
    if (vinylTab) {
        vinylTab.style.display = (APP_VARIANT === 'common') ? 'none' : '';
    }
    var vinylTag = document.getElementById('tag-vinyl');
    if (vinylTag) {
        vinylTag.style.display = (APP_VARIANT === 'common') ? 'none' : '';
    }
        // 3ï¼‰æ ‡é¢˜ç‰ˆæœ¬è§’æ ‡ï¼šcommon æ˜¾ç¤ºâ€œé€šç”¨ç‰ˆâ€
    const badge = document.querySelector('.version-badge');
    if (badge) {
        const base = badge.textContent.replace(/\s*é€šç”¨ç‰ˆ\s*/g, '').trim(); // å…ˆæ¸…æ‰æ—§çš„ï¼Œé¿å…å åŠ 
        badge.textContent = (APP_VARIANT === 'common') ? (base + ' é€šç”¨ç‰ˆ') : base;
    }
}

/* --- é¡µé¢è½½å…¥åè‡ªåŠ¨é€‰æ‹©ç­›é€‰é»˜è®¤å€¼ --- */
document.addEventListener("DOMContentLoaded", function() {
    const ctx = document.getElementById("selContext");
    const time = document.getElementById("selTime");
    if (ctx) ctx.value = "desktop";  // ä¹¦æ¡Œå‰
    if (time) time.value = "120";    // 2å°æ—¶+
});


</script>
    <!-- æ¯æ—¥æ‰“å¡å›¾å¼¹çª—ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="dailyPosterOverlay" class="daily-poster-overlay">
        <div class="daily-poster-card">
<div class="daily-poster-image">
    <img id="dailyPosterImg" class="daily-poster-photo" src="" alt="ä»Šæ—¥æ‰“å¡å›¾" style="opacity: 0; transition: opacity 0.3s; display: block;">
    <div class="daily-poster-caption">
        <div class="daily-poster-day">
            è¿™æ˜¯ä½ å’Œ Anchor çš„ç¬¬
            <span id="dailyPosterDayCount">1</span> å¤©
        </div>
        <div class="daily-poster-subline" id="dailyPosterDate">
            2025.01.01 åƒä¸€æ¬¡çŸ­æš‚åœé ï¼Œçœ‹çœ‹ä»Šå¤©èµ°åˆ°äº†å“ªé‡Œã€‚
        </div>
    </div>
</div>

            <div class="daily-poster-actions">
                <button type="button" class="poster-btn-primary" onclick="dailyPosterEatCandy()">
                    å…ˆåƒé¢—ç³–
                </button>
                <button type="button" class="poster-btn-secondary" onclick="dailyPosterSkipToGacha()">
                    ç›´æ¥æŠ½å¡
                </button>
                <button type="button" class="poster-btn-tertiary" onclick="closeDailyPoster()">
                    ç¨åå†è¯´
                </button>
            </div>
        </div>
    </div>

</body>
</html>