<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anchor</title>
    
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=âš“&background=FFC8D1&color=FFFFFF&size=512&length=1&font-size=0.5&rounded=true&bold=true">
    <link rel="icon" href="https://ui-avatars.com/api/?name=âš“&background=FFC8D1&color=FFFFFF&size=512&length=1&font-size=0.5&rounded=true&bold=true">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        /* ========================================
           ğŸ¨ è§†è§‰é£æ ¼å®šä¹‰ (CSS Variables)
           ========================================
        */
        :root {
            --bg-blue: #D4F1F4;
            --bg-wood: #FDF6E3;
            --bg-pink: #FFE2E2;
            --bg-sos:  #E8DFF5;
            --bg-setting: #F0F4F8;
            --text-main: #5D5C61;
            --gold: #D4AF37;
            --sport-green: #B5EAD7;
            --cycle-purple: #C7CEEA;
            --frog-green: #9CCC65;
            --flash-yellow: #FFD54F;
            --danger-red: #ff6b6b;
            --footprint-grey: #90A4AE;
        }

        /* å…¨å±€æ ·å¼ */
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            /* é˜²æ­¢ iOS åˆ—è¡¨æ»šåŠ¨æ—¶çš„æ©¡çš®ç­‹æ•ˆæœ */
            overscroll-behavior-y: none; 
        }

        .container {
            width: 100%;
            max-width: 450px;
            background-color: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 100vh;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .header {
            padding: 15px 20px;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            /* é€‚é…åˆ˜æµ·å± */
            padding-top: max(15px, env(safe-area-inset-top));
        }

        .app-title {
            font-weight: bold;
            font-size: 1.1rem;
            color: #444;
        }

        .version-badge {
            background: #FFC8D1;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .btn-icon {
            cursor: pointer;
            font-size: 1.2rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .btn-icon:hover { opacity: 1; }

        /* å¿µå¤´è®¡æ•°å™¨ (é¡¶éƒ¨ç»Ÿè®¡æ ) */
        .stats-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 15px;
            background: #fff;
            border-bottom: 1px solid #eee;
        }

        .stat-btn {
            flex: 1;
            margin: 0 5px;
            padding: 8px;
            border-radius: 12px;
            cursor: pointer;
            background: #fafafa;
            border: 1px solid #eee;
            text-align: center;
            transition: all 0.1s;
            user-select: none;
        }

        .stat-btn:active {
            transform: scale(0.96);
            background: #f0f0f0;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-right: 5px;
        }

        .stat-count {
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            font-family: monospace;
        }

        .stat-btn.willpower { color: #5C6BC0; }
        .stat-btn.joy { color: #FFA726; }

        /* ========================================
           1. ç­›é€‰ä¸æ§åˆ¶åŒº (Filter Section)
           ========================================
        */
        .section-filter {
            background-color: var(--bg-blue);
            padding: 20px;
            text-align: center;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            transition: background 0.4s;
            position: relative;
            z-index: 10;
        }

        .mode-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .mode-tab {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            background: rgba(255,255,255,0.5);
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .mode-tab.active {
            background: #fff;
            font-weight: bold;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .control-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        select {
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            font-size: 16px; /* ä¿æŒ16pxé˜²æ­¢iOSæ”¾å¤§ */
            outline: none;
        }
        
        .btn-main {
            background-color: #FF9AA2;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            padding: 12px 40px;
            border: none;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(255, 154, 162, 0.4);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.95); }

        /* ========================================
           2. ç»“æœå±•ç¤ºåŒº (Display Section)
           ========================================
        */
        .section-display {
            flex-grow: 1;
            background-color: var(--bg-pink);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-height: 220px;
            transition: background 0.4s;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            width: 85%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.06);
            display: none; /* é»˜è®¤éšè— */
            animation: slideUp 0.4s ease-out forwards;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .card-icon {
            font-size: 3.5rem;
            display: block;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .card-desc {
            font-size: 0.9rem;
            color: #777;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .card-time {
            display: inline-block;
            background: #f0f0f0;
            color: #888;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            margin-top: 5px;
        }
        
        /* ä»»åŠ¡å±æ€§å¾½ç«  (Badges) */
        .card-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            vertical-align: middle;
            margin-left: 5px;
            color: #fff;
        }
        .bg-cycle { background-color: var(--cycle-purple); }
        .bg-frog { background-color: var(--frog-green); }
        .bg-flash { background-color: var(--flash-yellow); color: #555; }

        .btn-card-action {
            background: #f0f0f0;
            padding: 8px 18px;
            border-radius: 15px;
            font-size: 0.85rem;
            border: none;
            cursor: pointer;
            color: #555;
            margin: 0 5px;
            transition: background 0.2s;
        }
        .btn-card-action:active { background: #e0e0e0; }

        /* ========================================
           3. è¾“å…¥æ§åˆ¶åŒº (Input Section)
           ========================================
        */
        .section-input {
            background-color: var(--bg-wood);
            padding: 20px;
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        .input-box {
            background: #fff;
            padding: 5px;
            border-radius: 15px;
            display: flex;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 10px;
            align-items: center;
        }

        textarea#inpTitle {
            border: none;
            padding: 10px;
            flex: 1;
            border-radius: 10px;
            outline: none;
            font-size: 16px; /* 16px é˜²æ­¢æ”¾å¤§ */
            font-family: inherit;
            resize: none;
            height: 24px;
            line-height: 24px;
        }

        .btn-add {
            background-color: #B5EAD7;
            border: none;
            padding: 0 20px;
            height: 40px;
            border-radius: 10px;
            font-weight: bold;
            color: #555;
            cursor: pointer;
        }
        
        .input-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .tags-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            background: rgba(0,0,0,0.05);
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .tag.active {
            background-color: #C7CEEA;
            border-color: #989ec2;
            color: #333;
        }
        .tag[data-v="sport"].active {
            background-color: var(--sport-green);
            border-color: #99cbb9;
        }

        /* å¼€å…³æŒ‰é’®æ ·å¼ */
        .switch-container { display: flex; gap: 8px; }
        
        .switch-btn {
            font-size: 0.75rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            background: rgba(255,255,255,0.5);
            padding: 4px 8px;
            border-radius: 10px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .switch-btn.active-cycle {
            background-color: var(--cycle-purple);
            color: #fff;
            font-weight: bold;
        }
        .switch-btn.active-flash {
            background-color: var(--flash-yellow);
            color: #555;
            font-weight: bold;
        }

        .time-select-small {
            font-size: 16px;
            padding: 4px;
            border-radius: 8px;
            border: 1px solid #ddd;
            color: #666;
            transition: opacity 0.3s;
        }
        .time-select-small.disabled { opacity: 0.3; pointer-events: none; }

        /* ========================================
           4. åˆ—è¡¨ä¸å½’æ¡£åŒº (Lists & Archive)
           ========================================
        */
        .section-list {
            background-color: #fff;
            padding: 20px;
        }

        .list-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            margin-top: 10px;
        }

        .list-title {
            font-size: 0.95rem;
            font-weight: bold;
            color: #555;
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .task-list.open {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #f9f9f9;
        }

        .task-status-done {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .list-badge {
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 5px;
            border: 1px solid #eee;
            color: #888;
        }
        .lb-frog { color: var(--frog-green); border-color: var(--frog-green); font-weight:bold; }
        .lb-flash { color: #FBC02D; border-color: #FBC02D; }

        .footprint-time {
            font-size: 0.7rem;
            color: #aaa;
            margin-right: 10px;
            font-family: monospace;
        }
        .footprint-item { color: #666; font-size: 0.85rem; }

        .archive-section {
            margin-top: 20px;
            border-top: 4px solid #f0f2f5;
            padding-top: 15px;
        }
        .archive-list {
            display: none;
            margin-top: 10px;
            color: #999;
            font-size: 0.85rem;
        }
        .archive-item { padding: 5px 0; display: flex; gap: 10px; }
        .archive-date { font-family: monospace; color: #ccc; }

        /* ========================================
           5. è¯´æ˜ä¹¦ & è®¾ç½®åŒº (Manual & Settings)
           ========================================
        */
        .section-manual {
            background-color: #fff;
            padding: 20px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        details {
            background: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        summary {
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #444;
        }
        summary::after { content: '+'; font-size: 1.2rem; font-weight: normal; color: #999; }
        details[open] summary::after { content: '-'; }
        
        .manual-content {
            padding: 0 15px 20px 15px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
        }
        .manual-h3 {
            font-weight: bold;
            color: #333;
            margin: 15px 0 5px 0;
        }
        .manual-tag {
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 0 2px;
        }

        .section-settings {
            background-color: var(--bg-setting);
            padding: 20px;
            border-top: 1px solid #eee;
            padding-bottom: 80px; /* åº•éƒ¨ç•™ç™½ */
        }
        .settings-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }
        
        .backup-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .btn-outline {
            background: #fff;
            border: 1px solid #bbb;
            color: #555;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-file {
            background: #e1eefd;
            border: 1px solid #bbd4f0;
            color: #1565C0;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .setting-textarea {
            width: 100%;
            height: 80px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            color: #555;
            padding: 8px;
            font-family: monospace;
        }
        .btn-danger {
            width: 100%;
            padding: 10px;
            background: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-size: 0.8rem;
        }

        /* ========================================
           6. æµ®çª—ç»„ä»¶ (Toast & Modal) - è§£å†³ iOS å…¼å®¹æ€§
           ========================================
        */
        .toast-notification {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 0.9rem;
            z-index: 2000;
            transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .toast-notification.show { top: 20px; }

        .custom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .custom-modal {
            background: white;
            width: 80%;
            max-width: 320px;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: left;
            animation: popIn 0.2s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }
        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-text {
            margin-bottom: 20px;
            font-size: 0.95rem;
            color: #333;
            line-height: 1.6;
        }
        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            text-align: center;
        }
        .modal-btn.cancel { background: #f0f0f0; color: #666; }
        .modal-btn.confirm { background: var(--bg-blue); color: #006064; }
        .modal-btn.danger { background: var(--danger-red); color: white; }

    </style>
</head>
<body>

<div id="toast" class="toast-notification">âœ… æ“ä½œæˆåŠŸ</div>

<div id="modalOverlay" class="custom-overlay">
    <div class="custom-modal">
        <div id="modalMsg" class="modal-text"></div>
        <div class="modal-btns" id="modalBtnContainer"></div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div><span class="app-title">Anchor âš“ï¸</span><span class="version-badge">v5.2</span></div>
        <span class="btn-icon" onclick="scrollToSettings()">âš™ï¸</span>
    </div>

    <div class="stats-bar">
        <div class="stat-btn willpower" onclick="incrementStat('willpower')">
            <span class="stat-label">ğŸ›¡ï¸ æ„å¿—åŠ›</span>
            <span class="stat-count" id="stat-willpower">0</span>
        </div>
        <div class="stat-btn joy" onclick="incrementStat('joy')">
            <span class="stat-label">âœ¨ å°ç¡®å¹¸</span>
            <span class="stat-count" id="stat-joy">0</span>
        </div>
    </div>

    <div class="section-filter" id="filterSec">
        <div class="mode-tabs">
            <div class="mode-tab active" onclick="setMode('normal')">ğŸ”® æ··åˆ/å…¨åŸŸ</div>
            <div class="mode-tab" onclick="setMode('culture')">ğŸ“š åªçœ‹ä¹¦å½±</div>
            <div class="mode-tab" onclick="setMode('vinyl')">ğŸµ åªå¬å”±ç‰‡</div>
            <div class="mode-tab" onclick="setMode('sos')" style="color:#d9534f">ğŸ†˜ SOS</div>
        </div>
        <div id="controls-normal" class="control-group">
            <select id="selContext"><option value="desktop">ğŸ’» ä¹¦æ¡Œå‰</option><option value="indoor">ğŸ  å®¤å†…/å®¶</option><option value="outdoor">ğŸŒ³ æˆ·å¤–</option></select>
            <select id="selTime"><option value="30">â³ æœ‰30åˆ†é’Ÿ</option><option value="60">â³ æœ‰1å°æ—¶</option><option value="120">â³ æœ‰2å°æ—¶+</option></select>
        </div>
        <div id="controls-sos" class="control-group" style="display:none; color: #555; font-size:0.9rem;"><span>ğŸƒ å…è®¸è‡ªå·±æš‚æ—¶åœä¸‹æ¥...</span></div>
        <button class="btn-main" onclick="draw()" id="mainBtn">æŠ½å–ä»»åŠ¡</button>
    </div>

    <div class="section-display" id="displaySec">
        <div id="placeholder" style="color:#aaa; font-weight:bold; opacity:0.5;">...</div>
        <div id="resultCard" class="card">
            <span class="card-icon" id="rIcon">ğŸ</span>
            <div class="card-title"><span id="rTitle"></span><span id="rBadge"></span></div>
            <div class="card-desc" id="rDesc"></div>
            <div class="card-time" id="rTime"></div> 
            <div style="margin-top:15px;">
                <button class="btn-card-action" onclick="draw()">æ¢ä¸€ä¸ª</button>
                <button class="btn-card-action" onclick="finishTask()" id="btnFinish">å»å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div class="section-input">
        <div class="input-box">
            <textarea id="inpTitle" rows="1" placeholder="è¾“å…¥äº‹é¡¹... (*å¼€å¤´æ ‡è®°é‡è¦/é’è›™)" oninput="autoTag()" onkeypress="handleEnter(event)"></textarea>
            <button class="btn-add" onclick="addNew()">ï¼‹</button>
        </div>
        <div class="input-options">
            <div class="tags-row">
                <div class="tag active" data-v="indoor" onclick="pickTag(this)">ğŸ  å®¤å†…</div>
                <div class="tag" data-v="desktop" onclick="pickTag(this)">ğŸ’» æ¡Œå‰</div>
                <div class="tag" data-v="outdoor" onclick="pickTag(this)">ğŸŒ³ æˆ·å¤–</div>
                <div class="tag" data-v="sport" onclick="pickTag(this)">ğŸƒ è¿åŠ¨</div>
                <div class="tag" data-v="culture" onclick="pickTag(this)">ğŸ“š ä¹¦/å½±</div>
                <div class="tag" data-v="vinyl" onclick="pickTag(this)">ğŸµ å¬ç¢Ÿ</div>
            </div>
        </div>
        <div class="input-options" style="margin-top:8px;">
            <div class="switch-container">
                <div class="switch-btn" id="cycleSwitch" onclick="toggleSwitch('cycle')"><span>ğŸ”„ æ¯æ—¥å¾ªç¯</span></div>
                <div class="switch-btn" id="flashSwitch" onclick="toggleSwitch('flash')"><span>âš¡ï¸ é€ŸåŠæ¨¡å¼</span></div>
            </div>
            <select id="inpTime" class="time-select-small">
                <option value="5">5m (é€ŸåŠ)</option>
                <option value="15">15m</option>
                <option value="30" selected>30m</option>
                <option value="60">1h</option>
                <option value="120">2h+</option>
            </select>
        </div>
        <div id="timeFeedback" style="font-size:0.7rem; color:#75B79E; margin-top:5px; margin-left:5px; height:1rem;"></div>
    </div>

    <div class="section-list">
        <div class="list-section-header" onclick="toggleList('dailyList')"><span class="list-title">ğŸ“‹ æ—¥å¸¸ & è¿åŠ¨ (<span id="dailyCount">0</span>)</span><span style="font-size:0.8rem; color:#ccc">â–¼</span></div>
        <ul id="dailyList" class="task-list open"></ul>
        
        <div class="list-section-header" onclick="toggleList('mediaList')"><span class="list-title">ğŸ¬ åª’ä½“åº“æˆ¿ (<span id="mediaCount">0</span>)</span><span style="font-size:0.8rem; color:#ccc">â–¼</span></div>
        <ul id="mediaList" class="task-list"></ul>

        <div class="list-section-header" onclick="toggleList('logList')"><span class="list-title" style="color:var(--footprint-grey)">ğŸ‘£ ä»Šæ—¥è¶³è¿¹ (<span id="logCount">0</span>)</span><span style="font-size:0.8rem; color:#ccc">â–¼</span></div>
        <ul id="logList" class="task-list"></ul>

        <div class="archive-section">
            <div class="list-section-header" onclick="toggleList('archiveList')"><span class="list-title" style="color:var(--gold)">ğŸ† è£èª‰æ®¿å ‚ (<span id="arcCount">0</span>)</span><span style="font-size:0.8rem; color:#ccc">â–¼</span></div>
            <div id="archiveList" class="task-list"></div>
        </div>
    </div>

    <div class="section-manual">
        <details>
            <summary>ğŸ“– ç”¨æˆ·æ‰‹å†Œ & é€»è¾‘è¯å…¸</summary>
            <div class="manual-content">
                <div class="manual-h3">ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ</div>
                <p>Anchor æ˜¯ä¸€ä¸ªå¸®ä½ å¯¹æŠ—æ— åºã€æ‰¾å›ç”Ÿæ´»æŒæ§æ„Ÿçš„å·¥å…·ã€‚æŠŠæƒ³åšçš„äº‹ä¸¢è¿›å»ï¼Œè®©â€œå‘½è¿â€å¸®ä½ åšå†³å®šã€‚</p>
                <div class="manual-h3">âŒ¨ï¸ æ™ºèƒ½è¾“å…¥</div>
                <p>æ”¯æŒâ€œè¯´äººè¯â€å’Œæ‰¹é‡ç²˜è´´ã€‚æ¯è¡Œä¸€ä¸ªä»»åŠ¡ã€‚</p>
                <ul>
                    <li><b>è‡ªåŠ¨ä¹¦å½±ï¼š</b> è¾“å…¥ <span class="manual-tag">çœ‹/è¯»/ä¹¦/å½±</span> å¼€å¤´ï¼Œè‡ªåŠ¨å½’ç±»ä¸ºæ–‡åŒ–ï¼Œå¹¶åŠ ä¹¦åå·ã€‚</li>
                    <li><b>é—ªç”µé€ŸåŠï¼š</b> è¾“å…¥ <span class="manual-tag">æ´—/åˆ·/ç†/æ‹†/æ‰”/å–</span> ç­‰ï¼Œè‡ªåŠ¨æ ‡è®°ä¸º <span class="manual-tag">âš¡ï¸é€ŸåŠ</span> (5min)ã€‚</li>
                    <li><b>é’è›™ä»»åŠ¡ï¼š</b> è¾“å…¥ <span class="manual-tag">*</span> (æ˜Ÿå·) å¼€å¤´ï¼Œæ ‡è®°ä¸ºå›°éš¾é‡è¦çš„ <span class="manual-tag">ğŸ¸é’è›™</span>ã€‚</li>
                    <li><b>æ¯æ—¥å¾ªç¯ï¼š</b> è¾“å…¥ <span class="manual-tag">æ¯å¤©/æ¯æ—¥</span>ï¼Œè‡ªåŠ¨å¼€å¯å¾ªç¯ã€‚</li>
                </ul>
                <div class="manual-h3">ğŸ² æŠ½å–é€»è¾‘</div>
                <ul>
                    <li><b>æ··åˆæ¨¡å¼ï¼š</b> æ ¹æ®å½“ä¸‹æ—¶é—´ã€åœ°ç‚¹ï¼Œä»æ‰€æœ‰åº“ä¸­éšæœºæŠ½å–ã€‚</li>
                    <li><b>é’è›™ä¼˜å…ˆï¼š</b> åœ¨ä¹¦æ¡Œå‰ä¸”æ—¶é—´å……è¶³æ—¶ï¼Œå¤§æ¦‚ç‡ä¼˜å…ˆæ¨â€œé’è›™â€ã€‚</li>
                    <li><b>é˜²é‡å¤ï¼š</b> æœ€è¿‘åˆšæŠ½è¿‡çš„ä»»åŠ¡ï¼ŒçŸ­æ—¶é—´å†…ä¸ä¼šå†å‡ºç°ã€‚</li>
                </ul>
                <div class="manual-h3">ğŸ“Š è®¡æ•°å™¨ä¸å½’æ¡£</div>
                <ul>
                    <li><b>ğŸ›¡ï¸ æ„å¿—åŠ›ï¼š</b> æƒ³åšåä¹ æƒ¯ä½†å¿ä½æ—¶ï¼Œç‚¹ä¸€ä¸‹ã€‚</li>
                    <li><b>âœ¨ å°ç¡®å¹¸ï¼š</b> é‡åˆ°å¼€å¿ƒçš„å°äº‹æ—¶ï¼Œç‚¹ä¸€ä¸‹ã€‚</li>
                    <li><b>ğŸ‘£ ä»Šæ—¥è¶³è¿¹ï¼š</b> è®°å½•ä»Šå¤©çš„æ—¥å¸¸æµæ°´ï¼Œæ¬¡æ—¥è‡ªåŠ¨æ¸…ç©ºã€‚</li>
                    <li><b>ğŸ† è£èª‰æ®¿å ‚ï¼š</b> æ°¸ä¹…ä¿å­˜è¯»å®Œçš„ä¹¦å’Œçœ‹è¿‡çš„ç”µå½±ã€‚</li>
                </ul>
            </div>
        </details>
    </div>

    <div class="section-settings" id="settingSec">
        <div class="settings-title">ğŸ“¡ æ•°æ®æ–¹èˆŸ (Stable)</div>
        <div style="font-size:0.8rem; color:#1565C0; margin-bottom:5px; font-weight:bold;">ğŸ“‚ æ–‡ä»¶å¤‡ä»½ (ç”µè„‘ç«¯æ¨è)</div>
        <div class="backup-grid">
            <button class="btn-file" onclick="exportToFile()">ğŸ“¥ å¯¼å‡ºæ–‡ä»¶</button>
            <button class="btn-file" onclick="triggerImport()">ğŸ“¤ å¯¼å…¥æ–‡ä»¶ (Merge)</button>
        </div>
        <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
        <div style="font-size:0.8rem; color:#666; margin-bottom:5px; font-weight:bold;">ğŸ“ æ–‡æœ¬æ“ä½œ (æ‰‹æœºç«¯)</div>
        <div class="backup-grid">
            <button class="btn-outline" onclick="copyToClip()">ğŸ“‹ å¤åˆ¶æ–‡æœ¬ç </button>
            <button class="btn-outline" onclick="document.getElementById('dataArea').value=''">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <textarea id="dataArea" class="setting-textarea" placeholder="åœ¨æ­¤é•¿æŒ‰ç²˜è´´æ•°æ®ä»£ç ..."></textarea>
        <button class="btn-file" style="width:100%; background:#E8F5E9; border-color:#A5D6A7; color:#2E7D32;" onclick="executeImport()">âœ… ç¡®è®¤å¯¼å…¥ (Merge)</button>
        <button class="btn-danger" onclick="tryResetAll()">ğŸ—‘ï¸ æ ¼å¼åŒ–/é‡ç½®æ‰€æœ‰æ•°æ®</button>
        <input type="file" id="fileInput" style="display:none" onchange="importFromFile(this)">
    </div>
</div>

<script>
    // --- ğŸ” æ ¸å¿ƒå­˜å‚¨é”®å (ä¿æŒ v5.x ç³»åˆ—ä¸€è‡´ï¼Œç¡®ä¿ä¸ä¸¢æ•°æ®) ---
    const KEY_DB = 'anchor_live_db';
    const KEY_ARCHIVE = 'anchor_live_archive';
    const KEY_LOG = 'anchor_live_log';
    const KEY_STATS = 'anchor_live_stats';
    const KEY_VISITED = 'anchor_has_visited';

    // é»˜è®¤æ•°æ®
    const defaultDB = [
        { id: 1, title: "å¬ä¸€å¼ å–œæ¬¢çš„é»‘èƒ¶", type: "vinyl", desc: "éŸ³ä¹æ—¶é—´", time: 0 },
        { id: 2, title: "å–æ°´æœèŒ¶", type: "indoor", desc: "è¡¥å……ç»´C", time: 15 }
    ];
    const sosLibrary = [
        { title: "å¤§å£å–æ°´", icon: "ğŸ’§" }, { title: "çœ‹çª—å¤–è¿œæ–¹", icon: "ğŸ‘€" }, { title: "4-7-8 å‘¼å¸", icon: "ğŸŒ¬ï¸" },
        { title: "å‹è…¿æ‹‰ä¼¸", icon: "ğŸ¦µ" }, { title: "äº”æ„Ÿç€é™†", icon: "ğŸ–ï¸" }, { title: "æ´—æŠŠè„¸", icon: "ğŸš¿" },
        { title: "åƒä¸€é¢—æ°´æœ", icon: "ğŸŠ" }
    ];

    // åŠ è½½æ•°æ®
    let db = JSON.parse(localStorage.getItem(KEY_DB)) || [];
    let archive = JSON.parse(localStorage.getItem(KEY_ARCHIVE)) || [];
    let dailyLog = JSON.parse(localStorage.getItem(KEY_LOG)) || [];
    let userStats = JSON.parse(localStorage.getItem(KEY_STATS)) || { willpower: 0, joy: 0 };
    
    let recentHistory = []; 
    let mode = 'normal';
    let currentTask = null;
    let switchState = { cycle: false, flash: false };

    // --- ğŸš€ åˆå§‹åŒ–å‡½æ•° ---
    function init() {
        // å°è¯•ä»æ—§ç‰ˆæœ¬è¿ç§»æ•°æ®ï¼ˆå¦‚æœå½“å‰ä¸ºç©ºï¼‰
        migrateOldData();
        
        // å¦‚æœè¿ç§»åè¿˜æ˜¯ç©ºçš„ï¼ŒåŠ è½½é»˜è®¤æ•°æ®
        if(db.length === 0 && archive.length === 0) {
            db = defaultDB; 
        }

        checkLogExpiry(); // æ£€æŸ¥æ—¥å¿—æ˜¯å¦è¿‡æœŸ
        renderList(); 
        renderArchive(); 
        renderLog(); 
        updateStatsUI(); 
        setMode('normal');

        // é¦–æ¬¡è®¿é—®å¼¹çª—
        if (!localStorage.getItem(KEY_VISITED)) {
            alert("ğŸ‘‹ æ¬¢è¿æ¥åˆ° Anchor v5.2ï¼\n\nåŠŸèƒ½å·²è¡¥å…¨ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚");
            localStorage.setItem(KEY_VISITED, 'true');
        }
    }

    // --- ğŸ› ï¸ æ•°æ®æŒä¹…åŒ–ä¸è¿ç§» ---
    function save() {
        localStorage.setItem(KEY_DB, JSON.stringify(db));
        localStorage.setItem(KEY_ARCHIVE, JSON.stringify(archive));
        localStorage.setItem(KEY_LOG, JSON.stringify(dailyLog));
        localStorage.setItem(KEY_STATS, JSON.stringify(userStats));
    }

    function migrateOldData() {
        if (localStorage.getItem(KEY_DB)) return; // å·²æœ‰æ–°æ•°æ®ï¼Œæ— éœ€è¿ç§»
        const oldKeys = [
            'anchor_v4_db', 'anchor_v2_7_db', 'anchor_v2_6_db', 'anchor_v2_5_db', 'anchor_v2_4_db', 
            'anchor_v2_3_db', 'anchor_v2_2_db', 'anchor_v2_1_db', 'anchor_v1_9_1_db'
        ];
        for (let key of oldKeys) {
            const oldData = localStorage.getItem(key);
            if (oldData) {
                try {
                    db = JSON.parse(oldData);
                    const ver = key.replace('_db', '');
                    const oldArc = localStorage.getItem(ver + '_archive');
                    const oldLog = localStorage.getItem(ver + '_log');
                    const oldStats = localStorage.getItem(ver + '_stats');
                    if (oldArc) archive = JSON.parse(oldArc);
                    if (oldLog) dailyLog = JSON.parse(oldLog);
                    if (oldStats) userStats = JSON.parse(oldStats);
                    
                    fixLegacyData(); // ä¿®å¤æ•°æ®ç»“æ„
                    save(); 
                    break; 
                } catch(e) {}
            }
        }
    }

    // æ•°æ®æ¸…æ´—ï¼šä¿è¯è€æ•°æ®æœ‰æ–°å­—æ®µ
    function fixLegacyData() {
        let fixedCount = 0;
        db.forEach(item => {
            if ((item.type === 'vinyl' || item.type === 'culture') && (item.time === undefined || item.time === null)) item.time = 0;
            else if (item.time === undefined || item.time === null) item.time = 30;
            
            if (item.recurrence === undefined) item.recurrence = 'none';
            if (item.desc === "è‡ªå®šä¹‰" || item.desc === "è‡ªå®šä¹‰ä»»åŠ¡") item.desc = "";
            
            if (item.isFrog === undefined) item.isFrog = false;
            if (item.isQuick === undefined) item.isQuick = false;
        });
        save();
    }

    // --- ğŸ•’ é€»è¾‘åŠŸèƒ½ ---
    function checkLogExpiry() {
        const today = new Date().toDateString();
        const validLogs = dailyLog.filter(log => log.date === today);
        // å¦‚æœæœ‰è¿‡æœŸæ—¥å¿—è¢«è¿‡æ»¤æ‰äº†ï¼Œä¿å­˜æ–°çŠ¶æ€
        if (validLogs.length !== dailyLog.length) {
            dailyLog = validLogs;
            save();
        }
    }

    function incrementStat(type) {
        if (type === 'willpower') {
            userStats.willpower++;
            showToast("ğŸ’ª æ„å¿—åŠ› +1");
        } else if (type === 'joy') {
            userStats.joy++;
            showToast("âœ¨ å°ç¡®å¹¸ +1");
        }
        updateStatsUI();
        save();
    }

    // --- ğŸ® æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (AddNew) ---
    function addNew() {
        const rawInput = document.getElementById('inpTitle').value;
        if(!rawInput || rawInput.trim() === "") return;
        
        let lines = rawInput.split('\n').filter(line => line.trim() !== "");
        const type = document.querySelector('.tag.active').dataset.v;
        let addedCount = 0;
        let batchSubtype = ''; 

        // é¢†å¤´ç¾Šæ£€æµ‹ (ç¬¬ä¸€è¡Œæ˜¯å¦ä¸ºæŒ‡ä»¤)
        if (lines.length > 0) {
            const first = lines[0].toLowerCase();
            const isCleaning = /(ç†|æ•´ç†|æ”¶æ‹¾|æ“¦|æ‰«|æ‹–|æ´—|æ¢|å |é“º|æŒ‚|æ‰”|æ‹†|è£…|å–)/.test(first);

            if (!isCleaning) {
                if (['çœ‹', 'å½±', 'è§†', 'å‰§', 'ç‰‡', 'movie'].some(k => first.includes(k))) {
                    batchSubtype = 'movie';
                } else if (['è¯»', 'ä¹¦', 'é˜…', 'book', 'read', 'æ‚å¿—'].some(k => first.includes(k))) {
                    batchSubtype = 'book';
                }
                // å¦‚æœæ˜¯çŸ­æŒ‡ä»¤ï¼Œç§»é™¤ç¬¬ä¸€è¡Œ
                if (batchSubtype && first.length <= 4) lines.shift();
            }
        }

        lines.forEach(line => {
            const parsed = parseTimeFromInput(line);
            let title = parsed.title;
            let timeVal = parsed.time;
            let subtype = batchSubtype;

            // é’è›™æ£€æµ‹
            let isFrog = false;
            if (title.startsWith('*') || title.startsWith('ï¼Š')) {
                isFrog = true;
                title = title.substring(1).trim();
            }

            // é€ŸåŠæ£€æµ‹
            let isQuick = switchState.flash;
            if (!isQuick) {
                if (/(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|ç†|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(title)) {
                    isQuick = true;
                }
                if (timeVal && timeVal <= 5) isQuick = true;
            }

            // æ—¶é—´åˆ¤å®š
            if (!timeVal) {
                timeVal = parseInt(document.getElementById('inpTime').value);
                if (type === 'vinyl' && !isQuick) timeVal = 0;
                else if (type === 'culture' && !isQuick) {
                    if (subtype === 'movie') timeVal = 120;
                    else timeVal = 0;
                }
            }
            if (isQuick && (!timeVal || timeVal > 15)) timeVal = 5;

            // å­ç±»å‹æ¨æ–­
            if (!isQuick && !subtype && type === 'culture') {
                if (title.includes('å½±') || title.includes('è§†') || title.includes('å‰§') || title.includes('ç‰‡') || title.includes('çœ‹')) subtype = 'movie';
                else if (title.includes('ä¹¦') || title.includes('è¯»') || title.includes('é˜…') || title.includes('æ‚å¿—') || title.includes('å‘¨åˆŠ')) subtype = 'book';
            }

            // æ¸…æ´—åŠ¨è¯
            title = title.replace(/^(å»|çœ‹|è¯»|å¬|å†™|åš)\s*/, '').trim();

            // ä¹¦åå·
            if (!isQuick && (type === 'culture' || type === 'vinyl')) {
                if (!title.startsWith('ã€Š') && !title.endsWith('ã€‹')) {
                    title = `ã€Š${title}ã€‹`;
                }
            }

            // ç³»åˆ—æ£€æµ‹
            let isSeries = false;
            if (type === 'culture') {
                if (title.includes('æ‚å¿—') || title.includes('å‘¨åˆŠ') || title.includes('ç³»åˆ—') || title.includes('å…¨é›†')) isSeries = true;
            }

            // æ¯æ—¥å¾ªç¯é€»è¾‘ (ä¿®å¤ç‚¹ï¼šå¼ºåˆ¶æ£€æµ‹å…³é”®è¯)
            let recurrence = switchState.cycle ? 'daily' : 'none';
            if (recurrence === 'none' && (title.includes('æ¯å¤©') || title.includes('æ¯æ—¥'))) {
                recurrence = 'daily';
            }
            if (recurrence === 'daily') title = title.replace(/æ¯å¤©|æ¯æ—¥/g, '').trim();

            db.push({ 
                id: Date.now() + Math.floor(Math.random() * 10000), 
                title: title, type: type, subtype: subtype, 
                desc: isSeries ? "ç³»åˆ—" : (recurrence === 'daily' ? "æ¯æ—¥ä»»åŠ¡" : ""), 
                isSeries: isSeries, time: timeVal, recurrence: recurrence,
                isFrog: isFrog, isQuick: isQuick, lastDone: '' 
            });
            addedCount++;
        });

        save(); renderList();
        
        const input = document.getElementById('inpTitle');
        input.value = '';
        input.placeholder = "âœ… å­˜å…¥æˆåŠŸï¼";
        document.getElementById('timeFeedback').innerText = "";
        
        // é‡ç½®å¼€å…³
        if(switchState.cycle) toggleSwitch('cycle', false);
        if(switchState.flash) toggleSwitch('flash', false);
        
        showToast(`ğŸ‰ å­˜å…¥ ${addedCount} ä¸ªä»»åŠ¡ï¼`);
        setTimeout(() => input.placeholder = "è¾“å…¥äº‹é¡¹... (*å¼€å¤´æ ‡è®°é‡è¦/é’è›™)", 1500);
    }

    // --- ğŸ® æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (Draw) ---
    function draw() {
        const card = document.getElementById('resultCard');
        card.style.display = 'none';
        
        setTimeout(() => {
            let result = null;
            if (mode === 'sos') {
                const r = Math.floor(Math.random() * sosLibrary.length);
                result = { ...sosLibrary[r], type: 'sos', time: 0 };
            } else {
                const ctx = document.getElementById('selContext').value;
                const limitTime = parseInt(document.getElementById('selTime').value);
                const todayStr = new Date().toDateString();

                let validPool = db.filter(item => {
                    if (item.recurrence === 'daily' && item.lastDone === todayStr) return false;
                    const tTime = (item.time === undefined || item.time === null) ? 30 : item.time;
                    const isFlexible = (tTime === 0);
                    if (!isFlexible && !item.isQuick && tTime > limitTime) return false;

                    if (mode === 'vinyl') return item.type === 'vinyl';
                    if (mode === 'culture') return item.type === 'culture';
                    
                    if (item.type === 'culture' || item.type === 'vinyl') {
                        if (ctx === 'outdoor') return false; 
                    } else if (item.type === 'sport') {
                        return true; 
                    } else {
                        if (ctx === 'desktop') return item.type !== 'outdoor';
                        if (ctx === 'indoor') return item.type === 'indoor';
                        if (ctx === 'outdoor') return item.type === 'outdoor';
                    }
                    return true;
                });

                if (validPool.length > 0) {
                    // é˜²é‡å¤é€»è¾‘
                    let nonRecentPool = validPool.filter(item => !recentHistory.includes(item.id));
                    let finalPool = (nonRecentPool.length > 0) ? nonRecentPool : validPool;

                    // é’è›™é€»è¾‘
                    const isFrogTime = (mode === 'normal' && (ctx === 'desktop' || ctx === 'indoor') && limitTime >= 60);
                    const frogs = finalPool.filter(t => t.isFrog);
                    
                    if (isFrogTime && frogs.length > 0 && Math.random() < 0.7) {
                        result = frogs[Math.floor(Math.random() * frogs.length)];
                    } else {
                        // éšæœºæŠ½å–
                        result = finalPool[Math.floor(Math.random() * finalPool.length)];
                    }
                }
            }

            if (result && result.type !== 'sos') {
                recentHistory.push(result.id);
                if (recentHistory.length > 2) recentHistory.shift(); 
            }

            currentTask = result;
            if (result) {
                document.getElementById('rTitle').innerText = result.title;
                
                let badgesHtml = "";
                if (result.isFrog) badgesHtml += `<span class='card-badge bg-frog'>ğŸ¸ é’è›™</span>`;
                if (result.isQuick) badgesHtml += `<span class='card-badge bg-flash'>âš¡ï¸ é€ŸåŠ</span>`;
                if (result.recurrence === 'daily') badgesHtml += `<span class='card-badge bg-cycle'>ğŸ”„ æ¯æ—¥</span>`;
                document.getElementById('rBadge').innerHTML = badgesHtml;
                
                let displayDesc = result.desc;
                if (!displayDesc || displayDesc === "è‡ªå®šä¹‰") displayDesc = getDescByType(result.type);
                document.getElementById('rDesc').innerText = displayDesc;
                document.getElementById('rIcon').innerText = result.icon || getSmartIcon(result);
                
                let timeStr = "";
                if (result.type === 'sos') timeStr = "âš¡ï¸ å³æ—¶";
                else if (result.isQuick) timeStr = "âš¡ï¸ é€Ÿæˆ˜é€Ÿå†³";
                else if(result.time === 0) timeStr = "â³ ä¸°ä¿­ç”±äºº";
                else timeStr = `â±ï¸ ${result.time} min`;
                
                document.getElementById('rTime').innerText = timeStr;
            } else {
                currentTask = null;
                document.getElementById('rTitle').innerText = "æš‚æ— ä»»åŠ¡";
                document.getElementById('rBadge').innerHTML = "";
                document.getElementById('rDesc').innerText = "ä¼‘æ¯ä¸€ä¸‹ï¼Ÿ";
                document.getElementById('rIcon').innerText = "ğŸŒ™";
                document.getElementById('rTime').innerText = "";
            }
            card.style.display = 'block';
        }, 300);
    }

    function finishTask() {
        if (!currentTask) return;
        if (currentTask.type === 'sos') {
             showToast("çŠ¶æ€é‡å¯ï¼ğŸŒ±");
             document.getElementById('resultCard').style.display = 'none';
             return;
        }

        const recordLog = () => {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            dailyLog.unshift({
                title: currentTask.title,
                icon: currentTask.icon || getSmartIcon(currentTask),
                timeStr: timeStr,
                date: now.toDateString()
            });
            renderLog();
        };

        if (currentTask.recurrence === 'daily') {
            const taskIndex = db.findIndex(t => t.id === currentTask.id);
            if (taskIndex > -1) {
                db[taskIndex].lastDone = new Date().toDateString();
            }
            recordLog();
            save(); renderList();
            showToast("âœ… ä»Šæ—¥æ‰“å¡æˆåŠŸï¼");
            document.getElementById('resultCard').style.display = 'none';
            return;
        }

        if (currentTask.type === 'culture') {
            if (currentTask.isSeries) {
                showToast("ğŸ‰ è®°å½•å®Œæˆï¼");
                document.getElementById('resultCard').style.display = 'none';
                return;
            }
            showModal(`ã€Š${currentTask.title}ã€‹å½»åº•çœ‹å®Œäº†å—ï¼Ÿ`, 'normal', () => {
                db = db.filter(i => i.id !== currentTask.id);
                const doneItem = { ...currentTask, finishDate: new Date().toLocaleDateString() };
                archive.unshift(doneItem);
                save(); renderList(); renderArchive();
                showToast("ğŸ† å·²è½½å…¥è£èª‰æ®¿å ‚ï¼");
                document.getElementById('resultCard').style.display = 'none';
            });
        } 
        else {
            db = db.filter(i => i.id !== currentTask.id);
            recordLog();
            save(); renderList(); 
            showToast("âœ¨ å®Œæˆï¼å·²è®°å…¥ä»Šæ—¥è¶³è¿¹");
            document.getElementById('resultCard').style.display = 'none';
        }
    }

    // --- å¯¼å…¥å¯¼å‡º (Robust) ---
    function executeImport() {
        const str = document.getElementById('dataArea').value;
        if (!str || str.trim().length === 0) {
            showToast("âš ï¸ æ–‡æœ¬æ¡†æ˜¯ç©ºçš„ï¼");
            return;
        }
        
        try {
            const json = JSON.parse(str);
            // å…¼å®¹æ—§ç‰ˆæœ¬ç»“æ„ï¼šå¦‚æœæ˜¯æ•°ç»„ï¼Œé»˜è®¤ä¸ºdbï¼›å¦‚æœæ˜¯å¯¹è±¡ï¼Œè¯»å–å„å­—æ®µ
            let incomingDB = json.db || (Array.isArray(json) ? json : []);
            let incomingArchive = json.archive || [];
            let incomingStats = json.userStats || {};

            if (!Array.isArray(incomingDB)) throw new Error("æ•°æ®æ ¼å¼é”™è¯¯");

            showModal(`ğŸ“¡ æ‰¾åˆ° ${incomingDB.length} ä¸ªä»»åŠ¡ã€‚<br>ç¡®å®šè¦åˆå¹¶å—ï¼Ÿ`, 'confirm', () => {
                 let addCount = 0;
                 incomingDB.forEach(newItem => {
                    const exists = db.some(e => e.title === newItem.title && e.type === newItem.type);
                    if (!exists) {
                        newItem.id = Date.now() + Math.floor(Math.random()*10000);
                        if (newItem.time === undefined) newItem.time = 30;
                        db.push(newItem);
                        addCount++;
                    }
                 });
                 
                 incomingArchive.forEach(newArc => {
                     const arcExists = archive.some(a => a.title === newArc.title);
                     if(!arcExists) archive.unshift(newArc);
                 });

                 if (incomingStats.willpower) userStats.willpower = Math.max(userStats.willpower, incomingStats.willpower);
                 if (incomingStats.joy) userStats.joy = Math.max(userStats.joy, incomingStats.joy);

                 fixLegacyData();
                 save(); renderList(); renderArchive(); updateStatsUI();
                 showToast(`âœ… æˆåŠŸåˆå¹¶ ${addCount} ä¸ªæ–°ä»»åŠ¡`);
                 document.getElementById('dataArea').value = "";
            });

        } catch(e) {
            showModal(`âŒ å¯¼å…¥å¤±è´¥<br>è¯·ç¡®ä¿å¤åˆ¶äº†å®Œæ•´çš„ä»£ç ã€‚`, 'danger', ()=>{});
        }
    }

    // --- è¾…åŠ©å‡½æ•°é›† ---
    function triggerImport() { document.getElementById('fileInput').click(); }
    function importFromFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { 
            document.getElementById('dataArea').value = e.target.result;
            executeImport(); 
        };
        reader.readAsText(file);
    }

    function exportToFile() {
        const allData = { db, archive, dailyLog, userStats };
        const blob = new Blob([JSON.stringify(allData, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "anchor_backup_" + new Date().toISOString().slice(0,10) + ".json";
        a.click();
    }
    
    function copyToClip() {
        const str = JSON.stringify({ db, archive, dailyLog, userStats });
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(str)
                .then(()=> showToast("âœ… å·²å¤åˆ¶æ–‡æœ¬ç "))
                .catch(()=>{ document.getElementById('dataArea').value=str; showToast("âš ï¸ è¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶"); });
        } else {
            document.getElementById('dataArea').value=str; 
            showToast("âš ï¸ è¯·æ‰‹åŠ¨å…¨é€‰å¤åˆ¶"); 
        }
    }
    
    function autoTag() {
        const raw = document.getElementById('inpTitle').value;
        const lines = raw.split('\n');
        let targetLine = lines[0] || ""; 
        const parsed = parseTimeFromInput(targetLine);
        const feedback = document.getElementById('timeFeedback');
        if (parsed.time) feedback.innerText = `ğŸ’¡ è¯†åˆ«: ${parsed.time} min`; else feedback.innerText = "";

        if (targetLine.includes("æ¯å¤©") || targetLine.includes("æ¯æ—¥")) {
            if(!isCycleActive) toggleCycle();
        }
        const v = targetLine; 
        const tags = document.querySelectorAll('.tag');
        let t = null; let detectQuick = false;
        if (/(æ´—|åˆ·|å‘|è”ç³»|é€šçŸ¥|æ‹¿|å–|æ‹†|è£…|æ“¦|æ‰«|å€’|æ”¶|ç†|æ•´ç†|æ”¶æ‹¾|æµ‡|å–‚|å‰ª|å……|æ‹–|æ¢|å |é“º|æŒ‚|æ‰”|å–)/.test(v)) { t = 'indoor'; detectQuick = true; } 
        else if(v.includes('å”±') || v.includes('å¬')) t = 'vinyl'; 
        else if(v.includes('ä¹¦') || v.includes('å½±') || v.includes('è¯»') || v.includes('çœ‹') || v.includes('æ‚å¿—')) t = 'culture'; 
        else if(v.includes('åŠ¨') || v.includes('è·‘') || v.includes('ç»ƒ') || v.includes('è·³') || v.includes('çƒ') || v.includes('èˆ') || v.includes('æ“')) t = 'sport'; 
        else if(v.includes('ä¹°') || v.includes('å¤–') || v.includes('å–') || v.includes('æ‹¿')) t = 'outdoor'; 
        else if(v.includes('è„‘') || v.includes('å†™') || v.includes('ç ”ç©¶') || v.includes('ä½œ') || v.includes('ç¼–è¾‘')) t = 'desktop';
        if (t) {
            tags.forEach(tag => tag.classList.remove('active'));
            const activeTag = document.querySelector(`.tag[data-v="${t}"]`);
            activeTag.classList.add('active');
            toggleTimeInput(t);
        }
        if (detectQuick && !switchState.flash) {
            toggleSwitch('flash', true); 
            document.getElementById('inpTime').value = "5"; 
        }
    }

    function pickTag(el) {
        document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        toggleTimeInput(el.dataset.v);
    }
    
    function toggleTimeInput(type) {
        const sel = document.getElementById('inpTime');
        if (type === 'vinyl' || type === 'culture') sel.classList.add('disabled');
        else sel.classList.remove('disabled');
    }

    function toggleSwitch(type, forceState) {
        const newState = (forceState !== undefined) ? forceState : !switchState[type];
        switchState[type] = newState;
        const sw = document.getElementById(type + 'Switch');
        const activeClass = (type === 'cycle') ? 'active-cycle' : 'active-flash';
        if (newState) sw.classList.add(activeClass);
        else sw.classList.remove(activeClass);
    }
    
    function toggleCycle() { toggleSwitch('cycle'); }
    function toggleList(id) { const el = document.getElementById(id); el.classList.toggle('open'); }
    function tryDeleteItem(id) { showModal("ç¡®å®šåˆ é™¤å—ï¼Ÿ", 'danger', () => { db = db.filter(item => item.id !== id); save(); renderList(); showToast("ğŸ—‘ï¸ å·²åˆ é™¤"); }); }
    function tryResetAll() { showModal("âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ", 'danger', () => { db = []; archive = []; dailyLog = []; userStats = { willpower: 0, joy: 0 }; save(); renderList(); renderArchive(); renderLog(); updateStatsUI(); showToast("å·²æ ¼å¼åŒ–"); }); }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
    function updateStatsUI() { document.getElementById('stat-willpower').innerText = userStats.willpower; document.getElementById('stat-joy').innerText = userStats.joy; }

    // Start
    init();

</script>
</body>
</html>
